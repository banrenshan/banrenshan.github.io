<!doctype html>
<html lang="zh-CN" data-theme="light">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <meta name="generator" content="VuePress 2.0.0-rc.9" />
    <meta name="theme" content="VuePress Theme Hope 2.0.0-rc.36" />
    <style>
      html {
        background: var(--bg-color, #fff);
      }

      html[data-theme="dark"] {
        background: var(--bg-color, #1d1e1f);
      }

      body {
        background: var(--bg-color);
      }
    </style>
    <script>
      const userMode = localStorage.getItem("vuepress-theme-hope-scheme");
      const systemDarkMode =
        window.matchMedia &&
        window.matchMedia("(prefers-color-scheme: dark)").matches;

      if (userMode === "dark" || (userMode !== "light" && systemDarkMode)) {
        document.documentElement.setAttribute("data-theme", "dark");
      }
    </script>
    <meta property="og:url" content="https://banrenshan.github.io/post/nginx.html"><meta property="og:site_name" content="心之所向，素履以往"><meta property="og:title" content="nginx"><meta property="og:description" content="访问日志解码请求参数 打印post请求的请求体信息 默认的日志打印不包含请求体的内容,如果要打印改值,只需要在log_format中添加$request_body 即可,更多日志打印变量参考官方文档 另外,即使打印出来请求体,内容不支持中文,都是经过url编码后的字符串. 添加或启动新模块 nginx不支持动态安装、加载模块的，所以当你安装第三方模块或..."><meta property="og:type" content="article"><meta property="og:locale" content="zh-CN"><meta property="og:updated_time" content="2024-04-20T07:19:17.000Z"><meta property="article:author" content="banrenshan"><meta property="article:tag" content="java"><meta property="article:published_time" content="2022-12-02T12:51:30.000Z"><meta property="article:modified_time" content="2024-04-20T07:19:17.000Z"><script type="application/ld+json">{"@context":"https://schema.org","@type":"Article","headline":"nginx","image":[""],"datePublished":"2022-12-02T12:51:30.000Z","dateModified":"2024-04-20T07:19:17.000Z","author":[{"@type":"Person","name":"banrenshan","url":"https://github.com/banrenshan"}]}</script><title>nginx | 心之所向，素履以往</title><meta name="description" content="访问日志解码请求参数 打印post请求的请求体信息 默认的日志打印不包含请求体的内容,如果要打印改值,只需要在log_format中添加$request_body 即可,更多日志打印变量参考官方文档 另外,即使打印出来请求体,内容不支持中文,都是经过url编码后的字符串. 添加或启动新模块 nginx不支持动态安装、加载模块的，所以当你安装第三方模块或...">
    <link rel="preload" href="/assets/style-wL6mR3b5.css" as="style"><link rel="stylesheet" href="/assets/style-wL6mR3b5.css">
    <link rel="modulepreload" href="/assets/app-7RQdUJPT.js"><link rel="modulepreload" href="/assets/nginx.html-yzrfvrvj.js"><link rel="modulepreload" href="/assets/plugin-vue_export-helper-DlAUqK2U.js">
    <link rel="prefetch" href="/assets/index.html-D93qcO7u.js" as="script"><link rel="prefetch" href="/assets/go-Context.html-CI67LKn6.js" as="script"><link rel="prefetch" href="/assets/go命令行.html-C0WRp8aY.js" as="script"><link rel="prefetch" href="/assets/go基础.html-CdP7s40v.js" as="script"><link rel="prefetch" href="/assets/go并发.html-Dv3-ooDM.js" as="script"><link rel="prefetch" href="/assets/go标准库-json.html-B6gNNKbG.js" as="script"><link rel="prefetch" href="/assets/go标准库-time.html-DH6P6vL_.js" as="script"><link rel="prefetch" href="/assets/go模块.html-WOzpfH6X.js" as="script"><link rel="prefetch" href="/assets/go泛型.html-FydGrdTI.js" as="script"><link rel="prefetch" href="/assets/go环境.html-rmKNJyoz.js" as="script"><link rel="prefetch" href="/assets/go面向对象.html-CLrq-bFy.js" as="script"><link rel="prefetch" href="/assets/k8s-client-go.html-Cbpij0wS.js" as="script"><link rel="prefetch" href="/assets/虚拟环境.html-eSEy8Mfd.js" as="script"><link rel="prefetch" href="/assets/ews邮箱.html-BY4g2gS2.js" as="script"><link rel="prefetch" href="/assets/gradle.html-B0tUAC3e.js" as="script"><link rel="prefetch" href="/assets/spring-resource.html-BDBKQnCT.js" as="script"><link rel="prefetch" href="/assets/spring-容器基础.html-Y0OlI5Zj.js" as="script"><link rel="prefetch" href="/assets/spring-容器高级.html-lHVyd4nV.js" as="script"><link rel="prefetch" href="/assets/spring-类型转换.html-CrBzAxBF.js" as="script"><link rel="prefetch" href="/assets/spring-表达式.html-ChqGl0Nj.js" as="script"><link rel="prefetch" href="/assets/spring事务.html-D-o_Vo-8.js" as="script"><link rel="prefetch" href="/assets/校验注解.html-DsHE9OIH.js" as="script"><link rel="prefetch" href="/assets/helm.html-DCJUuLzS.js" as="script"><link rel="prefetch" href="/assets/istio.html-Dv4LZfWc.js" as="script"><link rel="prefetch" href="/assets/minikube.html-DhodXFiX.js" as="script"><link rel="prefetch" href="/assets/00-金融知识.html-BEcYyGyH.js" as="script"><link rel="prefetch" href="/assets/01-flyway.html-CMpJA1Zt.js" as="script"><link rel="prefetch" href="/assets/02-jsonassert.html-LPl_VcDR.js" as="script"><link rel="prefetch" href="/assets/03-Junit5.html-C02zh8hk.js" as="script"><link rel="prefetch" href="/assets/04-mocktio.html-Dz-u7cRr.js" as="script"><link rel="prefetch" href="/assets/05-jsonpath.html-C_4HfVBb.js" as="script"><link rel="prefetch" href="/assets/06-spring-cloud-common.html-Cyi_9Ozv.js" as="script"><link rel="prefetch" href="/assets/07-oracle.html-CNnPOnQz.js" as="script"><link rel="prefetch" href="/assets/08-快捷键.html-D76SG3za.js" as="script"><link rel="prefetch" href="/assets/09-编程规范.html-DFll0N2I.js" as="script"><link rel="prefetch" href="/assets/10-多线程.html-C9SZjODt.js" as="script"><link rel="prefetch" href="/assets/11-分布式事务.html-BYfDXwM1.js" as="script"><link rel="prefetch" href="/assets/12-autosys.html-e6FHF6KP.js" as="script"><link rel="prefetch" href="/assets/13-spring-retry官方指南.html-vRtLXYGK.js" as="script"><link rel="prefetch" href="/assets/14-spring-integration.html-DW7v8MWA.js" as="script"><link rel="prefetch" href="/assets/15-Hibernate.html-BFQEVaG3.js" as="script"><link rel="prefetch" href="/assets/16-开发环境.html-C2kFLeiz.js" as="script"><link rel="prefetch" href="/assets/17-OpenShift路由.html-DeC8Qyis.js" as="script"><link rel="prefetch" href="/assets/mysql优化.html-BTxTu16P.js" as="script"><link rel="prefetch" href="/assets/mysql索引.html-DAB2w4JU.js" as="script"><link rel="prefetch" href="/assets/mysql运维和监控.html-CoBrVDSg.js" as="script"><link rel="prefetch" href="/assets/mysql高级.html-CMCs2nbg.js" as="script"><link rel="prefetch" href="/assets/spring-data-jpa.html-BXpMRoqq.js" as="script"><link rel="prefetch" href="/assets/spring-data-redis.html-D7Tztxx6.js" as="script"><link rel="prefetch" href="/assets/AirFlow.html-H-KVrpjc.js" as="script"><link rel="prefetch" href="/assets/ER图.html-D6m35oeW.js" as="script"><link rel="prefetch" href="/assets/Resilience4j.html-D_P8jwOf.js" as="script"><link rel="prefetch" href="/assets/filebeat.html-Cagbg_EM.js" as="script"><link rel="prefetch" href="/assets/go语言.html-gGzjo0pn.js" as="script"><link rel="prefetch" href="/assets/gradle-basic.html-DRLgqnOt.js" as="script"><link rel="prefetch" href="/assets/gradle-depedency.html-D7Y9fg5-.js" as="script"><link rel="prefetch" href="/assets/gradle-java.html-DmOr9iLw.js" as="script"><link rel="prefetch" href="/assets/grafana-1.html-gKDOCoNo.js" as="script"><link rel="prefetch" href="/assets/grafana.html-DgMAW3rN.js" as="script"><link rel="prefetch" href="/assets/java接口.html-5IaNTlSo.js" as="script"><link rel="prefetch" href="/assets/java日期.html-Br-D-mo-.js" as="script"><link rel="prefetch" href="/assets/java注解.html-DLrWvRJy.js" as="script"><link rel="prefetch" href="/assets/loki.html-Byn3ACav.js" as="script"><link rel="prefetch" href="/assets/remoteConnection.html-BloC99Qw.js" as="script"><link rel="prefetch" href="/assets/zero-copy.html-CWC79M5-.js" as="script"><link rel="prefetch" href="/assets/多线程-Exchanger.html-eClz0FUd.js" as="script"><link rel="prefetch" href="/assets/Vscode.html-DphMxb_u.js" as="script"><link rel="prefetch" href="/assets/代理.html-C77QQfd-.js" as="script"><link rel="prefetch" href="/assets/404.html-C3jcOVEe.js" as="script"><link rel="prefetch" href="/assets/index.html-DO2tofhf.js" as="script"><link rel="prefetch" href="/assets/index.html-Bq9R9arM.js" as="script"><link rel="prefetch" href="/assets/index.html-MwK0uww9.js" as="script"><link rel="prefetch" href="/assets/index.html-Du2Et9aP.js" as="script"><link rel="prefetch" href="/assets/index.html-BOthiLHJ.js" as="script"><link rel="prefetch" href="/assets/index.html-q3fQuzIP.js" as="script"><link rel="prefetch" href="/assets/index.html-BedXZc2P.js" as="script"><link rel="prefetch" href="/assets/index.html-6_ifywZ3.js" as="script"><link rel="prefetch" href="/assets/index.html-CxgXmMdy.js" as="script"><link rel="prefetch" href="/assets/index.html-MFo5f2gl.js" as="script"><link rel="prefetch" href="/assets/index.html-l6sZpKae.js" as="script"><link rel="prefetch" href="/assets/index.html-C48ZsKLd.js" as="script"><link rel="prefetch" href="/assets/index.html-Cu5QplII.js" as="script"><link rel="prefetch" href="/assets/index.html-DONYUWEE.js" as="script"><link rel="prefetch" href="/assets/index.html-Cb5LjeD-.js" as="script"><link rel="prefetch" href="/assets/index.html-DC7_AdgG.js" as="script"><link rel="prefetch" href="/assets/index.html-C48ZsKLd.js" as="script"><link rel="prefetch" href="/assets/index.html-Czx0WIYT.js" as="script"><link rel="prefetch" href="/assets/index.html-D7gWdgmG.js" as="script"><link rel="prefetch" href="/assets/index.html-CJfRfqNk.js" as="script"><link rel="prefetch" href="/assets/index.html-tiFyH_P-.js" as="script"><link rel="prefetch" href="/assets/index.html-BgbZXHgE.js" as="script"><link rel="prefetch" href="/assets/index.html-GPhK-HlH.js" as="script"><link rel="prefetch" href="/assets/index.html-BXQfQixs.js" as="script"><link rel="prefetch" href="/assets/index.html-Cu5QplII.js" as="script"><link rel="prefetch" href="/assets/index.html-CeyG9gGE.js" as="script"><link rel="prefetch" href="/assets/index.html-D5S-Vltv.js" as="script"><link rel="prefetch" href="/assets/index.html-CxgXmMdy.js" as="script"><link rel="prefetch" href="/assets/index.html-BPqRFsJH.js" as="script"><link rel="prefetch" href="/assets/index.html-CUO5hG-T.js" as="script"><link rel="prefetch" href="/assets/index.html-BumIp4Hx.js" as="script"><link rel="prefetch" href="/assets/index.html-Dxec4nK7.js" as="script"><link rel="prefetch" href="/assets/index.html-LuMcJjHf.js" as="script"><link rel="prefetch" href="/assets/index.html-CNu6Xqct.js" as="script"><link rel="prefetch" href="/assets/index.html-L-P4FVfs.js" as="script"><link rel="prefetch" href="/assets/index.html-BFtX3SVq.js" as="script"><link rel="prefetch" href="/assets/index.html-fR1onQnj.js" as="script"><link rel="prefetch" href="/assets/index.html-B7xOwFNP.js" as="script"><link rel="prefetch" href="/assets/index.html-2iwbVUyZ.js" as="script"><link rel="prefetch" href="/assets/index.html-D6iHC92-.js" as="script"><link rel="prefetch" href="/assets/index.html-WYZp0Q0d.js" as="script"><link rel="prefetch" href="/assets/index.html-CFLbIjY2.js" as="script"><link rel="prefetch" href="/assets/index.html-CKPp4SDp.js" as="script"><link rel="prefetch" href="/assets/index.html-DCnhMBVS.js" as="script"><link rel="prefetch" href="/assets/index.html-CV2l7hgd.js" as="script"><link rel="prefetch" href="/assets/index.html-CZ4-ryJ5.js" as="script"><link rel="prefetch" href="/assets/index.html-B-hig3BN.js" as="script"><link rel="prefetch" href="/assets/index.html-DSKOmg4G.js" as="script"><link rel="prefetch" href="/assets/index.html-ClJ9gqAC.js" as="script"><link rel="prefetch" href="/assets/index.html-pKKSIs37.js" as="script"><link rel="prefetch" href="/assets/index.html-B6Jv4XpT.js" as="script"><link rel="prefetch" href="/assets/index.html-ByAdN9t0.js" as="script"><link rel="prefetch" href="/assets/index.html--ImzJj1h.js" as="script"><link rel="prefetch" href="/assets/index.html-Daur8vvZ.js" as="script"><link rel="prefetch" href="/assets/index.html-Dj3UuM_l.js" as="script"><link rel="prefetch" href="/assets/index.html-BGMDySBJ.js" as="script"><link rel="prefetch" href="/assets/index.html-DW1Hgcnw.js" as="script"><link rel="prefetch" href="/assets/index.html-BdBaueVM.js" as="script"><link rel="prefetch" href="/assets/index.html-7APedaBk.js" as="script"><link rel="prefetch" href="/assets/index.html-KiyyBrRA.js" as="script"><link rel="prefetch" href="/assets/index.html-Dz_Miilj.js" as="script"><link rel="prefetch" href="/assets/index.html-BilVXGTn.js" as="script"><link rel="prefetch" href="/assets/index.html-BsvbCFFw.js" as="script"><link rel="prefetch" href="/assets/index.html-DAIBSeNA.js" as="script"><link rel="prefetch" href="/assets/index.html-BTDcbux1.js" as="script"><link rel="prefetch" href="/assets/index.html-DbjYkyBI.js" as="script"><link rel="prefetch" href="/assets/index.html-DrKtX-w2.js" as="script"><link rel="prefetch" href="/assets/index.html-DHug22Up.js" as="script"><link rel="prefetch" href="/assets/index.html-Dg2etHb6.js" as="script"><link rel="prefetch" href="/assets/index.html-ZO2LQsn-.js" as="script"><link rel="prefetch" href="/assets/index.html-BFtX3SVq.js" as="script"><link rel="prefetch" href="/assets/index.html-g1JTVnr8.js" as="script"><link rel="prefetch" href="/assets/index.html-cwUALWH6.js" as="script"><link rel="prefetch" href="/assets/index.html-DMKDY4KA.js" as="script"><link rel="prefetch" href="/assets/index.html-Br5eqDdk.js" as="script"><link rel="prefetch" href="/assets/index.html-BzUQsEpH.js" as="script"><link rel="prefetch" href="/assets/index.html-B2tRB9qn.js" as="script"><link rel="prefetch" href="/assets/index.html-CChF1VWV.js" as="script"><link rel="prefetch" href="/assets/index.html-IQ-F0LL2.js" as="script"><link rel="prefetch" href="/assets/index.html-vr3g8wB7.js" as="script"><link rel="prefetch" href="/assets/index.html-DPCPSe4j.js" as="script"><link rel="prefetch" href="/assets/index.html-gNxPy0QN.js" as="script"><link rel="prefetch" href="/assets/index.html-u50bpK-1.js" as="script"><link rel="prefetch" href="/assets/index.html-BF9h9LXM.js" as="script"><link rel="prefetch" href="/assets/index.html-CVgq64z-.js" as="script"><link rel="prefetch" href="/assets/index.html-BvYqOXU2.js" as="script"><link rel="prefetch" href="/assets/index.html-BUo3mxf1.js" as="script"><link rel="prefetch" href="/assets/photoswipe.esm-SzV8tJDW.js" as="script">
  </head>
  <body>
    <div id="app"><!--[--><!--[--><!--[--><span tabindex="-1"></span><a href="#main-content" class="vp-skip-link sr-only">跳至主要內容</a><!--]--><!--[--><div class="theme-container has-toc"><!--[--><header id="navbar" class="vp-navbar"><div class="vp-navbar-start"><button type="button" class="vp-toggle-sidebar-button" title="Toggle Sidebar"><span class="icon"></span></button><!--[--><!----><!--]--><!--[--><a class="route-link vp-brand" href="/"><img class="vp-nav-logo" src="https://theme-hope-assets.vuejs.press/logo.svg" alt><!----><span class="vp-site-name hide-in-pad">心之所向，素履以往</span></a><!--]--><!--[--><!----><!--]--></div><div class="vp-navbar-center"><!--[--><!----><!--]--><!--[--><nav class="vp-nav-links"><div class="vp-nav-item hide-in-mobile"><a class="route-link nav-link" href="/" aria-label="主页"><span class="font-icon icon fa-fw fa-sm fas fa-home" style=""></span>主页<!----></a></div><div class="vp-nav-item hide-in-mobile"><a class="route-link nav-link active" href="/post/" aria-label="博文"><span class="font-icon icon fa-fw fa-sm fas fa-pen-to-square" style=""></span>博文<!----></a></div><div class="vp-nav-item hide-in-mobile"><a class="route-link nav-link" href="/timeline/" aria-label="事件轴"><span class="font-icon icon fa-fw fa-sm fas fa-timeline" style=""></span>事件轴<!----></a></div><div class="vp-nav-item hide-in-mobile"><a class="route-link nav-link" href="/tag/" aria-label="标签"><span class="font-icon icon fa-fw fa-sm fas fa-tags" style=""></span>标签<!----></a></div><div class="vp-nav-item hide-in-mobile"><a class="route-link nav-link" href="/category/" aria-label="分类"><span class="font-icon icon fa-fw fa-sm fas fa-book" style=""></span>分类<!----></a></div></nav><!--]--><!--[--><!----><!--]--></div><div class="vp-navbar-end"><!--[--><!----><!--]--><!--[--><!----><div class="vp-nav-item vp-action"><a class="vp-action-link" href="https://github.com/banrenshan/banrenshan.github.io" target="_blank" rel="noopener noreferrer" aria-label="GitHub"><svg xmlns="http://www.w3.org/2000/svg" class="icon github-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="github icon" style="width:1.25rem;height:1.25rem;vertical-align:middle;"><path d="M511.957 21.333C241.024 21.333 21.333 240.981 21.333 512c0 216.832 140.544 400.725 335.574 465.664 24.49 4.395 32.256-10.07 32.256-23.083 0-11.69.256-44.245 0-85.205-136.448 29.61-164.736-64.64-164.736-64.64-22.315-56.704-54.4-71.765-54.4-71.765-44.587-30.464 3.285-29.824 3.285-29.824 49.195 3.413 75.179 50.517 75.179 50.517 43.776 75.008 114.816 53.333 142.762 40.79 4.523-31.66 17.152-53.377 31.19-65.537-108.971-12.458-223.488-54.485-223.488-242.602 0-53.547 19.114-97.323 50.517-131.67-5.035-12.33-21.93-62.293 4.779-129.834 0 0 41.258-13.184 134.912 50.346a469.803 469.803 0 0 1 122.88-16.554c41.642.213 83.626 5.632 122.88 16.554 93.653-63.488 134.784-50.346 134.784-50.346 26.752 67.541 9.898 117.504 4.864 129.834 31.402 34.347 50.474 78.123 50.474 131.67 0 188.586-114.73 230.016-224.042 242.09 17.578 15.232 33.578 44.672 33.578 90.454v135.85c0 13.142 7.936 27.606 32.854 22.87C862.25 912.597 1002.667 728.747 1002.667 512c0-271.019-219.648-490.667-490.71-490.667z"></path></svg></a></div><div class="vp-nav-item hide-in-mobile"><button type="button" id="appearance-switch"><svg xmlns="http://www.w3.org/2000/svg" class="icon auto-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="auto icon" style="display:block;"><path d="M512 992C246.92 992 32 777.08 32 512S246.92 32 512 32s480 214.92 480 480-214.92 480-480 480zm0-840c-198.78 0-360 161.22-360 360 0 198.84 161.22 360 360 360s360-161.16 360-360c0-198.78-161.22-360-360-360zm0 660V212c165.72 0 300 134.34 300 300 0 165.72-134.28 300-300 300z"></path></svg><svg xmlns="http://www.w3.org/2000/svg" class="icon dark-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="dark icon" style="display:none;"><path d="M524.8 938.667h-4.267a439.893 439.893 0 0 1-313.173-134.4 446.293 446.293 0 0 1-11.093-597.334A432.213 432.213 0 0 1 366.933 90.027a42.667 42.667 0 0 1 45.227 9.386 42.667 42.667 0 0 1 10.24 42.667 358.4 358.4 0 0 0 82.773 375.893 361.387 361.387 0 0 0 376.747 82.774 42.667 42.667 0 0 1 54.187 55.04 433.493 433.493 0 0 1-99.84 154.88 438.613 438.613 0 0 1-311.467 128z"></path></svg><svg xmlns="http://www.w3.org/2000/svg" class="icon light-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="light icon" style="display:none;"><path d="M952 552h-80a40 40 0 0 1 0-80h80a40 40 0 0 1 0 80zM801.88 280.08a41 41 0 0 1-57.96-57.96l57.96-58a41.04 41.04 0 0 1 58 58l-58 57.96zM512 752a240 240 0 1 1 0-480 240 240 0 0 1 0 480zm0-560a40 40 0 0 1-40-40V72a40 40 0 0 1 80 0v80a40 40 0 0 1-40 40zm-289.88 88.08-58-57.96a41.04 41.04 0 0 1 58-58l57.96 58a41 41 0 0 1-57.96 57.96zM192 512a40 40 0 0 1-40 40H72a40 40 0 0 1 0-80h80a40 40 0 0 1 40 40zm30.12 231.92a41 41 0 0 1 57.96 57.96l-57.96 58a41.04 41.04 0 0 1-58-58l58-57.96zM512 832a40 40 0 0 1 40 40v80a40 40 0 0 1-80 0v-80a40 40 0 0 1 40-40zm289.88-88.08 58 57.96a41.04 41.04 0 0 1-58 58l-57.96-58a41 41 0 0 1 57.96-57.96z"></path></svg></button></div><!----><!--]--><!--[--><!----><!--]--><button type="button" class="vp-toggle-navbar-button" aria-label="Toggle Navbar" aria-expanded="false" aria-controls="nav-screen"><span><span class="vp-top"></span><span class="vp-middle"></span><span class="vp-bottom"></span></span></button></div></header><!----><!--]--><!----><div class="toggle-sidebar-wrapper"><span class="arrow start"></span></div><aside id="sidebar" class="vp-sidebar"><!--[--><!----><!--]--><ul class="vp-sidebar-links"><li><section class="vp-sidebar-group"><p class="vp-sidebar-header clickable"><span class="font-icon icon fa-fw fa-sm fas fa-laptop-code" style=""></span><a class="route-link nav-link vp-sidebar-title" href="/gudie/" aria-label="指南"><!---->指南<!----></a><!----></p><ul class="vp-sidebar-links"><li><a class="route-link nav-link vp-sidebar-link vp-sidebar-page" href="/gudie/12-autosys.html" aria-label="AutoSys"><!---->AutoSys<!----></a></li><li><a class="route-link nav-link vp-sidebar-link vp-sidebar-page" href="/gudie/01-flyway.html" aria-label="flyway指南"><!---->flyway指南<!----></a></li><li><a class="route-link nav-link vp-sidebar-link vp-sidebar-page" href="/gudie/15-Hibernate.html" aria-label="Hibernate 指南"><!---->Hibernate 指南<!----></a></li><li><a class="route-link nav-link vp-sidebar-link vp-sidebar-page" href="/gudie/02-jsonassert.html" aria-label="JSONassert指南"><!---->JSONassert指南<!----></a></li><li><a class="route-link nav-link vp-sidebar-link vp-sidebar-page" href="/gudie/05-jsonpath.html" aria-label="JsonPath 指南"><!---->JsonPath 指南<!----></a></li><li><a class="route-link nav-link vp-sidebar-link vp-sidebar-page" href="/gudie/03-Junit5.html" aria-label="JUnit5指南"><!---->JUnit5指南<!----></a></li><li><a class="route-link nav-link vp-sidebar-link vp-sidebar-page" href="/gudie/04-mocktio.html" aria-label="mocktio指南"><!---->mocktio指南<!----></a></li><li><a class="route-link nav-link vp-sidebar-link vp-sidebar-page" href="/gudie/17-OpenShift%E8%B7%AF%E7%94%B1.html" aria-label="OpenShift 路由"><!---->OpenShift 路由<!----></a></li><li><a class="route-link nav-link vp-sidebar-link vp-sidebar-page" href="/gudie/07-oracle.html" aria-label="Oracle基础 指南"><!---->Oracle基础 指南<!----></a></li><li><a class="route-link nav-link vp-sidebar-link vp-sidebar-page" href="/gudie/spring-data-redis.html" aria-label="redis支持"><!---->redis支持<!----></a></li><li><a class="route-link nav-link vp-sidebar-link vp-sidebar-page" href="/gudie/spring-data-jpa.html" aria-label="Spring Data Repositories"><!---->Spring Data Repositories<!----></a></li><li><a class="route-link nav-link vp-sidebar-link vp-sidebar-page" href="/gudie/14-spring-integration.html" aria-label="Spring Integration 指南"><!---->Spring Integration 指南<!----></a></li><li><a class="route-link nav-link vp-sidebar-link vp-sidebar-page" href="/gudie/13-spring-retry%E5%AE%98%E6%96%B9%E6%8C%87%E5%8D%97.html" aria-label="Spring Retry 指南"><!---->Spring Retry 指南<!----></a></li><li><a class="route-link nav-link vp-sidebar-link vp-sidebar-page" href="/gudie/06-spring-cloud-common.html" aria-label="Spring-CLoud-Common"><!---->Spring-CLoud-Common<!----></a></li><li><a class="route-link nav-link vp-sidebar-link vp-sidebar-page" href="/gudie/mysql%E4%BC%98%E5%8C%96.html" aria-label="sql语句上的优化"><!---->sql语句上的优化<!----></a></li><li><a class="route-link nav-link vp-sidebar-link vp-sidebar-page" href="/gudie/11-%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1.html" aria-label="分布式事务"><!---->分布式事务<!----></a></li><li><a class="route-link nav-link vp-sidebar-link vp-sidebar-page" href="/gudie/10-%E5%A4%9A%E7%BA%BF%E7%A8%8B.html" aria-label="多线程"><!---->多线程<!----></a></li><li><a class="route-link nav-link vp-sidebar-link vp-sidebar-page" href="/gudie/mysql%E9%AB%98%E7%BA%A7.html" aria-label="安装"><!---->安装<!----></a></li><li><a class="route-link nav-link vp-sidebar-link vp-sidebar-page" href="/gudie/16-%E5%BC%80%E5%8F%91%E7%8E%AF%E5%A2%83.html" aria-label="开发环境"><!---->开发环境<!----></a></li><li><a class="route-link nav-link vp-sidebar-link vp-sidebar-page" href="/gudie/08-%E5%BF%AB%E6%8D%B7%E9%94%AE.html" aria-label="快捷键"><!---->快捷键<!----></a></li><li><a class="route-link nav-link vp-sidebar-link vp-sidebar-page" href="/gudie/mysql%E7%B4%A2%E5%BC%95.html" aria-label="概述"><!---->概述<!----></a></li><li><a class="route-link nav-link vp-sidebar-link vp-sidebar-page" href="/gudie/mysql%E8%BF%90%E7%BB%B4%E5%92%8C%E7%9B%91%E6%8E%A7.html" aria-label="监控"><!---->监控<!----></a></li><li><a class="route-link nav-link vp-sidebar-link vp-sidebar-page" href="/gudie/09-%E7%BC%96%E7%A8%8B%E8%A7%84%E8%8C%83.html" aria-label="编程规范"><!---->编程规范<!----></a></li><li><a class="route-link nav-link vp-sidebar-link vp-sidebar-page" href="/gudie/00-%E9%87%91%E8%9E%8D%E7%9F%A5%E8%AF%86.html" aria-label="金融知识"><!---->金融知识<!----></a></li></ul></section></li><li><section class="vp-sidebar-group"><p class="vp-sidebar-header active"><span class="font-icon icon fa-fw fa-sm fas fa-book" style=""></span><span class="vp-sidebar-title">文章</span><!----></p><ul class="vp-sidebar-links"><li><a class="route-link nav-link vp-sidebar-link vp-sidebar-page" href="/post/AirFlow.html" aria-label="AirFlow"><!---->AirFlow<!----></a></li><li><a class="route-link nav-link vp-sidebar-link vp-sidebar-page" href="/post/ER%E5%9B%BE.html" aria-label="ER图"><!---->ER图<!----></a></li><li><a class="route-link nav-link vp-sidebar-link vp-sidebar-page" href="/post/filebeat.html" aria-label="filebeat"><!---->filebeat<!----></a></li><li><a class="route-link nav-link vp-sidebar-link vp-sidebar-page" href="/post/go%E8%AF%AD%E8%A8%80.html" aria-label="go基础语法"><!---->go基础语法<!----></a></li><li><a class="route-link nav-link vp-sidebar-link vp-sidebar-page" href="/post/gradle-depedency.html" aria-label="gradle 依赖解析"><!---->gradle 依赖解析<!----></a></li><li><a class="route-link nav-link vp-sidebar-link vp-sidebar-page" href="/post/gradle-basic.html" aria-label="gradle-basic"><!---->gradle-basic<!----></a></li><li><a class="route-link nav-link vp-sidebar-link vp-sidebar-page" href="/post/gradle-java.html" aria-label="gradle-java"><!---->gradle-java<!----></a></li><li><a class="route-link nav-link vp-sidebar-link vp-sidebar-page" href="/post/grafana-1.html" aria-label="grafana1"><!---->grafana1<!----></a></li><li><a class="route-link nav-link vp-sidebar-link vp-sidebar-page" href="/post/grafana.html" aria-label="grafana2"><!---->grafana2<!----></a></li><li><a class="route-link nav-link vp-sidebar-link vp-sidebar-page" href="/post/java%E6%8E%A5%E5%8F%A3.html" aria-label="Java 接口"><!---->Java 接口<!----></a></li><li><a class="route-link nav-link vp-sidebar-link vp-sidebar-page" href="/post/java%E6%97%A5%E6%9C%9F.html" aria-label="Java 日期 API"><!---->Java 日期 API<!----></a></li><li><a class="route-link nav-link vp-sidebar-link vp-sidebar-page" href="/post/java%E6%B3%A8%E8%A7%A3.html" aria-label="Java 注解"><!---->Java 注解<!----></a></li><li><a class="route-link nav-link vp-sidebar-link vp-sidebar-page" href="/post/loki.html" aria-label="loki"><!---->loki<!----></a></li><li><a class="route-link nav-link active vp-sidebar-link vp-sidebar-page active" href="/post/nginx.html" aria-label="nginx"><!---->nginx<!----></a></li><li><a class="route-link nav-link vp-sidebar-link vp-sidebar-page" href="/post/Resilience4j.html" aria-label="Resilience4j"><!---->Resilience4j<!----></a></li><li><a class="route-link nav-link vp-sidebar-link vp-sidebar-page" href="/post/zero-copy.html" aria-label="zero-copy"><!---->zero-copy<!----></a></li><li><a class="route-link nav-link vp-sidebar-link vp-sidebar-page" href="/post/%E5%A4%9A%E7%BA%BF%E7%A8%8B-Exchanger.html" aria-label="多线程-Exchanger"><!---->多线程-Exchanger<!----></a></li><li><a class="route-link nav-link vp-sidebar-link vp-sidebar-page" href="/post/remoteConnection.html" aria-label="远程管理协议"><!---->远程管理协议<!----></a></li></ul></section></li><li><section class="vp-sidebar-group"><p class="vp-sidebar-header"><span class="font-icon icon fa-fw fa-sm fas fa-book" style=""></span><span class="vp-sidebar-title">Go</span><!----></p><ul class="vp-sidebar-links"><li><a class="route-link nav-link vp-sidebar-link vp-sidebar-page" href="/Go/go-Context.html" aria-label="Go Context"><!---->Go Context<!----></a></li><li><a class="route-link nav-link vp-sidebar-link vp-sidebar-page" href="/Go/go%E6%A0%87%E5%87%86%E5%BA%93-json.html" aria-label="Go Json"><!---->Go Json<!----></a></li><li><a class="route-link nav-link vp-sidebar-link vp-sidebar-page" href="/Go/go%E6%A0%87%E5%87%86%E5%BA%93-time.html" aria-label="Go Time"><!---->Go Time<!----></a></li><li><a class="route-link nav-link vp-sidebar-link vp-sidebar-page" href="/Go/go%E5%91%BD%E4%BB%A4%E8%A1%8C.html" aria-label="Go 命令行"><!---->Go 命令行<!----></a></li><li><a class="route-link nav-link vp-sidebar-link vp-sidebar-page" href="/Go/go%E5%9F%BA%E7%A1%80.html" aria-label="Go 基础"><!---->Go 基础<!----></a></li><li><a class="route-link nav-link vp-sidebar-link vp-sidebar-page" href="/Go/go%E5%B9%B6%E5%8F%91.html" aria-label="Go 并发"><!---->Go 并发<!----></a></li><li><a class="route-link nav-link vp-sidebar-link vp-sidebar-page" href="/Go/go%E6%A8%A1%E5%9D%97.html" aria-label="Go 模块"><!---->Go 模块<!----></a></li><li><a class="route-link nav-link vp-sidebar-link vp-sidebar-page" href="/Go/go%E9%9D%A2%E5%90%91%E5%AF%B9%E8%B1%A1.html" aria-label="Go 面向对象"><!---->Go 面向对象<!----></a></li><li><a class="route-link nav-link vp-sidebar-link vp-sidebar-page" href="/Go/go%E6%B3%9B%E5%9E%8B.html" aria-label="Go泛型"><!---->Go泛型<!----></a></li><li><a class="route-link nav-link vp-sidebar-link vp-sidebar-page" href="/Go/go%E7%8E%AF%E5%A2%83.html" aria-label="Go环境"><!---->Go环境<!----></a></li><li><a class="route-link nav-link vp-sidebar-link vp-sidebar-page" href="/Go/k8s-client-go.html" aria-label="Kubernate Go"><!---->Kubernate Go<!----></a></li></ul></section></li><li><section class="vp-sidebar-group"><p class="vp-sidebar-header"><span class="font-icon icon fa-fw fa-sm fas fa-book" style=""></span><span class="vp-sidebar-title">云技术</span><!----></p><ul class="vp-sidebar-links"><li><a class="route-link nav-link vp-sidebar-link vp-sidebar-page" href="/cloud/helm.html" aria-label="Helm 指南"><!---->Helm 指南<!----></a></li><li><a class="route-link nav-link vp-sidebar-link vp-sidebar-page" href="/cloud/istio.html" aria-label="Istio 指南"><!---->Istio 指南<!----></a></li><li><a class="route-link nav-link vp-sidebar-link vp-sidebar-page" href="/cloud/minikube.html" aria-label="minikube 指南"><!---->minikube 指南<!----></a></li></ul></section></li><li><section class="vp-sidebar-group"><p class="vp-sidebar-header"><span class="font-icon icon fa-fw fa-sm fas fa-book" style=""></span><span class="vp-sidebar-title">Python</span><!----></p><ul class="vp-sidebar-links"><li><a class="route-link nav-link vp-sidebar-link vp-sidebar-page" href="/Python/%E8%99%9A%E6%8B%9F%E7%8E%AF%E5%A2%83.html" aria-label="虚拟环境"><!---->虚拟环境<!----></a></li></ul></section></li><li><section class="vp-sidebar-group"><p class="vp-sidebar-header"><span class="font-icon icon fa-fw fa-sm fas fa-book" style=""></span><span class="vp-sidebar-title">Tools</span><!----></p><ul class="vp-sidebar-links"><li><a class="route-link nav-link vp-sidebar-link vp-sidebar-page" href="/tool/Vscode.html" aria-label="Vscode"><!---->Vscode<!----></a></li><li><a class="route-link nav-link vp-sidebar-link vp-sidebar-page" href="/tool/%E4%BB%A3%E7%90%86.html" aria-label="各种代理设置"><!---->各种代理设置<!----></a></li></ul></section></li><li><section class="vp-sidebar-group"><p class="vp-sidebar-header"><span class="font-icon icon fa-fw fa-sm fas fa-book" style=""></span><span class="vp-sidebar-title">Spring</span><!----></p><ul class="vp-sidebar-links"><li><a class="route-link nav-link vp-sidebar-link vp-sidebar-page" href="/Spring/ews%E9%82%AE%E7%AE%B1.html" aria-label="ews 邮箱API"><!---->ews 邮箱API<!----></a></li><li><a class="route-link nav-link vp-sidebar-link vp-sidebar-page" href="/Spring/gradle.html" aria-label="Gradle指南"><!---->Gradle指南<!----></a></li><li><a class="route-link nav-link vp-sidebar-link vp-sidebar-page" href="/Spring/%E6%A0%A1%E9%AA%8C%E6%B3%A8%E8%A7%A3.html" aria-label="Spring Validation"><!---->Spring Validation<!----></a></li><li><a class="route-link nav-link vp-sidebar-link vp-sidebar-page" href="/Spring/spring%E4%BA%8B%E5%8A%A1.html" aria-label="Spring 事务"><!---->Spring 事务<!----></a></li><li><a class="route-link nav-link vp-sidebar-link vp-sidebar-page" href="/Spring/spring-%E5%AE%B9%E5%99%A8%E5%9F%BA%E7%A1%80.html" aria-label="Spring 容器基础"><!---->Spring 容器基础<!----></a></li><li><a class="route-link nav-link vp-sidebar-link vp-sidebar-page" href="/Spring/spring-%E5%AE%B9%E5%99%A8%E9%AB%98%E7%BA%A7.html" aria-label="Spring 容器高级"><!---->Spring 容器高级<!----></a></li><li><a class="route-link nav-link vp-sidebar-link vp-sidebar-page" href="/Spring/spring-%E7%B1%BB%E5%9E%8B%E8%BD%AC%E6%8D%A2.html" aria-label="Spring 类型转换"><!---->Spring 类型转换<!----></a></li><li><a class="route-link nav-link vp-sidebar-link vp-sidebar-page" href="/Spring/spring-%E8%A1%A8%E8%BE%BE%E5%BC%8F.html" aria-label="Spring 表达式"><!---->Spring 表达式<!----></a></li><li><a class="route-link nav-link vp-sidebar-link vp-sidebar-page" href="/Spring/spring-resource.html" aria-label="Spring 资源处理"><!---->Spring 资源处理<!----></a></li></ul></section></li></ul><!--[--><!----><!--]--></aside><!--[--><main id="main-content" class="vp-page"><!--[--><!--[--><!----><!--]--><!----><nav class="vp-breadcrumb disable"></nav><div class="vp-page-title"><h1><!---->nginx</h1><div class="page-info"><span class="page-author-info" aria-label="作者🖊" data-balloon-pos="up"><svg xmlns="http://www.w3.org/2000/svg" class="icon author-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="author icon"><path d="M649.6 633.6c86.4-48 147.2-144 147.2-249.6 0-160-128-288-288-288s-288 128-288 288c0 108.8 57.6 201.6 147.2 249.6-121.6 48-214.4 153.6-240 288-3.2 9.6 0 19.2 6.4 25.6 3.2 9.6 12.8 12.8 22.4 12.8h704c9.6 0 19.2-3.2 25.6-12.8 6.4-6.4 9.6-16 6.4-25.6-25.6-134.4-121.6-240-243.2-288z"></path></svg><span><a class="page-author-item" href="https://github.com/banrenshan" target="_blank" rel="noopener noreferrer">banrenshan</a></span><span property="author" content="banrenshan"></span></span><!----><span class="page-date-info" aria-label="写作日期📅" data-balloon-pos="up"><svg xmlns="http://www.w3.org/2000/svg" class="icon calendar-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="calendar icon"><path d="M716.4 110.137c0-18.753-14.72-33.473-33.472-33.473-18.753 0-33.473 14.72-33.473 33.473v33.473h66.993v-33.473zm-334.87 0c0-18.753-14.72-33.473-33.473-33.473s-33.52 14.72-33.52 33.473v33.473h66.993v-33.473zm468.81 33.52H716.4v100.465c0 18.753-14.72 33.473-33.472 33.473a33.145 33.145 0 01-33.473-33.473V143.657H381.53v100.465c0 18.753-14.72 33.473-33.473 33.473a33.145 33.145 0 01-33.473-33.473V143.657H180.6A134.314 134.314 0 0046.66 277.595v535.756A134.314 134.314 0 00180.6 947.289h669.74a134.36 134.36 0 00133.94-133.938V277.595a134.314 134.314 0 00-133.94-133.938zm33.473 267.877H147.126a33.145 33.145 0 01-33.473-33.473c0-18.752 14.72-33.473 33.473-33.473h736.687c18.752 0 33.472 14.72 33.472 33.473a33.145 33.145 0 01-33.472 33.473z"></path></svg><span><!----></span><meta property="datePublished" content="2022-12-02T12:51:30.000Z"></span><span class="page-pageview-info" aria-label="访问量🔢" data-balloon-pos="up"><svg xmlns="http://www.w3.org/2000/svg" class="icon eye-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="eye icon"><path d="M992 512.096c0-5.76-.992-10.592-1.28-11.136-.192-2.88-1.152-8.064-2.08-10.816-.256-.672-.544-1.376-.832-2.08-.48-1.568-1.024-3.104-1.6-4.32C897.664 290.112 707.104 160 512 160c-195.072 0-385.632 130.016-473.76 322.592-1.056 2.112-1.792 4.096-2.272 5.856a55.512 55.512 0 00-.64 1.6c-1.76 5.088-1.792 8.64-1.632 7.744-.832 3.744-1.568 11.168-1.568 11.168-.224 2.272-.224 4.032.032 6.304 0 0 .736 6.464 1.088 7.808.128 1.824.576 4.512 1.12 6.976h-.032c.448 2.08 1.12 4.096 1.984 6.08.48 1.536.992 2.976 1.472 4.032C126.432 733.856 316.992 864 512 864c195.136 0 385.696-130.048 473.216-321.696 1.376-2.496 2.24-4.832 2.848-6.912.256-.608.48-1.184.672-1.728 1.536-4.48 1.856-8.32 1.728-8.32l-.032.032c.608-3.104 1.568-7.744 1.568-13.28zM512 672c-88.224 0-160-71.776-160-160s71.776-160 160-160 160 71.776 160 160-71.776 160-160 160z"></path></svg><span id="ArtalkPV" class="vp-pageview waline-pageview-count" data-path="/post/nginx.html" data-page-key="/post/nginx.html">...</span></span><span class="page-reading-time-info" aria-label="阅读时间⌛" data-balloon-pos="up"><svg xmlns="http://www.w3.org/2000/svg" class="icon timer-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="timer icon"><path d="M799.387 122.15c4.402-2.978 7.38-7.897 7.38-13.463v-1.165c0-8.933-7.38-16.312-16.312-16.312H256.33c-8.933 0-16.311 7.38-16.311 16.312v1.165c0 5.825 2.977 10.874 7.637 13.592 4.143 194.44 97.22 354.963 220.201 392.763-122.204 37.542-214.893 196.511-220.2 389.397-4.661 5.049-7.638 11.651-7.638 19.03v5.825h566.49v-5.825c0-7.379-2.849-13.981-7.509-18.9-5.049-193.016-97.867-351.985-220.2-389.527 123.24-37.67 216.446-198.453 220.588-392.892zM531.16 450.445v352.632c117.674 1.553 211.787 40.778 211.787 88.676H304.097c0-48.286 95.149-87.382 213.728-88.676V450.445c-93.077-3.107-167.901-81.297-167.901-177.093 0-8.803 6.99-15.793 15.793-15.793 8.803 0 15.794 6.99 15.794 15.793 0 80.261 63.69 145.635 142.01 145.635s142.011-65.374 142.011-145.635c0-8.803 6.99-15.793 15.794-15.793s15.793 6.99 15.793 15.793c0 95.019-73.789 172.82-165.96 177.093z"></path></svg><span>大约 20 分钟</span><meta property="timeRequired" content="PT20M"></span><!----><!----></div><hr></div><div class="vp-toc-placeholder"><aside id="toc"><!--[--><!----><!--]--><div class="vp-toc-header">此页内容<button type="button" class="print-button" title="打印"><svg xmlns="http://www.w3.org/2000/svg" class="icon print-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="print icon"><path d="M819.2 364.8h-44.8V128c0-17.067-14.933-32-32-32H281.6c-17.067 0-32 14.933-32 32v236.8h-44.8C145.067 364.8 96 413.867 96 473.6v192c0 59.733 49.067 108.8 108.8 108.8h44.8V896c0 17.067 14.933 32 32 32h460.8c17.067 0 32-14.933 32-32V774.4h44.8c59.733 0 108.8-49.067 108.8-108.8v-192c0-59.733-49.067-108.8-108.8-108.8zM313.6 160h396.8v204.8H313.6V160zm396.8 704H313.6V620.8h396.8V864zM864 665.6c0 25.6-19.2 44.8-44.8 44.8h-44.8V588.8c0-17.067-14.933-32-32-32H281.6c-17.067 0-32 14.933-32 32v121.6h-44.8c-25.6 0-44.8-19.2-44.8-44.8v-192c0-25.6 19.2-44.8 44.8-44.8h614.4c25.6 0 44.8 19.2 44.8 44.8v192z"></path></svg></button><div class="arrow end"></div></div><div class="vp-toc-wrapper"><ul class="vp-toc-list"><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level2" href="#访问日志解码请求参数">访问日志解码请求参数</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level2" href="#打印post请求的请求体信息">打印post请求的请求体信息</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level2" href="#添加或启动新模块">添加或启动新模块</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level2" href="#x-forwarded-for-和-x-real-ip">X-Forwarded-For 和 X-Real-IP</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level2" href="#ngx-http-realip-module模块">ngx_http_realip_module模块</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level2" href="#httpgeoip模块">HttpGeoIP模块</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level2" href="#post-action请求后置处理器">post_action请求后置处理器</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level2" href="#ngx-http-stub-status-module监控ngnix处理的请求数">ngx_http_stub_status_module监控ngnix处理的请求数</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level2" href="#http-random-index-module-随机页面返回">http_random_index_module 随机页面返回</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level2" href="#http-sub-module-替换响应">http_sub_module 替换响应</a></li><li><ul class="vp-toc-list"><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#语法">语法</a></li><!----><!--]--></ul></li><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level2" href="#ngx-http-limit-conn-module限制客户端连接数">ngx_http_limit_conn_module限制客户端连接数</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level2" href="#http-limit-req-module-限制请求速率">http_limit_req_module 限制请求速率</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level2" href="#http-access-module-访问控制">http_access_module 访问控制</a></li><li><ul class="vp-toc-list"><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#语法-1">语法</a></li><!----><!--]--></ul></li><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level2" href="#http-auth-basic-module-认证用户">http_auth_basic_module 认证用户</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level2" href="#secure-link-module">secure_link_module</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level2" href="#索引静态目录">索引静态目录</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level2" href="#nginx架构模型">nginx架构模型</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level2" href="#静态资源">静态资源</a></li><li><ul class="vp-toc-list"><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#sendfile">sendfile</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#tcp-nopush-和-tcp-nodelay">tcp_nopush 和 tcp_nodelay</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#gzip-压缩">gzip 压缩</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#gzip-static-module-模块">gzip_static_module 模块</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#gunzip-module-模块">gunzip_module 模块</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#缓存">缓存</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#跨站">跨站</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#防盗链">防盗链</a></li><!----><!--]--></ul></li><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level2" href="#反向代理">反向代理</a></li><li><ul class="vp-toc-list"><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#负载均衡">负载均衡</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#缓存-1">缓存</a></li><!----><!--]--></ul></li><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level2" href="#日志文件分割">日志文件分割</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level2" href="#nginx灰度测试">nginx灰度测试</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level2" href="#ngx-http-map-module">ngx_http_map_module</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level2" href="#使用nginx进行ab测试">使用nginx进行AB测试</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level2" href="#nginx请求镜像">nginx请求镜像</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level2" href="#rewrite指令">rewrite指令</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level2" href="#nginx文件上传">nginx文件上传</a></li><!----><!--]--></ul><div class="vp-toc-marker" style="top:-1.7rem;"></div></div><!--[--><!----><!--]--></aside></div><!--[--><!----><!--]--><div class="theme-hope-content"><h2 id="访问日志解码请求参数" tabindex="-1"><a class="header-anchor" href="#访问日志解码请求参数"><span>访问日志解码请求参数</span></a></h2><hr><h2 id="打印post请求的请求体信息" tabindex="-1"><a class="header-anchor" href="#打印post请求的请求体信息"><span>打印post请求的请求体信息</span></a></h2><p>默认的日志打印不包含请求体的内容,如果要打印改值,只需要在log_format中添加$request_body 即可,更多日志打印变量参考<a href="https://nginx.org/en/docs/http/ngx_http_log_module.html" target="_blank" rel="noopener noreferrer">官方文档<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></p><p>另外,即使打印出来请求体,内容不支持中文,都是经过url编码后的字符串.</p><h2 id="添加或启动新模块" tabindex="-1"><a class="header-anchor" href="#添加或启动新模块"><span>添加或启动新模块</span></a></h2><p>nginx不支持动态安装、加载模块的，所以当你安装第三方模块或者启动nginx本身的新模块功能的时候，都是覆盖nginx的；所以，一定要注意：首先查看你已经安装的nginx模块！然后安装新东西的时候，要把已安装的，再次配置。</p><p>1.查看ngnix已经安装的模块<code>./nginx -V</code></p><p>2.执行configure和make</p><div class="language-bash line-numbers-mode" data-ext="sh" data-title="sh"><pre class="language-bash"><code>./configure <span class="token parameter variable">--prefix</span><span class="token operator">=</span>/usr/local/nginx <span class="token punctuation">\</span>
 --with-http_stub_status_module <span class="token punctuation">\</span>
 --with-http_ssl_module --with-http_realip_module <span class="token punctuation">\</span>
 --with-http_image_filter_module <span class="token punctuation">\</span>
 --add-module<span class="token operator">=</span><span class="token punctuation">..</span>/ngx_pagespeed-master
<span class="token function">make</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>3.替换nginx二进制文件</p><div class="language-text line-numbers-mode" data-ext="text" data-title="text"><pre class="language-text"><code>cp /root/nginx-1.8.1/objs/nginx /usr/local/nginx/sbin/nginx
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><h2 id="x-forwarded-for-和-x-real-ip" tabindex="-1"><a class="header-anchor" href="#x-forwarded-for-和-x-real-ip"><span>X-Forwarded-For 和 X-Real-IP</span></a></h2><p>X-Forwarded-For:被代理服务器使用,用来记录经过的代理服务信息. X-Real-IP:被代理服务器使用,用来记录客户端的真实IP地址.</p><p>举例: 现在有ngnix代理服务器A和B,请求先请过A[10.187.144.41],然后B[10.187.112.151],最后到达服务器[10.176.175.149]处理该请求.</p><p>A的ngnix配置</p><div class="language-bash line-numbers-mode" data-ext="sh" data-title="sh"><pre class="language-bash"><code>proxy_set_header X-Forwarded-For <span class="token variable">$proxy_add_x_forwarded_for</span><span class="token punctuation">;</span>
proxy_set_header X-Real-IP <span class="token variable">$remote_addr</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p>B的ngnix配置</p><div class="language-plain line-numbers-mode" data-ext="plain" data-title="plain"><pre class="language-plain"><code>proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>服务器的响应</p><div class="language-plain line-numbers-mode" data-ext="plain" data-title="plain"><pre class="language-plain"><code>x-forwarded-for:114.141.166.125, 10.187.144.41
host:10.176.175.149:8080
connection:close
x-real-ip:114.141.166.125
getRemoteAddr:10.187.112.151
getRemoteHost:10.187.112.151
getServerName:10.176.175.149
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>变动1:如果B的配置也加上proxy_set_header X-Real-IP $remote_addr呢,服务器收到的请求头信息会是神马呢?</p><div class="language-plain line-numbers-mode" data-ext="plain" data-title="plain"><pre class="language-plain"><code>x-real-ip:10.187.144.41
x-forwarded-for:114.141.166.125, 10.187.144.41
host:10.176.175.149:8080
getRemoteAddr:10.187.112.151
getRemoteHost:10.187.112.151
getServerName:10.176.175.149
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>需要注意的是x-forwarded-for并没有把最后一个代理添加上去</p><p>我们看到x-real-ip的地址发生改变,不再是真实的客户端ip,而是代理A的ip,说明此时的$remote_addr的值是代理A的IP,如何修改这个值为真实的IP呢? 可以使用ngx_http_realip_module模块</p><h2 id="ngx-http-realip-module模块" tabindex="-1"><a class="header-anchor" href="#ngx-http-realip-module模块"><span>ngx_http_realip_module模块</span></a></h2><p>安装请参考模块安装,A配置不变,B配置如下:</p><div class="language-plain line-numbers-mode" data-ext="plain" data-title="plain"><pre class="language-plain"><code>set_real_ip_from 10.187.144.41
real_ip_header X-Real-IP ;
proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
proxy_set_header X-Real-IP $remote_addr;
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>set_real_ip_from:指定真实IP的地址是在哪个代理机器上 real_ip_header:真实IP所在的请求头字段</p><h2 id="httpgeoip模块" tabindex="-1"><a class="header-anchor" href="#httpgeoip模块"><span>HttpGeoIP模块</span></a></h2><p>1.安装</p><div class="language-plain line-numbers-mode" data-ext="plain" data-title="plain"><pre class="language-plain"><code>#下载免费的geo_city数据库
wget http://geolite.maxmind.com/download/geoip/database/GeoLiteCity.dat.gz
#下载免费的geo_coundty数据库
wget http://geolite.maxmind.com/download/geoip/database/GeoLiteCountry/GeoIP.dat.gz
#在debian中安装libgeoip:
sudo apt-get install libgeoip-dev
#其它系统，你可以下载并编译一个源文件
wget http://geolite.maxmind.com/download/geoip/api/c/GeoIP.tar.gz
#编译
./configure --with-http_geoip_module
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>2.配置数据源</p><div class="language-plain line-numbers-mode" data-ext="plain" data-title="plain"><pre class="language-plain"><code>http {
    geoip_country  GeoIP.dat; #放在ngnix home目录下面
    geoip_city     GeoLiteCity.dat;
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>3.使用举例</p><div class="language-plain line-numbers-mode" data-ext="plain" data-title="plain"><pre class="language-plain"><code>server {
...
        location / {
            root   /home/vpsee/www;
            if ($geoip_country_code = CN) {
                root /home/vpsee/cn;
            }
            ...
        }
...
}
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>这样，当来自中国的 IP 访问网站后就自动访问到预定的 /home/vpsee/cn 页面</p><h2 id="post-action请求后置处理器" tabindex="-1"><a class="header-anchor" href="#post-action请求后置处理器"><span>post_action请求后置处理器</span></a></h2><p>该指令可以在响应完成之后跳转到另外的location上,可用于接口调用统计等.</p><div class="language-plain line-numbers-mode" data-ext="plain" data-title="plain"><pre class="language-plain"><code>server {
        listen  80;
        server_name www.a.com;
        location /aa {
                proxy_set_header Host &quot;www.a-upstream.com&quot;;
                proxy_pass http://127.0.0.1:8000;
                post_action @action;
        }
        location @action {
                proxy_set_header Host &quot;www.a-post-action.com&quot;;
                proxy_pass http://127.0.0.1:8001;
        }
}
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>上面的aa请求在发送给8000端口之后,也会发送给8001端口一份</p><h2 id="ngx-http-stub-status-module监控ngnix处理的请求数" tabindex="-1"><a class="header-anchor" href="#ngx-http-stub-status-module监控ngnix处理的请求数"><span>ngx_http_stub_status_module监控ngnix处理的请求数</span></a></h2><p>默认没有开启该模块，需要编译添加，添加之后,在文件中配置:</p><div class="language-plain line-numbers-mode" data-ext="plain" data-title="plain"><pre class="language-plain"><code>location /basic_status {
	stub_status;
}
Active connections: 291
server accepts handled requests
16630948 16630948 31070465
Reading: 6 Writing: 179 Waiting: 106
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ol><li>Active connections: 活动状态的连接数；</li><li>accepts：已经接受的客户端握手的总数；accepts和handled相等，代表链接没有丢失</li><li>handled：已经处理完成的客户端请求的总数；</li><li>requests：客户端发来的总的请求数；</li><li>Reading：处于读取客户端请求报文首部的连接的连接数；</li><li>Writing：处于向客户端发送响应报文过程中的连接数；</li><li>Waiting：开启keepalive时，处于等待客户端发出请求的空闲连接数；此时连接已经处理完请求，但是并没有关闭，等待下一次请求重用该连接（需要客户端配合才可以）。</li></ol><h2 id="http-random-index-module-随机页面返回" tabindex="-1"><a class="header-anchor" href="#http-random-index-module-随机页面返回"><span>http_random_index_module 随机页面返回</span></a></h2><p>处理以斜杠（&#39;/&#39;）结尾的请求，并从目录中随机选择一个html文件作为返回。 该模块在ngx_http_index_module模块之前进行处理。 默认情况下未构建此模块，应使用—with-http_random_index_module配置参数启用它。</p><p>语法</p><div class="language-plain line-numbers-mode" data-ext="plain" data-title="plain"><pre class="language-plain"><code>Syntax:	random_index on | off;
Default:
random_index off;
Context:	location
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>示例</p><div class="language-plain line-numbers-mode" data-ext="plain" data-title="plain"><pre class="language-plain"><code>location / {
    random_index on;
}
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="http-sub-module-替换响应" tabindex="-1"><a class="header-anchor" href="#http-sub-module-替换响应"><span>http_sub_module 替换响应</span></a></h2><p>ngx_http_sub_module模块是一个过滤器，它通过将一个指定的字符串替换为另一个指定的字符串来修改响应。 默认情况下未构建此模块，应使用—with-http_sub_module配置参数启用它。</p><h3 id="语法" tabindex="-1"><a class="header-anchor" href="#语法"><span>语法</span></a></h3><div class="language-plain line-numbers-mode" data-ext="plain" data-title="plain"><pre class="language-plain"><code>Syntax:	sub_filter string replacement;
Default:	—
Context:	http, server, location
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>设置要替换的字符串和替换字符串。 替换忽略大小写。 要替换的字符串和替换字符串可以包含变量。 可以在一个配置级别上指定多个sub_filter伪指令。 当且仅当当前级别上未定义sub_filter指令时，这些指令才从上一级继承。</p><div class="language-plain line-numbers-mode" data-ext="plain" data-title="plain"><pre class="language-plain"><code>Syntax:	sub_filter_once on | off;
Default:
sub_filter_once on;
Context:	http, server, location
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>指示替换匹配的一个还是全部。</p><div class="language-plain line-numbers-mode" data-ext="plain" data-title="plain"><pre class="language-plain"><code>Syntax:	sub_filter_last_modified on | off;
Default:
sub_filter_last_modified off;
Context:	http, server, location
This directive appeared in version 1.5.1.
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>允许在替换期间从原始响应中保留“最后修改的”标头字段，以方便响应缓存。 默认情况下，在处理期间修改响应的内容时，将删除标头字段。</p><div class="language-plain line-numbers-mode" data-ext="plain" data-title="plain"><pre class="language-plain"><code>Syntax:	sub_filter_types mime-type ...;
Default:
sub_filter_types text/html;
Context:	http, server, location
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>除了“ text / html”之外，还可以在具有指定MIME类型的响应中启用字符串替换。 特殊值“ *”与任何MIME类型（0.8.29）匹配。</p><p>示例</p><div class="language-plain line-numbers-mode" data-ext="plain" data-title="plain"><pre class="language-plain"><code>location / {
    sub_filter &#39;&lt;a href=&quot;http://127.0.0.1:8080/&#39;  &#39;&lt;a href=&quot;https://$host/&#39;;
    sub_filter &#39;&lt;img src=&quot;http://127.0.0.1:8080/&#39; &#39;&lt;img src=&quot;https://$host/&#39;;
    sub_filter_once on;
}
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="ngx-http-limit-conn-module限制客户端连接数" tabindex="-1"><a class="header-anchor" href="#ngx-http-limit-conn-module限制客户端连接数"><span>ngx_http_limit_conn_module限制客户端连接数</span></a></h2><p>ngx_http_limit_conn_module模块用于限制每个已定义key的连接数，特别是来自单个IP地址的连接数.但是，并非所有连接都被计算在内 ，只有在服务器处理了请求并且整个请求头已经被读取的情况下才计算连接。</p><div class="language-plain line-numbers-mode" data-ext="plain" data-title="plain"><pre class="language-plain"><code>Syntax:	limit_conn_zone key zone=name:size;
Default:	—
Context:	http
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>定义内存区域存储客户端的信息，例如指定key的当前连接数， key可以包含文本，变量及其组合。 key值为空的请求不予考虑。下面是一个示例：</p><div class="language-plain line-numbers-mode" data-ext="plain" data-title="plain"><pre class="language-plain"><code>limit_conn_zone $binary_remote_addr zone=addr:10m;
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>客户端IP作为key值，为什么不使用$remote_addr呢？</p><ul><li>$remote_addr大小为7~15byte。</li><li>$binary_remote_addr相对IPV4始终是4个字节，IPV6是16字节。</li><li>1M的区域可以保留大约3.2万个32字节状态或大约1.6万个64字节状态。 如果区域存储空间已用完，服务器将把错误返回给所有其他请求。</li></ul><div class="language-plain line-numbers-mode" data-ext="plain" data-title="plain"><pre class="language-plain"><code>Syntax:	limit_conn zone number;
Default:	—
Context:	http, server, location
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>设置共享内存区域和最大允许连接数。 当超过此限制时，服务器将返回错误以回复请求。 例如</p><div class="language-plain line-numbers-mode" data-ext="plain" data-title="plain"><pre class="language-plain"><code>limit_conn_zone $binary_remote_addr zone=addr:10m;
server {
    location /download/ {
        limit_conn addr 1;
    }
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>同一时间只允许客户段IP有一个连接。</p><p>可能有几个limit_conn指令。 例如，以下配置将限制每个客户端IP与服务器的连接数，并同时限制与虚拟服务器的连接总数：</p><div class="language-plain line-numbers-mode" data-ext="plain" data-title="plain"><pre class="language-plain"><code>limit_conn_zone $binary_remote_addr zone=perip:10m;
limit_conn_zone $server_name zone=perserver:10m;
server {
    ...
    limit_conn perip 10;
    limit_conn perserver 100;
}
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>当且仅当当前级别上没有limit_conn指令时，这些指令才从上一级继承。</p><div class="language-plain line-numbers-mode" data-ext="plain" data-title="plain"><pre class="language-plain"><code>Syntax:	limit_conn_status code;
Default:
limit_conn_status 503;
Context:	http, server, location
This directive appeared in version 1.3.15.
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>连接被拒绝后，nginx的响应状态码。</p><div class="language-plain line-numbers-mode" data-ext="plain" data-title="plain"><pre class="language-plain"><code>Syntax:	limit_conn_log_level info | notice | warn | error;
Default:
limit_conn_log_level error;
Context:	http, server, location
This directive appeared in version 0.8.18.
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>连接被拒绝后，记录该请求的日志级别</p><div class="language-plain line-numbers-mode" data-ext="plain" data-title="plain"><pre class="language-plain"><code>Syntax:	limit_conn_dry_run on | off;
Default:
limit_conn_dry_run off;
Context:	http, server, location
This directive appeared in version 1.17.6.
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>启用空运行模式。 在这种模式下，连接数不受限制，但是，在共享内存区域中，过多连接的数将照常计算。</p><h2 id="http-limit-req-module-限制请求速率" tabindex="-1"><a class="header-anchor" href="#http-limit-req-module-限制请求速率"><span>http_limit_req_module 限制请求速率</span></a></h2><p>ngx_http_limit_req_module模块用于限制请求处理速率，特别是来自单个IP地址的请求的处理速率。 使用“漏斗”方法完成限制。</p><div class="language-plain line-numbers-mode" data-ext="plain" data-title="plain"><pre class="language-plain"><code>Syntax:	limit_req_zone key zone=name:size rate=rate [sync];
Default:	—
Context:	http
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>定义内存区域存储客户端的信息，例如指定key的当前请求数， key可以包含文本，变量及其组合。 key值为空的请求不予考虑。下面是一个示例：</p><div class="language-plain line-numbers-mode" data-ext="plain" data-title="plain"><pre class="language-plain"><code>limit_req_zone $binary_remote_addr zone=one:10m rate=1r/s;
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>请求速率是每秒一个。</p><div class="language-plain line-numbers-mode" data-ext="plain" data-title="plain"><pre class="language-plain"><code>Syntax:	limit_req zone=name [burst=number] [nodelay | delay=number];
Default:	—
Context:	http, server, location
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>设置共享内存区域和请求的最大突发大小。 如果请求速率超过为区域配置的速率，则会延迟其处理，以便以定义的速率处理请求。 过多的请求将被延迟，直到其数量超过最大突发大小为止，在这种情况下，该请求将因错误而终止。 默认情况下，最大突发大小等于零。 例如，指令</p><div class="language-plain line-numbers-mode" data-ext="plain" data-title="plain"><pre class="language-plain"><code>limit_req_zone $binary_remote_addr zone=one:10m rate=1r/s;
server {
    location /search/ {
        limit_req zone=one burst=5;
    }
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>平均每秒最多允许不超过1个请求，并且突发不超过5个请求。</p><p>如果不需要在限制请求时延迟过多的请求，则应使用参数nodelay：</p><div class="language-plain line-numbers-mode" data-ext="plain" data-title="plain"><pre class="language-plain"><code>limit_req zone=one burst=5 nodelay;
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>delay参数指定一个限制，在该限制下，过多的请求将被延迟。 默认值为零，即所有多余的请求都会延迟。</p><p>可能有几个limit_req指令。 例如，以下配置将限制来自单个IP地址的请求的处理速度，同时限制虚拟服务器的请求处理速度：</p><div class="language-plain line-numbers-mode" data-ext="plain" data-title="plain"><pre class="language-plain"><code>limit_req_zone $binary_remote_addr zone=perip:10m rate=1r/s;
limit_req_zone $server_name zone=perserver:10m rate=10r/s;
server {
    ...
    limit_req zone=perip burst=5 nodelay;
    limit_req zone=perserver burst=10;
}
Syntax:	limit_req_status code;
Default:
limit_req_status 503;
Context:	http, server, location
This directive appeared in version 1.3.15.
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>请求被拒绝后，nginx的响应状态码。</p><div class="language-plain line-numbers-mode" data-ext="plain" data-title="plain"><pre class="language-plain"><code>Syntax:	limit_req_log_level info | notice | warn | error;
Default:
limit_req_log_level error;
Context:	http, server, location
This directive appeared in version 0.8.18.
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>请求被拒绝后，记录该请求的日志级别</p><div class="language-plain line-numbers-mode" data-ext="plain" data-title="plain"><pre class="language-plain"><code>Syntax:	limit_req_dry_run on | off;
Default:
limit_req_dry_run off;
Context:	http, server, location
This directive appeared in version 1.17.1.
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>启用空运行模式。 在这种模式下，请求数不受限制，但是，在共享内存区域中，过多请求的数将照常计算。</p><h2 id="http-access-module-访问控制" tabindex="-1"><a class="header-anchor" href="#http-access-module-访问控制"><span>http_access_module 访问控制</span></a></h2><p>ngx_http_access_module模块允许限制对某些客户端地址的访问。</p><h3 id="语法-1" tabindex="-1"><a class="header-anchor" href="#语法-1"><span>语法</span></a></h3><div class="language-plain line-numbers-mode" data-ext="plain" data-title="plain"><pre class="language-plain"><code>Syntax:	allow address | CIDR | unix: | all;
Default:	—
Context:	http, server, location, limit_except
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><code>允许访问</code> 指定的网络或地址。 如果指定特殊值unix：，则允许访问所有UNIX域套接字。</p><div class="language-plain line-numbers-mode" data-ext="plain" data-title="plain"><pre class="language-plain"><code>Syntax:	deny address | CIDR | unix: | all;
Default:	—
Context:	http, server, location, limit_except
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><code>拒绝访问</code> 指定的网络或地址。 如果指定了特殊值unix：，则拒绝所有UNIX域套接字的访问。</p><p>示例</p><div class="language-plain line-numbers-mode" data-ext="plain" data-title="plain"><pre class="language-plain"><code>location / {
    deny  192.168.1.1;
    allow 192.168.1.0/24;
    allow 10.1.1.0/16;
    allow 2001:0db8::/32;
    deny  all;
}
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>依次检查规则，直到找到第一个匹配项。 在此示例中，仅对IPv4网络 <code>10.1.1.0/16</code> 和 <code>192.168.1.0/24</code>（地址192.168.1.1除外）和IPv6网络 <code>2001:0db8::/32</code> 允许访问。 在有很多规则的情况下，最好使用ngx_http_geo_module模块变量。</p><table><thead><tr><th></th><th>该模块存在一定的局限性，如果应用经过一层代理，则真实IP不可达，需要我们在代理上配置一定规则将真是的IP传递</th></tr></thead><tbody><tr><td></td><td></td></tr></tbody></table><h2 id="http-auth-basic-module-认证用户" tabindex="-1"><a class="header-anchor" href="#http-auth-basic-module-认证用户"><span>http_auth_basic_module 认证用户</span></a></h2><p>ngx_http_auth_basic_module模块允许通过使用“ HTTP基本身份验证”协议验证用户名和密码来限制对资源的访问。</p><div class="language-plain line-numbers-mode" data-ext="plain" data-title="plain"><pre class="language-plain"><code>Syntax:	auth_basic string | off;
Default:
auth_basic off;
Context:	http, server, location, limit_except
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>使用“ HTTP基本认证”协议启用用户名和密码的验证。 指定的参数用作realm。 参数值可以包含变量。 特殊值off允许取消从先前配置级别继承的auth_basic指令的效果。</p><div class="language-plain line-numbers-mode" data-ext="plain" data-title="plain"><pre class="language-plain"><code>Syntax:	auth_basic_user_file file;
Default:	—
Context:	http, server, location, limit_except
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>以以下格式指定保存用户名和密码的文件：</p><div class="language-plain line-numbers-mode" data-ext="plain" data-title="plain"><pre class="language-plain"><code># comment
name1:password1
name2:password2:comment
name3:password3
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>file名称可以包含变量。 支持一下密码类型：</p><ul><li>用crypt（）函数加密； 可以使用Apache HTTP Server发行版中的“ htpasswd”实用程序或“ openssl passwd”命令生成。</li><li>使用基于MD5的密码算法（apr1）的Apache变体进行哈希处理； 可以使用相同的工具生成；</li><li>由RFC 2307中所述的“ {scheme} data”语法（1.0.3+）指定； 当前实施的方案包括一些软件包使用的PLAIN（不应该使用示例1），SHA（1.3.13）（不应该使用普通SHA-1哈希）和SSHA（盐化的SHA-1哈希）。 OpenLDAP和Dovecot）。</li></ul><p>示例</p><div class="language-plain line-numbers-mode" data-ext="plain" data-title="plain"><pre class="language-plain"><code>location / {
    auth_basic           &quot;closed site&quot;;
    auth_basic_user_file conf/htpasswd;
}
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><table><thead><tr><th></th><th>由于密码认证是通过本地文件，所以速度慢，且不好管理。可以使用Lua脚本来做。</th></tr></thead><tbody><tr><td></td><td></td></tr></tbody></table><h2 id="secure-link-module" tabindex="-1"><a class="header-anchor" href="#secure-link-module"><span>secure_link_module</span></a></h2><h2 id="索引静态目录" tabindex="-1"><a class="header-anchor" href="#索引静态目录"><span>索引静态目录</span></a></h2><div class="language-plain line-numbers-mode" data-ext="plain" data-title="plain"><pre class="language-plain"><code>location  /  { #不能是其他路径
  autoindex  on;
}
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="nginx架构模型" tabindex="-1"><a class="header-anchor" href="#nginx架构模型"><span>nginx架构模型</span></a></h2><p>epoll模型 worker_processes 配置 use 配置 connection 配置</p><p>format日志变量</p><h2 id="静态资源" tabindex="-1"><a class="header-anchor" href="#静态资源"><span>静态资源</span></a></h2><h3 id="sendfile" tabindex="-1"><a class="header-anchor" href="#sendfile"><span>sendfile</span></a></h3><p>指定是否使用sendfile系统调用来传输文件。 sendfile系统调用在两个文件描述符之间直接传递数据(完全在内核中操作)，从而避免了数据在内核缓冲区和用户缓冲区之间的拷贝，操作效率很高，被称之为零拷贝</p><h3 id="tcp-nopush-和-tcp-nodelay" tabindex="-1"><a class="header-anchor" href="#tcp-nopush-和-tcp-nodelay"><span><code>tcp_nopush</code> 和 <code>tcp_nodelay</code></span></a></h3><h3 id="gzip-压缩" tabindex="-1"><a class="header-anchor" href="#gzip-压缩"><span>gzip 压缩</span></a></h3><div class="language-plain line-numbers-mode" data-ext="plain" data-title="plain"><pre class="language-plain"><code>Syntax:	gzip on | off;
Default:
gzip off;
Context:	http, server, location, if in location
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>是否开启gzip压缩</p><div class="language-plain line-numbers-mode" data-ext="plain" data-title="plain"><pre class="language-plain"><code>Syntax:	gzip_buffers number size;
Default:
gzip_buffers 32 4k|16 8k;
Context:	http, server, location
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>设置用于压缩响应的缓冲区的数量和大小。 默认情况下，缓冲区大小等于一个内存页。 根据平台的不同，它可以是4K或8K。建议此项不设置，使用默认值。</p><div class="language-plain line-numbers-mode" data-ext="plain" data-title="plain"><pre class="language-plain"><code>Syntax:	gzip_comp_level level;
Default:
gzip_comp_level 1;
Context:	http, server, location
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>设置压缩比率，最小为1；9为最大压缩比; 压缩比越大，压缩后的文件越小，但是压缩过程比较慢，消耗CPU</p><div class="language-plain line-numbers-mode" data-ext="plain" data-title="plain"><pre class="language-plain"><code>Syntax:	gzip_disable regex ...;
Default:	—
Context:	http, server, location
This directive appeared in version 0.6.23.
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>如果“User-Agent”头字段内容匹配任何指定的正则表达式，则禁用gzip。</p><div class="language-plain line-numbers-mode" data-ext="plain" data-title="plain"><pre class="language-plain"><code>Syntax:	gzip_http_version 1.0 | 1.1;
Default:
gzip_http_version 1.1;
Context:	http, server, location
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>设置压缩响应所需的最低HTTP请求版本。</p><div class="language-plain line-numbers-mode" data-ext="plain" data-title="plain"><pre class="language-plain"><code>Syntax:	gzip_min_length length;
Default:
gzip_min_length 20;
Context:	http, server, location
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>超过该长度的响应会被压缩。 长度仅由“ Content-Length”响应头字段确定。</p><div class="language-plain line-numbers-mode" data-ext="plain" data-title="plain"><pre class="language-plain"><code>Syntax:	gzip_proxied off | expired | no-cache | no-store | private | no_last_modified | no_etag | auth | any ...;
Default:
gzip_proxied off;
Context:	http, server, location
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>根据请求或响应，决定反向代理是否对返回结果进行gzip压缩。是否进行gzip压缩是通过是否存在可变的请求头来决定的。该指令可以接受多个值。</p><ul><li>off:禁用压缩</li><li>expired：如果响应头中包含“ Expires”字段且其值禁用了缓存，则启用压缩；</li><li>no-cache：如果响应头包含带有“Cache-Control: no-cache”字段，则启用压缩；</li><li>no-store: 如果响应头包含带有“Cache-Control: no-store”字段，则启用压缩；</li><li>private: 如果响应头包含带有“Cache-Control: private”字段，则启用压缩；</li><li>no_last_modified: 如果响应头不包含“ Last-Modified”字段，则启用压缩；</li><li>no_etag: 如果响应头不包含“ ETag”字段，则启用压缩；</li><li>auth: 如果请求标头包含“ Authorization”字段，则启用压缩；</li><li>any: 为所有代理请求启用压缩。</li></ul><div class="language-plain line-numbers-mode" data-ext="plain" data-title="plain"><pre class="language-plain"><code>Syntax:	gzip_types mime-type ...;
Default:
gzip_types text/html;
Context:	http, server, location
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>除了“text/html”之外，还对指定的MIME类型启用gzipping响应。 特殊值“*”与任何MIME类型匹配。 始终会压缩“text/html”类型的响应。</p><div class="language-plain line-numbers-mode" data-ext="plain" data-title="plain"><pre class="language-plain"><code>Syntax:	gzip_vary on | off;
Default:
gzip_vary off;
Context:	http, server, location
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>如果指令gzip，gzip_static或gunzip处于活动状态，则启用或禁用插入“Vary：Accept-Encoding”响应标头字段。</p><h3 id="gzip-static-module-模块" tabindex="-1"><a class="header-anchor" href="#gzip-static-module-模块"><span>gzip_static_module 模块</span></a></h3><p>ngx_http_gzip_static_module模块允许优先发送扩展名为“.gz”的预压缩文件。简单来说，nginx会先查找相同目录下，是否存在该文件以“.gz”结尾的压缩文件，存在则返回，不存在则使用原文件。默认情况下未构建此模块，应使用—with-http_gzip_static_module配置参数启用它。</p><div class="language-plain line-numbers-mode" data-ext="plain" data-title="plain"><pre class="language-plain"><code>Syntax:	gzip_static on | off | always;
Default:
gzip_static off;
Context:	http, server, location
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>启用（“ on”）或禁用（“ off”）检查是否存在预压缩文件。 还考虑了以下指令：gzip_http_version，gzip_proxied，gzip_disable和gzip_vary。</p><p>使用“always”值，在所有情况下都使用压缩文件，而无需检查客户端是否支持它。</p><p>可以使用gzip命令或任何其他兼容的命令压缩文件。 建议原始文件和压缩文件的修改日期和时间相同。</p><h3 id="gunzip-module-模块" tabindex="-1"><a class="header-anchor" href="#gunzip-module-模块"><span>gunzip_module 模块</span></a></h3><p>ngx_http_gunzip_module模块是一个过滤器，用于对不支持“gzip”编码方法的客户端使用“ Content-Encoding：gzip”解压缩后返回响应。 现在的客户端基本都支持，该模块用途很小。</p><h3 id="缓存" tabindex="-1"><a class="header-anchor" href="#缓存"><span>缓存</span></a></h3><div class="language-plain line-numbers-mode" data-ext="plain" data-title="plain"><pre class="language-plain"><code>Syntax:    expires [modified]  time；
           expires epoch|max|off；
Default:   expires off；                 # 静态缓存
Context:   http，server，location，if in location
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>指定过期时间。会在响应头中添加“Expires”（http1.0之前的）和“Cache-Control”（http1.1之后）</p><p>time的值是负值，“Cache-Control: no-cache” time的值是正值t: <code>Cache-Control: max-age=t</code></p><p>“Expires”字段中的时间计算为当前时间与指令中指定的时间之和。</p><ul><li>epoch参数将“ Expires”设置为值“ Thu，1970年1月1日00:00:01 GMT”，将“ Cache-Control”设置为“ no-cache”。</li><li>max参数将“ Expires”设置为值“ Thu，2037年12月31日23:55:55 GMT”，将“ Cache-Control”设置为10年。</li><li>off参数禁用添加或修改“ Expires”和“ Cache-Control”响应头字段。</li></ul><h3 id="跨站" tabindex="-1"><a class="header-anchor" href="#跨站"><span>跨站</span></a></h3><div class="language-plain line-numbers-mode" data-ext="plain" data-title="plain"><pre class="language-plain"><code>add_header Access-Control-Allow-Origin *;
    add_header Access-Control-Allow-Headers X-Requested-With;
    add_header Access-Control-Allow-Methods GET,POST,OPTIONS;
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="防盗链" tabindex="-1"><a class="header-anchor" href="#防盗链"><span>防盗链</span></a></h3><div class="language-plain line-numbers-mode" data-ext="plain" data-title="plain"><pre class="language-plain"><code>Syntax:	valid_referers none | blocked | server_names | string ...;
Default:	—
Context:	server, location
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>匹配请求头中的“Referer”，匹配则 <code>$valid_referers</code> 的值为空，否则为1.</p><ul><li>none:请求标头中缺少“ Referer”字段；</li><li>blocked: 请求标头中存在“ Referer”字段，但其值已被防火墙或代理服务器删除； 这些值是不以“ http：//”或“ https：//”开头的字符串；</li><li>server_names: “ Referer”请求标头字段包含任一服务器名称；</li><li>任意字符串：定义服务器名称和可选的URI前缀。 服务器名称的开头或结尾可以带有“ *”。 在检查过程中，“ Referer”字段中的服务器端口将被忽略；</li><li>正则：第一个符号应为“〜”。 应当注意，表达式将与“ http：//”或“ https：//”之后的文本匹配。</li></ul><p>示例：</p><div class="language-bash line-numbers-mode" data-ext="sh" data-title="sh"><pre class="language-bash"><code>valid_referers none blocked *.source.com source.com<span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$invalid_referer</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
     <span class="token builtin class-name">return</span> <span class="token number">403</span> <span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="反向代理" tabindex="-1"><a class="header-anchor" href="#反向代理"><span>反向代理</span></a></h2><h3 id="负载均衡" tabindex="-1"><a class="header-anchor" href="#负载均衡"><span>负载均衡</span></a></h3><h3 id="缓存-1" tabindex="-1"><a class="header-anchor" href="#缓存-1"><span>缓存</span></a></h3><h2 id="日志文件分割" tabindex="-1"><a class="header-anchor" href="#日志文件分割"><span>日志文件分割</span></a></h2><p>默认情况下,nginx的日志文件不支持按天或者按大小切分,这对我们排查错误非常不便.这里提供一种在配置文件中分割日志文件的方式(此外还有cron定时切分日志文件的方式):</p><div class="language-bash line-numbers-mode" data-ext="sh" data-title="sh"><pre class="language-bash"><code><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$time_iso8601</span> ~ <span class="token string">&quot;^(\d{4})-(\d{2})-(\d{2})&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token builtin class-name">set</span> <span class="token variable">$year</span> <span class="token variable">$1</span><span class="token punctuation">;</span>
    <span class="token builtin class-name">set</span> <span class="token variable">$month</span> <span class="token variable">$2</span><span class="token punctuation">;</span>
    <span class="token builtin class-name">set</span> <span class="token variable">$day</span> <span class="token variable">$3</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
access_log /usr/local/nginx/logs/www.ttlsa.com-<span class="token variable">$year</span>-<span class="token variable">$month</span>-<span class="token variable">$day</span>-access.log<span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>此外需要注意的是,默认情况下,ngnix的权限用户并不是root,那么将无法生成日志文件,所有需要指定user为root.例如:</p><figure><img src="/assets/1621836593350-ebb8bad7-d0bd-4c07-9f92-ab7faa8603ad-DICp0v5q.png" alt="img" tabindex="0" loading="lazy"><figcaption>img</figcaption></figure><h2 id="nginx灰度测试" tabindex="-1"><a class="header-anchor" href="#nginx灰度测试"><span>nginx灰度测试</span></a></h2><p>灰度发布是指在黑与白之间，能够平滑过渡的一种发布方式。AB test就是一种灰度发布方式，让一部分用户继续用A，一部分用户开始用B，如果用户对B没有什么反对意见，那么逐步扩大范围，把所有用户都迁移到B上面来。</p><p>灰度发布常见一般有三种方式:</p><ul><li>Nginx+LUA方式</li><li>根据Cookie实现灰度发布</li><li>根据来路IP实现灰度发布</li></ul><p>本文主要将讲解根据Cookie和来路IP这两种方式实现简单的灰度发布。这两种的实现原理是相同的,这里只介绍一种即可：</p><div class="language-bash line-numbers-mode" data-ext="sh" data-title="sh"><pre class="language-bash"><code>upstream hilinux_01 <span class="token punctuation">{</span>
    server <span class="token number">192.168</span>.1.100:8080 <span class="token assign-left variable">max_fails</span><span class="token operator">=</span><span class="token number">1</span> <span class="token assign-left variable">fail_timeout</span><span class="token operator">=</span><span class="token number">60</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

upstream hilinux_02 <span class="token punctuation">{</span>
    server <span class="token number">192.168</span>.1.200:8080 <span class="token assign-left variable">max_fails</span><span class="token operator">=</span><span class="token number">1</span> <span class="token assign-left variable">fail_timeout</span><span class="token operator">=</span><span class="token number">60</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

upstream default <span class="token punctuation">{</span>
    server <span class="token number">192.168</span>.1.100:8080 <span class="token assign-left variable">max_fails</span><span class="token operator">=</span><span class="token number">1</span> <span class="token assign-left variable">fail_timeout</span><span class="token operator">=</span><span class="token number">60</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

server <span class="token punctuation">{</span>
    listen <span class="token number">80</span><span class="token punctuation">;</span>
    server_name  www.hi-linux.com<span class="token punctuation">;</span>
    access_log  logs/www.hi-linux.com.log  main<span class="token punctuation">;</span>

    <span class="token comment">#match cookie</span>
    <span class="token builtin class-name">set</span> <span class="token variable">$group</span> <span class="token string">&quot;default&quot;</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$http_cookie</span> ~* <span class="token string">&quot;version=V1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
          <span class="token builtin class-name">set</span> <span class="token variable">$group</span> hilinux_01<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$http_cookie</span> ~* <span class="token string">&quot;version=V2&quot;</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
          <span class="token builtin class-name">set</span> <span class="token variable">$group</span> hilinux_02<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    location / <span class="token punctuation">{</span>                       
      proxy_pass http://<span class="token variable">$group</span><span class="token punctuation">;</span>
      proxy_set_header   Host             <span class="token variable">$host</span><span class="token punctuation">;</span>
      proxy_set_header   X-Real-IP        <span class="token variable">$remote_addr</span><span class="token punctuation">;</span>
      proxy_set_header   X-Forwarded-For  <span class="token variable">$proxy_add_x_forwarded_for</span><span class="token punctuation">;</span>
      index  index.html index.htm<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
 <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="ngx-http-map-module" tabindex="-1"><a class="header-anchor" href="#ngx-http-map-module"><span>ngx_http_map_module</span></a></h2><p>默认情况下安装 nginx 都会安装该模块。</p><p>map 的主要作用是创建自定义变量，通过使用 nginx 的内置变量，去匹配某些特定规则，如果匹配成功则设置某个值给自定义变量。 而这个自定义变量又可以作于他用。</p><p>直接看个例子理解起来比较清晰：</p><p>场景： 匹配请求 url 的参数，如果参数是 debug 则设置 $foo = 1 ，默认设置 $foo = 0</p><div class="language-bash line-numbers-mode" data-ext="sh" data-title="sh"><pre class="language-bash"><code>map <span class="token variable">$args</span> <span class="token variable">$foo</span> <span class="token punctuation">{</span>
    default <span class="token number">0</span><span class="token punctuation">;</span>
    debug <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>$args 是nginx内置变量，就是获取的请求 url 的参数。 如果 $args 匹配到 debug 那么 $foo 的值会被设为 1 ，如果 $args 一个都匹配不到 $foo 就是default 定义的值，在这里就是 0.</p><p>使用map也可以用作灰度测试：</p><div class="language-bash line-numbers-mode" data-ext="sh" data-title="sh"><pre class="language-bash"><code>upstream hilinux_01 <span class="token punctuation">{</span>
    server <span class="token number">192.168</span>.1.100:8080 <span class="token assign-left variable">max_fails</span><span class="token operator">=</span><span class="token number">1</span> <span class="token assign-left variable">fail_timeout</span><span class="token operator">=</span><span class="token number">60</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

upstream hilinux_02 <span class="token punctuation">{</span>
    server <span class="token number">192.168</span>.1.200:8080 <span class="token assign-left variable">max_fails</span><span class="token operator">=</span><span class="token number">1</span> <span class="token assign-left variable">fail_timeout</span><span class="token operator">=</span><span class="token number">60</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

upstream default <span class="token punctuation">{</span>
    server <span class="token number">192.168</span>.1.100:8080 <span class="token assign-left variable">max_fails</span><span class="token operator">=</span><span class="token number">1</span> <span class="token assign-left variable">fail_timeout</span><span class="token operator">=</span><span class="token number">60</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

map <span class="token variable">$COOKIE_version</span> <span class="token variable">$group</span> <span class="token punctuation">{</span>
    ~*V1$ hilinux_01<span class="token punctuation">;</span>
    ~*V2$ hilinux_02<span class="token punctuation">;</span>
    default default<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

server <span class="token punctuation">{</span>
  listen <span class="token number">80</span><span class="token punctuation">;</span>
  server_name  www.hi-linux.com<span class="token punctuation">;</span>
  access_log  logs/www.hi-linux.com.log  main<span class="token punctuation">;</span>

  location / <span class="token punctuation">{</span>                       
    proxy_pass http://<span class="token variable">$group</span><span class="token punctuation">;</span>
    proxy_set_header   Host             <span class="token variable">$host</span><span class="token punctuation">;</span>
    proxy_set_header   X-Real-IP        <span class="token variable">$remote_addr</span><span class="token punctuation">;</span>
    proxy_set_header   X-Forwarded-For <span class="token variable">$proxy_add_x_forwarded_for</span><span class="token punctuation">;</span>
    index  index.html index.htm<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
 <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="使用nginx进行ab测试" tabindex="-1"><a class="header-anchor" href="#使用nginx进行ab测试"><span>使用nginx进行AB测试</span></a></h2><p>根据请求的路径来选择路由的首页:</p><div class="language-bash line-numbers-mode" data-ext="sh" data-title="sh"><pre class="language-bash"><code>http <span class="token punctuation">{</span>
    split_clients <span class="token string">&quot;<span class="token variable">${remote_addr}</span>AAA&quot;</span> <span class="token variable">$variant</span> <span class="token punctuation">{</span>
                   <span class="token number">0.5</span>%               .one<span class="token punctuation">;</span>
                   <span class="token number">2.0</span>%               .two<span class="token punctuation">;</span>
                   *                  <span class="token string">&quot;&quot;</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    server <span class="token punctuation">{</span>
        location / <span class="token punctuation">{</span>
            index index<span class="token variable">${variant}</span>.html<span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>原始字符串的值使用MurmurHash2散列。 在给出的例子中，从0到21474835（0.5％）的散列值对应于$ variant变量的值“.one”，从21474836到107374180（2％）的散列值对应于值“.two”，散列值 从107374181到4294967295的值对应于值“”（一个空字符串）。</p><h2 id="nginx请求镜像" tabindex="-1"><a class="header-anchor" href="#nginx请求镜像"><span>nginx请求镜像</span></a></h2><p>请求镜像就是nginx在接受到客户端请求进行反向代理的时候分别代理到原地址和镜像地址一次。镜像地址的返回结果不会返回到客户端。看下图：</p><figure><img src="/assets/1621837474856-935013b5-75a3-4f44-a1e0-3afc104ee9d1-B-aGhfk3.png" alt="img" tabindex="0" loading="lazy"><figcaption>img</figcaption></figure><p>利用这一功能我们就可以将线上实时访问流量拷贝至其它环境，基于这些流量可以做版本发布前的预先验证或者进行流量放大后的压测等等。</p><p>mirror模块配置分为两部分，源地址和镜像地址配置，配置位置可以为nginx配置文件的http, server, location上下文，配置示例为：</p><div class="language-bash line-numbers-mode" data-ext="sh" data-title="sh"><pre class="language-bash"><code>location /user <span class="token punctuation">{</span>
         mirror /mirror <span class="token punctuation">;</span>
         mirror_request_body off<span class="token punctuation">;</span>
         proxy_pass http://localhost:8080 <span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
location /mirror <span class="token punctuation">{</span>
       internal<span class="token punctuation">;</span>
       proxy_pass http://127.0.0.1:8081<span class="token variable">$request_uri</span><span class="token punctuation">;</span>
       proxy_set_header X-Original-URI <span class="token variable">$request_uri</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1.original配置</p><ul><li>location /指定了源uri为/</li><li>mirror /mirror指定镜像uri为/mirror</li><li>mirror_request_body off | on 指定是否镜像请求body部分，此选项与proxy_request_buffering、fastcgi_request_buffering、scgi_request_buffering和 uwsgi_request_buffering冲突，一旦开启mirror_request_body为on，则请求自动缓存;</li></ul><p>2.mirror配置</p><ul><li>internal 指定此location只能被“内部的”请求调用，外部的调用请求会返回”Not found” (404)</li><li>proxy_pass 指定上游server的地址</li><li>proxy_set_header 设置镜像流量的头部</li></ul><h2 id="rewrite指令" tabindex="-1"><a class="header-anchor" href="#rewrite指令"><span>rewrite指令</span></a></h2><ul><li>last： url重写后，马上发起一个新的请求，再次进入server块，重试location匹配，超过10次匹配不到报500错误，地址栏url不变</li><li>break: url重写后，直接使用当前资源，执行location里余下的语句，完成本次请求(不会再次进入server块)，地址栏url不变</li><li>redirect ： 返回302临时重定向，地址栏显示重定向后的url，爬虫不会更新url（因为是临时）</li><li>permanent ： 返回301永久重定向, 地址栏显示重定向后的url，爬虫更新url</li></ul><p>nginx 的 rewrite log 是记录在 error log 文件中，而不是access log中。</p><p>nginx 开启 rewrite 日志的方法(在server段中添加）:首先，打开 error_log 日志：</p><div class="language-bash line-numbers-mode" data-ext="sh" data-title="sh"><pre class="language-bash"><code>error_log logs/error.log notice<span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>然后打开 rewrite_log 开关:</p><div class="language-bash line-numbers-mode" data-ext="sh" data-title="sh"><pre class="language-bash"><code>rewrite_log on<span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><h2 id="nginx文件上传" tabindex="-1"><a class="header-anchor" href="#nginx文件上传"><span>nginx文件上传</span></a></h2></div><!--[--><!----><!--]--><footer class="vp-page-meta"><div class="vp-meta-item edit-link"><a href="https://github.com/banrenshan/banrenshan.github.io/edit/main/src/post/nginx.md" rel="noopener noreferrer" target="_blank" aria-label="在 GitHub 上编辑此页" class="nav-link vp-meta-label"><!--[--><svg xmlns="http://www.w3.org/2000/svg" class="icon edit-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="edit icon"><path d="M430.818 653.65a60.46 60.46 0 0 1-50.96-93.281l71.69-114.012 7.773-10.365L816.038 80.138A60.46 60.46 0 0 1 859.225 62a60.46 60.46 0 0 1 43.186 18.138l43.186 43.186a60.46 60.46 0 0 1 0 86.373L588.879 565.55l-8.637 8.637-117.466 68.234a60.46 60.46 0 0 1-31.958 11.229z"></path><path d="M728.802 962H252.891A190.883 190.883 0 0 1 62.008 771.98V296.934a190.883 190.883 0 0 1 190.883-192.61h267.754a60.46 60.46 0 0 1 0 120.92H252.891a69.962 69.962 0 0 0-69.098 69.099V771.98a69.962 69.962 0 0 0 69.098 69.098h475.911A69.962 69.962 0 0 0 797.9 771.98V503.363a60.46 60.46 0 1 1 120.922 0V771.98A190.883 190.883 0 0 1 728.802 962z"></path></svg><!--]-->在 GitHub 上编辑此页<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span><!----></a></div><div class="vp-meta-item git-info"><div class="update-time"><span class="vp-meta-label">上次编辑于: </span><!----></div><div class="contributors"><span class="vp-meta-label">贡献者: </span><!--[--><!--[--><span class="vp-meta-info" title="email: CP_zhaozhiqiang@163.com">banrenshan</span><!--]--><!--]--></div></div></footer><nav class="vp-page-nav"><a class="route-link nav-link prev" href="/post/loki.html" aria-label="loki"><div class="hint"><span class="arrow start"></span>上一页</div><div class="link"><!---->loki</div></a><a class="route-link nav-link next" href="/post/Resilience4j.html" aria-label="Resilience4j"><div class="hint">下一页<span class="arrow end"></span></div><div class="link">Resilience4j<!----></div></a></nav><!----><!--[--><!----><!--]--><!--]--></main><!--]--><!----></div><!--]--><!--]--><!--[--><!----><!--]--><!--]--></div>
    <script type="module" src="/assets/app-7RQdUJPT.js" defer></script>
  </body>
</html>
