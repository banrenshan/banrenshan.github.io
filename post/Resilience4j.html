<!doctype html>
<html lang="zh-CN" data-theme="light">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <meta name="generator" content="VuePress 2.0.0-rc.9" />
    <meta name="theme" content="VuePress Theme Hope 2.0.0-rc.36" />
    <style>
      html {
        background: var(--bg-color, #fff);
      }

      html[data-theme="dark"] {
        background: var(--bg-color, #1d1e1f);
      }

      body {
        background: var(--bg-color);
      }
    </style>
    <script>
      const userMode = localStorage.getItem("vuepress-theme-hope-scheme");
      const systemDarkMode =
        window.matchMedia &&
        window.matchMedia("(prefers-color-scheme: dark)").matches;

      if (userMode === "dark" || (userMode !== "light" && systemDarkMode)) {
        document.documentElement.setAttribute("data-theme", "dark");
      }
    </script>
    <meta property="og:url" content="https://banrenshan.github.io/post/Resilience4j.html"><meta property="og:site_name" content="å¿ƒä¹‹æ‰€å‘ï¼Œç´ å±¥ä»¥å¾€"><meta property="og:title" content="Resilience4j"><meta property="og:description" content="ç®€ä»‹ Resilience4jä¸€ä¸ªè½»é‡çº§ï¼ˆåªä¾èµ–Vavrç¬¬ä¸‰æ–¹åº“ï¼‰çš„ï¼Œæ˜“äºä½¿ç”¨çš„å®¹é”™æ¡†æ¶ï¼Œçµæ„Ÿæ¥æºäºNetflix Hystrixï¼Œä¾æ‰˜äºjava8çš„å‡½æ•°å¼ç¼–ç¨‹ã€‚ Resilience4jæä¾›äº†æ–­è·¯å™¨ã€é™é€Ÿã€é‡è¯•ã€Bulkheadç­‰åŠŸèƒ½ã€‚ä½ å¯ä»¥ä»»æ„é€‰æ‹©å’Œæ­é…è¿™äº›åŠŸèƒ½ã€‚ Bulkhead(éš”æ¿æ¨¡å¼)æ˜¯ä¸€ç§å®¹é”™çš„åº”ç”¨ç¨‹åºè®¾è®¡ã€‚ åœ¨éš”æ¿æ¶æ„ä¸­ï¼Œåº”ç”¨ç¨‹åºçš„å…ƒç´ ..."><meta property="og:type" content="article"><meta property="og:locale" content="zh-CN"><meta property="og:updated_time" content="2024-04-20T07:19:17.000Z"><meta property="article:author" content="banrenshan"><meta property="article:tag" content="java"><meta property="article:published_time" content="2022-12-02T12:54:32.000Z"><meta property="article:modified_time" content="2024-04-20T07:19:17.000Z"><script type="application/ld+json">{"@context":"https://schema.org","@type":"Article","headline":"Resilience4j","image":[""],"datePublished":"2022-12-02T12:54:32.000Z","dateModified":"2024-04-20T07:19:17.000Z","author":[{"@type":"Person","name":"banrenshan","url":"https://github.com/banrenshan"}]}</script><title>Resilience4j | å¿ƒä¹‹æ‰€å‘ï¼Œç´ å±¥ä»¥å¾€</title><meta name="description" content="ç®€ä»‹ Resilience4jä¸€ä¸ªè½»é‡çº§ï¼ˆåªä¾èµ–Vavrç¬¬ä¸‰æ–¹åº“ï¼‰çš„ï¼Œæ˜“äºä½¿ç”¨çš„å®¹é”™æ¡†æ¶ï¼Œçµæ„Ÿæ¥æºäºNetflix Hystrixï¼Œä¾æ‰˜äºjava8çš„å‡½æ•°å¼ç¼–ç¨‹ã€‚ Resilience4jæä¾›äº†æ–­è·¯å™¨ã€é™é€Ÿã€é‡è¯•ã€Bulkheadç­‰åŠŸèƒ½ã€‚ä½ å¯ä»¥ä»»æ„é€‰æ‹©å’Œæ­é…è¿™äº›åŠŸèƒ½ã€‚ Bulkhead(éš”æ¿æ¨¡å¼)æ˜¯ä¸€ç§å®¹é”™çš„åº”ç”¨ç¨‹åºè®¾è®¡ã€‚ åœ¨éš”æ¿æ¶æ„ä¸­ï¼Œåº”ç”¨ç¨‹åºçš„å…ƒç´ ...">
    <link rel="preload" href="/assets/style-wL6mR3b5.css" as="style"><link rel="stylesheet" href="/assets/style-wL6mR3b5.css">
    <link rel="modulepreload" href="/assets/app-DSYRoKiT.js"><link rel="modulepreload" href="/assets/Resilience4j.html-BmuHR3d_.js"><link rel="modulepreload" href="/assets/plugin-vue_export-helper-DlAUqK2U.js">
    <link rel="prefetch" href="/assets/index.html-DBfghPsY.js" as="script"><link rel="prefetch" href="/assets/01-flyway.html-BJhX5Gr0.js" as="script"><link rel="prefetch" href="/assets/02-jsonassert.html-Cu4at-PF.js" as="script"><link rel="prefetch" href="/assets/03-Junit5.html-CxmWsbPK.js" as="script"><link rel="prefetch" href="/assets/04-mocktio.html-DQKF_P_a.js" as="script"><link rel="prefetch" href="/assets/05-jsonpath.html-IEaAxwTJ.js" as="script"><link rel="prefetch" href="/assets/06-spring-cloud-common.html-DY6qlwH5.js" as="script"><link rel="prefetch" href="/assets/07-oracle.html-ewBZ-PLK.js" as="script"><link rel="prefetch" href="/assets/08-å¿«æ·é”®.html-CWixqv68.js" as="script"><link rel="prefetch" href="/assets/09-ç¼–ç¨‹è§„èŒƒ.html-D0CuEKP4.js" as="script"><link rel="prefetch" href="/assets/10-å¤šçº¿ç¨‹.html-DCn28rGJ.js" as="script"><link rel="prefetch" href="/assets/11-åˆ†å¸ƒå¼äº‹åŠ¡.html-DlXK6XLh.js" as="script"><link rel="prefetch" href="/assets/12-autosys.html--HNltCGy.js" as="script"><link rel="prefetch" href="/assets/mysqlä¼˜åŒ–.html-CPzEZ28d.js" as="script"><link rel="prefetch" href="/assets/mysqlç´¢å¼•.html-BY-e9DJq.js" as="script"><link rel="prefetch" href="/assets/mysqlè¿ç»´å’Œç›‘æ§.html-BtPva9Ni.js" as="script"><link rel="prefetch" href="/assets/mysqlé«˜çº§.html-Bbk91UWO.js" as="script"><link rel="prefetch" href="/assets/spring-data-jpa.html-Co7_vkdT.js" as="script"><link rel="prefetch" href="/assets/spring-data-redis.html-CjA6mt8L.js" as="script"><link rel="prefetch" href="/assets/AirFlow.html-Ckrd1BUc.js" as="script"><link rel="prefetch" href="/assets/ERå›¾.html-DUh23MiO.js" as="script"><link rel="prefetch" href="/assets/filebeat.html-ek-dFYhc.js" as="script"><link rel="prefetch" href="/assets/goè¯­è¨€.html-DHFASSLv.js" as="script"><link rel="prefetch" href="/assets/gradle-basic.html-CbO1zues.js" as="script"><link rel="prefetch" href="/assets/gradle-depedency.html-DGFQD1P5.js" as="script"><link rel="prefetch" href="/assets/gradle-java.html-C8lopwBy.js" as="script"><link rel="prefetch" href="/assets/grafana-1.html-8uuW21QO.js" as="script"><link rel="prefetch" href="/assets/grafana.html-B9WbjfTl.js" as="script"><link rel="prefetch" href="/assets/loki.html-DprKEHNG.js" as="script"><link rel="prefetch" href="/assets/nginx.html-CiBFGHtO.js" as="script"><link rel="prefetch" href="/assets/remoteConnection.html-CrA-O5Kc.js" as="script"><link rel="prefetch" href="/assets/zero-copy.html-CbRjw3FW.js" as="script"><link rel="prefetch" href="/assets/404.html-BMet8KjK.js" as="script"><link rel="prefetch" href="/assets/index.html-ZdfWzQwp.js" as="script"><link rel="prefetch" href="/assets/index.html-0fm6IOe2.js" as="script"><link rel="prefetch" href="/assets/index.html-tKXBrqJq.js" as="script"><link rel="prefetch" href="/assets/index.html-DnNNceV6.js" as="script"><link rel="prefetch" href="/assets/index.html-B9sgHOxT.js" as="script"><link rel="prefetch" href="/assets/index.html-l4kdxWH3.js" as="script"><link rel="prefetch" href="/assets/index.html-BO-xMzC6.js" as="script"><link rel="prefetch" href="/assets/index.html-ByZ_ogO6.js" as="script"><link rel="prefetch" href="/assets/index.html-BGaHjYLY.js" as="script"><link rel="prefetch" href="/assets/index.html-Br10t5Tk.js" as="script"><link rel="prefetch" href="/assets/index.html-DVx638c9.js" as="script"><link rel="prefetch" href="/assets/index.html--_UTfwQb.js" as="script"><link rel="prefetch" href="/assets/index.html-BdL6pHpw.js" as="script"><link rel="prefetch" href="/assets/index.html-Ctjjc35Q.js" as="script"><link rel="prefetch" href="/assets/index.html-Bx2KVLcu.js" as="script"><link rel="prefetch" href="/assets/index.html-D5aKwSrO.js" as="script"><link rel="prefetch" href="/assets/index.html-C33D8lTl.js" as="script"><link rel="prefetch" href="/assets/index.html-BjIjgDi0.js" as="script"><link rel="prefetch" href="/assets/index.html-Dl0LsYmf.js" as="script"><link rel="prefetch" href="/assets/index.html-COfE1CuW.js" as="script"><link rel="prefetch" href="/assets/index.html-ga4MCIji.js" as="script"><link rel="prefetch" href="/assets/index.html-2zE_GBUb.js" as="script"><link rel="prefetch" href="/assets/index.html-_IOpIUi5.js" as="script"><link rel="prefetch" href="/assets/index.html-BI_hvm71.js" as="script"><link rel="prefetch" href="/assets/index.html-D1FR64fe.js" as="script"><link rel="prefetch" href="/assets/index.html-DWYy4uQ8.js" as="script"><link rel="prefetch" href="/assets/index.html-BURclNSP.js" as="script"><link rel="prefetch" href="/assets/index.html-CxCuHMJ-.js" as="script"><link rel="prefetch" href="/assets/index.html-BfAw0WVd.js" as="script"><link rel="prefetch" href="/assets/index.html-CP2EsfH4.js" as="script"><link rel="prefetch" href="/assets/index.html-gK5iWHQf.js" as="script"><link rel="prefetch" href="/assets/index.html-BxjD4-YX.js" as="script"><link rel="prefetch" href="/assets/index.html-CgXhI6MQ.js" as="script"><link rel="prefetch" href="/assets/index.html-yxb-Bx9-.js" as="script"><link rel="prefetch" href="/assets/index.html-DzfyVEt_.js" as="script"><link rel="prefetch" href="/assets/index.html-D7C76jxO.js" as="script"><link rel="prefetch" href="/assets/index.html-DY7qZVmC.js" as="script"><link rel="prefetch" href="/assets/index.html-D2LoX7gK.js" as="script"><link rel="prefetch" href="/assets/index.html-Bip3cWH8.js" as="script"><link rel="prefetch" href="/assets/index.html-CluKc64L.js" as="script"><link rel="prefetch" href="/assets/index.html-D5XOuNSd.js" as="script"><link rel="prefetch" href="/assets/index.html-CNRk1cMV.js" as="script"><link rel="prefetch" href="/assets/index.html-vbM7XZSE.js" as="script"><link rel="prefetch" href="/assets/index.html-Jm4UV4qm.js" as="script"><link rel="prefetch" href="/assets/index.html-BJa901Wn.js" as="script"><link rel="prefetch" href="/assets/photoswipe.esm-SzV8tJDW.js" as="script">
  </head>
  <body>
    <div id="app"><!--[--><!--[--><!--[--><span tabindex="-1"></span><a href="#main-content" class="vp-skip-link sr-only">è·³è‡³ä¸»è¦å…§å®¹</a><!--]--><!--[--><div class="theme-container has-toc"><!--[--><header id="navbar" class="vp-navbar"><div class="vp-navbar-start"><button type="button" class="vp-toggle-sidebar-button" title="Toggle Sidebar"><span class="icon"></span></button><!--[--><!----><!--]--><!--[--><a class="route-link vp-brand" href="/"><img class="vp-nav-logo" src="https://theme-hope-assets.vuejs.press/logo.svg" alt><!----><span class="vp-site-name hide-in-pad">å¿ƒä¹‹æ‰€å‘ï¼Œç´ å±¥ä»¥å¾€</span></a><!--]--><!--[--><!----><!--]--></div><div class="vp-navbar-center"><!--[--><!----><!--]--><!--[--><nav class="vp-nav-links"><div class="vp-nav-item hide-in-mobile"><a class="route-link nav-link" href="/" aria-label="ä¸»é¡µ"><span class="font-icon icon fa-fw fa-sm fas fa-home" style=""></span>ä¸»é¡µ<!----></a></div><div class="vp-nav-item hide-in-mobile"><a class="route-link nav-link active" href="/post/" aria-label="åšæ–‡"><span class="font-icon icon fa-fw fa-sm fas fa-pen-to-square" style=""></span>åšæ–‡<!----></a></div><div class="vp-nav-item hide-in-mobile"><a class="route-link nav-link" href="/timeline/" aria-label="äº‹ä»¶è½´"><span class="font-icon icon fa-fw fa-sm fas fa-timeline" style=""></span>äº‹ä»¶è½´<!----></a></div><div class="vp-nav-item hide-in-mobile"><a class="route-link nav-link" href="/tag/" aria-label="æ ‡ç­¾"><span class="font-icon icon fa-fw fa-sm fas fa-tags" style=""></span>æ ‡ç­¾<!----></a></div><div class="vp-nav-item hide-in-mobile"><a class="route-link nav-link" href="/category/" aria-label="åˆ†ç±»"><span class="font-icon icon fa-fw fa-sm fas fa-book" style=""></span>åˆ†ç±»<!----></a></div></nav><!--]--><!--[--><!----><!--]--></div><div class="vp-navbar-end"><!--[--><!----><!--]--><!--[--><!----><div class="vp-nav-item vp-action"><a class="vp-action-link" href="https://github.com/banrenshan/banrenshan.github.io" target="_blank" rel="noopener noreferrer" aria-label="GitHub"><svg xmlns="http://www.w3.org/2000/svg" class="icon github-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="github icon" style="width:1.25rem;height:1.25rem;vertical-align:middle;"><path d="M511.957 21.333C241.024 21.333 21.333 240.981 21.333 512c0 216.832 140.544 400.725 335.574 465.664 24.49 4.395 32.256-10.07 32.256-23.083 0-11.69.256-44.245 0-85.205-136.448 29.61-164.736-64.64-164.736-64.64-22.315-56.704-54.4-71.765-54.4-71.765-44.587-30.464 3.285-29.824 3.285-29.824 49.195 3.413 75.179 50.517 75.179 50.517 43.776 75.008 114.816 53.333 142.762 40.79 4.523-31.66 17.152-53.377 31.19-65.537-108.971-12.458-223.488-54.485-223.488-242.602 0-53.547 19.114-97.323 50.517-131.67-5.035-12.33-21.93-62.293 4.779-129.834 0 0 41.258-13.184 134.912 50.346a469.803 469.803 0 0 1 122.88-16.554c41.642.213 83.626 5.632 122.88 16.554 93.653-63.488 134.784-50.346 134.784-50.346 26.752 67.541 9.898 117.504 4.864 129.834 31.402 34.347 50.474 78.123 50.474 131.67 0 188.586-114.73 230.016-224.042 242.09 17.578 15.232 33.578 44.672 33.578 90.454v135.85c0 13.142 7.936 27.606 32.854 22.87C862.25 912.597 1002.667 728.747 1002.667 512c0-271.019-219.648-490.667-490.71-490.667z"></path></svg></a></div><div class="vp-nav-item hide-in-mobile"><button type="button" id="appearance-switch"><svg xmlns="http://www.w3.org/2000/svg" class="icon auto-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="auto icon" style="display:block;"><path d="M512 992C246.92 992 32 777.08 32 512S246.92 32 512 32s480 214.92 480 480-214.92 480-480 480zm0-840c-198.78 0-360 161.22-360 360 0 198.84 161.22 360 360 360s360-161.16 360-360c0-198.78-161.22-360-360-360zm0 660V212c165.72 0 300 134.34 300 300 0 165.72-134.28 300-300 300z"></path></svg><svg xmlns="http://www.w3.org/2000/svg" class="icon dark-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="dark icon" style="display:none;"><path d="M524.8 938.667h-4.267a439.893 439.893 0 0 1-313.173-134.4 446.293 446.293 0 0 1-11.093-597.334A432.213 432.213 0 0 1 366.933 90.027a42.667 42.667 0 0 1 45.227 9.386 42.667 42.667 0 0 1 10.24 42.667 358.4 358.4 0 0 0 82.773 375.893 361.387 361.387 0 0 0 376.747 82.774 42.667 42.667 0 0 1 54.187 55.04 433.493 433.493 0 0 1-99.84 154.88 438.613 438.613 0 0 1-311.467 128z"></path></svg><svg xmlns="http://www.w3.org/2000/svg" class="icon light-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="light icon" style="display:none;"><path d="M952 552h-80a40 40 0 0 1 0-80h80a40 40 0 0 1 0 80zM801.88 280.08a41 41 0 0 1-57.96-57.96l57.96-58a41.04 41.04 0 0 1 58 58l-58 57.96zM512 752a240 240 0 1 1 0-480 240 240 0 0 1 0 480zm0-560a40 40 0 0 1-40-40V72a40 40 0 0 1 80 0v80a40 40 0 0 1-40 40zm-289.88 88.08-58-57.96a41.04 41.04 0 0 1 58-58l57.96 58a41 41 0 0 1-57.96 57.96zM192 512a40 40 0 0 1-40 40H72a40 40 0 0 1 0-80h80a40 40 0 0 1 40 40zm30.12 231.92a41 41 0 0 1 57.96 57.96l-57.96 58a41.04 41.04 0 0 1-58-58l58-57.96zM512 832a40 40 0 0 1 40 40v80a40 40 0 0 1-80 0v-80a40 40 0 0 1 40-40zm289.88-88.08 58 57.96a41.04 41.04 0 0 1-58 58l-57.96-58a41 41 0 0 1 57.96-57.96z"></path></svg></button></div><!----><!--]--><!--[--><!----><!--]--><button type="button" class="vp-toggle-navbar-button" aria-label="Toggle Navbar" aria-expanded="false" aria-controls="nav-screen"><span><span class="vp-top"></span><span class="vp-middle"></span><span class="vp-bottom"></span></span></button></div></header><!----><!--]--><!----><div class="toggle-sidebar-wrapper"><span class="arrow start"></span></div><aside id="sidebar" class="vp-sidebar"><!--[--><!----><!--]--><ul class="vp-sidebar-links"><li><section class="vp-sidebar-group"><p class="vp-sidebar-header clickable"><span class="font-icon icon fa-fw fa-sm fas fa-laptop-code" style=""></span><a class="route-link nav-link vp-sidebar-title" href="/gudie/" aria-label="æŒ‡å—"><!---->æŒ‡å—<!----></a><!----></p><ul class="vp-sidebar-links"><li><a class="route-link nav-link vp-sidebar-link vp-sidebar-page" href="/gudie/12-autosys.html" aria-label="AutoSys"><!---->AutoSys<!----></a></li><li><a class="route-link nav-link vp-sidebar-link vp-sidebar-page" href="/gudie/01-flyway.html" aria-label="flywayæŒ‡å—"><!---->flywayæŒ‡å—<!----></a></li><li><a class="route-link nav-link vp-sidebar-link vp-sidebar-page" href="/gudie/02-jsonassert.html" aria-label="JSONassertæŒ‡å—"><!---->JSONassertæŒ‡å—<!----></a></li><li><a class="route-link nav-link vp-sidebar-link vp-sidebar-page" href="/gudie/05-jsonpath.html" aria-label="JsonPath æŒ‡å—"><!---->JsonPath æŒ‡å—<!----></a></li><li><a class="route-link nav-link vp-sidebar-link vp-sidebar-page" href="/gudie/03-Junit5.html" aria-label="JUnit5æŒ‡å—"><!---->JUnit5æŒ‡å—<!----></a></li><li><a class="route-link nav-link vp-sidebar-link vp-sidebar-page" href="/gudie/04-mocktio.html" aria-label="mocktioæŒ‡å—"><!---->mocktioæŒ‡å—<!----></a></li><li><a class="route-link nav-link vp-sidebar-link vp-sidebar-page" href="/gudie/07-oracle.html" aria-label="OracleåŸºç¡€ æŒ‡å—"><!---->OracleåŸºç¡€ æŒ‡å—<!----></a></li><li><a class="route-link nav-link vp-sidebar-link vp-sidebar-page" href="/gudie/spring-data-redis.html" aria-label="redisæ”¯æŒ"><!---->redisæ”¯æŒ<!----></a></li><li><a class="route-link nav-link vp-sidebar-link vp-sidebar-page" href="/gudie/spring-data-jpa.html" aria-label="Spring Data Repositories"><!---->Spring Data Repositories<!----></a></li><li><a class="route-link nav-link vp-sidebar-link vp-sidebar-page" href="/gudie/06-spring-cloud-common.html" aria-label="Spring-CLoud-Common"><!---->Spring-CLoud-Common<!----></a></li><li><a class="route-link nav-link vp-sidebar-link vp-sidebar-page" href="/gudie/mysql%E4%BC%98%E5%8C%96.html" aria-label="sqlè¯­å¥ä¸Šçš„ä¼˜åŒ–"><!---->sqlè¯­å¥ä¸Šçš„ä¼˜åŒ–<!----></a></li><li><a class="route-link nav-link vp-sidebar-link vp-sidebar-page" href="/gudie/11-%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1.html" aria-label="åˆ†å¸ƒå¼äº‹åŠ¡"><!---->åˆ†å¸ƒå¼äº‹åŠ¡<!----></a></li><li><a class="route-link nav-link vp-sidebar-link vp-sidebar-page" href="/gudie/10-%E5%A4%9A%E7%BA%BF%E7%A8%8B.html" aria-label="å¤šçº¿ç¨‹"><!---->å¤šçº¿ç¨‹<!----></a></li><li><a class="route-link nav-link vp-sidebar-link vp-sidebar-page" href="/gudie/mysql%E9%AB%98%E7%BA%A7.html" aria-label="å®‰è£…"><!---->å®‰è£…<!----></a></li><li><a class="route-link nav-link vp-sidebar-link vp-sidebar-page" href="/gudie/08-%E5%BF%AB%E6%8D%B7%E9%94%AE.html" aria-label="å¿«æ·é”®"><!---->å¿«æ·é”®<!----></a></li><li><a class="route-link nav-link vp-sidebar-link vp-sidebar-page" href="/gudie/mysql%E7%B4%A2%E5%BC%95.html" aria-label="æ¦‚è¿°"><!---->æ¦‚è¿°<!----></a></li><li><a class="route-link nav-link vp-sidebar-link vp-sidebar-page" href="/gudie/mysql%E8%BF%90%E7%BB%B4%E5%92%8C%E7%9B%91%E6%8E%A7.html" aria-label="ç›‘æ§"><!---->ç›‘æ§<!----></a></li><li><a class="route-link nav-link vp-sidebar-link vp-sidebar-page" href="/gudie/09-%E7%BC%96%E7%A8%8B%E8%A7%84%E8%8C%83.html" aria-label="ç¼–ç¨‹è§„èŒƒ"><!---->ç¼–ç¨‹è§„èŒƒ<!----></a></li></ul></section></li><li><section class="vp-sidebar-group"><p class="vp-sidebar-header active"><span class="font-icon icon fa-fw fa-sm fas fa-book" style=""></span><span class="vp-sidebar-title">æ–‡ç« </span><!----></p><ul class="vp-sidebar-links"><li><a class="route-link nav-link vp-sidebar-link vp-sidebar-page" href="/post/AirFlow.html" aria-label="AirFlow"><!---->AirFlow<!----></a></li><li><a class="route-link nav-link vp-sidebar-link vp-sidebar-page" href="/post/ER%E5%9B%BE.html" aria-label="ERå›¾"><!---->ERå›¾<!----></a></li><li><a class="route-link nav-link vp-sidebar-link vp-sidebar-page" href="/post/filebeat.html" aria-label="filebeat"><!---->filebeat<!----></a></li><li><a class="route-link nav-link vp-sidebar-link vp-sidebar-page" href="/post/go%E8%AF%AD%E8%A8%80.html" aria-label="goåŸºç¡€è¯­æ³•"><!---->goåŸºç¡€è¯­æ³•<!----></a></li><li><a class="route-link nav-link vp-sidebar-link vp-sidebar-page" href="/post/gradle-depedency.html" aria-label="gradle ä¾èµ–è§£æ"><!---->gradle ä¾èµ–è§£æ<!----></a></li><li><a class="route-link nav-link vp-sidebar-link vp-sidebar-page" href="/post/gradle-basic.html" aria-label="gradle-basic"><!---->gradle-basic<!----></a></li><li><a class="route-link nav-link vp-sidebar-link vp-sidebar-page" href="/post/gradle-java.html" aria-label="gradle-java"><!---->gradle-java<!----></a></li><li><a class="route-link nav-link vp-sidebar-link vp-sidebar-page" href="/post/grafana-1.html" aria-label="grafana1"><!---->grafana1<!----></a></li><li><a class="route-link nav-link vp-sidebar-link vp-sidebar-page" href="/post/grafana.html" aria-label="grafana2"><!---->grafana2<!----></a></li><li><a class="route-link nav-link vp-sidebar-link vp-sidebar-page" href="/post/loki.html" aria-label="loki"><!---->loki<!----></a></li><li><a class="route-link nav-link vp-sidebar-link vp-sidebar-page" href="/post/nginx.html" aria-label="nginx"><!---->nginx<!----></a></li><li><a class="route-link nav-link active vp-sidebar-link vp-sidebar-page active" href="/post/Resilience4j.html" aria-label="Resilience4j"><!---->Resilience4j<!----></a></li><li><a class="route-link nav-link vp-sidebar-link vp-sidebar-page" href="/post/zero-copy.html" aria-label="zero-copy"><!---->zero-copy<!----></a></li><li><a class="route-link nav-link vp-sidebar-link vp-sidebar-page" href="/post/remoteConnection.html" aria-label="è¿œç¨‹ç®¡ç†åè®®"><!---->è¿œç¨‹ç®¡ç†åè®®<!----></a></li></ul></section></li></ul><!--[--><!----><!--]--></aside><!--[--><main id="main-content" class="vp-page"><!--[--><!--[--><!----><!--]--><!----><nav class="vp-breadcrumb disable"></nav><div class="vp-page-title"><h1><!---->Resilience4j</h1><div class="page-info"><span class="page-author-info" aria-label="ä½œè€…ğŸ–Š" data-balloon-pos="up"><svg xmlns="http://www.w3.org/2000/svg" class="icon author-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="author icon"><path d="M649.6 633.6c86.4-48 147.2-144 147.2-249.6 0-160-128-288-288-288s-288 128-288 288c0 108.8 57.6 201.6 147.2 249.6-121.6 48-214.4 153.6-240 288-3.2 9.6 0 19.2 6.4 25.6 3.2 9.6 12.8 12.8 22.4 12.8h704c9.6 0 19.2-3.2 25.6-12.8 6.4-6.4 9.6-16 6.4-25.6-25.6-134.4-121.6-240-243.2-288z"></path></svg><span><a class="page-author-item" href="https://github.com/banrenshan" target="_blank" rel="noopener noreferrer">banrenshan</a></span><span property="author" content="banrenshan"></span></span><!----><span class="page-date-info" aria-label="å†™ä½œæ—¥æœŸğŸ“…" data-balloon-pos="up"><svg xmlns="http://www.w3.org/2000/svg" class="icon calendar-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="calendar icon"><path d="M716.4 110.137c0-18.753-14.72-33.473-33.472-33.473-18.753 0-33.473 14.72-33.473 33.473v33.473h66.993v-33.473zm-334.87 0c0-18.753-14.72-33.473-33.473-33.473s-33.52 14.72-33.52 33.473v33.473h66.993v-33.473zm468.81 33.52H716.4v100.465c0 18.753-14.72 33.473-33.472 33.473a33.145 33.145 0 01-33.473-33.473V143.657H381.53v100.465c0 18.753-14.72 33.473-33.473 33.473a33.145 33.145 0 01-33.473-33.473V143.657H180.6A134.314 134.314 0 0046.66 277.595v535.756A134.314 134.314 0 00180.6 947.289h669.74a134.36 134.36 0 00133.94-133.938V277.595a134.314 134.314 0 00-133.94-133.938zm33.473 267.877H147.126a33.145 33.145 0 01-33.473-33.473c0-18.752 14.72-33.473 33.473-33.473h736.687c18.752 0 33.472 14.72 33.472 33.473a33.145 33.145 0 01-33.472 33.473z"></path></svg><span><!----></span><meta property="datePublished" content="2022-12-02T12:54:32.000Z"></span><span class="page-pageview-info" aria-label="è®¿é—®é‡ğŸ”¢" data-balloon-pos="up"><svg xmlns="http://www.w3.org/2000/svg" class="icon eye-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="eye icon"><path d="M992 512.096c0-5.76-.992-10.592-1.28-11.136-.192-2.88-1.152-8.064-2.08-10.816-.256-.672-.544-1.376-.832-2.08-.48-1.568-1.024-3.104-1.6-4.32C897.664 290.112 707.104 160 512 160c-195.072 0-385.632 130.016-473.76 322.592-1.056 2.112-1.792 4.096-2.272 5.856a55.512 55.512 0 00-.64 1.6c-1.76 5.088-1.792 8.64-1.632 7.744-.832 3.744-1.568 11.168-1.568 11.168-.224 2.272-.224 4.032.032 6.304 0 0 .736 6.464 1.088 7.808.128 1.824.576 4.512 1.12 6.976h-.032c.448 2.08 1.12 4.096 1.984 6.08.48 1.536.992 2.976 1.472 4.032C126.432 733.856 316.992 864 512 864c195.136 0 385.696-130.048 473.216-321.696 1.376-2.496 2.24-4.832 2.848-6.912.256-.608.48-1.184.672-1.728 1.536-4.48 1.856-8.32 1.728-8.32l-.032.032c.608-3.104 1.568-7.744 1.568-13.28zM512 672c-88.224 0-160-71.776-160-160s71.776-160 160-160 160 71.776 160 160-71.776 160-160 160z"></path></svg><span id="ArtalkPV" class="vp-pageview waline-pageview-count" data-path="/post/Resilience4j.html" data-page-key="/post/Resilience4j.html">...</span></span><span class="page-reading-time-info" aria-label="é˜…è¯»æ—¶é—´âŒ›" data-balloon-pos="up"><svg xmlns="http://www.w3.org/2000/svg" class="icon timer-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="timer icon"><path d="M799.387 122.15c4.402-2.978 7.38-7.897 7.38-13.463v-1.165c0-8.933-7.38-16.312-16.312-16.312H256.33c-8.933 0-16.311 7.38-16.311 16.312v1.165c0 5.825 2.977 10.874 7.637 13.592 4.143 194.44 97.22 354.963 220.201 392.763-122.204 37.542-214.893 196.511-220.2 389.397-4.661 5.049-7.638 11.651-7.638 19.03v5.825h566.49v-5.825c0-7.379-2.849-13.981-7.509-18.9-5.049-193.016-97.867-351.985-220.2-389.527 123.24-37.67 216.446-198.453 220.588-392.892zM531.16 450.445v352.632c117.674 1.553 211.787 40.778 211.787 88.676H304.097c0-48.286 95.149-87.382 213.728-88.676V450.445c-93.077-3.107-167.901-81.297-167.901-177.093 0-8.803 6.99-15.793 15.793-15.793 8.803 0 15.794 6.99 15.794 15.793 0 80.261 63.69 145.635 142.01 145.635s142.011-65.374 142.011-145.635c0-8.803 6.99-15.793 15.794-15.793s15.793 6.99 15.793 15.793c0 95.019-73.789 172.82-165.96 177.093z"></path></svg><span>å¤§çº¦ 27 åˆ†é’Ÿ</span><meta property="timeRequired" content="PT27M"></span><!----><!----></div><hr></div><div class="vp-toc-placeholder"><aside id="toc"><!--[--><!----><!--]--><div class="vp-toc-header">æ­¤é¡µå†…å®¹<button type="button" class="print-button" title="æ‰“å°"><svg xmlns="http://www.w3.org/2000/svg" class="icon print-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="print icon"><path d="M819.2 364.8h-44.8V128c0-17.067-14.933-32-32-32H281.6c-17.067 0-32 14.933-32 32v236.8h-44.8C145.067 364.8 96 413.867 96 473.6v192c0 59.733 49.067 108.8 108.8 108.8h44.8V896c0 17.067 14.933 32 32 32h460.8c17.067 0 32-14.933 32-32V774.4h44.8c59.733 0 108.8-49.067 108.8-108.8v-192c0-59.733-49.067-108.8-108.8-108.8zM313.6 160h396.8v204.8H313.6V160zm396.8 704H313.6V620.8h396.8V864zM864 665.6c0 25.6-19.2 44.8-44.8 44.8h-44.8V588.8c0-17.067-14.933-32-32-32H281.6c-17.067 0-32 14.933-32 32v121.6h-44.8c-25.6 0-44.8-19.2-44.8-44.8v-192c0-25.6 19.2-44.8 44.8-44.8h614.4c25.6 0 44.8 19.2 44.8 44.8v192z"></path></svg></button><div class="arrow end"></div></div><div class="vp-toc-wrapper"><ul class="vp-toc-list"><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level2" href="#æ•…éšœç‡å’Œæ…¢é€Ÿè°ƒç”¨ç‡é˜ˆå€¼">æ•…éšœç‡å’Œæ…¢é€Ÿè°ƒç”¨ç‡é˜ˆå€¼</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level2" href="#å¦‚ä½•ä½¿ç”¨">å¦‚ä½•ä½¿ç”¨</a></li><li><ul class="vp-toc-list"><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#æ–­è·¯å™¨é…ç½®">æ–­è·¯å™¨é…ç½®</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#ä½¿ç”¨æ–­è·¯å™¨è£…æ‰®å‡½æ•°å¹¶è°ƒç”¨">ä½¿ç”¨æ–­è·¯å™¨è£…æ‰®å‡½æ•°å¹¶è°ƒç”¨</a></li><!----><!--]--></ul></li><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level2" href="#ä¾èµ–">ä¾èµ–</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level2" href="#ç›¸å…³é…ç½®">ç›¸å…³é…ç½®</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level2" href="#æ³¨è§£">æ³¨è§£</a></li><li><ul class="vp-toc-list"><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#æ³¨è§£çš„é¡ºåº">æ³¨è§£çš„é¡ºåº</a></li><!----><!--]--></ul></li><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level2" href="#æŒ‡æ ‡ç«¯ç‚¹">æŒ‡æ ‡ç«¯ç‚¹</a></li><li><ul class="vp-toc-list"><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#health-ç«¯ç‚¹">health ç«¯ç‚¹</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#eventsç«¯ç‚¹">eventsç«¯ç‚¹</a></li><!----><!--]--></ul></li><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level2" href="#è£…æ‰®æ¥å£">è£…æ‰®æ¥å£</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level2" href="#è£…æ‰®å™¨çš„é¡ºåº">è£…æ‰®å™¨çš„é¡ºåº</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level2" href="#fallback">Fallback</a></li><!----><!--]--></ul><div class="vp-toc-marker" style="top:-1.7rem;"></div></div><!--[--><!----><!--]--></aside></div><!--[--><!----><!--]--><div class="theme-hope-content"><h1 id="ç®€ä»‹" tabindex="-1"><a class="header-anchor" href="#ç®€ä»‹"><span>ç®€ä»‹</span></a></h1><p>Resilience4jä¸€ä¸ªè½»é‡çº§ï¼ˆåªä¾èµ–Vavrç¬¬ä¸‰æ–¹åº“ï¼‰çš„ï¼Œæ˜“äºä½¿ç”¨çš„å®¹é”™æ¡†æ¶ï¼Œçµæ„Ÿæ¥æºäºNetflix Hystrixï¼Œä¾æ‰˜äºjava8çš„å‡½æ•°å¼ç¼–ç¨‹ã€‚</p><p>Resilience4jæä¾›äº†æ–­è·¯å™¨ã€é™é€Ÿã€é‡è¯•ã€Bulkheadç­‰åŠŸèƒ½ã€‚ä½ å¯ä»¥ä»»æ„é€‰æ‹©å’Œæ­é…è¿™äº›åŠŸèƒ½ã€‚</p><p>Bulkhead(éš”æ¿æ¨¡å¼)æ˜¯ä¸€ç§å®¹é”™çš„åº”ç”¨ç¨‹åºè®¾è®¡ã€‚ åœ¨éš”æ¿æ¶æ„ä¸­ï¼Œåº”ç”¨ç¨‹åºçš„å…ƒç´ è¢«éš”ç¦»åˆ°æ± ä¸­ï¼Œå› æ­¤ï¼Œå¦‚æœå…¶ä¸­ä¸€ä¸ªå¤±è´¥ï¼Œåˆ™å…¶ä»–å…ƒç´ å°†ç»§ç»­è¿è¡Œã€‚ å®ƒæ˜¯æ ¹æ®èˆ¹ä½“çš„åˆ†æ®µéš”æ¿ï¼ˆå‡¸å¤´ï¼‰æ¥å‘½åçš„ã€‚ å¦‚æœèˆ¹ä½“å—æŸï¼Œåˆ™åªæœ‰æŸåçš„éƒ¨åˆ†ä¼šå……æ»¡æ°´ï¼Œä»è€Œé˜²æ­¢èˆ¹ä¸‹æ²‰ã€‚</p><p>ä»¥ä¸‹ç¤ºä¾‹æ˜¾ç¤ºäº†å¦‚ä½•ä½¿ç”¨CircuitBreakerå’ŒRetryè£…é¥°lambdaè¡¨è¾¾å¼ï¼Œä»¥ä¾¿åœ¨å‘ç”Ÿå¼‚å¸¸æ—¶æœ€å¤šé‡è¯•3æ¬¡ã€‚</p><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token comment">// åˆ›å»ºé»˜è®¤çš„æ–­è·¯å™¨</span>
<span class="token class-name">CircuitBreaker</span> circuitBreaker <span class="token operator">=</span> <span class="token class-name">CircuitBreaker</span><span class="token punctuation">.</span><span class="token function">ofDefaults</span><span class="token punctuation">(</span><span class="token string">&quot;backendService&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// åˆ›å»ºé»˜è®¤çš„é‡è¯•å™¨ï¼Œé‡æ‹¾3æ¬¡ï¼Œé—´éš”ä¸º500ms</span>
<span class="token class-name">Retry</span> retry <span class="token operator">=</span> <span class="token class-name">Retry</span><span class="token punctuation">.</span><span class="token function">ofDefaults</span><span class="token punctuation">(</span><span class="token string">&quot;backendService&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// åˆ›å»ºé»˜è®¤çš„éš”ç¦»å™¨</span>
<span class="token class-name">Bulkhead</span> bulkhead <span class="token operator">=</span> <span class="token class-name">Bulkhead</span><span class="token punctuation">.</span><span class="token function">ofDefaults</span><span class="token punctuation">(</span><span class="token string">&quot;backendService&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//å…·ä½“çš„ä¸šåŠ¡è°ƒç”¨</span>
<span class="token class-name">Supplier</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> supplier <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> backendService<span class="token punctuation">.</span><span class="token function">doSomething</span><span class="token punctuation">(</span>param1<span class="token punctuation">,</span> param2<span class="token punctuation">)</span>

<span class="token comment">// ä½¿ç”¨è£…æ‰®å™¨è£…æ‰®å‡½æ•°</span>
<span class="token class-name">Supplier</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> decoratedSupplier <span class="token operator">=</span> <span class="token class-name">Decorators</span><span class="token punctuation">.</span><span class="token function">ofSupplier</span><span class="token punctuation">(</span>supplier<span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">withCircuitBreaker</span><span class="token punctuation">(</span>circuitBreaker<span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">withBulkhead</span><span class="token punctuation">(</span>bulkhead<span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">withRetry</span><span class="token punctuation">(</span>retry<span class="token punctuation">)</span>  
  <span class="token punctuation">.</span><span class="token function">decorate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// æ‰§è¡Œå‡½æ•°ï¼Œå¹¶è®¾ç½®åé€€å‡½æ•°</span>
<span class="token class-name">String</span> result <span class="token operator">=</span> <span class="token class-name">Try</span><span class="token punctuation">.</span><span class="token function">ofSupplier</span><span class="token punctuation">(</span>decoratedSupplier<span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">recover</span><span class="token punctuation">(</span>throwable <span class="token operator">-&gt;</span> <span class="token string">&quot;Hello from Recovery&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// ä¸ä½¿ç”¨è£…æ‰®å™¨ï¼Œç›´æ¥ä½¿ç”¨æ–­è·¯å™¨è°ƒç”¨å‡½æ•°</span>
<span class="token class-name">String</span> result <span class="token operator">=</span> circuitBreaker
  <span class="token punctuation">.</span><span class="token function">executeSupplier</span><span class="token punctuation">(</span>backendService<span class="token operator">::</span><span class="token function">doSomething</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// ä½¿ç”¨ThreadPoolBulkheadåœ¨å¦å¤–çš„çº¿ç¨‹ä¸­å¼‚æ­¥è¿è¡Œ</span>
 <span class="token class-name">ThreadPoolBulkhead</span> threadPoolBulkhead <span class="token operator">=</span> <span class="token class-name">ThreadPoolBulkhead</span><span class="token punctuation">.</span><span class="token function">ofDefaults</span><span class="token punctuation">(</span><span class="token string">&quot;backendService&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// è®¾å®šè¶…æ—¶æœºåˆ¶ï¼Œè¶…æ—¶éœ€è¦Scheduleræ¥è°ƒåº¦</span>
<span class="token class-name">ScheduledExecutorService</span> scheduledExecutorService <span class="token operator">=</span> <span class="token class-name">Executors</span><span class="token punctuation">.</span><span class="token function">newScheduledThreadPool</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">TimeLimiter</span> timeLimiter <span class="token operator">=</span> <span class="token class-name">TimeLimiter</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span><span class="token class-name">Duration</span><span class="token punctuation">.</span><span class="token function">ofSeconds</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token class-name">CompletableFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> future <span class="token operator">=</span> <span class="token class-name">Decorators</span><span class="token punctuation">.</span><span class="token function">ofSupplier</span><span class="token punctuation">(</span>supplier<span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">withThreadPoolBulkhead</span><span class="token punctuation">(</span>threadPoolBulkhead<span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">withTimeLimiter</span><span class="token punctuation">(</span>timeLimiter<span class="token punctuation">,</span> scheduledExecutorService<span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">withCircuitBreaker</span><span class="token punctuation">(</span>circuitBreaker<span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">withFallback</span><span class="token punctuation">(</span><span class="token function">asList</span><span class="token punctuation">(</span><span class="token class-name">TimeoutException</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> 
                         <span class="token class-name">CallNotPermittedException</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> 
                         <span class="token class-name">BulkheadFullException</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  
                  throwable <span class="token operator">-&gt;</span> <span class="token string">&quot;Hello from Recovery&quot;</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toCompletableFuture</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>æ‚¨å¯ä»¥é…ç½®é‡è¯•ä¹‹é—´çš„ç­‰å¾…é—´éš”ï¼Œè¿˜å¯ä»¥é…ç½®å›é€€ç®—æ³•ã€‚</p><p>å½“æ‰€æœ‰é‡è¯•å‡å¤±è´¥æ—¶ï¼Œè¯¥ç¤ºä¾‹ä½¿ç”¨Vavrçš„monadä»å¼‚å¸¸ä¸­æ¢å¤å¹¶è°ƒç”¨å¦ä¸€ä¸ªlambdaè¡¨è¾¾å¼ä½œä¸ºåå¤‡ã€‚</p><h1 id="æ¨¡å—" tabindex="-1"><a class="header-anchor" href="#æ¨¡å—"><span>æ¨¡å—</span></a></h1><p>æ ¸å¿ƒæ¨¡å—</p><ul><li>resilience4j-circuitbreaker: Circuit breaking</li><li>resilience4j-ratelimiter: Rate limiting</li><li>resilience4j-bulkhead: Bulkheading</li><li>resilience4j-retry: Automatic retrying (sync and async)</li><li>resilience4j-cache: Result caching</li><li>resilience4j-timelimiter: Timeout handling</li></ul><p>æ‰©å±•æ¨¡å—</p><ul><li>resilience4j-retrofit: Retrofit adapter</li><li>resilience4j-feign: Feign adapter</li><li>resilience4j-consumer: Circular Buffer Event consumer</li><li>resilience4j-kotlin: Kotlin coroutines support</li></ul><p>æ¡†æ¶æ¨¡å—</p><ul><li>resilience4j-spring-boot: Spring Boot Starter</li><li>resilience4j-spring-boot2: Spring Boot 2 Starter</li><li>resilience4j-ratpack: Ratpack Starter</li><li>resilience4j-vertx: Vertx Future decorator</li></ul><p>Reactive æ¨¡å—</p><ul><li>resilience4j-rxjava2: Custom RxJava2 operators</li><li>resilience4j-reactor: Custom Spring Reactor operators</li></ul><p>Metrics modules</p><ul><li>resilience4j-micrometer: Micrometer Metrics exporter</li><li>resilience4j-metrics: Dropwizard Metrics exporter</li><li>resilience4j-prometheus: Prometheus Metrics exporter</li></ul><h1 id="circuitbreaker" tabindex="-1"><a class="header-anchor" href="#circuitbreaker"><span>CircuitBreaker</span></a></h1><p>æ–­è·¯å™¨åˆä¸‰ä¸ªæ­£å¸¸çŠ¶æ€ï¼šCLOSEï¼ŒOPENå’ŒHALF_OPEN ,ä¸¤ä¸ªç‰¹æ®ŠçŠ¶æ€ DISABLEDå’ŒFORCED_OPEN.</p><figure><img src="/assets/1621905009574-efb3e8d2-37b4-4c11-a31d-217d6ca40521-XsmuXXG6.png" alt="img" tabindex="0" loading="lazy"><figcaption>img</figcaption></figure><p>æ–­è·¯å™¨ä½¿ç”¨æ»‘åŠ¨çª—å£æ¥å­˜å‚¨å’Œæ±‡æ€»è°ƒç”¨ç»“æœï¼Œè¿™ä¸ªçª—å£å¯ä»¥åŸºäºè®¡æ•°æˆ–æ—¶é—´ã€‚åŸºäºè®¡æ•°çš„æ»‘åŠ¨çª—å£æ±‡æ€»äº†æœ€è¿‘Nä¸ªè°ƒç”¨çš„ç»“æœã€‚ åŸºäºæ—¶é—´çš„æ»‘åŠ¨çª—å£æ±‡æ€»äº†æœ€è¿‘Nç§’çš„è°ƒç”¨ç»“æœã€‚</p><ul><li>åŸºäºè®¡æ•°çš„æ»‘åŠ¨çª—å£ç”±Nä¸ªæµ‹é‡å€¼çš„åœ†å½¢æ•°ç»„å®ç°ã€‚å¦‚æœè®¡æ•°çª—å£å¤§å°ä¸º10ï¼Œåˆ™åœ†å½¢é˜µåˆ—å§‹ç»ˆå…·æœ‰10ä¸ªæµ‹é‡å€¼ã€‚æ»‘åŠ¨çª—å£ä»¥å¢é‡æ–¹å¼æ›´æ–°æ±‡æ€»ç»“æœã€‚ å½“è®°å½•æ–°çš„callç»“æœæ—¶ï¼Œå°†æ›´æ–°æ€»æ±‡æ€»ã€‚ æ”¶å›æœ€æ—§çš„åº¦é‡åï¼Œå°†ä»æ€»èšåˆä¸­å‡å»è¯¥åº¦é‡ï¼Œç„¶åé‡ç½®å­˜å‚¨æ¡¶ã€‚ ï¼ˆé€é¡¹æ‰£é™¤ï¼‰</li><li>åŸºäºæ—¶é—´çš„æ»‘åŠ¨çª—å£æ˜¯ç”±Nä¸ªéƒ¨åˆ†æ±‡æ€»ç»“æœï¼ˆå­˜å‚¨æ¡¶ï¼‰çš„åœ†å½¢æ•°ç»„å®ç°çš„ã€‚å¦‚æœæ—¶é—´çª—å£å¤§å°ä¸º10ç§’ï¼Œåˆ™åœ†å½¢æ•°ç»„å°†å§‹ç»ˆå…·æœ‰10ä¸ªéƒ¨åˆ†æ±‡æ€»ç»“æœï¼ˆå­˜å‚¨æ¡¶ï¼‰ã€‚ æ¯ä¸ªå­˜å‚¨æ®µéƒ½ä¼šæ±‡æ€»åœ¨æŸä¸ªçºªå…ƒç§’å†…å‘ç”Ÿçš„æ‰€æœ‰è°ƒç”¨çš„ç»“æœã€‚ åœ†å½¢æ•°ç»„çš„å¤´å­˜å‚¨åŒºå­˜å‚¨å½“å‰çºªå…ƒçš„callç»“æœã€‚ å…¶ä»–éƒ¨åˆ†èšåˆå­˜å‚¨å‰å‡ ç§’çš„callç»“æœã€‚æ»‘åŠ¨çª—å£ä¸ä¼šå•ç‹¬å­˜å‚¨callç»“æœï¼ˆå…ƒç»„ï¼‰ï¼Œè€Œæ˜¯ä»¥å¢é‡æ–¹å¼æ›´æ–°éƒ¨åˆ†èšåˆï¼ˆå­˜å‚¨æ¡¶ï¼‰å’Œæ€»èšåˆã€‚å½“è®°å½•æ–°çš„callç»“æœæ—¶ï¼Œæ€»èšåˆå°†å¢é‡æ›´æ–°ã€‚ å½“æœ€æ—§çš„å­˜å‚¨æ¡¶è¢«æ”¶å›æ—¶ï¼Œè¯¥å­˜å‚¨æ¡¶çš„éƒ¨åˆ†æ€»èšåˆå°†ä»æ€»èšåˆä¸­å‡å»ï¼Œç„¶åé‡ç½®è¯¥å­˜å‚¨æ¡¶ï¼ˆé€é¡¹æ‰£é™¤ï¼‰ã€‚ <code>éƒ¨åˆ†èšåˆ</code> ç”±3ä¸ªæ•´æ•°ç»„æˆï¼Œä»¥è®¡ç®—å¤±è´¥çš„callæ•°ï¼Œæ…¢é€Ÿcallæ•°å’Œæ€»callæ•°ã€‚ ä¸€ä¸ªé•¿å­˜å‚¨æ‰€æœ‰callçš„æ€»æŒç»­æ—¶é—´ã€‚</li></ul><h2 id="æ•…éšœç‡å’Œæ…¢é€Ÿè°ƒç”¨ç‡é˜ˆå€¼" tabindex="-1"><a class="header-anchor" href="#æ•…éšœç‡å’Œæ…¢é€Ÿè°ƒç”¨ç‡é˜ˆå€¼"><span>æ•…éšœç‡å’Œæ…¢é€Ÿè°ƒç”¨ç‡é˜ˆå€¼</span></a></h2><p>å½“æ•…éšœç‡ç­‰äºæˆ–å¤§äºé…ç½®çš„é˜ˆå€¼æ—¶ï¼ŒCircuitBreakerçš„çŠ¶æ€å°†ä»â€œCLOSEâ€æ›´æ”¹ä¸ºâ€œOPENâ€ã€‚ ä¾‹å¦‚ï¼Œå½“è¶…è¿‡50ï¼…çš„callå¤±è´¥æ—¶ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼Œæ‰€æœ‰å¼‚å¸¸å‡è§†ä¸ºå¤±è´¥ã€‚ æ‚¨å¯ä»¥å®šä¹‰åº”è§†ä¸ºå¤±è´¥çš„å¼‚å¸¸åˆ—è¡¨ã€‚ é™¤éå¿½ç•¥æ‰€æœ‰å…¶ä»–å¼‚å¸¸ï¼Œå¦åˆ™æ‰€æœ‰å…¶ä»–å¼‚å¸¸å‡è¢«è§†ä¸ºæˆåŠŸã€‚ ä¹Ÿå¯ä»¥å¿½ç•¥å¼‚å¸¸ï¼Œä»¥ä½¿å®ƒä»¬æ—¢ä¸ç®—ä½œå¤±è´¥ä¹Ÿä¸ç®—æˆåŠŸã€‚</p><p>å½“æ…¢é€Ÿå‘¼å«çš„ç™¾åˆ†æ¯”ç­‰äºæˆ–å¤§äºé…ç½®çš„é˜ˆå€¼æ—¶ï¼ŒCircuitBreakerä¹Ÿä¼šä»CLOSEDå˜ä¸ºOPENã€‚ ä¾‹å¦‚ï¼Œå½“è¶…è¿‡50ï¼…çš„callæ—¶é—´è¶…è¿‡5ç§’ã€‚ è¿™æœ‰åŠ©äºå‡è½»è¢«è°ƒç”¨ç³»ç»Ÿçš„è´Ÿæ‹…ã€‚</p><p>å¦‚æœè®°å½•çš„callæ•°é‡è¾¾åˆ°æŒ‡å®šçš„è¦æ±‚ï¼Œæ‰ä¼šè®¡ç®—æ•…éšœç‡å’Œæ…¢é€Ÿå‘¼å«ç‡ã€‚ ä¾‹å¦‚ï¼Œå¦‚æœæ‰€éœ€callçš„æœ€å°æ•°é‡ä¸º10ï¼Œåˆ™å¿…é¡»è‡³å°‘è®°å½•10ä¸ªcallï¼Œç„¶åæ‰èƒ½è®¡ç®—å‡ºæ•…éšœç‡ã€‚ å¦‚æœä»…è¯„ä¼°äº†9ä¸ªcallï¼Œåˆ™å³ä½¿æ‰€æœ‰9ä¸ªcallå‡å¤±è´¥ï¼ŒCircuitBreakerä¹Ÿä¸ä¼šè·³é—¸ã€‚</p><p>å½“æ–­è·¯å™¨æ‰“å¼€æ—¶ï¼Œè¿”å›CallNotPermittedException å¼‚å¸¸ã€‚ ç»è¿‡ä¸€æ®µç­‰å¾…æ—¶é—´åï¼ŒCircuitBreakerçŠ¶æ€ä»OPENå˜ä¸ºHALF_OPENï¼Œå¹¶å…è®¸å¯é…ç½®æ•°é‡çš„callä»¥æŸ¥çœ‹åç«¯æ˜¯å¦å¯ç”¨ï¼Œ é™¤éæ‰€æœ‰å…è®¸çš„calléƒ½å·²å®Œæˆï¼Œå¦åˆ™å°†é€šè¿‡CallNotPermittedExceptionæ‹’ç»è¿›ä¸€æ­¥çš„callã€‚</p><p>æ–­è·¯å™¨æ”¯æŒå¦å¤–ä¸¤ä¸ªç‰¹æ®ŠçŠ¶æ€ï¼Œå³DISABLEDï¼ˆå§‹ç»ˆå…è®¸è®¿é—®ï¼‰å’ŒFORCED_OPENï¼ˆå§‹ç»ˆæ‹’ç»è®¿é—®ï¼‰ã€‚ åœ¨è¿™ä¸¤ç§çŠ¶æ€ä¸‹ï¼Œä¸ä¼šç”Ÿæˆä»»ä½•æ–­è·¯å™¨äº‹ä»¶ï¼ˆçŠ¶æ€è½¬æ¢é™¤å¤–ï¼‰ï¼Œä¹Ÿä¸ä¼šè®°å½•ä»»ä½•åº¦é‡ã€‚ é€€å‡ºè¿™äº›çŠ¶æ€çš„å”¯ä¸€æ–¹æ³•æ˜¯è§¦å‘çŠ¶æ€è½¬æ¢æˆ–é‡ç½®æ–­è·¯å™¨ã€‚</p><p>CircuitBreakeræ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p><ul><li>CircuitBreakerçš„çŠ¶æ€å­˜å‚¨åœ¨AtomicReferenceä¸­</li><li>CircuitBreakerä½¿ç”¨åŸå­æ“ä½œæ¥æ›´æ–°çŠ¶æ€ã€‚</li><li>ä»â€œæ»‘åŠ¨çª—å£â€è®°å½•callå’Œè¯»å–å¿«ç…§æ˜¯åŒæ­¥æ“ä½œ</li></ul><p>å¦‚æœæœ‰20ä¸ªå¹¶å‘çº¿ç¨‹è¯·æ±‚æ‰§è¡Œå‡½æ•°çš„è®¸å¯ï¼Œå¹¶ä¸”CircuitBreakerçš„çŠ¶æ€å…³é—­ï¼Œåˆ™å…è®¸æ‰€æœ‰çº¿ç¨‹è°ƒç”¨è¯¥åŠŸèƒ½ã€‚ å³ä½¿æ»‘åŠ¨çª—å£çš„å¤§å°ä¸º15ã€‚æ»‘åŠ¨çª—å£ä¹Ÿä¸æ„å‘³ç€ä»…å…è®¸15ä¸ªè°ƒç”¨å¹¶å‘è¿è¡Œã€‚ å¦‚æœè¦é™åˆ¶å¹¶å‘çº¿ç¨‹çš„æ•°é‡ï¼Œè¯·ä½¿ç”¨Bulkheadã€‚ æ‚¨å¯ä»¥ç»„åˆä½¿ç”¨Bulkheadå’ŒCircuitBreakerã€‚</p><p><strong>å•ä¸ªçº¿ç¨‹çš„ç¤ºæ„å›¾</strong></p><figure><img src="/assets/1621905043342-a94cf788-6465-4725-8411-c9d235694a40-BzSjXxDf.png" alt="img" tabindex="0" loading="lazy"><figcaption>img</figcaption></figure><p><strong>ä¸‰ä¸ªçº¿ç¨‹çš„ç¤ºæ„å›¾</strong></p><figure><img src="/assets/1621907196798-f3dc2a24-6363-48f5-a47b-cd4ca0728914-h7HJdWQL.png" alt="img" tabindex="0" loading="lazy"><figcaption>img</figcaption></figure><h2 id="å¦‚ä½•ä½¿ç”¨" tabindex="-1"><a class="header-anchor" href="#å¦‚ä½•ä½¿ç”¨"><span>å¦‚ä½•ä½¿ç”¨</span></a></h2><p>åŸºäºConcurrentHashMapçš„CircuitBreakerRegistryï¼Œå¯æä¾›çº¿ç¨‹å®‰å…¨æ€§å’ŒåŸå­æ€§ä¿è¯ã€‚ æ‚¨å¯ä»¥ä½¿ç”¨CircuitBreakerRegistryæ¥ç®¡ç†ï¼ˆåˆ›å»ºå’Œæ£€ç´¢ï¼‰CircuitBreakerå®ä¾‹ã€‚ æ‚¨å¯ä»¥ä¸ºæ‰€æœ‰CircuitBreakerå®ä¾‹åˆ›å»ºä¸€ä¸ªå…·æœ‰å…¨å±€é»˜è®¤CircuitBreakerConfigçš„CircuitBreakerRegistryï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token class-name">CircuitBreakerRegistry</span> circuitBreakerRegistry <span class="token operator">=</span> <span class="token class-name">CircuitBreakerRegistry</span><span class="token punctuation">.</span><span class="token function">ofDefaults</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><h3 id="æ–­è·¯å™¨é…ç½®" tabindex="-1"><a class="header-anchor" href="#æ–­è·¯å™¨é…ç½®"><span>æ–­è·¯å™¨é…ç½®</span></a></h3><p>æ‚¨å¯ä»¥æä¾›è‡ªå®šä¹‰çš„å…¨å±€CircuitBreakerConfigã€‚ ä¸ºäº†åˆ›å»ºå®šåˆ¶çš„å…¨å±€CircuitBreakerConfigï¼Œå¯ä»¥ä½¿ç”¨CircuitBreakerConfigæ„å»ºå™¨ã€‚ æ‚¨å¯ä»¥ä½¿ç”¨æ„å»ºå™¨æ¥é…ç½®ä»¥ä¸‹å±æ€§ã€‚</p><table><thead><tr><th>é…ç½®çš„å±æ€§</th><th>é»˜è®¤å€¼</th><th>æè¿°</th></tr></thead><tbody><tr><td>failureRateThreshold</td><td>50</td><td>ä»¥ç™¾åˆ†æ¯”é…ç½®æ•…éšœç‡é˜ˆå€¼ã€‚å½“æ•…éšœç‡ç­‰äºæˆ–å¤§äºé˜ˆå€¼æ—¶ï¼ŒCircuitBreakerè½¬æ¢ä¸ºæ‰“å¼€çŠ¶æ€ã€‚</td></tr><tr><td>slowCallRateThreshold</td><td>100</td><td>å½“callæŒç»­æ—¶é—´slowCallDurationThresholdæ—¶ï¼ŒCircuitBreakerä¼šå°†callè§†ä¸ºæ…¢é€Ÿcall å½“æ…¢é€Ÿcallçš„ç™¾åˆ†æ¯”ç­‰äºæˆ–å¤§äºé˜ˆå€¼æ—¶ï¼ŒCircuitBreakerè½¬æ¢ä¸ºæ‰“å¼€çŠ¶æ€</td></tr><tr><td>slowCallDurationThreshold</td><td>60000 [ms]</td><td>å½“callçš„è°ƒç”¨æ—¶é—´è¶…è¿‡æ”¹å€¼æ—¶ï¼Œè®¤ä¸ºæ—¶æ…¢é€Ÿçš„</td></tr><tr><td>permittedNumberOfCalls InHalfOpenState</td><td>10</td><td>é…ç½®CircuitBreakeråŠæ‰“å¼€æ—¶å…è®¸çš„callæ•°ã€‚</td></tr><tr><td>maxWaitDurationInHalfOpenState</td><td>0</td><td>è¯¥æ—¶é—´ç”¨äºæ§åˆ¶CircuitBreakeråœ¨åˆ‡æ¢åˆ°æ‰“å¼€ä¹‹å‰å¯ä»¥ä¿æŒåœ¨Half OpençŠ¶æ€çš„æœ€é•¿æ—¶é—´ã€‚å€¼0è¡¨ç¤ºæ–­è·¯å™¨å°†åœ¨HalfOpençŠ¶æ€ä¸‹æ— é™æœŸç­‰å¾…ï¼Œç›´åˆ°æ‰€æœ‰å…è®¸çš„callå®Œæˆã€‚</td></tr><tr><td>slidingWindowType</td><td>COUNT_BASED</td><td>é…ç½®æ»‘åŠ¨çª—å£çš„ç±»å‹ï¼Œå¦‚æœæ˜¯ COUNT_BASED, æœ€åçš„ slidingWindowSizeä¸ªcallè¢«è®°å½•å’Œæ±‡æ€»ï¼›å¦‚æœæ˜¯ TIME_BASED, æœ€åslidingWindowSizeç§’æ•°å†…çš„è¯·æ±‚è¢«è®°å½•å’Œæ±‡æ€»</td></tr><tr><td>slidingWindowSize</td><td>100</td><td>é…ç½®æ»‘åŠ¨çª—å£çš„å¤§å°ï¼Œè¯¥çª—å£ç”¨äºåœ¨CircuitBreakerå…³é—­æ—¶è®°å½•callç»“æœã€‚</td></tr><tr><td>minimumNumberOfCalls</td><td>100</td><td>é…ç½®CircuitBreakerå¯ä»¥è®¡ç®—é”™è¯¯ç‡æˆ–æ…¢é€Ÿå‘¼å«ç‡ä¹‹å‰æ‰€éœ€çš„æœ€å°å‘¼å«æ•°ï¼ˆæ¯ä¸ªæ»‘åŠ¨çª—å£æ—¶æ®µï¼‰ã€‚ä¾‹å¦‚ï¼Œå¦‚æœminimumNumberOfCallsä¸º10ï¼Œåˆ™å¿…é¡»è‡³å°‘è®°å½•10ä¸ªå‘¼å«ï¼Œç„¶åæ‰èƒ½è®¡ç®—å¤±è´¥ç‡ã€‚å¦‚æœä»…è®°å½•äº†9ä¸ªå‘¼å«ï¼Œåˆ™å³ä½¿æ‰€æœ‰9ä¸ªå‘¼å«å‡å¤±è´¥ï¼ŒCircuitBreakerä¹Ÿä¸ä¼šè½¬æ¢ä¸ºæ‰“å¼€ã€‚</td></tr><tr><td>waitDurationInOpenState</td><td>60000 [ms]</td><td>ä»æ–­å¼€åˆ°åŠå¼€ä¹‹å‰CircuitBreakeråº”è¯¥ç­‰å¾…çš„æ—¶é—´ã€‚</td></tr><tr><td>automaticTransition FromOpenToHalfOpenEnabled</td><td>false</td><td>å¦‚æœè®¾ç½®ä¸ºtrueï¼Œåˆ™æ„å‘³ç€CircuitBreakerå°†è‡ªåŠ¨ä»æ‰“å¼€çŠ¶æ€è½¬æ¢ä¸ºåŠæ‰“å¼€çŠ¶æ€ï¼Œä¸éœ€è¦è°ƒç”¨å³å¯è§¦å‘è¯¥è½¬æ¢ã€‚ ä¸€æ—¦waitDurationInOpenStateé€šè¿‡ï¼Œå°±ä¼šåˆ›å»ºä¸€ä¸ªçº¿ç¨‹æ¥ç›‘è§†CircuitBreakersçš„æ‰€æœ‰å®ä¾‹ï¼Œä»¥å°†å…¶è½¬æ¢ä¸ºHALF_OPENã€‚ è€Œå¦‚æœå°†å…¶è®¾ç½®ä¸ºfalseï¼Œåˆ™å³ä½¿åœ¨ä¼ é€’äº†waitDurationInOpenStateä¹‹åï¼Œä¹Ÿåªæœ‰åœ¨è¿›è¡Œè°ƒç”¨æ—¶æ‰å‘ç”Ÿå‘HALF_OPENçš„è½¬æ¢ã€‚ è¿™é‡Œçš„ä¼˜ç‚¹æ˜¯æ²¡æœ‰çº¿ç¨‹ç›‘è§†æ‰€æœ‰CircuitBreakersçš„çŠ¶æ€ã€‚</td></tr><tr><td>recordExceptions</td><td>empty</td><td>è®°å½•ä¸ºæ•…éšœçš„å¼‚å¸¸åˆ—è¡¨ã€‚ é™¤éé€šè¿‡ignoreExceptionsè¡¨æ˜ç¡®å¿½ç•¥ï¼Œå¦åˆ™ä»»ä½•ä¸åˆ—è¡¨ä¹‹ä¸€åŒ¹é…æˆ–ç»§æ‰¿çš„å¼‚å¸¸éƒ½å°†è§†ä¸ºå¤±è´¥ã€‚ å¦‚æœæŒ‡å®šignoreExceptionsä¾‹å¤–åˆ—è¡¨ï¼Œåˆ™æ‰€æœ‰å…¶ä»–ä¾‹å¤–éƒ½å°†è§†ä¸ºæˆåŠŸï¼Œé™¤éå®ƒä»¬è¢«æ˜¾å¼å¿½ç•¥</td></tr><tr><td>ignoreExceptions</td><td>empty</td><td>å¿½ç•¥çš„å¼‚å¸¸åˆ—è¡¨ï¼Œæ—¢ä¸ç®—ä½œå¤±è´¥ä¹Ÿä¸ç®—æˆåŠŸã€‚ ä»åˆ—è¡¨ä¹‹ä¸€åŒ¹é…æˆ–ç»§æ‰¿çš„ä»»ä½•å¼‚å¸¸éƒ½ä¸ä¼šè¢«è§†ä¸ºå¤±è´¥æˆ–æˆåŠŸï¼Œå³ä½¿è¯¥å¼‚å¸¸æ˜¯recordExceptionså…¶ä¸­çš„ä¸€éƒ¨åˆ†</td></tr><tr><td>recordException</td><td>throwable -&gt; true æ‰€æœ‰å¼‚å¸¸</td><td>ä¸€ä¸ªè‡ªå®šä¹‰è°“è¯ï¼Œç”¨äºè¯„ä¼°æ˜¯å¦åº”å°†å¼‚å¸¸è®°å½•ä¸ºå¤±è´¥ã€‚ å¦‚æœå¼‚å¸¸åº”è®¡ä¸ºå¤±è´¥ï¼Œåˆ™è°“è¯å¿…é¡»è¿”å›trueã€‚ é™¤éæˆåŠŸå°†ignoreExceptionså¼‚å¸¸æ˜¾å¼å¿½ç•¥ï¼Œå¦åˆ™åº”è¯¥ç®—æ˜¯æˆåŠŸ</td></tr><tr><td>ignoreException</td><td>throwable -&gt; false æ²¡æœ‰yi</td><td>ä¸€ä¸ªè‡ªå®šä¹‰è°“è¯ï¼Œç”¨äºè¯„ä¼°æ˜¯å¦åº”å¿½ç•¥å¼‚å¸¸ï¼Œå¹¶ä¸”è¯¥å¼‚å¸¸æ—¢ä¸ç®—ä½œå¤±è´¥ä¹Ÿä¸ç®—æˆåŠŸã€‚ å¦‚æœåº”å¿½ç•¥å¼‚å¸¸ï¼Œåˆ™è°“è¯å¿…é¡»è¿”å›trueã€‚ å¦‚æœå¼‚å¸¸åº”è®¡ä¸ºå¤±è´¥ï¼Œåˆ™è°“è¯å¿…é¡»è¿”å›falseã€‚</td></tr></tbody></table><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token comment">// è‡ªå®šä¹‰CircuitBreakerçš„é…ç½®</span>
<span class="token class-name">CircuitBreakerConfig</span> circuitBreakerConfig <span class="token operator">=</span> <span class="token class-name">CircuitBreakerConfig</span><span class="token punctuation">.</span><span class="token function">custom</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">failureRateThreshold</span><span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">slowCallRateThreshold</span><span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">waitDurationInOpenState</span><span class="token punctuation">(</span><span class="token class-name">Duration</span><span class="token punctuation">.</span><span class="token function">ofMillis</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">slowCallDurationThreshold</span><span class="token punctuation">(</span><span class="token class-name">Duration</span><span class="token punctuation">.</span><span class="token function">ofSeconds</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">permittedNumberOfCallsInHalfOpenState</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">minimumNumberOfCalls</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">slidingWindowType</span><span class="token punctuation">(</span><span class="token class-name">SlidingWindowType</span><span class="token punctuation">.</span><span class="token constant">TIME_BASED</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">slidingWindowSize</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">recordException</span><span class="token punctuation">(</span>e <span class="token operator">-&gt;</span> <span class="token constant">INTERNAL_SERVER_ERROR</span>
                 <span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token function">getResponse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">recordExceptions</span><span class="token punctuation">(</span><span class="token class-name">IOException</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token class-name">TimeoutException</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">ignoreExceptions</span><span class="token punctuation">(</span><span class="token class-name">BusinessException</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token class-name">OtherBusinessException</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// ä½¿ç”¨è‡ªå®šä¹‰é…ç½®åˆ›å»ºCircuitBreakerRegistry</span>
<span class="token class-name">CircuitBreakerRegistry</span> circuitBreakerRegistry <span class="token operator">=</span> 
  <span class="token class-name">CircuitBreakerRegistry</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span>circuitBreakerConfig<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// åˆ›å»ºé»˜è®¤çš„æ–­è·¯å™¨</span>
<span class="token class-name">CircuitBreaker</span> circuitBreakerWithDefaultConfig <span class="token operator">=</span> 
  circuitBreakerRegistry<span class="token punctuation">.</span><span class="token function">circuitBreaker</span><span class="token punctuation">(</span><span class="token string">&quot;name1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// è‡ªå®šä¹‰æ–­è·¯å™¨</span>
<span class="token class-name">CircuitBreaker</span> circuitBreakerWithCustomConfig <span class="token operator">=</span> circuitBreakerRegistry
  <span class="token punctuation">.</span><span class="token function">circuitBreaker</span><span class="token punctuation">(</span><span class="token string">&quot;name2&quot;</span><span class="token punctuation">,</span> circuitBreakerConfig<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>åˆ›å»ºç”±å¤šä¸ªå®ä¾‹å…±äº«çš„é…ç½®:</p><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token class-name">CircuitBreakerConfig</span> circuitBreakerConfig <span class="token operator">=</span> <span class="token class-name">CircuitBreakerConfig</span><span class="token punctuation">.</span><span class="token function">custom</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">failureRateThreshold</span><span class="token punctuation">(</span><span class="token number">70</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

circuitBreakerRegistry<span class="token punctuation">.</span><span class="token function">addConfiguration</span><span class="token punctuation">(</span><span class="token string">&quot;someSharedConfig&quot;</span><span class="token punctuation">,</span> config<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token class-name">CircuitBreaker</span> circuitBreaker <span class="token operator">=</span> circuitBreakerRegistry
  <span class="token punctuation">.</span><span class="token function">circuitBreaker</span><span class="token punctuation">(</span><span class="token string">&quot;name&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;someSharedConfig&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>è¦†ç›–é»˜è®¤é…ç½®:</p><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token class-name">CircuitBreakerConfig</span> defaultConfig <span class="token operator">=</span> circuitBreakerRegistry
   <span class="token punctuation">.</span><span class="token function">getDefaultConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token class-name">CircuitBreakerConfig</span> overwrittenConfig <span class="token operator">=</span> <span class="token class-name">CircuitBreakerConfig</span>
  <span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span>defaultConfig<span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">waitDurationInOpenState</span><span class="token punctuation">(</span><span class="token class-name">Duration</span><span class="token punctuation">.</span><span class="token function">ofSeconds</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>å¦‚æœæ‚¨ä¸æƒ³ä½¿ç”¨CircuitBreakerRegistryç®¡ç†CircuitBreakerå®ä¾‹ï¼Œä¹Ÿå¯ä»¥ç›´æ¥åˆ›å»ºå®ä¾‹:</p><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token comment">// Create a custom configuration for a CircuitBreaker</span>
<span class="token class-name">CircuitBreakerConfig</span> circuitBreakerConfig <span class="token operator">=</span> <span class="token class-name">CircuitBreakerConfig</span><span class="token punctuation">.</span><span class="token function">custom</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">recordExceptions</span><span class="token punctuation">(</span><span class="token class-name">IOException</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token class-name">TimeoutException</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">ignoreExceptions</span><span class="token punctuation">(</span><span class="token class-name">BusinessException</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token class-name">OtherBusinessException</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token class-name">CircuitBreaker</span> customCircuitBreaker <span class="token operator">=</span> <span class="token class-name">CircuitBreaker</span>
  <span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span><span class="token string">&quot;testName&quot;</span><span class="token punctuation">,</span> circuitBreakerConfig<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>æ‚¨è¿˜å¯ä»¥ä½¿ç”¨å…¶ç”Ÿæˆå™¨æ–¹æ³•åˆ›å»ºCircuitBreakerRegistryï¼š</p><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token class-name">Map</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> circuitBreakerTags <span class="token operator">=</span> <span class="token class-name">Map</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span><span class="token string">&quot;key1&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;value1&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;key2&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;value2&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token class-name">CircuitBreakerRegistry</span> circuitBreakerRegistry <span class="token operator">=</span> <span class="token class-name">CircuitBreakerRegistry</span><span class="token punctuation">.</span><span class="token function">custom</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">withCircuitBreakerConfig</span><span class="token punctuation">(</span><span class="token class-name">CircuitBreakerConfig</span><span class="token punctuation">.</span><span class="token function">ofDefaults</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">addRegistryEventConsumer</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">RegistryEventConsumer</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onEntryAddedEvent</span><span class="token punctuation">(</span><span class="token class-name">EntryAddedEvent</span> entryAddedEvent<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// implementation</span>
        <span class="token punctuation">}</span>
        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onEntryRemovedEvent</span><span class="token punctuation">(</span><span class="token class-name">EntryRemovedEvent</span> entryRemoveEvent<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// implementation</span>
        <span class="token punctuation">}</span>
        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onEntryReplacedEvent</span><span class="token punctuation">(</span><span class="token class-name">EntryReplacedEvent</span> entryReplacedEvent<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// implementation</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">withTags</span><span class="token punctuation">(</span>circuitBreakerTags<span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token class-name">CircuitBreaker</span> circuitBreaker <span class="token operator">=</span> circuitBreakerRegistry<span class="token punctuation">.</span><span class="token function">circuitBreaker</span><span class="token punctuation">(</span><span class="token string">&quot;testName&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>å¦‚æœè¦æ’å…¥è‡ªå·±çš„Registryå®ç°ï¼Œåˆ™å¯ä»¥æä¾›Interface RegistryStoreçš„è‡ªå®šä¹‰å®ç°ï¼Œå¹¶ä½¿ç”¨builderæ–¹æ³•æ’å…¥:</p><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token class-name">CircuitBreakerRegistry</span> registry <span class="token operator">=</span> <span class="token class-name">CircuitBreakerRegistry</span><span class="token punctuation">.</span><span class="token function">custom</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">withRegistryStore</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">YourRegistryStoreImplementation</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">withCircuitBreakerConfig</span><span class="token punctuation">(</span><span class="token class-name">CircuitBreakerConfig</span><span class="token punctuation">.</span><span class="token function">ofDefaults</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="ä½¿ç”¨æ–­è·¯å™¨è£…æ‰®å‡½æ•°å¹¶è°ƒç”¨" tabindex="-1"><a class="header-anchor" href="#ä½¿ç”¨æ–­è·¯å™¨è£…æ‰®å‡½æ•°å¹¶è°ƒç”¨"><span>ä½¿ç”¨æ–­è·¯å™¨è£…æ‰®å‡½æ•°å¹¶è°ƒç”¨</span></a></h3><p>æ‚¨å¯ä»¥ä½¿ç”¨CircuitBreakerè£…é¥°ä»»ä½•Callableï¼ŒSupplierï¼ŒRunnableï¼ŒConsumerï¼ŒCheckedRunnableï¼ŒCheckedSupplierï¼ŒCheckedConsumeræˆ–CompletionStageã€‚</p><p>æ‚¨å¯ä»¥ä½¿ç”¨Vavrä¸­çš„Try.ofï¼ˆ...ï¼‰æˆ–Try.runï¼ˆ...ï¼‰æ¥è°ƒç”¨ä¿®é¥°çš„å‡½æ•°ã€‚ è¿™å…è®¸ä½¿ç”¨mapï¼ŒflatMapï¼Œfilterï¼Œrecoveræˆ–andThené“¾æ¥å…¶ä»–åŠŸèƒ½ã€‚ ä»…å½“CircuitBreakerä¸ºCLOSEDæˆ–HALF_OPENæ—¶ï¼Œæ‰è°ƒç”¨é“¾æ¥å‡½æ•°ã€‚</p><p>åœ¨ä¸‹é¢çš„ç¤ºä¾‹ä¸­ï¼Œå¦‚æœå‡½æ•°è°ƒç”¨æˆåŠŸï¼Œåˆ™Try.ofï¼ˆ...ï¼‰è¿”å›<code>Success &lt;String&gt; Monad</code>ã€‚ å¦‚æœå‡½æ•°å¼•å‘å¼‚å¸¸ï¼Œåˆ™è¿”å›<code>Failure &lt;Throwable&gt; Monad</code>ï¼Œå¹¶ä¸”ä¸è°ƒç”¨mapã€‚</p><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token comment">// Given</span>
<span class="token class-name">CircuitBreaker</span> circuitBreaker <span class="token operator">=</span> <span class="token class-name">CircuitBreaker</span><span class="token punctuation">.</span><span class="token function">ofDefaults</span><span class="token punctuation">(</span><span class="token string">&quot;testName&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// When I decorate my function</span>
<span class="token class-name">CheckedFunction0</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> decoratedSupplier <span class="token operator">=</span> <span class="token class-name">CircuitBreaker</span>
        <span class="token punctuation">.</span><span class="token function">decorateCheckedSupplier</span><span class="token punctuation">(</span>circuitBreaker<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token string">&quot;This can be any method which returns: &#39;Hello&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// and chain an other function with map</span>
<span class="token class-name">Try</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> result <span class="token operator">=</span> <span class="token class-name">Try</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span>decoratedSupplier<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>value <span class="token operator">-&gt;</span> value <span class="token operator">+</span> <span class="token string">&quot; world&#39;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Then the Try Monad returns a Success&lt;String&gt;, if all functions ran successfully.</span>
<span class="token function">assertThat</span><span class="token punctuation">(</span>result<span class="token punctuation">.</span><span class="token function">isSuccess</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isTrue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">assertThat</span><span class="token punctuation">(</span>result<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isEqualTo</span><span class="token punctuation">(</span><span class="token string">&quot;This can be any method which returns: &#39;Hello world&#39;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>æ‚¨å¯ä»¥åœ¨CircuitBreakerRegistryä¸Šæ³¨å†Œäº‹ä»¶ä½¿ç”¨è€…ï¼Œå¹¶åœ¨æ¯æ¬¡åˆ›å»ºï¼Œæ›¿æ¢æˆ–åˆ é™¤CircuitBreakeræ—¶é‡‡å–æªæ–½ã€‚</p><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token class-name">CircuitBreakerRegistry</span> circuitBreakerRegistry <span class="token operator">=</span> <span class="token class-name">CircuitBreakerRegistry</span><span class="token punctuation">.</span><span class="token function">ofDefaults</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
circuitBreakerRegistry<span class="token punctuation">.</span><span class="token function">getEventPublisher</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">onEntryAdded</span><span class="token punctuation">(</span>entryAddedEvent <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
    <span class="token class-name">CircuitBreaker</span> addedCircuitBreaker <span class="token operator">=</span> entryAddedEvent<span class="token punctuation">.</span><span class="token function">getAddedEntry</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token constant">LOG</span><span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;CircuitBreaker {} added&quot;</span><span class="token punctuation">,</span> addedCircuitBreaker<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">onEntryRemoved</span><span class="token punctuation">(</span>entryRemovedEvent <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
    <span class="token class-name">CircuitBreaker</span> removedCircuitBreaker <span class="token operator">=</span> entryRemovedEvent<span class="token punctuation">.</span><span class="token function">getRemovedEntry</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token constant">LOG</span><span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;CircuitBreaker {} removed&quot;</span><span class="token punctuation">,</span> removedCircuitBreaker<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>CircuitBreakerEventå¯ä»¥æ˜¯çŠ¶æ€è½¬æ¢ï¼Œæ–­è·¯å™¨é‡ç½®ï¼ŒæˆåŠŸè°ƒç”¨ï¼Œè®°å½•çš„é”™è¯¯æˆ–å¿½ç•¥çš„é”™è¯¯ã€‚ æ‰€æœ‰äº‹ä»¶éƒ½åŒ…å«å…¶ä»–ä¿¡æ¯ï¼Œä¾‹å¦‚äº‹ä»¶åˆ›å»ºæ—¶é—´å’Œå‘¼å«çš„å¤„ç†æŒç»­æ—¶é—´ã€‚ å¦‚æœè¦ä½¿ç”¨äº‹ä»¶ï¼Œåˆ™å¿…é¡»æ³¨å†Œäº‹ä»¶ä½¿ç”¨è€…ã€‚</p><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code>circuitBreaker<span class="token punctuation">.</span><span class="token function">getEventPublisher</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">onSuccess</span><span class="token punctuation">(</span>event <span class="token operator">-&gt;</span> logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">onError</span><span class="token punctuation">(</span>event <span class="token operator">-&gt;</span> logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">onIgnoredError</span><span class="token punctuation">(</span>event <span class="token operator">-&gt;</span> logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">onReset</span><span class="token punctuation">(</span>event <span class="token operator">-&gt;</span> logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">onStateTransition</span><span class="token punctuation">(</span>event <span class="token operator">-&gt;</span> logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// Or if you want to register a consumer listening</span>
<span class="token comment">// to all events, you can do:</span>
circuitBreaker<span class="token punctuation">.</span><span class="token function">getEventPublisher</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">onEvent</span><span class="token punctuation">(</span>event <span class="token operator">-&gt;</span> logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>æ‚¨å¯ä»¥ä½¿ç”¨CircularEventConsumerå°†äº‹ä»¶å­˜å‚¨åœ¨å…·æœ‰å›ºå®šå®¹é‡çš„å¾ªç¯ç¼“å†²åŒºä¸­ã€‚</p><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token class-name">CircularEventConsumer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">CircuitBreakerEvent</span><span class="token punctuation">&gt;</span></span> ringBuffer <span class="token operator">=</span> 
  <span class="token keyword">new</span> <span class="token class-name">CircularEventConsumer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
circuitBreaker<span class="token punctuation">.</span><span class="token function">getEventPublisher</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">onEvent</span><span class="token punctuation">(</span>ringBuffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">CircuitBreakerEvent</span><span class="token punctuation">&gt;</span></span> bufferedEvents <span class="token operator">=</span> ringBuffer<span class="token punctuation">.</span><span class="token function">getBufferedEvents</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>æ‚¨å¯ä»¥ä½¿ç”¨RxJavaæˆ–RxJava2é€‚é…å™¨å°†EventPublisherè½¬æ¢ä¸ºå“åº”æµã€‚</p><p>æ‚¨å¯ä»¥é€šè¿‡è‡ªå®šä¹‰å®ç°è¦†ç›–å†…å­˜RegistryStoreã€‚ ä¾‹å¦‚ï¼Œå¦‚æœè¦ä½¿ç”¨åœ¨ä¸€å®šæ—¶é—´ååˆ é™¤æœªä½¿ç”¨å®ä¾‹çš„ç¼“å­˜ã€‚</p><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token class-name">CircuitBreakerRegistry</span> circuitBreakerRegistry <span class="token operator">=</span> <span class="token class-name">CircuitBreakerRegistry</span><span class="token punctuation">.</span><span class="token function">custom</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">withRegistryStore</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">CacheCircuitBreakerRegistryStore</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>å¦‚æœæ‚¨æƒ³åœ¨CircuitBreakerå°†å¼‚å¸¸è®°å½•ä¸ºå¤±è´¥ä¹‹åä»å¼‚å¸¸ä¸­æ¢å¤ï¼Œåˆ™å¯ä»¥é“¾æ¥<code>Try.recover</code>æ–¹æ³•ã€‚ ä»…å½“<code>Try.of</code>è¿”å›Failure <code>&lt;Throwable&gt; Monad</code>æ—¶ï¼Œæ‰è°ƒç”¨æ¢å¤æ–¹æ³•ã€‚</p><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token comment">// Given</span>
<span class="token class-name">CircuitBreaker</span> circuitBreaker <span class="token operator">=</span> <span class="token class-name">CircuitBreaker</span><span class="token punctuation">.</span><span class="token function">ofDefaults</span><span class="token punctuation">(</span><span class="token string">&quot;testName&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// When I decorate my function and invoke the decorated function</span>
<span class="token class-name">CheckedFunction0</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> checkedSupplier <span class="token operator">=</span>
  <span class="token class-name">CircuitBreaker</span><span class="token punctuation">.</span><span class="token function">decorateCheckedSupplier</span><span class="token punctuation">(</span>circuitBreaker<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">&quot;BAM!&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">Try</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> result <span class="token operator">=</span> <span class="token class-name">Try</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span>checkedSupplier<span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">recover</span><span class="token punctuation">(</span>throwable <span class="token operator">-&gt;</span> <span class="token string">&quot;Hello Recovery&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Then the function should be a success, </span>
<span class="token comment">// because the exception could be recovered</span>
<span class="token function">assertThat</span><span class="token punctuation">(</span>result<span class="token punctuation">.</span><span class="token function">isSuccess</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isTrue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// and the result must match the result of the recovery function.</span>
<span class="token function">assertThat</span><span class="token punctuation">(</span>result<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isEqualTo</span><span class="token punctuation">(</span><span class="token string">&quot;Hello Recovery&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>å¦‚æœè¦åœ¨CircuitBreakerå°†å¼‚å¸¸è®°å½•ä¸ºå¤±è´¥ä¹‹å‰ä»å¼‚å¸¸ä¸­æ¢å¤ï¼Œå¯ä»¥æ‰§è¡Œä»¥ä¸‹æ“ä½œï¼š</p><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token class-name">Supplier</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> supplier <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">&quot;BAM!&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token class-name">Supplier</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> supplierWithRecovery <span class="token operator">=</span> <span class="token class-name">SupplierUtils</span>
  <span class="token punctuation">.</span><span class="token function">recover</span><span class="token punctuation">(</span>supplier<span class="token punctuation">,</span> <span class="token punctuation">(</span>exception<span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token string">&quot;Hello Recovery&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token class-name">String</span> result <span class="token operator">=</span> circuitBreaker<span class="token punctuation">.</span><span class="token function">executeSupplier</span><span class="token punctuation">(</span>supplierWithRecovery<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">assertThat</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isEqualTo</span><span class="token punctuation">(</span><span class="token string">&quot;Hello Recovery&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>SupplierUtilså’ŒCallableUtilsåŒ…å«å…¶ä»–æ–¹æ³•ï¼Œä¾‹å¦‚andThenï¼Œå¯ä»¥é‡‡ç”¨è¿™äº›æ–¹æ³•æ¥é“¾æ¥å‡½æ•°ã€‚ ä¾‹å¦‚ï¼Œæ£€æŸ¥HTTPå“åº”çš„çŠ¶æ€ä»£ç ï¼Œä»¥ä¾¿å¯ä»¥å¼•å‘å¼‚å¸¸ã€‚</p><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token class-name">Supplier</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> supplierWithResultAndExceptionHandler <span class="token operator">=</span> <span class="token class-name">SupplierUtils</span>
  <span class="token punctuation">.</span><span class="token function">andThen</span><span class="token punctuation">(</span>supplier<span class="token punctuation">,</span> <span class="token punctuation">(</span>result<span class="token punctuation">,</span> exception<span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token string">&quot;Hello Recovery&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token class-name">Supplier</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">HttpResponse</span><span class="token punctuation">&gt;</span></span> supplier <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> httpClient<span class="token punctuation">.</span><span class="token function">doRemoteCall</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">Supplier</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">HttpResponse</span><span class="token punctuation">&gt;</span></span> supplierWithResultHandling <span class="token operator">=</span> <span class="token class-name">SupplierUtils</span><span class="token punctuation">.</span><span class="token function">andThen</span><span class="token punctuation">(</span>supplier<span class="token punctuation">,</span> result <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>result<span class="token punctuation">.</span><span class="token function">getStatusCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">400</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
       <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">ClientException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>result<span class="token punctuation">.</span><span class="token function">getStatusCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">500</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
       <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">ServerException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> result<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">HttpResponse</span> httpResponse <span class="token operator">=</span> circuitBreaker
  <span class="token punctuation">.</span><span class="token function">executeSupplier</span><span class="token punctuation">(</span>supplierWithResultHandling<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>æ–­è·¯å™¨æ”¯æŒé‡ç½®ä¸ºåŸå§‹çŠ¶æ€ï¼Œä¸¢å¤±æ‰€æœ‰æŒ‡æ ‡å¹¶æœ‰æ•ˆé‡ç½®å…¶æ»‘åŠ¨çª—å£ã€‚</p><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token class-name">CircuitBreaker</span> circuitBreaker <span class="token operator">=</span> <span class="token class-name">CircuitBreaker</span><span class="token punctuation">.</span><span class="token function">ofDefaults</span><span class="token punctuation">(</span><span class="token string">&quot;testName&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
circuitBreaker<span class="token punctuation">.</span><span class="token function">reset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p>æ‰‹åŠ¨è½¬æ¢ä¸ºçŠ¶æ€:</p><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token class-name">CircuitBreaker</span> circuitBreaker <span class="token operator">=</span> <span class="token class-name">CircuitBreaker</span><span class="token punctuation">.</span><span class="token function">ofDefaults</span><span class="token punctuation">(</span><span class="token string">&quot;testName&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
circuitBreaker<span class="token punctuation">.</span><span class="token function">transitionToDisabledState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// circuitBreaker.onFailure(...) won&#39;t trigger a state change</span>
circuitBreaker<span class="token punctuation">.</span><span class="token function">transitionToClosedState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// will transition to CLOSED state and re-enable normal behaviour, keeping metrics</span>
circuitBreaker<span class="token punctuation">.</span><span class="token function">transitionToForcedOpenState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// circuitBreaker.onSuccess(...) won&#39;t trigger a state change</span>
circuitBreaker<span class="token punctuation">.</span><span class="token function">reset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//  will transition to CLOSED state and re-enable normal behaviour, losing metrics</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h1 id="bulkhead" tabindex="-1"><a class="header-anchor" href="#bulkhead"><span>Bulkhead</span></a></h1><p>Resilience4j æä¾›äº†ä¸¤ç§æ–¹å¼å®ç°èˆ±å£æ¨¡å¼æ¥éš”ç¦»çº¿ç¨‹çš„æ‰§è¡Œï¼š</p><ul><li>SemaphoreBulkheadä½¿ç”¨ä¿¡å·é‡</li><li>FixedThreadPoolBulkhead ä½¿ç”¨æœ‰ç•Œé˜Ÿåˆ—å’Œå›ºå®šå¤§å°çš„çº¿ç¨‹æ± </li></ul><p>SemaphoreBulkheadåœ¨å„ç§çº¿ç¨‹å’ŒI/Oæ¨¡å‹ä¸Šéƒ½èƒ½å¾ˆå¥½åœ°å·¥ä½œã€‚ å®ƒåŸºäºä¿¡å·é‡ï¼Œä¸Hystrixä¸åŒï¼Œå®ƒä¸æä¾›â€œå½±å­â€çº¿ç¨‹æ± é€‰é¡¹ã€‚ ç”±å®¢æˆ·ç«¯æ¥ç¡®ä¿æ­£ç¡®çš„çº¿ç¨‹æ± å¤§å°ï¼ˆä¸é…ç½®ä¸€è‡´ï¼‰ã€‚</p><p>è·ŸCircuitBreaker æ¨¡å—ä¸€æ ·ï¼ŒBulkheadä¹Ÿæä¾›äº†åŸºäºå†…å­˜çš„BulkheadRegistry å’ŒThreadPoolBulkheadRegistry ï¼Œä½ å¯ä»¥ä½¿ç”¨ä»–ä»¬æ¥ç®¡ç†ï¼ˆåˆ›å»ºå’Œæ£€ç´¢ï¼‰Bulkhead å®ä¾‹ã€‚</p><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token class-name">BulkheadRegistry</span> bulkheadRegistry <span class="token operator">=</span> <span class="token class-name">BulkheadRegistry</span><span class="token punctuation">.</span><span class="token function">ofDefaults</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token class-name">ThreadPoolBulkheadRegistry</span> threadPoolBulkheadRegistry <span class="token operator">=</span> 
  <span class="token class-name">ThreadPoolBulkheadRegistry</span><span class="token punctuation">.</span><span class="token function">ofDefaults</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ä½ å¯ä»¥è‡ªå®šä¹‰å…¨å±€é…ç½®ï¼Œä½¿ç”¨BulkheadConfig æ„å»ºï¼Œç›¸å…³çš„å¯é…ç½®å±æ€§å¦‚ä¸‹ï¼š</p><table><thead><tr><th>å±æ€§</th><th>é»˜è®¤å€¼</th><th>æè¿°</th></tr></thead><tbody><tr><td>maxConcurrentCalls</td><td>25</td><td>æœ€å¤§çš„å¹¶è¡Œæ‰§è¡Œæ•°</td></tr><tr><td>maxWaitDuration</td><td>0</td><td>å°è¯•è¿›å…¥é¥±å’Œèˆ±å£æ—¶ï¼Œåº”é˜»å¡çº¿ç¨‹çš„æœ€é•¿æ—¶é—´ã€‚</td></tr></tbody></table><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token comment">// Create a custom configuration for a Bulkhead</span>
<span class="token class-name">BulkheadConfig</span> config <span class="token operator">=</span> <span class="token class-name">BulkheadConfig</span><span class="token punctuation">.</span><span class="token function">custom</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">maxConcurrentCalls</span><span class="token punctuation">(</span><span class="token number">150</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">maxWaitDuration</span><span class="token punctuation">(</span><span class="token class-name">Duration</span><span class="token punctuation">.</span><span class="token function">ofMillis</span><span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Create a BulkheadRegistry with a custom global configuration</span>
<span class="token class-name">BulkheadRegistry</span> registry <span class="token operator">=</span> <span class="token class-name">BulkheadRegistry</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Get or create a Bulkhead from the registry - </span>
<span class="token comment">// bulkhead will be backed by the default config</span>
<span class="token class-name">Bulkhead</span> bulkheadWithDefaultConfig <span class="token operator">=</span> registry<span class="token punctuation">.</span><span class="token function">bulkhead</span><span class="token punctuation">(</span><span class="token string">&quot;name1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Get or create a Bulkhead from the registry, </span>
<span class="token comment">// use a custom configuration when creating the bulkhead</span>
<span class="token class-name">Bulkhead</span> bulkheadWithCustomConfig <span class="token operator">=</span> registry<span class="token punctuation">.</span><span class="token function">bulkhead</span><span class="token punctuation">(</span><span class="token string">&quot;name2&quot;</span><span class="token punctuation">,</span> custom<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ThreadPoolBulkheadé…ç½®çš„å±æ€§æœ‰æ‰€ä¸åŒï¼Œä½¿ç”¨ThreadPoolBulkheadConfig æ„å»ºé…ç½®é¡¹ï¼Œå±æ€§åˆ—è¡¨å¦‚ä¸‹ï¼š</p><table><thead><tr><th>é…ç½®å±æ€§</th><th>é»˜è®¤å€¼</th><th>æè¿°</th></tr></thead><tbody><tr><td>maxThreadPoolSize</td><td>Runtime.getRuntime() .availableProcessors()</td><td>çº¿ç¨‹æ± çš„æœ€å¤§å¤§å°</td></tr><tr><td>coreThreadPoolSize</td><td>Runtime.getRuntime() .availableProcessors() - 1</td><td>çº¿ç¨‹æ± çš„æ ¸å¿ƒå¤§å°</td></tr><tr><td>queueCapacity</td><td>100</td><td>ç­‰å¾…é˜Ÿåˆ—çš„å®¹é‡</td></tr><tr><td>keepAliveDuration</td><td>20 [ms]</td><td>å½“çº¿ç¨‹æ•°å¤§äºå†…æ ¸æ•°æ—¶ï¼Œè¿™æ˜¯å¤šä½™çš„ç©ºé—²çº¿ç¨‹æœ€å¤§ç©ºé—²æ—¶é—´</td></tr></tbody></table><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token class-name">ThreadPoolBulkheadConfig</span> config <span class="token operator">=</span> <span class="token class-name">ThreadPoolBulkheadConfig</span><span class="token punctuation">.</span><span class="token function">custom</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">maxThreadPoolSize</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">coreThreadPoolSize</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">queueCapacity</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        
<span class="token comment">// Create a BulkheadRegistry with a custom global configuration</span>
<span class="token class-name">ThreadPoolBulkheadRegistry</span> registry <span class="token operator">=</span> <span class="token class-name">ThreadPoolBulkheadRegistry</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Get or create a ThreadPoolBulkhead from the registry - </span>
<span class="token comment">// bulkhead will be backed by the default config</span>
<span class="token class-name">ThreadPoolBulkhead</span> bulkheadWithDefaultConfig <span class="token operator">=</span> registry<span class="token punctuation">.</span><span class="token function">bulkhead</span><span class="token punctuation">(</span><span class="token string">&quot;name1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Get or create a Bulkhead from the registry, </span>
<span class="token comment">// use a custom configuration when creating the bulkhead</span>
<span class="token class-name">ThreadPoolBulkheadConfig</span> custom <span class="token operator">=</span> <span class="token class-name">BulkheadConfig</span><span class="token punctuation">.</span><span class="token function">custom</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">maxThreadPoolSize</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token class-name">ThreadPoolBulkhead</span> bulkheadWithCustomConfig <span class="token operator">=</span> registry<span class="token punctuation">.</span><span class="token function">bulkhead</span><span class="token punctuation">(</span><span class="token string">&quot;name2&quot;</span><span class="token punctuation">,</span> custom<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>å¯ä»¥çŒœåˆ°ï¼ŒBulkheadå…·æœ‰å„ç§ç±»ä¼¼äºCircuitBreakerçš„é«˜é˜¶è£…é¥°å™¨åŠŸèƒ½ã€‚ æ‚¨å¯ä»¥ç”¨éš”æ¿è£…é¥°ä»»ä½•Callableï¼ŒSupplierï¼ŒRunnableï¼ŒConsumerï¼ŒCheckedRunnableï¼ŒCheckedSupplierï¼ŒCheckedConsumeræˆ–CompletionStageã€‚</p><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token comment">// Given</span>
<span class="token class-name">Bulkhead</span> bulkhead <span class="token operator">=</span> <span class="token class-name">Bulkhead</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span><span class="token string">&quot;name&quot;</span><span class="token punctuation">,</span> config<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// When I decorate my function</span>
<span class="token class-name">CheckedFunction0</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> decoratedSupplier <span class="token operator">=</span> <span class="token class-name">Bulkhead</span>
  <span class="token punctuation">.</span><span class="token function">decorateCheckedSupplier</span><span class="token punctuation">(</span>bulkhead<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token string">&quot;This can be any method which returns: &#39;Hello&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// and chain an other function with map</span>
<span class="token class-name">Try</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> result <span class="token operator">=</span> <span class="token class-name">Try</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span>decoratedSupplier<span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>value <span class="token operator">-&gt;</span> value <span class="token operator">+</span> <span class="token string">&quot; world&#39;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Then the Try Monad returns a Success&lt;String&gt;, if all functions ran successfully.</span>
<span class="token function">assertThat</span><span class="token punctuation">(</span>result<span class="token punctuation">.</span><span class="token function">isSuccess</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isTrue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">assertThat</span><span class="token punctuation">(</span>result<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isEqualTo</span><span class="token punctuation">(</span><span class="token string">&quot;This can be any method which returns: &#39;Hello world&#39;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">assertThat</span><span class="token punctuation">(</span>bulkhead<span class="token punctuation">.</span><span class="token function">getMetrics</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getAvailableConcurrentCalls</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isEqualTo</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">ThreadPoolBulkheadConfig</span> config <span class="token operator">=</span> <span class="token class-name">ThreadPoolBulkheadConfig</span><span class="token punctuation">.</span><span class="token function">custom</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">maxThreadPoolSize</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">coreThreadPoolSize</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">queueCapacity</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token class-name">ThreadPoolBulkhead</span> bulkhead <span class="token operator">=</span> <span class="token class-name">ThreadPoolBulkhead</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span><span class="token string">&quot;name&quot;</span><span class="token punctuation">,</span> config<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token class-name">CompletionStage</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> supplier <span class="token operator">=</span> <span class="token class-name">ThreadPoolBulkhead</span>
    <span class="token punctuation">.</span><span class="token function">executeSupplier</span><span class="token punctuation">(</span>bulkhead<span class="token punctuation">,</span> backendService<span class="token operator">::</span><span class="token function">doSomething</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>æ‚¨å¯ä»¥åœ¨BulkheadRegistryä¸Šæ³¨å†Œäº‹ä»¶ä½¿ç”¨è€…ï¼Œå¹¶åœ¨åˆ›å»ºï¼Œæ›¿æ¢æˆ–åˆ é™¤Bulkheadæ—¶æ‰§è¡Œæ“ä½œã€‚</p><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token class-name">BulkheadRegistry</span> registry <span class="token operator">=</span> <span class="token class-name">BulkheadRegistry</span><span class="token punctuation">.</span><span class="token function">ofDefaults</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
registry<span class="token punctuation">.</span><span class="token function">getEventPublisher</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">onEntryAdded</span><span class="token punctuation">(</span>entryAddedEvent <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
    <span class="token class-name">Bulkhead</span> addedBulkhead <span class="token operator">=</span> entryAddedEvent<span class="token punctuation">.</span><span class="token function">getAddedEntry</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token constant">LOG</span><span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;Bulkhead {} added&quot;</span><span class="token punctuation">,</span> addedBulkhead<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">onEntryRemoved</span><span class="token punctuation">(</span>entryRemovedEvent <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
    <span class="token class-name">Bulkhead</span> removedBulkhead <span class="token operator">=</span> entryRemovedEvent<span class="token punctuation">.</span><span class="token function">getRemovedEntry</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token constant">LOG</span><span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;Bulkhead {} removed&quot;</span><span class="token punctuation">,</span> removedBulkhead<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>BulkHeadå‘å‡ºBulkHeadEventsæµã€‚ å‘å‡ºä¸¤ç§ç±»å‹çš„äº‹ä»¶ï¼šå…è®¸æ‰§è¡Œï¼Œæ‹’ç»æ‰§è¡Œå’Œå®Œæˆæ‰§è¡Œã€‚ å¦‚æœè¦ä½¿ç”¨è¿™äº›äº‹ä»¶ï¼Œåˆ™å¿…é¡»æ³¨å†Œä¸€ä¸ªäº‹ä»¶ä½¿ç”¨è€…ã€‚</p><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code>bulkhead<span class="token punctuation">.</span><span class="token function">getEventPublisher</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">onCallPermitted</span><span class="token punctuation">(</span>event <span class="token operator">-&gt;</span> logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">onCallRejected</span><span class="token punctuation">(</span>event <span class="token operator">-&gt;</span> logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">onCallFinished</span><span class="token punctuation">(</span>event <span class="token operator">-&gt;</span> logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h1 id="timelimiter" tabindex="-1"><a class="header-anchor" href="#timelimiter"><span>TimeLimiter</span></a></h1><p>è¶…æ—¶å™¨ï¼Œè·Ÿæ–­è·¯å™¨ä¸€æ ·ï¼Œæä¾›äº†åŸºäºå†…å­˜çš„TimeLimiterRegistry ï¼Œå¯ä»¥ä½¿ç”¨è¯¥å®ä¾‹ç®¡ç†TimeLimiter</p><p>TimeLimiterRegistry timeLimiterRegistry = TimeLimiterRegistry.ofDefaults();</p><p>ä½¿ç”¨TimeLimiterConfigè‡ªå®šä¹‰è¶…æ—¶å™¨çš„é…ç½®ï¼Œå¯ä»¥é…ç½®çš„å†…å®¹æœ‰ä¸¤ç§ï¼š</p><p>* è¶…æ—¶æ—¶é—´</p><p>* æ˜¯å¦è°ƒç”¨cancle</p><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code>
<span class="token class-name">TimeLimiterConfig</span> config <span class="token operator">=</span> <span class="token class-name">TimeLimiterConfig</span><span class="token punctuation">.</span><span class="token function">custom</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

 <span class="token punctuation">.</span><span class="token function">cancelRunningFuture</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span>

 <span class="token punctuation">.</span><span class="token function">timeoutDuration</span><span class="token punctuation">(</span><span class="token class-name">Duration</span><span class="token punctuation">.</span><span class="token function">ofMillis</span><span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

 <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Create a TimeLimiterRegistry with a custom global configuration</span>

<span class="token class-name">TimeLimiterRegistry</span> timeLimiterRegistry <span class="token operator">=</span> <span class="token class-name">TimeLimiterRegistry</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Get or create a TimeLimiter from the registry - </span>

<span class="token comment">// TimeLimiter will be backed by the default config</span>

<span class="token class-name">TimeLimiter</span> timeLimiterWithDefaultConfig <span class="token operator">=</span> registry<span class="token punctuation">.</span><span class="token function">timeLimiter</span><span class="token punctuation">(</span><span class="token string">&quot;name1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Get or create a TimeLimiter from the registry, </span>

<span class="token comment">// use a custom configuration when creating the TimeLimiter</span>

<span class="token class-name">TimeLimiterConfig</span> config <span class="token operator">=</span> <span class="token class-name">TimeLimiterConfig</span><span class="token punctuation">.</span><span class="token function">custom</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

 <span class="token punctuation">.</span><span class="token function">cancelRunningFuture</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span>

 <span class="token punctuation">.</span><span class="token function">timeoutDuration</span><span class="token punctuation">(</span><span class="token class-name">Duration</span><span class="token punctuation">.</span><span class="token function">ofMillis</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

 <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token class-name">TimeLimiter</span> timeLimiterWithCustomConfig <span class="token operator">=</span> registry<span class="token punctuation">.</span><span class="token function">timeLimiter</span><span class="token punctuation">(</span><span class="token string">&quot;name2&quot;</span><span class="token punctuation">,</span> config<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token class-name">TimeLimiter</span>å…·æœ‰è¾ƒé«˜é˜¶çš„è£…é¥°å™¨å‡½æ•°æ¥è£…é¥°<span class="token class-name">CompletionStage</span>æˆ–<span class="token class-name">Future</span>ï¼Œä»¥é™åˆ¶æ‰§è¡Œæ—¶é—´ã€‚



<span class="token comment">// Given I have a helloWorldService.sayHelloWorld() method which takes too long</span>

<span class="token class-name">HelloWorldService</span> helloWorldService <span class="token operator">=</span> <span class="token function">mock</span><span class="token punctuation">(</span><span class="token class-name">HelloWorldService</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Create a TimeLimiter</span>

<span class="token class-name">TimeLimiter</span> timeLimiter <span class="token operator">=</span> <span class="token class-name">TimeLimiter</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span><span class="token class-name">Duration</span><span class="token punctuation">.</span><span class="token function">ofSeconds</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// The Scheduler is needed to schedule a timeout on a non-blocking CompletableFuture</span>

<span class="token class-name">ScheduledExecutorService</span> scheduler <span class="token operator">=</span> <span class="token class-name">Executors</span><span class="token punctuation">.</span><span class="token function">newScheduledThreadPool</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// The non-blocking variant with a CompletableFuture</span>

<span class="token class-name">CompletableFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> result <span class="token operator">=</span> timeLimiter<span class="token punctuation">.</span><span class="token function">executeCompletionStage</span><span class="token punctuation">(</span>

 scheduler<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token class-name">CompletableFuture</span><span class="token punctuation">.</span><span class="token function">supplyAsync</span><span class="token punctuation">(</span>helloWorldService<span class="token operator">::</span><span class="token function">sayHelloWorld</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toCompletableFuture</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// The blocking variant which is basically future.get(timeoutDuration, MILLISECONDS)</span>

<span class="token class-name">String</span> result <span class="token operator">=</span> timeLimiter<span class="token punctuation">.</span><span class="token function">executeFutureSupplier</span><span class="token punctuation">(</span>

 <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token class-name">CompletableFuture</span><span class="token punctuation">.</span><span class="token function">supplyAsync</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> helloWorldService<span class="token operator">::</span><span class="token function">sayHelloWorld</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h1 id="ç¼“å­˜" tabindex="-1"><a class="header-anchor" href="#ç¼“å­˜"><span>ç¼“å­˜</span></a></h1><p>ä»¥ä¸‹ç¤ºä¾‹æ˜¾ç¤ºå¦‚ä½•ä½¿ç”¨CacheæŠ½è±¡è£…é¥°lambdaè¡¨è¾¾å¼ã€‚ ç¼“å­˜æŠ½è±¡å°†lambdaè¡¨è¾¾å¼çš„ç»“æœæ”¾å…¥ç¼“å­˜å®ä¾‹ï¼ˆJCacheï¼‰ä¸­ï¼Œå¹¶åœ¨è°ƒç”¨lambdaè¡¨è¾¾å¼ä¹‹å‰å°è¯•ä»ç¼“å­˜ä¸­æ£€ç´¢ä»¥å‰çš„ç¼“å­˜ç»“æœã€‚ å¦‚æœä»åˆ†å¸ƒå¼ç¼“å­˜ä¸­æ£€ç´¢ç¼“å­˜å¤±è´¥ï¼Œåˆ™ä¼šå¤„ç†è¯¥å¼‚å¸¸å¹¶è°ƒç”¨lambdaè¡¨è¾¾å¼ã€‚</p><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token comment">// Create a CacheContext by wrapping a JCache instance.</span>

<span class="token class-name"><span class="token namespace">javax<span class="token punctuation">.</span>cache<span class="token punctuation">.</span></span>Cache</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> cacheInstance <span class="token operator">=</span> <span class="token class-name">Caching</span>

  <span class="token punctuation">.</span><span class="token function">getCache</span><span class="token punctuation">(</span><span class="token string">&quot;cacheName&quot;</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token class-name">Cache</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> cacheContext <span class="token operator">=</span> <span class="token class-name">Cache</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span>cacheInstance<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Decorate your call to BackendService.doSomething()</span>

<span class="token class-name">CheckedFunction1</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> cachedFunction <span class="token operator">=</span> <span class="token class-name">Decorators</span>

   <span class="token punctuation">.</span><span class="token function">ofCheckedSupplier</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> backendService<span class="token punctuation">.</span><span class="token function">doSomething</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

   <span class="token punctuation">.</span><span class="token function">withCache</span><span class="token punctuation">(</span>cacheContext<span class="token punctuation">)</span>

   <span class="token punctuation">.</span><span class="token function">decorate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token class-name">String</span> value <span class="token operator">=</span> <span class="token class-name">Try</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> cachedFunction<span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span><span class="token string">&quot;cacheKey&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ç¼“å­˜å‘å‡ºCacheEventsæµã€‚ äº‹ä»¶å¯ä»¥æ˜¯é«˜é€Ÿç¼“å­˜å‘½ä¸­ï¼Œé«˜é€Ÿç¼“å­˜æœªå‘½ä¸­æˆ–é”™è¯¯ã€‚</p><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code>cacheContext<span class="token punctuation">.</span><span class="token function">getEventPublisher</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

   <span class="token punctuation">.</span><span class="token function">onCacheHit</span><span class="token punctuation">(</span>event <span class="token operator">-&gt;</span> logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

   <span class="token punctuation">.</span><span class="token function">onCacheMiss</span><span class="token punctuation">(</span>event <span class="token operator">-&gt;</span> logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

   <span class="token punctuation">.</span><span class="token function">onError</span><span class="token punctuation">(</span>event <span class="token operator">-&gt;</span> logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token class-name">Ehcache</span> ä½¿ç”¨å®ä¾‹ï¼š

compile &#39;org<span class="token punctuation">.</span>ehcache<span class="token operator">:</span>ehcache<span class="token operator">:</span><span class="token number">3.7</span><span class="token number">.1</span>&#39;

 

<span class="token comment">// Configure a cache (once)</span>

<span class="token keyword">this</span><span class="token punctuation">.</span>cacheManager <span class="token operator">=</span> <span class="token class-name">Caching</span><span class="token punctuation">.</span><span class="token function">getCachingProvider</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getCacheManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">this</span><span class="token punctuation">.</span>cache <span class="token operator">=</span> <span class="token class-name">Cache</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span>cacheManager

   <span class="token punctuation">.</span><span class="token function">createCache</span><span class="token punctuation">(</span><span class="token string">&quot;booksCache&quot;</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">MutableConfiguration</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Get books using a cache</span>

<span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Book</span><span class="token punctuation">&gt;</span></span> books <span class="token operator">=</span> <span class="token class-name">Cache</span><span class="token punctuation">.</span><span class="token function">decorateSupplier</span><span class="token punctuation">(</span>cache<span class="token punctuation">,</span> library<span class="token operator">::</span><span class="token function">getBooks</span><span class="token punctuation">)</span>

   <span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span><span class="token constant">BOOKS_CACHE_KEY</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ä¸å»ºè®®åœ¨ç”Ÿäº§ç¯å¢ƒä¸­ä½¿ç”¨JCacheå‚è€ƒå®ç°ï¼Œå› ä¸ºå®ƒä¼šå¯¼è‡´ä¸€äº›å¹¶å‘é—®é¢˜ã€‚ ä½¿ç”¨Ehcacheï¼ŒCaffeineï¼ŒRedissonï¼ŒHazelcastï¼ŒIgniteæˆ–å…¶ä»–JCacheå®ç°ã€‚</p><h1 id="é‡è¯•" tabindex="-1"><a class="header-anchor" href="#é‡è¯•"><span>é‡è¯•</span></a></h1><p>åƒæ–­è·¯å™¨ä¸€æ ·ï¼Œæä¾›äº†åŸºäºå†…å­˜çš„RetryRegistry ï¼š</p><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token class-name">RetryRegistry</span> retryRegistry <span class="token operator">=</span> <span class="token class-name">RetryRegistry</span><span class="token punctuation">.</span><span class="token function">ofDefaults</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><table><thead><tr><th>å±æ€§</th><th>é»˜è®¤å€¼</th><th>æè¿°</th></tr></thead><tbody><tr><td>maxAttempts</td><td>3</td><td>æœ€å¤§å°è¯•æ¬¡æ•°ï¼ˆé¦–æ¬¡è°ƒç”¨ä¹Ÿè¢«ç®—ä½œä¸€æ¬¡ï¼‰</td></tr><tr><td>waitDuration</td><td>500 [ms]</td><td>é‡è¯•ä¹‹é—´çš„å›ºå®šç­‰å¾…æ—¶é—´</td></tr><tr><td>intervalFunction</td><td>numOfAttempts -&gt; waitDuration</td><td>å‘ç”Ÿæ•…éšœåä¿®æ”¹ç­‰å¾…é—´éš”çš„åŠŸèƒ½ã€‚ é»˜è®¤æƒ…å†µä¸‹ï¼Œç­‰å¾…æ—¶é—´ä¿æŒä¸å˜ã€‚</td></tr><tr><td>intervalBiFunction</td><td><code> (numOfAttempts, Either&lt;throwable, result) -&gt; waitDuration</code></td><td>æ ¹æ®å°è¯•æ¬¡æ•°å’Œç»“æœæˆ–å¼‚å¸¸ä¿®æ”¹å¤±è´¥åçš„ç­‰å¾…é—´éš”çš„åŠŸèƒ½ã€‚ ä¸intervalFunctionä¸€èµ·ä½¿ç”¨æ—¶ï¼Œå°†æŠ›å‡ºIllegalStateExceptionã€‚</td></tr><tr><td>retryOnResultPredicate</td><td>result -&gt; false</td><td>é…ç½®ä¸€ä¸ªè°“è¯ï¼Œè¯¥è°“è¯è¯„ä¼°æ˜¯å¦åº”é‡è¯•ç»“æœã€‚ å¦‚æœè¦é‡è¯•ç»“æœï¼Œåˆ™è°“è¯å¿…é¡»è¿”å›trueï¼Œå¦åˆ™å¿…é¡»è¿”å›falseã€‚</td></tr><tr><td>retryOnExceptionPredicate</td><td>throwable -&gt; true</td><td>é…ç½®ä¸€ä¸ªè°“è¯ï¼Œè¯¥è°“è¯è¯„ä¼°æ˜¯å¦åº”é‡è¯•å¼‚å¸¸ã€‚ å¦‚æœåº”é‡è¯•å¼‚å¸¸ï¼Œåˆ™è°“è¯å¿…é¡»è¿”å›trueï¼Œå¦åˆ™å¿…é¡»è¿”å›falseã€‚</td></tr><tr><td>retryExceptions</td><td>empty</td><td>é…ç½®Throwableç±»çš„åˆ—è¡¨ï¼Œè¿™äº›ç±»è¢«è®°å½•ä¸ºå¤±è´¥å¹¶å› æ­¤è¢«é‡è¯•ã€‚ æ­¤å‚æ•°æ”¯æŒå­ç±»å‹ã€‚ æ³¨æ„ï¼šå¦‚æœä½¿ç”¨çš„æ˜¯Checked Exceptionï¼Œåˆ™å¿…é¡»ä½¿ç”¨CheckedSupplier</td></tr><tr><td>ignoreExceptions</td><td>empty</td><td>é…ç½®è¢«å¿½ç•¥å› è€Œä¸ä¼šé‡è¯•çš„Throwableç±»çš„åˆ—è¡¨ã€‚ æ­¤å‚æ•°æ”¯æŒå­ç±»å‹ã€‚</td></tr><tr><td>failAfterMaxRetries</td><td>false</td><td>å½“é‡è¯•å·²è¾¾åˆ°é…ç½®çš„maxAttemptsä¸”ç»“æœä»æœªé€šè¿‡retryOnResultPredicateæ—¶ï¼Œå¯ç”¨æˆ–ç¦ç”¨æŠ›å‡ºMaxRetriesExceededExceptionçš„å¸ƒå°”å€¼</td></tr></tbody></table><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token class-name">RetryConfig</span> config <span class="token operator">=</span> <span class="token class-name">RetryConfig</span><span class="token punctuation">.</span><span class="token function">custom</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">maxAttempts</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">waitDuration</span><span class="token punctuation">(</span><span class="token class-name">Duration</span><span class="token punctuation">.</span><span class="token function">ofMillis</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">retryOnResult</span><span class="token punctuation">(</span>response <span class="token operator">-&gt;</span> response<span class="token punctuation">.</span><span class="token function">getStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">500</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">retryOnException</span><span class="token punctuation">(</span>e <span class="token operator">-&gt;</span> e <span class="token keyword">instanceof</span> <span class="token class-name">WebServiceException</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">retryExceptions</span><span class="token punctuation">(</span><span class="token class-name">IOException</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token class-name">TimeoutException</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">ignoreExceptions</span><span class="token punctuation">(</span><span class="token class-name">BusinessException</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token class-name">OtherBusinessException</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">failAfterMaxAttempts</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// Create a RetryRegistry with a custom global configuration</span>
<span class="token class-name">RetryRegistry</span> registry <span class="token operator">=</span> <span class="token class-name">RetryRegistry</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// Get or create a Retry from the registry - </span>
<span class="token comment">// Retry will be backed by the default config</span>
<span class="token class-name">Retry</span> retryWithDefaultConfig <span class="token operator">=</span> registry<span class="token punctuation">.</span><span class="token function">retry</span><span class="token punctuation">(</span><span class="token string">&quot;name1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// Get or create a Retry from the registry, </span>
<span class="token comment">// use a custom configuration when creating the retry</span>
<span class="token class-name">RetryConfig</span> custom <span class="token operator">=</span> <span class="token class-name">RetryConfig</span><span class="token punctuation">.</span><span class="token function">custom</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">waitDuration</span><span class="token punctuation">(</span><span class="token class-name">Duration</span><span class="token punctuation">.</span><span class="token function">ofMillis</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">Retry</span> retryWithCustomConfig <span class="token operator">=</span> registry<span class="token punctuation">.</span><span class="token function">retry</span><span class="token punctuation">(</span><span class="token string">&quot;name2&quot;</span><span class="token punctuation">,</span> custom<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>å¯ä»¥çŒœåˆ°ï¼Œé‡è¯•å…·æœ‰å„ç§é«˜çº§è£…é¥°å™¨åŠŸèƒ½ï¼Œå°±åƒCircuitBreakerä¸€æ ·ã€‚ æ‚¨å¯ä»¥ä½¿ç”¨é‡è¯•è£…é¥°ä»»ä½•Callableï¼ŒSupplierï¼ŒRunnableï¼ŒConsumerï¼ŒCheckedRunnableï¼ŒCheckedSupplierï¼ŒCheckedConsumeræˆ–CompletionStageã€‚</p><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token comment">// Given I have a HelloWorldService which throws an exception</span>
<span class="token class-name">HelloWorldService</span>  helloWorldService <span class="token operator">=</span> <span class="token function">mock</span><span class="token punctuation">(</span><span class="token class-name">HelloWorldService</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">given</span><span class="token punctuation">(</span>helloWorldService<span class="token punctuation">.</span><span class="token function">sayHelloWorld</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">willThrow</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">WebServiceException</span><span class="token punctuation">(</span><span class="token string">&quot;BAM!&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// Create a Retry with default configuration</span>
<span class="token class-name">Retry</span> retry <span class="token operator">=</span> <span class="token class-name">Retry</span><span class="token punctuation">.</span><span class="token function">ofDefaults</span><span class="token punctuation">(</span><span class="token string">&quot;id&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// Decorate the invocation of the HelloWorldService</span>
<span class="token class-name">CheckedFunction0</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> retryableSupplier <span class="token operator">=</span> <span class="token class-name">Retry</span>
  <span class="token punctuation">.</span><span class="token function">decorateCheckedSupplier</span><span class="token punctuation">(</span>retry<span class="token punctuation">,</span> helloWorldService<span class="token operator">::</span><span class="token function">sayHelloWorld</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// When I invoke the function</span>
<span class="token class-name">Try</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> result <span class="token operator">=</span> <span class="token class-name">Try</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span>retryableSupplier<span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">recover</span><span class="token punctuation">(</span><span class="token punctuation">(</span>throwable<span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token string">&quot;Hello world from recovery function&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// Then the helloWorldService should be invoked 3 times</span>
<span class="token class-name">BDDMockito</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>helloWorldService<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">should</span><span class="token punctuation">(</span><span class="token function">times</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">sayHelloWorld</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// and the exception should be handled by the recovery function</span>
<span class="token function">assertThat</span><span class="token punctuation">(</span>result<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isEqualTo</span><span class="token punctuation">(</span><span class="token string">&quot;Hello world from recovery function&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>æ‚¨å¯ä»¥åœ¨RetryRegistryä¸Šæ³¨å†Œäº‹ä»¶ä½¿ç”¨è€…ï¼Œå¹¶åœ¨åˆ›å»ºï¼Œæ›¿æ¢æˆ–åˆ é™¤é‡è¯•æ—¶æ‰§è¡Œæ“ä½œã€‚</p><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token class-name">RetryRegistry</span> registry <span class="token operator">=</span> <span class="token class-name">RetryRegistry</span><span class="token punctuation">.</span><span class="token function">ofDefaults</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
registry<span class="token punctuation">.</span><span class="token function">getEventPublisher</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">onEntryAdded</span><span class="token punctuation">(</span>entryAddedEvent <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
    <span class="token class-name">Retry</span> addedRetry <span class="token operator">=</span> entryAddedEvent<span class="token punctuation">.</span><span class="token function">getAddedEntry</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token constant">LOG</span><span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;Retry {} added&quot;</span><span class="token punctuation">,</span> addedRetry<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">onEntryRemoved</span><span class="token punctuation">(</span>entryRemovedEvent <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
    <span class="token class-name">Retry</span> removedRetry <span class="token operator">=</span> entryRemovedEvent<span class="token punctuation">.</span><span class="token function">getRemovedEntry</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token constant">LOG</span><span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;Retry {} removed&quot;</span><span class="token punctuation">,</span> removedRetry<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>å¦‚æœä¸æƒ³åœ¨é‡è¯•å°è¯•ä¹‹é—´ä½¿ç”¨å›ºå®šçš„ç­‰å¾…æ—¶é—´ï¼Œåˆ™å¯ä»¥é…ç½®ä¸€ä¸ªIntervalFunctionï¼Œè¯¥å‡½æ•°ç”¨äºè®¡ç®—æ¯æ¬¡å°è¯•çš„ç­‰å¾…æ—¶é—´ã€‚ Resilience4jæä¾›äº†å‡ ç§å·¥å‚æ–¹æ³•æ¥ç®€åŒ–IntervalFunctionçš„åˆ›å»ºã€‚</p><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token class-name">IntervalFunction</span> defaultWaitInterval <span class="token operator">=</span> <span class="token class-name">IntervalFunction</span>
  <span class="token punctuation">.</span><span class="token function">ofDefaults</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// This interval function is used internally </span>
<span class="token comment">// when you only configure waitDuration</span>
<span class="token class-name">IntervalFunction</span> fixedWaitInterval <span class="token operator">=</span> <span class="token class-name">IntervalFunction</span>
  <span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span><span class="token class-name">Duration</span><span class="token punctuation">.</span><span class="token function">ofSeconds</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">IntervalFunction</span> intervalWithExponentialBackoff <span class="token operator">=</span> <span class="token class-name">IntervalFunction</span>
  <span class="token punctuation">.</span><span class="token function">ofExponentialBackoff</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">IntervalFunction</span> intervalWithCustomExponentialBackoff <span class="token operator">=</span> <span class="token class-name">IntervalFunction</span>
  <span class="token punctuation">.</span><span class="token function">ofExponentialBackoff</span><span class="token punctuation">(</span><span class="token class-name">IntervalFunction</span><span class="token punctuation">.</span><span class="token constant">DEFAULT_INITIAL_INTERVAL</span><span class="token punctuation">,</span> <span class="token number">2d</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">IntervalFunction</span> randomWaitInterval <span class="token operator">=</span> <span class="token class-name">IntervalFunction</span>
  <span class="token punctuation">.</span><span class="token function">ofRandomized</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// Overwrite the default intervalFunction with your custom one</span>
<span class="token class-name">RetryConfig</span> retryConfig <span class="token operator">=</span> <span class="token class-name">RetryConfig</span><span class="token punctuation">.</span><span class="token function">custom</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">intervalFunction</span><span class="token punctuation">(</span>intervalWithExponentialBackoff<span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h1 id="ratelimiter" tabindex="-1"><a class="header-anchor" href="#ratelimiter"><span>RateLimiter</span></a></h1><p>é€Ÿç‡é™åˆ¶æ˜¯ä¸€é¡¹å¿…ä¸å¯å°‘çš„æŠ€æœ¯ï¼Œå®ƒå¯ä»¥ä¸ºæ‰©å±•æ‚¨çš„APIåšå¥½å‡†å¤‡å¹¶å»ºç«‹æœåŠ¡çš„é«˜å¯ç”¨æ€§å’Œå¯é æ€§ã€‚ è€Œä¸”ï¼Œæ­¤æŠ€æœ¯è¿˜æä¾›äº†å¾ˆå¤šä¸åŒçš„é€‰æ‹©ï¼Œä¾‹å¦‚å¦‚ä½•å¤„ç†æ£€æµ‹åˆ°çš„é™åˆ¶è¶…é¢ï¼Œæˆ–æ‚¨è¦é™åˆ¶å“ªç§ç±»å‹çš„è¯·æ±‚ã€‚ æ‚¨å¯ä»¥ç®€å•åœ°æ‹’ç»æ­¤è¶…é™è¯·æ±‚ï¼Œæˆ–å»ºç«‹é˜Ÿåˆ—ä»¥ç¨åæ‰§è¡Œå®ƒä»¬ï¼Œæˆ–ä»¥æŸç§æ–¹å¼ç»„åˆè¿™ä¸¤ç§æ–¹æ³•ã€‚</p><p>Resilience4jæä¾›äº†ä¸€ä¸ªRateLimiterï¼Œå®ƒå°†ä»çºªå…ƒå¼€å§‹å°†æ‰€æœ‰çº³ç§’çº§åˆ†ä¸ºå¤šä¸ªå‘¨æœŸã€‚ æ¯ä¸ªå‘¨æœŸéƒ½æœ‰ä¸€ä¸ªç”±RateLimiterConfig.limitRefreshPeriodé…ç½®çš„æŒç»­æ—¶é—´ã€‚ åœ¨æ¯ä¸ªå‘¨æœŸçš„å¼€å§‹ï¼ŒRateLimiterä¼šå°†æ´»åŠ¨è®¸å¯çš„æ•°é‡è®¾ç½®ä¸ºRateLimiterConfig.limitForPeriodã€‚</p><p>RateLimiterçš„é»˜è®¤å®ç°æ˜¯AtomicRateLimiterï¼Œå®ƒé€šè¿‡AtomicReferenceç®¡ç†å…¶çŠ¶æ€ã€‚ AtomicRateLimiter.Stateæ˜¯å®Œå…¨ä¸å¯å˜çš„ï¼Œå¹¶ä¸”å…·æœ‰ä»¥ä¸‹å­—æ®µï¼š</p><p>* activeCycle : ä¸Šæ¬¡è°ƒç”¨ä½¿ç”¨çš„cycleå·</p><p>* activePermissions :ä¸Šæ¬¡callåçš„å¯ç”¨æƒé™è®¡æ•°ã€‚å¦‚æœä¿ç•™æŸäº›æƒé™ï¼Œåˆ™å¯ä»¥ä¸ºè´Ÿ</p><p>* nanosToWait :ç­‰å¾…ä¸Šä¸€æ¬¡callçš„ç­‰å¾…æ—¶é—´ï¼ˆä»¥çº³ç§’ä¸ºå•ä½ï¼‰</p><p>è¿˜æœ‰ä¸€ä¸ªä½¿ç”¨ä¿¡å·é‡çš„SemaphoreBasedRateLimiterå’Œä¸€ä¸ªè®¡åˆ’ç¨‹åºï¼Œè¯¥è®¡åˆ’ç¨‹åºå°†åœ¨æ¯ä¸ªRateLimiterConfigï¼ƒlimitRefreshPeriodä¹‹ååˆ·æ–°æƒé™ã€‚</p><p>åˆ›å»ºé»˜è®¤çš„é€Ÿç‡å™¨ï¼š</p><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token class-name">RateLimiterRegistry</span> rateLimiterRegistry <span class="token operator">=</span> <span class="token class-name">RateLimiterRegistry</span><span class="token punctuation">.</span><span class="token function">ofDefaults</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>RateLimiterConfigé…ç½®é€Ÿç‡å™¨ï¼š</p><table><thead><tr><th>å±æ€§</th><th>é»˜è®¤å€¼</th><th>æè¿°</th></tr></thead><tbody><tr><td>timeoutDuration</td><td>5 [s]</td><td>çº¿ç¨‹ç­‰å¾…æƒé™çš„é»˜è®¤ç­‰å¾…æ—¶é—´</td></tr><tr><td>limitRefreshPeriod</td><td>500 [ns]</td><td>é™åˆ¶åˆ·æ–°çš„æ—¶é—´æ®µã€‚ åœ¨æ¯ä¸ªæ—¶é—´æ®µä¹‹åï¼Œé€Ÿç‡é™åˆ¶å™¨å°†å…¶æƒé™è®¡æ•°é‡æ–°è®¾ç½®ä¸ºlimitForPeriodå€¼</td></tr><tr><td>limitForPeriod</td><td>50</td><td>ä¸€ä¸ªé™åˆ¶åˆ·æ–°æœŸé—´å¯ç”¨çš„æƒé™æ•°</td></tr></tbody></table><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token class-name">RateLimiterConfig</span> config <span class="token operator">=</span> <span class="token class-name">RateLimiterConfig</span><span class="token punctuation">.</span><span class="token function">custom</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">limitRefreshPeriod</span><span class="token punctuation">(</span><span class="token class-name">Duration</span><span class="token punctuation">.</span><span class="token function">ofMillis</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">limitForPeriod</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">timeoutDuration</span><span class="token punctuation">(</span><span class="token class-name">Duration</span><span class="token punctuation">.</span><span class="token function">ofMillis</span><span class="token punctuation">(</span><span class="token number">25</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// Create registry</span>
<span class="token class-name">RateLimiterRegistry</span> rateLimiterRegistry <span class="token operator">=</span> <span class="token class-name">RateLimiterRegistry</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// Use registry</span>
<span class="token class-name">RateLimiter</span> rateLimiterWithDefaultConfig <span class="token operator">=</span> rateLimiterRegistry
  <span class="token punctuation">.</span><span class="token function">rateLimiter</span><span class="token punctuation">(</span><span class="token string">&quot;name1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">RateLimiter</span> rateLimiterWithCustomConfig <span class="token operator">=</span> rateLimiterRegistry
  <span class="token punctuation">.</span><span class="token function">rateLimiter</span><span class="token punctuation">(</span><span class="token string">&quot;name2&quot;</span><span class="token punctuation">,</span> config<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>å¦‚æ‚¨æ‰€æ–™ï¼ŒRateLimiterå…·æœ‰å„ç§ç±»ä¼¼äºCircuitBreakerçš„é«˜é˜¶è£…é¥°å™¨åŠŸèƒ½ã€‚ æ‚¨å¯ä»¥ä½¿ç”¨RateLimiterè£…é¥°ä»»ä½•Callableï¼ŒSupplierï¼ŒRunnableï¼ŒConsumerï¼ŒCheckedRunnableï¼ŒCheckedSupplierï¼ŒCheckedConsumeræˆ–CompletionStageã€‚</p><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token comment">// Decorate your call to BackendService.doSomething()</span>
<span class="token class-name">CheckedRunnable</span> restrictedCall <span class="token operator">=</span> <span class="token class-name">RateLimiter</span>
    <span class="token punctuation">.</span><span class="token function">decorateCheckedRunnable</span><span class="token punctuation">(</span>rateLimiter<span class="token punctuation">,</span> backendService<span class="token operator">::</span><span class="token function">doSomething</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">Try</span><span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span>restrictedCall<span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">andThenTry</span><span class="token punctuation">(</span>restrictedCall<span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">onFailure</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">RequestNotPermitted</span> throwable<span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token constant">LOG</span><span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;Wait before call it again :)&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>æ‚¨å¯ä»¥ä½¿ç”¨changeTimeoutDurationå’ŒchangeLimitForPeriodæ–¹æ³•åœ¨è¿è¡Œæ—¶æ›´æ”¹é€Ÿç‡é™åˆ¶å™¨å‚æ•°ã€‚</p><p>æ–°çš„è¶…æ—¶æ—¶é—´ä¸ä¼šå½±å“å½“å‰æ­£åœ¨ç­‰å¾…è®¸å¯çš„çº¿ç¨‹ã€‚</p><p>æ–°çš„é™åˆ¶ä¸ä¼šå½±å“å½“å‰æœŸé™çš„æƒé™ï¼Œå¹¶ä¸”ä»…ä»ä¸‹ä¸€ä¸ªé™åˆ¶å¼€å§‹é€‚ç”¨ã€‚</p><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token comment">// Decorate your call to BackendService.doSomething()</span>
<span class="token class-name">CheckedRunnable</span> restrictedCall <span class="token operator">=</span> <span class="token class-name">RateLimiter</span>
    <span class="token punctuation">.</span><span class="token function">decorateCheckedRunnable</span><span class="token punctuation">(</span>rateLimiter<span class="token punctuation">,</span> backendService<span class="token operator">::</span><span class="token function">doSomething</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// during second refresh cycle limiter will get 100 permissions</span>
rateLimiter<span class="token punctuation">.</span><span class="token function">changeLimitForPeriod</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>æ‚¨å¯ä»¥åœ¨RateLimiterRegistryä¸Šæ³¨å†Œäº‹ä»¶ä½¿ç”¨è€…ï¼Œå¹¶åœ¨åˆ›å»ºï¼Œæ›¿æ¢æˆ–åˆ é™¤RateLimiteræ—¶æ‰§è¡Œæ“ä½œã€‚</p><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token class-name">RateLimiterRegistry</span> registry <span class="token operator">=</span> <span class="token class-name">RateLimiterRegistry</span><span class="token punctuation">.</span><span class="token function">ofDefaults</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
registry<span class="token punctuation">.</span><span class="token function">getEventPublisher</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">onEntryAdded</span><span class="token punctuation">(</span>entryAddedEvent <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
    <span class="token class-name">RateLimiter</span> addedRateLimiter <span class="token operator">=</span> entryAddedEvent<span class="token punctuation">.</span><span class="token function">getAddedEntry</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token constant">LOG</span><span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;RateLimiter {} added&quot;</span><span class="token punctuation">,</span> addedRateLimiter<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">onEntryRemoved</span><span class="token punctuation">(</span>entryRemovedEvent <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
    <span class="token class-name">RateLimiter</span> removedRateLimiter <span class="token operator">=</span> entryRemovedEvent<span class="token punctuation">.</span><span class="token function">getRemovedEntry</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token constant">LOG</span><span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;RateLimiter {} removed&quot;</span><span class="token punctuation">,</span> removedRateLimiter<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>RateLimiterå‘å‡ºRateLimiterEventsæµã€‚ äº‹ä»¶å¯ä»¥æ˜¯æˆåŠŸçš„è®¸å¯è·å–æˆ–è·å–å¤±è´¥ã€‚</p><p>æ‰€æœ‰äº‹ä»¶éƒ½åŒ…å«å…¶ä»–ä¿¡æ¯ï¼Œä¾‹å¦‚äº‹ä»¶åˆ›å»ºæ—¶é—´å’Œé€Ÿç‡é™åˆ¶å™¨åç§°ã€‚</p><p>å¦‚æœè¦ä½¿ç”¨äº‹ä»¶ï¼Œåˆ™å¿…é¡»æ³¨å†Œäº‹ä»¶ä½¿ç”¨è€…ã€‚</p><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code>rateLimiter<span class="token punctuation">.</span><span class="token function">getEventPublisher</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">onSuccess</span><span class="token punctuation">(</span>event <span class="token operator">-&gt;</span> logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">onFailure</span><span class="token punctuation">(</span>event <span class="token operator">-&gt;</span> logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>æ‚¨å¯ä»¥é€šè¿‡è‡ªå®šä¹‰å®ç°è¦†ç›–å†…å­˜RegistryStoreã€‚ ä¾‹å¦‚ï¼Œå¦‚æœè¦ä½¿ç”¨åœ¨ä¸€å®šæ—¶é—´ååˆ é™¤æœªä½¿ç”¨å®ä¾‹çš„ç¼“å­˜ã€‚</p><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token class-name">RateLimiterRegistry</span> rateLimiterRegistry <span class="token operator">=</span> <span class="token class-name">RateLimiterRegistry</span><span class="token punctuation">.</span><span class="token function">custom</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">withRegistryStore</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">CacheRateLimiterRegistryStore</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h1 id="å’Œspring-bootç»“åˆ" tabindex="-1"><a class="header-anchor" href="#å’Œspring-bootç»“åˆ"><span>å’Œspring bootç»“åˆ</span></a></h1><h2 id="ä¾èµ–" tabindex="-1"><a class="header-anchor" href="#ä¾èµ–"><span>ä¾èµ–</span></a></h2><div class="language-groovy line-numbers-mode" data-ext="groovy" data-title="groovy"><pre class="language-groovy"><code>repositories <span class="token punctuation">{</span>
    <span class="token function">jCenter</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

dependencies <span class="token punctuation">{</span>
  compile <span class="token interpolation-string"><span class="token string">&quot;io.github.resilience4j:resilience4j-spring-boot2:</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token expression">resilience4jVersion</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&quot;</span></span>
  <span class="token function">compile</span><span class="token punctuation">(</span><span class="token string">&#39;org.springframework.boot:spring-boot-starter-actuator&#39;</span><span class="token punctuation">)</span>
  <span class="token function">compile</span><span class="token punctuation">(</span><span class="token string">&#39;org.springframework.boot:spring-boot-starter-aop&#39;</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="ç›¸å…³é…ç½®" tabindex="-1"><a class="header-anchor" href="#ç›¸å…³é…ç½®"><span>ç›¸å…³é…ç½®</span></a></h2><div class="language-yaml line-numbers-mode" data-ext="yml" data-title="yml"><pre class="language-yaml"><code><span class="token key atrule">resilience4j.circuitbreaker</span><span class="token punctuation">:</span>
    <span class="token key atrule">instances</span><span class="token punctuation">:</span>
        <span class="token key atrule">backendA</span><span class="token punctuation">:</span>
            <span class="token key atrule">registerHealthIndicator</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
            <span class="token key atrule">slidingWindowSize</span><span class="token punctuation">:</span> <span class="token number">100</span>
        <span class="token key atrule">backendB</span><span class="token punctuation">:</span>
            <span class="token key atrule">registerHealthIndicator</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
            <span class="token key atrule">slidingWindowSize</span><span class="token punctuation">:</span> <span class="token number">10</span>
            <span class="token key atrule">permittedNumberOfCallsInHalfOpenState</span><span class="token punctuation">:</span> <span class="token number">3</span>
            <span class="token key atrule">slidingWindowType</span><span class="token punctuation">:</span> TIME_BASED
            <span class="token key atrule">minimumNumberOfCalls</span><span class="token punctuation">:</span> <span class="token number">20</span>
            <span class="token key atrule">waitDurationInOpenState</span><span class="token punctuation">:</span> 50s
            <span class="token key atrule">failureRateThreshold</span><span class="token punctuation">:</span> <span class="token number">50</span>
            <span class="token key atrule">eventConsumerBufferSize</span><span class="token punctuation">:</span> <span class="token number">10</span>
            <span class="token key atrule">recordFailurePredicate</span><span class="token punctuation">:</span> io.github.robwin.exception.RecordFailurePredicate
            
<span class="token key atrule">resilience4j.retry</span><span class="token punctuation">:</span>
    <span class="token key atrule">instances</span><span class="token punctuation">:</span>
        <span class="token key atrule">backendA</span><span class="token punctuation">:</span>
            <span class="token key atrule">maxAttempts</span><span class="token punctuation">:</span> <span class="token number">3</span>
            <span class="token key atrule">waitDuration</span><span class="token punctuation">:</span> 10s
            <span class="token key atrule">enableExponentialBackoff</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
            <span class="token key atrule">exponentialBackoffMultiplier</span><span class="token punctuation">:</span> <span class="token number">2</span>
            <span class="token key atrule">retryExceptions</span><span class="token punctuation">:</span>
                <span class="token punctuation">-</span> org.springframework.web.client.HttpServerErrorException
                <span class="token punctuation">-</span> java.io.IOException
            <span class="token key atrule">ignoreExceptions</span><span class="token punctuation">:</span>
                <span class="token punctuation">-</span> io.github.robwin.exception.BusinessException
        <span class="token key atrule">backendB</span><span class="token punctuation">:</span>
            <span class="token key atrule">maxAttempts</span><span class="token punctuation">:</span> <span class="token number">3</span>
            <span class="token key atrule">waitDuration</span><span class="token punctuation">:</span> 10s
            <span class="token key atrule">retryExceptions</span><span class="token punctuation">:</span>
                <span class="token punctuation">-</span> org.springframework.web.client.HttpServerErrorException
                <span class="token punctuation">-</span> java.io.IOException
            <span class="token key atrule">ignoreExceptions</span><span class="token punctuation">:</span>
                <span class="token punctuation">-</span> io.github.robwin.exception.BusinessException
                
<span class="token key atrule">resilience4j.bulkhead</span><span class="token punctuation">:</span>
    <span class="token key atrule">instances</span><span class="token punctuation">:</span>
        <span class="token key atrule">backendA</span><span class="token punctuation">:</span>
            <span class="token key atrule">maxConcurrentCalls</span><span class="token punctuation">:</span> <span class="token number">10</span>
        <span class="token key atrule">backendB</span><span class="token punctuation">:</span>
            <span class="token key atrule">maxWaitDuration</span><span class="token punctuation">:</span> 10ms
            <span class="token key atrule">maxConcurrentCalls</span><span class="token punctuation">:</span> <span class="token number">20</span>
            
<span class="token key atrule">resilience4j.thread-pool-bulkhead</span><span class="token punctuation">:</span>
  <span class="token key atrule">instances</span><span class="token punctuation">:</span>
    <span class="token key atrule">backendC</span><span class="token punctuation">:</span>
      <span class="token key atrule">maxThreadPoolSize</span><span class="token punctuation">:</span> <span class="token number">1</span>
      <span class="token key atrule">coreThreadPoolSize</span><span class="token punctuation">:</span> <span class="token number">1</span>
      <span class="token key atrule">queueCapacity</span><span class="token punctuation">:</span> <span class="token number">1</span>
        
<span class="token key atrule">resilience4j.ratelimiter</span><span class="token punctuation">:</span>
    <span class="token key atrule">instances</span><span class="token punctuation">:</span>
        <span class="token key atrule">backendA</span><span class="token punctuation">:</span>
            <span class="token key atrule">limitForPeriod</span><span class="token punctuation">:</span> <span class="token number">10</span>
            <span class="token key atrule">limitRefreshPeriod</span><span class="token punctuation">:</span> 1s
            <span class="token key atrule">timeoutDuration</span><span class="token punctuation">:</span> <span class="token number">0</span>
            <span class="token key atrule">registerHealthIndicator</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
            <span class="token key atrule">eventConsumerBufferSize</span><span class="token punctuation">:</span> <span class="token number">100</span>
        <span class="token key atrule">backendB</span><span class="token punctuation">:</span>
            <span class="token key atrule">limitForPeriod</span><span class="token punctuation">:</span> <span class="token number">6</span>
            <span class="token key atrule">limitRefreshPeriod</span><span class="token punctuation">:</span> 500ms
            <span class="token key atrule">timeoutDuration</span><span class="token punctuation">:</span> 3s
            
<span class="token key atrule">resilience4j.timelimiter</span><span class="token punctuation">:</span>
    <span class="token key atrule">instances</span><span class="token punctuation">:</span>
        <span class="token key atrule">backendA</span><span class="token punctuation">:</span>
            <span class="token key atrule">timeoutDuration</span><span class="token punctuation">:</span> 2s
            <span class="token key atrule">cancelRunningFuture</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
        <span class="token key atrule">backendB</span><span class="token punctuation">:</span>
            <span class="token key atrule">timeoutDuration</span><span class="token punctuation">:</span> 1s
            <span class="token key atrule">cancelRunningFuture</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ä½ å¯ä»¥è¦†ç›–é»˜è®¤é…ç½®ã€å®šä¹‰å…±äº«é…ç½®ï¼š</p><div class="language-yaml line-numbers-mode" data-ext="yml" data-title="yml"><pre class="language-yaml"><code><span class="token key atrule">resilience4j.circuitbreaker</span><span class="token punctuation">:</span>
    <span class="token key atrule">configs</span><span class="token punctuation">:</span>
        <span class="token key atrule">default</span><span class="token punctuation">:</span>
            <span class="token key atrule">slidingWindowSize</span><span class="token punctuation">:</span> <span class="token number">100</span>
            <span class="token key atrule">permittedNumberOfCallsInHalfOpenState</span><span class="token punctuation">:</span> <span class="token number">10</span>
            <span class="token key atrule">waitDurationInOpenState</span><span class="token punctuation">:</span> <span class="token number">10000</span>
            <span class="token key atrule">failureRateThreshold</span><span class="token punctuation">:</span> <span class="token number">60</span>
            <span class="token key atrule">eventConsumerBufferSize</span><span class="token punctuation">:</span> <span class="token number">10</span>
            <span class="token key atrule">registerHealthIndicator</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
        <span class="token key atrule">someShared</span><span class="token punctuation">:</span>
            <span class="token key atrule">slidingWindowSize</span><span class="token punctuation">:</span> <span class="token number">50</span>
            <span class="token key atrule">permittedNumberOfCallsInHalfOpenState</span><span class="token punctuation">:</span> <span class="token number">10</span>
    <span class="token key atrule">instances</span><span class="token punctuation">:</span>
        <span class="token key atrule">backendA</span><span class="token punctuation">:</span>
            <span class="token key atrule">baseConfig</span><span class="token punctuation">:</span> default
            <span class="token key atrule">waitDurationInOpenState</span><span class="token punctuation">:</span> <span class="token number">5000</span>
        <span class="token key atrule">backendB</span><span class="token punctuation">:</span>
            <span class="token key atrule">baseConfig</span><span class="token punctuation">:</span> someShared
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ä½ è¿˜å¯ä»¥é€šè¿‡ä»£ç è¦†ç›–yamlä¸­çš„é…ç½®ï¼š</p><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token annotation punctuation">@Bean</span>
<span class="token keyword">public</span> <span class="token class-name">CircuitBreakerConfigCustomizer</span> <span class="token function">testCustomizer</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token class-name">CircuitBreakerConfigCustomizer</span>
        <span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span><span class="token string">&quot;backendA&quot;</span><span class="token punctuation">,</span> builder <span class="token operator">-&gt;</span> builder<span class="token punctuation">.</span><span class="token function">slidingWindowSize</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>Resilience4j æä¾›äº†è‡ªå®šä¹‰é…ç½®çš„ç±»ï¼š</p><table><thead><tr><th>Resilienc4j Type</th><th>Instance Customizer class</th></tr></thead><tbody><tr><td>Circuit breaker</td><td>CircuitBreakerConfigCustomizer</td></tr><tr><td>Retry</td><td>RetryConfigCustomizer</td></tr><tr><td>Rate limiter</td><td>RateLimiterConfigCustomizer</td></tr><tr><td>Bulkhead</td><td>BulkheadConfigCustomizer</td></tr><tr><td>ThreadPoolBulkhead</td><td>ThreadPoolBulkheadConfigCustomizer</td></tr><tr><td>Time Limiter</td><td>TimeLimiterConfigCustomizer</td></tr></tbody></table><h2 id="æ³¨è§£" tabindex="-1"><a class="header-anchor" href="#æ³¨è§£"><span>æ³¨è§£</span></a></h2><p>spring bootæä¾›äº†æ³¨è§£æ”¯æŒï¼Œè¿™äº›æ³¨è§£æ ‡æ³¨çš„æ–¹æ³•çš„è¿”å›å€¼å¯ä»¥æ˜¯å¼‚æ­¥æˆ–åŒæ­¥çš„</p><p>Bulkheadæ³¨è§£çš„typeå±æ€§å¯ä»¥æŒ‡å®šé‡‡ç”¨ä½•ç§ç±»å‹çš„éš”ç¦»å™¨ï¼Œé»˜è®¤æ˜¯semaphore ï¼š</p><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token annotation punctuation">@Bulkhead</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token constant">BACKEND</span><span class="token punctuation">,</span> type <span class="token operator">=</span> <span class="token class-name">Bulkhead<span class="token punctuation">.</span>Type</span><span class="token punctuation">.</span><span class="token constant">THREADPOOL</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">CompletableFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> <span class="token function">doSomethingAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span>
        <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token class-name">CompletableFuture</span><span class="token punctuation">.</span><span class="token function">completedFuture</span><span class="token punctuation">(</span><span class="token string">&quot;Test&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
<span class="token annotation punctuation">@CircuitBreaker</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token constant">BACKEND</span><span class="token punctuation">,</span> fallbackMethod <span class="token operator">=</span> <span class="token string">&quot;fallback&quot;</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@RateLimiter</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token constant">BACKEND</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@Bulkhead</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token constant">BACKEND</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@Retry</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token constant">BACKEND</span><span class="token punctuation">,</span> fallbackMethod <span class="token operator">=</span> <span class="token string">&quot;fallback&quot;</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@TimeLimiter</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token constant">BACKEND</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">Mono</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> <span class="token function">method</span><span class="token punctuation">(</span><span class="token class-name">String</span> param1<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token class-name">Mono</span><span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">NumberFormatException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">private</span> <span class="token class-name">Mono</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> <span class="token function">fallback</span><span class="token punctuation">(</span><span class="token class-name">String</span> param1<span class="token punctuation">,</span> <span class="token class-name">IllegalArgumentException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token class-name">Mono</span><span class="token punctuation">.</span><span class="token function">just</span><span class="token punctuation">(</span><span class="token string">&quot;test&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">private</span> <span class="token class-name">Mono</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> <span class="token function">fallback</span><span class="token punctuation">(</span><span class="token class-name">String</span> param1<span class="token punctuation">,</span> <span class="token class-name">RuntimeException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token class-name">Mono</span><span class="token punctuation">.</span><span class="token function">just</span><span class="token punctuation">(</span><span class="token string">&quot;test&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œfallbackå¿…é¡»æ”¾åœ¨åŒä¸ªç±»ä¸­ï¼Œå¹¶ä¸”æœ‰ç›¸åŒçš„æ–¹æ³•ç­¾åå¹¶è¿½åŠ ä¸€ä¸ªå¼‚å¸¸å‚æ•°ã€‚</p><p>å¦‚æœæœ‰å¤šä¸ªfallbackæ–¹æ³•ï¼Œåˆ™æœ€è¿‘çš„æ–¹æ³•ä¼šæ‰§è¡Œï¼Œä¾‹å¦‚ä¸Šé¢çš„æ–¹æ³•æŠ›å‡º NumberFormatExceptionï¼ŒIllegalArgumentExceptionæ–¹æ³•ä¼šæ‰§è¡Œã€‚</p><p>ä»…å½“å¤šä¸ªæ–¹æ³•å…·æœ‰ç›¸åŒçš„è¿”å›ç±»å‹ï¼Œå¹¶ä¸”æ‚¨è¦ä¸€åŠ³æ°¸é€¸åœ°ä¸ºå®ƒä»¬å®šä¹‰ç›¸åŒçš„åå¤‡æ–¹æ³•æ—¶ï¼Œæ‰å¯ä»¥ä½¿ç”¨å¼‚å¸¸å‚æ•°å®šä¹‰ä¸€ä¸ªå…¨å±€åå¤‡æ–¹æ³•ã€‚</p><h3 id="æ³¨è§£çš„é¡ºåº" tabindex="-1"><a class="header-anchor" href="#æ³¨è§£çš„é¡ºåº"><span>æ³¨è§£çš„é¡ºåº</span></a></h3><div class="language-text line-numbers-mode" data-ext="text" data-title="text"><pre class="language-text"><code>Retry ( CircuitBreaker ( RateLimiter ( TimeLimiter ( Bulkhead ( Function ) ) ) ) )
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>å¦‚æœéœ€è¦å…¶ä»–é¡ºåºï¼Œåˆ™å¿…é¡»ä½¿ç”¨åŠŸèƒ½é“¾æ ·å¼è€Œä¸æ˜¯Springæ‰¹æ³¨æ ·å¼ï¼Œæˆ–ä½¿ç”¨ä»¥ä¸‹å±æ€§æ¥æ˜¾å¼è®¾ç½®å¤–è§‚é¡ºåºï¼š</p><div class="language-yaml line-numbers-mode" data-ext="yml" data-title="yml"><pre class="language-yaml"><code><span class="token punctuation">-</span> resilience4j.retry.retryAspectOrder
<span class="token punctuation">-</span> resilience4j.circuitbreaker.circuitBreakerAspectOrder
<span class="token punctuation">-</span> resilience4j.ratelimiter.rateLimiterAspectOrder
<span class="token punctuation">-</span> resilience4j.timelimiter.timeLimiterAspectOrder
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ä¾‹å¦‚ï¼Œè®©çŸ­è·¯å™¨åœ¨é‡è¯•å™¨åæ‰§è¡Œï¼Œä½ å¿…é¡»è®¾ç½®<code>retryAspectOrder</code> çš„å€¼å¤§äº<code>circuitBreakerAspectOrder</code> ï¼š</p><div class="language-yaml line-numbers-mode" data-ext="yml" data-title="yml"><pre class="language-yaml"><code><span class="token key atrule">resilience4j</span><span class="token punctuation">:</span>
  <span class="token key atrule">circuitbreaker</span><span class="token punctuation">:</span>
    <span class="token key atrule">circuitBreakerAspectOrder</span><span class="token punctuation">:</span> <span class="token number">1</span>
  <span class="token key atrule">retry</span><span class="token punctuation">:</span>
    <span class="token key atrule">retryAspectOrder</span><span class="token punctuation">:</span> <span class="token number">2</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="æŒ‡æ ‡ç«¯ç‚¹" tabindex="-1"><a class="header-anchor" href="#æŒ‡æ ‡ç«¯ç‚¹"><span>æŒ‡æ ‡ç«¯ç‚¹</span></a></h2><div class="language-text line-numbers-mode" data-ext="text" data-title="text"><pre class="language-text"><code>/actuator/metrics
{
    &quot;names&quot;: [
        &quot;resilience4j.circuitbreaker.calls&quot;,
        &quot;resilience4j.circuitbreaker.buffered.calls&quot;,
        &quot;resilience4j.circuitbreaker.state&quot;,
        &quot;resilience4j.circuitbreaker.failure.rate&quot;
        ]
}
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>è·å–å…·ä½“çš„æŒ‡æ ‡ä¿¡æ¯ï¼Œ<code>GET /actuator/metrics/{metric.name}</code>,ä¾‹å¦‚ï¼š<code>/actuator/metrics/resilience4j.circuitbreaker.calls</code>ï¼š</p><div class="language-json line-numbers-mode" data-ext="json" data-title="json"><pre class="language-json"><code><span class="token punctuation">{</span>
    <span class="token property">&quot;name&quot;</span><span class="token operator">:</span> <span class="token string">&quot;resilience4j.circuitbreaker.calls&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;measurements&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token punctuation">{</span>
            <span class="token property">&quot;statistic&quot;</span><span class="token operator">:</span> <span class="token string">&quot;VALUE&quot;</span><span class="token punctuation">,</span>
            <span class="token property">&quot;value&quot;</span><span class="token operator">:</span> <span class="token number">3</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token property">&quot;availableTags&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token punctuation">{</span>
            <span class="token property">&quot;tag&quot;</span><span class="token operator">:</span> <span class="token string">&quot;kind&quot;</span><span class="token punctuation">,</span>
            <span class="token property">&quot;values&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
                <span class="token string">&quot;not_permitted&quot;</span><span class="token punctuation">,</span>
                <span class="token string">&quot;successful&quot;</span><span class="token punctuation">,</span>
                <span class="token string">&quot;failed&quot;</span>
            <span class="token punctuation">]</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span>
            <span class="token property">&quot;tag&quot;</span><span class="token operator">:</span> <span class="token string">&quot;name&quot;</span><span class="token punctuation">,</span>
            <span class="token property">&quot;values&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
                <span class="token string">&quot;backendB&quot;</span><span class="token punctuation">,</span>
                <span class="token string">&quot;backendA&quot;</span>
            <span class="token punctuation">]</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>å¦‚æœæƒ³è¦ä½¿ç”¨ prometheusï¼Œéœ€è¦æ·»åŠ ä¾èµ– io.micrometer:micrometer-registry-prometheusï¼Œç«¯ç‚¹æ˜¯/actuator/prometheus</p><h3 id="health-ç«¯ç‚¹" tabindex="-1"><a class="header-anchor" href="#health-ç«¯ç‚¹"><span>health ç«¯ç‚¹</span></a></h3><p>é»˜è®¤ï¼ŒCircuitBreaker å’Œ RateLimiter çš„healthç«¯ç‚¹æ˜¯ç¦ç”¨çš„ã€‚å½“CircuitBreakeræ‰“å¼€æ—¶ï¼Œç”±äºåº”ç”¨ç¨‹åºçŠ¶æ€ä¸ºDOWNï¼Œå› æ­¤ä¼šç¦ç”¨è¿è¡ŒçŠ¶å†µæŒ‡ç¤ºå™¨ã€‚ è¿™å¯èƒ½ä¸æ˜¯æ‚¨æƒ³è¦å®ç°çš„ã€‚</p><div class="language-yaml line-numbers-mode" data-ext="yml" data-title="yml"><pre class="language-yaml"><code><span class="token key atrule">management.health.circuitbreakers.enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
<span class="token key atrule">management.health.ratelimiters.enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>

<span class="token key atrule">resilience4j.circuitbreaker</span><span class="token punctuation">:</span>
  <span class="token key atrule">configs</span><span class="token punctuation">:</span>
    <span class="token key atrule">default</span><span class="token punctuation">:</span>
      <span class="token key atrule">registerHealthIndicator</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>


<span class="token key atrule">resilience4j.ratelimiter</span><span class="token punctuation">:</span>
  <span class="token key atrule">configs</span><span class="token punctuation">:</span>
    <span class="token key atrule">default</span><span class="token punctuation">:</span>
      <span class="token key atrule">registerHealthIndicator</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>é—­åˆçš„CircuitBreakerçŠ¶æ€æ˜ å°„ä¸ºUPï¼Œæ‰“å¼€çŠ¶æ€æ˜ å°„ä¸ºDOWNï¼ŒåŠæ‰“å¼€çŠ¶æ€æ˜ å°„ä¸ºUNKNOWNã€‚</p><div class="language-json line-numbers-mode" data-ext="json" data-title="json"><pre class="language-json"><code><span class="token punctuation">{</span>
  <span class="token property">&quot;status&quot;</span><span class="token operator">:</span> <span class="token string">&quot;UP&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;details&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;circuitBreakers&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">&quot;status&quot;</span><span class="token operator">:</span> <span class="token string">&quot;UP&quot;</span><span class="token punctuation">,</span>
      <span class="token property">&quot;details&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;backendB&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
          <span class="token property">&quot;status&quot;</span><span class="token operator">:</span> <span class="token string">&quot;UP&quot;</span><span class="token punctuation">,</span>
          <span class="token property">&quot;details&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
            <span class="token property">&quot;failureRate&quot;</span><span class="token operator">:</span> <span class="token string">&quot;-1.0%&quot;</span><span class="token punctuation">,</span>
            <span class="token property">&quot;failureRateThreshold&quot;</span><span class="token operator">:</span> <span class="token string">&quot;50.0%&quot;</span><span class="token punctuation">,</span>
            <span class="token property">&quot;slowCallRate&quot;</span><span class="token operator">:</span> <span class="token string">&quot;-1.0%&quot;</span><span class="token punctuation">,</span>
            <span class="token property">&quot;slowCallRateThreshold&quot;</span><span class="token operator">:</span> <span class="token string">&quot;100.0%&quot;</span><span class="token punctuation">,</span>
            <span class="token property">&quot;bufferedCalls&quot;</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
            <span class="token property">&quot;slowCalls&quot;</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
            <span class="token property">&quot;slowFailedCalls&quot;</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
            <span class="token property">&quot;failedCalls&quot;</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
            <span class="token property">&quot;notPermittedCalls&quot;</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
            <span class="token property">&quot;state&quot;</span><span class="token operator">:</span> <span class="token string">&quot;CLOSED&quot;</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token property">&quot;backendA&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
          <span class="token property">&quot;status&quot;</span><span class="token operator">:</span> <span class="token string">&quot;UP&quot;</span><span class="token punctuation">,</span>
          <span class="token property">&quot;details&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
            <span class="token property">&quot;failureRate&quot;</span><span class="token operator">:</span> <span class="token string">&quot;-1.0%&quot;</span><span class="token punctuation">,</span>
            <span class="token property">&quot;failureRateThreshold&quot;</span><span class="token operator">:</span> <span class="token string">&quot;50.0%&quot;</span><span class="token punctuation">,</span>
            <span class="token property">&quot;slowCallRate&quot;</span><span class="token operator">:</span> <span class="token string">&quot;-1.0%&quot;</span><span class="token punctuation">,</span>
            <span class="token property">&quot;slowCallRateThreshold&quot;</span><span class="token operator">:</span> <span class="token string">&quot;100.0%&quot;</span><span class="token punctuation">,</span>
            <span class="token property">&quot;bufferedCalls&quot;</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
            <span class="token property">&quot;slowCalls&quot;</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
            <span class="token property">&quot;slowFailedCalls&quot;</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
            <span class="token property">&quot;failedCalls&quot;</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
            <span class="token property">&quot;notPermittedCalls&quot;</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
            <span class="token property">&quot;state&quot;</span><span class="token operator">:</span> <span class="token string">&quot;CLOSED&quot;</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="eventsç«¯ç‚¹" tabindex="-1"><a class="header-anchor" href="#eventsç«¯ç‚¹"><span>eventsç«¯ç‚¹</span></a></h3><p>å‘å‡ºçš„CircuitBreakerï¼ŒRetryï¼ŒRateLimiterï¼ŒBulkheadå’ŒTimeLimiteräº‹ä»¶å­˜å‚¨åœ¨å•ç‹¬çš„å¾ªç¯äº‹ä»¶æ¶ˆè´¹è€…ç¼“å†²åŒºä¸­ã€‚ å¯ä»¥åœ¨application.ymlæ–‡ä»¶ï¼ˆeventConsumerBufferSizeï¼‰ä¸­é…ç½®äº‹ä»¶æ¶ˆè´¹è€…ç¼“å†²åŒºçš„å¤§å°ã€‚</p><p>ç«¯ç‚¹ <code>/ctuator/circuitbreakers</code> åˆ—å‡ºäº†æ‰€æœ‰CircuitBreakerå®ä¾‹çš„åç§°ã€‚ è¯¥ç«¯ç‚¹ä¹Ÿå¯ç”¨äºRetryï¼ŒRateLimiterï¼ŒBulkheadå’ŒTimeLimiterã€‚</p><div class="language-json line-numbers-mode" data-ext="json" data-title="json"><pre class="language-json"><code><span class="token punctuation">{</span>
    <span class="token property">&quot;circuitBreakers&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
      <span class="token string">&quot;backendA&quot;</span><span class="token punctuation">,</span>
      <span class="token string">&quot;backendB&quot;</span>
    <span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ç«¯ç‚¹/ actuator / circuitbreakereventsé»˜è®¤æƒ…å†µä¸‹åˆ—å‡ºæ‰€æœ‰CircuitBreakerå®ä¾‹çš„æœ€è¿‘100ä¸ªå‘å‡ºçš„äº‹ä»¶ã€‚ è¯¥ç«¯ç‚¹ä¹Ÿå¯ç”¨äºRetryï¼ŒRateLimiterï¼ŒBulkheadå’ŒTimeLimiterã€‚</p><div class="language-json line-numbers-mode" data-ext="json" data-title="json"><pre class="language-json"><code><span class="token punctuation">{</span>
    <span class="token property">&quot;circuitBreakerEvents&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token punctuation">{</span>
            <span class="token property">&quot;circuitBreakerName&quot;</span><span class="token operator">:</span> <span class="token string">&quot;backendA&quot;</span><span class="token punctuation">,</span>
            <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;ERROR&quot;</span><span class="token punctuation">,</span>
            <span class="token property">&quot;creationTime&quot;</span><span class="token operator">:</span> <span class="token string">&quot;2017-01-10T15:39:17.117+01:00[Europe/Berlin]&quot;</span><span class="token punctuation">,</span>
            <span class="token property">&quot;errorMessage&quot;</span><span class="token operator">:</span> <span class="token string">&quot;org.springframework.web.client.HttpServerErrorException: 500 This is a remote exception&quot;</span><span class="token punctuation">,</span>
            <span class="token property">&quot;durationInMs&quot;</span><span class="token operator">:</span> <span class="token number">0</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span>
            <span class="token property">&quot;circuitBreakerName&quot;</span><span class="token operator">:</span> <span class="token string">&quot;backendA&quot;</span><span class="token punctuation">,</span>
            <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;SUCCESS&quot;</span><span class="token punctuation">,</span>
            <span class="token property">&quot;creationTime&quot;</span><span class="token operator">:</span> <span class="token string">&quot;2017-01-10T15:39:20.518+01:00[Europe/Berlin]&quot;</span><span class="token punctuation">,</span>
            <span class="token property">&quot;durationInMs&quot;</span><span class="token operator">:</span> <span class="token number">0</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span>
            <span class="token property">&quot;circuitBreakerName&quot;</span><span class="token operator">:</span> <span class="token string">&quot;backendB&quot;</span><span class="token punctuation">,</span>
            <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;ERROR&quot;</span><span class="token punctuation">,</span>
            <span class="token property">&quot;creationTime&quot;</span><span class="token operator">:</span> <span class="token string">&quot;2017-01-10T15:41:31.159+01:00[Europe/Berlin]&quot;</span><span class="token punctuation">,</span>
            <span class="token property">&quot;errorMessage&quot;</span><span class="token operator">:</span> <span class="token string">&quot;org.springframework.web.client.HttpServerErrorException: 500 This is a remote exception&quot;</span><span class="token punctuation">,</span>
            <span class="token property">&quot;durationInMs&quot;</span><span class="token operator">:</span> <span class="token number">0</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span>
            <span class="token property">&quot;circuitBreakerName&quot;</span><span class="token operator">:</span> <span class="token string">&quot;backendB&quot;</span><span class="token punctuation">,</span>
            <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;SUCCESS&quot;</span><span class="token punctuation">,</span>
            <span class="token property">&quot;creationTime&quot;</span><span class="token operator">:</span> <span class="token string">&quot;2017-01-10T15:41:33.526+01:00[Europe/Berlin]&quot;</span><span class="token punctuation">,</span>
            <span class="token property">&quot;durationInMs&quot;</span><span class="token operator">:</span> <span class="token number">0</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h1 id="spring-cloud-ç»“åˆ" tabindex="-1"><a class="header-anchor" href="#spring-cloud-ç»“åˆ"><span>spring cloud ç»“åˆ</span></a></h1><p>å°†Spring Cloud 2 Starter of Resilience4jæ·»åŠ åˆ°æ‚¨çš„ç¼–è¯‘ä¾èµ–é¡¹ä¸­ã€‚</p><p>Spring Cloud 2 Starterå…è®¸æ‚¨å°†Spring Cloud Configç”¨ä½œåœ¨è¿è¡Œæ—¶ç®¡ç†å’Œåˆ·æ–°å±æ€§ã€‚</p><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code>repositories <span class="token punctuation">{</span>
    <span class="token function">jCenter</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

dependencies <span class="token punctuation">{</span>
    compile <span class="token string">&quot;io.github.resilience4j:resilience4j-spring-cloud2:${resilience4jVersion}&quot;</span>
    <span class="token function">compile</span><span class="token punctuation">(</span>&#39;org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>boot<span class="token operator">:</span>spring<span class="token operator">-</span>boot<span class="token operator">-</span>starter<span class="token operator">-</span>actuator&#39;<span class="token punctuation">)</span>
    <span class="token function">compile</span><span class="token punctuation">(</span>&#39;org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>boot<span class="token operator">:</span>spring<span class="token operator">-</span>boot<span class="token operator">-</span>starter<span class="token operator">-</span>aop&#39;<span class="token punctuation">)</span>
    <span class="token function">compile</span><span class="token punctuation">(</span>&#39;org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>cloud<span class="token operator">:</span>spring<span class="token operator">-</span>cloud<span class="token operator">-</span>starter<span class="token operator">-</span>config&#39;<span class="token punctuation">)</span>  
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h1 id="å’Œfeignç»“åˆ" tabindex="-1"><a class="header-anchor" href="#å’Œfeignç»“åˆ"><span>å’Œfeignç»“åˆ</span></a></h1><p>å½“å‰ä»…æ”¯æŒæ–­è·¯å™¨ã€é™æµå™¨å’Œfallback.</p><h2 id="è£…æ‰®æ¥å£" tabindex="-1"><a class="header-anchor" href="#è£…æ‰®æ¥å£"><span>è£…æ‰®æ¥å£</span></a></h2><p>Resilience4jFeign.builderæ˜¯ç”¨äºåˆ›å»ºfeignçš„å®¹é”™å®ä¾‹çš„ä¸»è¦ç±»ã€‚</p><p>å®ƒæ‰©å±•äº†Feign.builderï¼Œæ·»åŠ è‡ªå®šä¹‰InvocationHandlerFactoryã€‚ Resilience4jFeignä½¿ç”¨å…¶è‡ªå·±çš„InvocationHandlerFactoryæ¥åº”ç”¨è£…é¥°å™¨ã€‚ å¯ä»¥ä½¿ç”¨FeignDecoratorsç±»æ¥æ„å»ºè£…é¥°å™¨ã€‚ å¯ä»¥ç»„åˆå¤šä¸ªè£…é¥°å™¨ã€‚</p><p>ä»¥ä¸‹ç¤ºä¾‹æ˜¾ç¤ºå¦‚ä½•ä½¿ç”¨RateLimiterå’ŒCircuitBreakerè£…é¥°feignæ¥å£ï¼š</p><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">MyService</span> <span class="token punctuation">{</span>
            <span class="token annotation punctuation">@RequestLine</span><span class="token punctuation">(</span><span class="token string">&quot;GET /greeting&quot;</span><span class="token punctuation">)</span>
            <span class="token class-name">String</span> <span class="token function">getGreeting</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            
            <span class="token annotation punctuation">@RequestLine</span><span class="token punctuation">(</span><span class="token string">&quot;POST /greeting&quot;</span><span class="token punctuation">)</span>
            <span class="token class-name">String</span> <span class="token function">createGreeting</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

<span class="token class-name">CircuitBreaker</span> circuitBreaker <span class="token operator">=</span> <span class="token class-name">CircuitBreaker</span><span class="token punctuation">.</span><span class="token function">ofDefaults</span><span class="token punctuation">(</span><span class="token string">&quot;backendName&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">RateLimiter</span> rateLimiter <span class="token operator">=</span> <span class="token class-name">RateLimiter</span><span class="token punctuation">.</span><span class="token function">ofDefaults</span><span class="token punctuation">(</span><span class="token string">&quot;backendName&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">FeignDecorators</span> decorators <span class="token operator">=</span> <span class="token class-name">FeignDecorators</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                                 <span class="token punctuation">.</span><span class="token function">withRateLimiter</span><span class="token punctuation">(</span>rateLimiter<span class="token punctuation">)</span>
                                 <span class="token punctuation">.</span><span class="token function">withCircuitBreaker</span><span class="token punctuation">(</span>circuitBreaker<span class="token punctuation">)</span>
                                 <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">MyService</span> myService <span class="token operator">=</span> <span class="token class-name">Resilience4jFeign</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span>decorators<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">target</span><span class="token punctuation">(</span><span class="token class-name">MyService</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token string">&quot;http://localhost:8080/&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>è°ƒç”¨MyServiceå®ä¾‹çš„ä»»ä½•æ–¹æ³•å°†å…ˆè°ƒç”¨CircuitBreakerï¼Œç„¶åå†è°ƒç”¨RateLimiterã€‚</p><p>å¦‚æœè¿™äº›æœºåˆ¶ä¹‹ä¸€ç”Ÿæ•ˆï¼Œåˆ™å°†å¼•å‘ç›¸åº”çš„RuntimeExceptionï¼Œä¾‹å¦‚CircuitBreakerOpenExceptionæˆ–RequestNotPermittedï¼ˆæç¤ºï¼šè¿™äº›ä¸ä¼šæ‰©å±•FeignExceptionç±»ï¼‰ã€‚<img src="/assets/1621912949221-8935c2a6-f611-4ac4-8e98-f5666bbaa829-CpP5pu3h.png" alt="img" loading="lazy"></p><h2 id="è£…æ‰®å™¨çš„é¡ºåº" tabindex="-1"><a class="header-anchor" href="#è£…æ‰®å™¨çš„é¡ºåº"><span>è£…æ‰®å™¨çš„é¡ºåº</span></a></h2><p>è£…é¥°å™¨çš„åº”ç”¨é¡ºåºä¸å£°æ˜å®ƒä»¬çš„é¡ºåºç›¸å¯¹åº”ã€‚</p><p>åœ¨æ„å»ºFeignDecoratorsæ—¶ï¼Œè¯·æ³¨æ„è¿™ä¸€ç‚¹ï¼Œå› ä¸ºé¡ºåºä¼šå½±å“æœ€ç»ˆçš„è¡Œä¸ºï¼Œè¿™ä¸€ç‚¹å¾ˆé‡è¦ã€‚</p><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token class-name">FeignDecorators</span> decoratorsA <span class="token operator">=</span> <span class="token class-name">FeignDecorators</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                                         <span class="token punctuation">.</span><span class="token function">withCircuitBreaker</span><span class="token punctuation">(</span>circuitBreaker<span class="token punctuation">)</span>
                                         <span class="token punctuation">.</span><span class="token function">withRateLimiter</span><span class="token punctuation">(</span>rateLimiter<span class="token punctuation">)</span>
                                         <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                                         
        <span class="token class-name">FeignDecorators</span> decoratorsB <span class="token operator">=</span> <span class="token class-name">FeignDecorators</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                                         <span class="token punctuation">.</span><span class="token function">withRateLimiter</span><span class="token punctuation">(</span>rateLimiter<span class="token punctuation">)</span>
                                         <span class="token punctuation">.</span><span class="token function">withCircuitBreaker</span><span class="token punctuation">(</span>circuitBreaker<span class="token punctuation">)</span>
                                         <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ä½¿ç”¨decoratorsAæ—¶ï¼Œå°†åœ¨CircuitBreakerä¹‹å‰è°ƒç”¨RateLimiterã€‚ è¿™æ„å‘³ç€å³ä½¿CircuitBreakeræ‰“å¼€ï¼ŒRateLimiterä»å°†é™åˆ¶å‘¼å«é€Ÿç‡ã€‚ decoratorsBåº”ç”¨ç›¸åçš„é¡ºåºã€‚ è¿™æ„å‘³ç€ä¸€æ—¦CircuitBreakeræ‰“å¼€ï¼ŒRateLimiterå°†ä¸å†èµ·ä½œç”¨ã€‚</p><h2 id="fallback" tabindex="-1"><a class="header-anchor" href="#fallback"><span>Fallback</span></a></h2><p>å¯ä»¥å®šä¹‰åœ¨æŠ›å‡ºå¼‚å¸¸æ—¶è°ƒç”¨çš„fallbackã€‚ å½“HTTPè¯·æ±‚å¤±è´¥æ—¶ï¼Œä¹Ÿå¯èƒ½åœ¨FeignDecoratorsä¸­çš„ä¸€ä¸ªæ¿€æ´»æ—¶ï¼Œä¾‹å¦‚CircuitBreakerï¼Œå°±ä¼šå‘ç”Ÿå¼‚å¸¸ã€‚</p><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">MyService</span> <span class="token punctuation">{</span>
            <span class="token annotation punctuation">@RequestLine</span><span class="token punctuation">(</span><span class="token string">&quot;GET /greeting&quot;</span><span class="token punctuation">)</span>
            <span class="token class-name">String</span> <span class="token function">greeting</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

<span class="token class-name">MyService</span> requestFailedFallback <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token string">&quot;fallback greeting&quot;</span><span class="token punctuation">;</span>
<span class="token class-name">MyService</span> circuitBreakerFallback <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token string">&quot;CircuitBreaker is open!&quot;</span><span class="token punctuation">;</span>
<span class="token class-name">CircuitBreaker</span> circuitBreaker <span class="token operator">=</span> <span class="token class-name">CircuitBreaker</span><span class="token punctuation">.</span><span class="token function">ofDefaults</span><span class="token punctuation">(</span><span class="token string">&quot;backendName&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">FeignDecorators</span> decorators <span class="token operator">=</span> <span class="token class-name">FeignDecorators</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                         <span class="token punctuation">.</span><span class="token function">withFallback</span><span class="token punctuation">(</span>requestFailedFallback<span class="token punctuation">,</span> <span class="token class-name">FeignException</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
                         <span class="token punctuation">.</span><span class="token function">withFallback</span><span class="token punctuation">(</span>circuitBreakerFallback<span class="token punctuation">,</span> <span class="token class-name">CircuitBreakerOpenException</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
                         <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">MyService</span> myService <span class="token operator">=</span> <span class="token class-name">Resilience4jFeign</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span>decorators<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">target</span><span class="token punctuation">(</span><span class="token class-name">MyService</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token string">&quot;http://localhost:8080/&quot;</span><span class="token punctuation">,</span> fallback<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>åœ¨æ­¤ç¤ºä¾‹ä¸­ï¼Œå½“æŠ›å‡ºFeignExceptionæ—¶ï¼ˆé€šå¸¸åœ¨HTTPè¯·æ±‚å¤±è´¥æ—¶ï¼‰å°†è°ƒç”¨requestFailedFallbackï¼Œè€Œä»…åœ¨CircuitBreakerOpenExceptionæƒ…å†µä¸‹æ‰è°ƒç”¨circuitBreakerFallbackã€‚ æ£€æŸ¥FeignDecoratorsç±»ï¼Œä»¥äº†è§£æ›´å¤šè¿‡æ»¤åå¤‡çš„æ–¹æ³•ã€‚</p><p>æ‰€æœ‰å›é€€å¿…é¡»å®ç°åœ¨â€œç›®æ ‡â€ï¼ˆResilience4jFeign.Builderï¼ƒtargetï¼‰æ–¹æ³•ä¸­å£°æ˜çš„ç›¸åŒæ¥å£ï¼Œå¦åˆ™å°†æŠ›å‡ºIllegalArgumentExceptionã€‚</p><p>å¯ä»¥åˆ†é…å¤šä¸ªå›é€€æ¥å¤„ç†ç›¸åŒçš„Exceptionï¼Œå¹¶åœ¨å‰ä¸€ä¸ªå¤±è´¥æ—¶è°ƒç”¨ä¸‹ä¸€ä¸ªå›é€€ã€‚</p><p>å¦‚æœéœ€è¦ï¼Œå›é€€å¯ä»¥æ¶ˆè€—æŠ›å‡ºçš„Exceptionã€‚ å¦‚æœå›é€€å–å†³äºå¼‚å¸¸å¯èƒ½å…·æœ‰ä¸åŒçš„è¡Œä¸ºï¼Œæˆ–è€…ä»…è®°å½•å¼‚å¸¸ï¼Œè¿™å°†å¾ˆæœ‰ç”¨ã€‚</p><p>è¯·æ³¨æ„ï¼Œå°†ä¸ºæŠ›å‡ºçš„æ¯ä¸ªå¼‚å¸¸å®ä¾‹åŒ–è¿™ç§å›é€€ã€‚</p><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">MyService</span> <span class="token punctuation">{</span>
            <span class="token annotation punctuation">@RequestLine</span><span class="token punctuation">(</span><span class="token string">&quot;GET /greeting&quot;</span><span class="token punctuation">)</span>
            <span class="token class-name">String</span> <span class="token function">greeting</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MyFallback</span> <span class="token keyword">implements</span> <span class="token class-name">MyService</span> <span class="token punctuation">{</span>
            <span class="token keyword">private</span> <span class="token class-name">Exception</span> cause<span class="token punctuation">;</span>

            <span class="token keyword">public</span> <span class="token class-name">MyFallback</span><span class="token punctuation">(</span><span class="token class-name">Exception</span> cause<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>cause <span class="token operator">=</span> cause<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">greeting</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>cause instanceOf <span class="token class-name">FeignException</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">return</span> <span class="token string">&quot;Feign Exception&quot;</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                    <span class="token keyword">return</span> <span class="token string">&quot;Other exception&quot;</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token class-name">FeignDecorators</span> decorators <span class="token operator">=</span> <span class="token class-name">FeignDecorators</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">withFallbackFactory</span><span class="token punctuation">(</span><span class="token class-name">MyFallback</span><span class="token operator">::</span><span class="token keyword">new</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></div><!--[--><!----><!--]--><footer class="vp-page-meta"><div class="vp-meta-item edit-link"><a href="https://github.com/banrenshan/banrenshan.github.io/edit/main/src/post/Resilience4j.md" rel="noopener noreferrer" target="_blank" aria-label="åœ¨ GitHub ä¸Šç¼–è¾‘æ­¤é¡µ" class="nav-link vp-meta-label"><!--[--><svg xmlns="http://www.w3.org/2000/svg" class="icon edit-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="edit icon"><path d="M430.818 653.65a60.46 60.46 0 0 1-50.96-93.281l71.69-114.012 7.773-10.365L816.038 80.138A60.46 60.46 0 0 1 859.225 62a60.46 60.46 0 0 1 43.186 18.138l43.186 43.186a60.46 60.46 0 0 1 0 86.373L588.879 565.55l-8.637 8.637-117.466 68.234a60.46 60.46 0 0 1-31.958 11.229z"></path><path d="M728.802 962H252.891A190.883 190.883 0 0 1 62.008 771.98V296.934a190.883 190.883 0 0 1 190.883-192.61h267.754a60.46 60.46 0 0 1 0 120.92H252.891a69.962 69.962 0 0 0-69.098 69.099V771.98a69.962 69.962 0 0 0 69.098 69.098h475.911A69.962 69.962 0 0 0 797.9 771.98V503.363a60.46 60.46 0 1 1 120.922 0V771.98A190.883 190.883 0 0 1 728.802 962z"></path></svg><!--]-->åœ¨ GitHub ä¸Šç¼–è¾‘æ­¤é¡µ<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span><!----></a></div><div class="vp-meta-item git-info"><div class="update-time"><span class="vp-meta-label">ä¸Šæ¬¡ç¼–è¾‘äº: </span><!----></div><div class="contributors"><span class="vp-meta-label">è´¡çŒ®è€…: </span><!--[--><!--[--><span class="vp-meta-info" title="email: CP_zhaozhiqiang@163.com">banrenshan</span><!--]--><!--]--></div></div></footer><nav class="vp-page-nav"><a class="route-link nav-link prev" href="/post/nginx.html" aria-label="nginx"><div class="hint"><span class="arrow start"></span>ä¸Šä¸€é¡µ</div><div class="link"><!---->nginx</div></a><a class="route-link nav-link next" href="/post/zero-copy.html" aria-label="zero-copy"><div class="hint">ä¸‹ä¸€é¡µ<span class="arrow end"></span></div><div class="link">zero-copy<!----></div></a></nav><!----><!--[--><!----><!--]--><!--]--></main><!--]--><!----></div><!--]--><!--]--><!--[--><!----><!--]--><!--]--></div>
    <script type="module" src="/assets/app-DSYRoKiT.js" defer></script>
  </body>
</html>
