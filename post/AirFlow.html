<!doctype html>
<html lang="zh-CN" data-theme="light">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <meta name="generator" content="VuePress 2.0.0-rc.9" />
    <meta name="theme" content="VuePress Theme Hope 2.0.0-rc.36" />
    <style>
      html {
        background: var(--bg-color, #fff);
      }

      html[data-theme="dark"] {
        background: var(--bg-color, #1d1e1f);
      }

      body {
        background: var(--bg-color);
      }
    </style>
    <script>
      const userMode = localStorage.getItem("vuepress-theme-hope-scheme");
      const systemDarkMode =
        window.matchMedia &&
        window.matchMedia("(prefers-color-scheme: dark)").matches;

      if (userMode === "dark" || (userMode !== "light" && systemDarkMode)) {
        document.documentElement.setAttribute("data-theme", "dark");
      }
    </script>
    <meta property="og:url" content="https://banrenshan.github.io/post/AirFlow.html"><meta property="og:site_name" content="å¿ƒä¹‹æ‰€å‘ï¼Œç´ å±¥ä»¥å¾€"><meta property="og:title" content="AirFlow"><meta property="og:description" content="Airflowæ˜¯ä¸€ä¸ªç”¨äºå¼€å‘ã€è°ƒåº¦å’Œç›‘æ§ é¢å‘æ‰¹å¤„ç†çš„å·¥ä½œæµ çš„å¼€æºå¹³å°ã€‚ä¸»è¦ç‰¹ç‚¹æ˜¯æ‰€æœ‰å·¥ä½œæµéƒ½æ˜¯ç”¨Pythonä»£ç å®šä¹‰çš„ã€‚ å¿«é€Ÿå…¥é—¨ ä¸€ä¸ªåä¸º demo çš„DAGï¼Œä»2022å¹´1æœˆ1æ—¥å¼€å§‹ï¼Œæ¯å¤©è¿è¡Œä¸€æ¬¡ã€‚DAGæ˜¯Airflowå¯¹å·¥ä½œæµçš„è¡¨ç¤ºã€‚ ä¸¤ä¸ªä»»åŠ¡ï¼Œä¸€ä¸ªæ˜¯è¿è¡ŒBashè„šæœ¬çš„BashOperatorï¼Œå¦ä¸€ä¸ªæ˜¯ä½¿ç”¨@task decoratorå®šä¹‰çš„..."><meta property="og:type" content="article"><meta property="og:image" content="http://montcs.bloomu.edu/~bobmon/Semesters/2012-01/491/import%20soul.png"><meta property="og:locale" content="zh-CN"><meta property="og:updated_time" content="2024-04-15T13:40:04.000Z"><meta property="article:author" content="banrenshan"><meta property="article:tag" content="AirFlow"><meta property="article:tag" content="ä»»åŠ¡è°ƒåº¦"><meta property="article:published_time" content="2023-10-08T00:00:00.000Z"><meta property="article:modified_time" content="2024-04-15T13:40:04.000Z"><script type="application/ld+json">{"@context":"https://schema.org","@type":"Article","headline":"AirFlow","image":["http://montcs.bloomu.edu/~bobmon/Semesters/2012-01/491/import%20soul.png"],"datePublished":"2023-10-08T00:00:00.000Z","dateModified":"2024-04-15T13:40:04.000Z","author":[{"@type":"Person","name":"banrenshan","url":"https://github.com/banrenshan"}]}</script><title>AirFlow | å¿ƒä¹‹æ‰€å‘ï¼Œç´ å±¥ä»¥å¾€</title><meta name="description" content="Airflowæ˜¯ä¸€ä¸ªç”¨äºå¼€å‘ã€è°ƒåº¦å’Œç›‘æ§ é¢å‘æ‰¹å¤„ç†çš„å·¥ä½œæµ çš„å¼€æºå¹³å°ã€‚ä¸»è¦ç‰¹ç‚¹æ˜¯æ‰€æœ‰å·¥ä½œæµéƒ½æ˜¯ç”¨Pythonä»£ç å®šä¹‰çš„ã€‚ å¿«é€Ÿå…¥é—¨ ä¸€ä¸ªåä¸º demo çš„DAGï¼Œä»2022å¹´1æœˆ1æ—¥å¼€å§‹ï¼Œæ¯å¤©è¿è¡Œä¸€æ¬¡ã€‚DAGæ˜¯Airflowå¯¹å·¥ä½œæµçš„è¡¨ç¤ºã€‚ ä¸¤ä¸ªä»»åŠ¡ï¼Œä¸€ä¸ªæ˜¯è¿è¡ŒBashè„šæœ¬çš„BashOperatorï¼Œå¦ä¸€ä¸ªæ˜¯ä½¿ç”¨@task decoratorå®šä¹‰çš„...">
    <link rel="preload" href="/assets/style-wL6mR3b5.css" as="style"><link rel="stylesheet" href="/assets/style-wL6mR3b5.css">
    <link rel="modulepreload" href="/assets/app-DMMI-IL5.js"><link rel="modulepreload" href="/assets/AirFlow.html-CrGw0Qby.js"><link rel="modulepreload" href="/assets/plugin-vue_export-helper-DlAUqK2U.js">
    <link rel="prefetch" href="/assets/index.html-ljx2ySIn.js" as="script"><link rel="prefetch" href="/assets/go-Context.html-DOZI6Z63.js" as="script"><link rel="prefetch" href="/assets/goå‘½ä»¤è¡Œ.html-Du41D2pA.js" as="script"><link rel="prefetch" href="/assets/goåŸºç¡€.html-B4eMZBfm.js" as="script"><link rel="prefetch" href="/assets/goå¹¶å‘.html-B4-aQHB8.js" as="script"><link rel="prefetch" href="/assets/goæ ‡å‡†åº“-json.html-CZC1PPEp.js" as="script"><link rel="prefetch" href="/assets/goæ ‡å‡†åº“-time.html-CYsRMJkn.js" as="script"><link rel="prefetch" href="/assets/goæ¨¡å—.html-DsiM4JLd.js" as="script"><link rel="prefetch" href="/assets/goæ³›å‹.html-CowFXSVB.js" as="script"><link rel="prefetch" href="/assets/goç¯å¢ƒ.html-YSNMcgBo.js" as="script"><link rel="prefetch" href="/assets/goé¢å‘å¯¹è±¡.html-DNwXf7eZ.js" as="script"><link rel="prefetch" href="/assets/k8s-client-go.html-Do7lql2L.js" as="script"><link rel="prefetch" href="/assets/è™šæ‹Ÿç¯å¢ƒ.html-dqPWnhii.js" as="script"><link rel="prefetch" href="/assets/ewsé‚®ç®±.html-BJktdj6j.js" as="script"><link rel="prefetch" href="/assets/gradle.html-BYfEyJsH.js" as="script"><link rel="prefetch" href="/assets/springäº‹åŠ¡.html-Dg7udx_3.js" as="script"><link rel="prefetch" href="/assets/æ ¡éªŒæ³¨è§£.html-BmAl1Fph.js" as="script"><link rel="prefetch" href="/assets/helm.html-vrch1_5F.js" as="script"><link rel="prefetch" href="/assets/istio.html-CKYYE9I-.js" as="script"><link rel="prefetch" href="/assets/minikube.html-C7HjKvD4.js" as="script"><link rel="prefetch" href="/assets/00-é‡‘èçŸ¥è¯†.html-Cfav5_v-.js" as="script"><link rel="prefetch" href="/assets/01-flyway.html-B68M-Etj.js" as="script"><link rel="prefetch" href="/assets/02-jsonassert.html-De9XZSu3.js" as="script"><link rel="prefetch" href="/assets/03-Junit5.html-Ci75kR4n.js" as="script"><link rel="prefetch" href="/assets/04-mocktio.html-CEq3cg09.js" as="script"><link rel="prefetch" href="/assets/05-jsonpath.html-DBXNOMO-.js" as="script"><link rel="prefetch" href="/assets/06-spring-cloud-common.html-Ck7zVjCS.js" as="script"><link rel="prefetch" href="/assets/07-oracle.html-mRXn5Stv.js" as="script"><link rel="prefetch" href="/assets/08-å¿«æ·é”®.html-B3pZI_HM.js" as="script"><link rel="prefetch" href="/assets/09-ç¼–ç¨‹è§„èŒƒ.html-pWdIzXM9.js" as="script"><link rel="prefetch" href="/assets/10-å¤šçº¿ç¨‹.html-qjluoQKy.js" as="script"><link rel="prefetch" href="/assets/11-åˆ†å¸ƒå¼äº‹åŠ¡.html-BZ8Jq_m-.js" as="script"><link rel="prefetch" href="/assets/12-autosys.html-DFe8Tnpv.js" as="script"><link rel="prefetch" href="/assets/13-spring-retryå®˜æ–¹æŒ‡å—.html-nV-dCR8l.js" as="script"><link rel="prefetch" href="/assets/14-spring-integration.html-CLYJIAhk.js" as="script"><link rel="prefetch" href="/assets/15-Hibernate.html-Dtt7fKfG.js" as="script"><link rel="prefetch" href="/assets/16-å¼€å‘ç¯å¢ƒ.html-DWkZJsqo.js" as="script"><link rel="prefetch" href="/assets/17-OpenShiftè·¯ç”±.html-BzzZ8nsd.js" as="script"><link rel="prefetch" href="/assets/mysqlä¼˜åŒ–.html-4bOIvQ_n.js" as="script"><link rel="prefetch" href="/assets/mysqlç´¢å¼•.html-CgUnssHf.js" as="script"><link rel="prefetch" href="/assets/mysqlè¿ç»´å’Œç›‘æ§.html-BbaBEbEp.js" as="script"><link rel="prefetch" href="/assets/mysqlé«˜çº§.html-CoAioaNy.js" as="script"><link rel="prefetch" href="/assets/spring-data-jpa.html-_n-nbU9q.js" as="script"><link rel="prefetch" href="/assets/spring-data-redis.html-CFVSzsYC.js" as="script"><link rel="prefetch" href="/assets/ERå›¾.html--3x9wq6_.js" as="script"><link rel="prefetch" href="/assets/Resilience4j.html-RcFB8KYb.js" as="script"><link rel="prefetch" href="/assets/filebeat.html-Bpaf7HIz.js" as="script"><link rel="prefetch" href="/assets/goè¯­è¨€.html-C2UKhgra.js" as="script"><link rel="prefetch" href="/assets/gradle-basic.html-BrhO_3ZY.js" as="script"><link rel="prefetch" href="/assets/gradle-depedency.html-Cw_U5bvx.js" as="script"><link rel="prefetch" href="/assets/gradle-java.html-DqjYdWLO.js" as="script"><link rel="prefetch" href="/assets/grafana-1.html-DW4warot.js" as="script"><link rel="prefetch" href="/assets/grafana.html-BaEVq0qw.js" as="script"><link rel="prefetch" href="/assets/javaæ¥å£.html-qE14rKd_.js" as="script"><link rel="prefetch" href="/assets/javaæ—¥æœŸ.html-BDxmJmQb.js" as="script"><link rel="prefetch" href="/assets/javaæ³¨è§£.html-BwbpSPoO.js" as="script"><link rel="prefetch" href="/assets/loki.html-C0dzyIqw.js" as="script"><link rel="prefetch" href="/assets/nginx.html-RqhrnP8W.js" as="script"><link rel="prefetch" href="/assets/remoteConnection.html-LX6mbspx.js" as="script"><link rel="prefetch" href="/assets/zero-copy.html-CHIp3h84.js" as="script"><link rel="prefetch" href="/assets/å¤šçº¿ç¨‹-Exchanger.html-DPjYwr_r.js" as="script"><link rel="prefetch" href="/assets/Vscode.html-CuHhjwF0.js" as="script"><link rel="prefetch" href="/assets/ä»£ç†.html-Ds41vERL.js" as="script"><link rel="prefetch" href="/assets/404.html-N967FDFb.js" as="script"><link rel="prefetch" href="/assets/index.html-P1m3P8Dc.js" as="script"><link rel="prefetch" href="/assets/index.html-DPnESbwX.js" as="script"><link rel="prefetch" href="/assets/index.html-BhqPiDxe.js" as="script"><link rel="prefetch" href="/assets/index.html-Cb-t2wX6.js" as="script"><link rel="prefetch" href="/assets/index.html-DR74rPYd.js" as="script"><link rel="prefetch" href="/assets/index.html-D49p3apK.js" as="script"><link rel="prefetch" href="/assets/index.html-CJIsSlqa.js" as="script"><link rel="prefetch" href="/assets/index.html-DMNiHXk6.js" as="script"><link rel="prefetch" href="/assets/index.html-952nH6Zv.js" as="script"><link rel="prefetch" href="/assets/index.html-BYobQwpa.js" as="script"><link rel="prefetch" href="/assets/index.html-Z2bxrRZv.js" as="script"><link rel="prefetch" href="/assets/index.html-CNSc70Tr.js" as="script"><link rel="prefetch" href="/assets/index.html-BMcJseTy.js" as="script"><link rel="prefetch" href="/assets/index.html-BZOkVxhK.js" as="script"><link rel="prefetch" href="/assets/index.html-CfiVXRqL.js" as="script"><link rel="prefetch" href="/assets/index.html-C5s5fZA8.js" as="script"><link rel="prefetch" href="/assets/index.html-CNSc70Tr.js" as="script"><link rel="prefetch" href="/assets/index.html-C_ehIC3V.js" as="script"><link rel="prefetch" href="/assets/index.html-DDo0bQoH.js" as="script"><link rel="prefetch" href="/assets/index.html-BssFn-ez.js" as="script"><link rel="prefetch" href="/assets/index.html-buMfTyaz.js" as="script"><link rel="prefetch" href="/assets/index.html-BlNpW_Xk.js" as="script"><link rel="prefetch" href="/assets/index.html-CHg_oGW9.js" as="script"><link rel="prefetch" href="/assets/index.html-D4NHgwRt.js" as="script"><link rel="prefetch" href="/assets/index.html-BMcJseTy.js" as="script"><link rel="prefetch" href="/assets/index.html-1WB-7mxe.js" as="script"><link rel="prefetch" href="/assets/index.html-BajfZzY6.js" as="script"><link rel="prefetch" href="/assets/index.html-952nH6Zv.js" as="script"><link rel="prefetch" href="/assets/index.html-qX6BD477.js" as="script"><link rel="prefetch" href="/assets/index.html-DmossWt-.js" as="script"><link rel="prefetch" href="/assets/index.html-Dneuzcrt.js" as="script"><link rel="prefetch" href="/assets/index.html-DsG-wtqH.js" as="script"><link rel="prefetch" href="/assets/index.html-CVLkYf-T.js" as="script"><link rel="prefetch" href="/assets/index.html-CYqiBnKP.js" as="script"><link rel="prefetch" href="/assets/index.html-Xob89Upc.js" as="script"><link rel="prefetch" href="/assets/index.html-0TflCnwi.js" as="script"><link rel="prefetch" href="/assets/index.html-D8nzE-Gx.js" as="script"><link rel="prefetch" href="/assets/index.html-DHV9x0XK.js" as="script"><link rel="prefetch" href="/assets/index.html-DttjKt1k.js" as="script"><link rel="prefetch" href="/assets/index.html-Bo6IFWPR.js" as="script"><link rel="prefetch" href="/assets/index.html-CpSrViwB.js" as="script"><link rel="prefetch" href="/assets/index.html-zd-h-aDP.js" as="script"><link rel="prefetch" href="/assets/index.html-CDbVKm8u.js" as="script"><link rel="prefetch" href="/assets/index.html-Dnwjy0_X.js" as="script"><link rel="prefetch" href="/assets/index.html-BKy_tmdC.js" as="script"><link rel="prefetch" href="/assets/index.html-AG70gP8c.js" as="script"><link rel="prefetch" href="/assets/index.html-Cu2mLq9S.js" as="script"><link rel="prefetch" href="/assets/index.html-8-EVwlxI.js" as="script"><link rel="prefetch" href="/assets/index.html-Cly8oag5.js" as="script"><link rel="prefetch" href="/assets/index.html-DbU2Jpsm.js" as="script"><link rel="prefetch" href="/assets/index.html-BvtBOARr.js" as="script"><link rel="prefetch" href="/assets/index.html-B3KoqgLt.js" as="script"><link rel="prefetch" href="/assets/index.html-DnTzXOfv.js" as="script"><link rel="prefetch" href="/assets/index.html-BfGmWWJn.js" as="script"><link rel="prefetch" href="/assets/index.html-ihXQAJSz.js" as="script"><link rel="prefetch" href="/assets/index.html-BSaTvVoA.js" as="script"><link rel="prefetch" href="/assets/index.html-B7nV-xpE.js" as="script"><link rel="prefetch" href="/assets/index.html-KUczFPFP.js" as="script"><link rel="prefetch" href="/assets/index.html-0lVBwd42.js" as="script"><link rel="prefetch" href="/assets/index.html-B5bOe9ly.js" as="script"><link rel="prefetch" href="/assets/index.html-LttTQAm5.js" as="script"><link rel="prefetch" href="/assets/index.html-Bs4jKZxn.js" as="script"><link rel="prefetch" href="/assets/index.html-Dph2T67n.js" as="script"><link rel="prefetch" href="/assets/index.html-Wg1bZUTs.js" as="script"><link rel="prefetch" href="/assets/index.html-C9Wbg5XQ.js" as="script"><link rel="prefetch" href="/assets/index.html-BT1ekKuQ.js" as="script"><link rel="prefetch" href="/assets/index.html-0TflCnwi.js" as="script"><link rel="prefetch" href="/assets/index.html-Bp8-vnAx.js" as="script"><link rel="prefetch" href="/assets/index.html-v5ZQPG-h.js" as="script"><link rel="prefetch" href="/assets/index.html-D9dL3S4z.js" as="script"><link rel="prefetch" href="/assets/index.html-DOAr2oNw.js" as="script"><link rel="prefetch" href="/assets/index.html-CkAGf3w1.js" as="script"><link rel="prefetch" href="/assets/index.html-D9a43-_d.js" as="script"><link rel="prefetch" href="/assets/index.html-B1g-op6-.js" as="script"><link rel="prefetch" href="/assets/index.html-z3Myytui.js" as="script"><link rel="prefetch" href="/assets/index.html-xynJs8Mb.js" as="script"><link rel="prefetch" href="/assets/index.html-CvJu0EpW.js" as="script"><link rel="prefetch" href="/assets/index.html-DOQIKadI.js" as="script"><link rel="prefetch" href="/assets/index.html-CJJkKtIh.js" as="script"><link rel="prefetch" href="/assets/index.html-BMe3AFTI.js" as="script"><link rel="prefetch" href="/assets/index.html-8CTnOaDC.js" as="script"><link rel="prefetch" href="/assets/index.html-Ch9dIMZB.js" as="script"><link rel="prefetch" href="/assets/index.html-NnYA_-q4.js" as="script"><link rel="prefetch" href="/assets/photoswipe.esm-SzV8tJDW.js" as="script">
  </head>
  <body>
    <div id="app"><!--[--><!--[--><!--[--><span tabindex="-1"></span><a href="#main-content" class="vp-skip-link sr-only">è·³è‡³ä¸»è¦å…§å®¹</a><!--]--><!--[--><div class="theme-container has-toc"><!--[--><header id="navbar" class="vp-navbar"><div class="vp-navbar-start"><button type="button" class="vp-toggle-sidebar-button" title="Toggle Sidebar"><span class="icon"></span></button><!--[--><!----><!--]--><!--[--><a class="route-link vp-brand" href="/"><img class="vp-nav-logo" src="https://theme-hope-assets.vuejs.press/logo.svg" alt><!----><span class="vp-site-name hide-in-pad">å¿ƒä¹‹æ‰€å‘ï¼Œç´ å±¥ä»¥å¾€</span></a><!--]--><!--[--><!----><!--]--></div><div class="vp-navbar-center"><!--[--><!----><!--]--><!--[--><nav class="vp-nav-links"><div class="vp-nav-item hide-in-mobile"><a class="route-link nav-link" href="/" aria-label="ä¸»é¡µ"><span class="font-icon icon fa-fw fa-sm fas fa-home" style=""></span>ä¸»é¡µ<!----></a></div><div class="vp-nav-item hide-in-mobile"><a class="route-link nav-link active" href="/post/" aria-label="åšæ–‡"><span class="font-icon icon fa-fw fa-sm fas fa-pen-to-square" style=""></span>åšæ–‡<!----></a></div><div class="vp-nav-item hide-in-mobile"><a class="route-link nav-link" href="/timeline/" aria-label="äº‹ä»¶è½´"><span class="font-icon icon fa-fw fa-sm fas fa-timeline" style=""></span>äº‹ä»¶è½´<!----></a></div><div class="vp-nav-item hide-in-mobile"><a class="route-link nav-link" href="/tag/" aria-label="æ ‡ç­¾"><span class="font-icon icon fa-fw fa-sm fas fa-tags" style=""></span>æ ‡ç­¾<!----></a></div><div class="vp-nav-item hide-in-mobile"><a class="route-link nav-link" href="/category/" aria-label="åˆ†ç±»"><span class="font-icon icon fa-fw fa-sm fas fa-book" style=""></span>åˆ†ç±»<!----></a></div></nav><!--]--><!--[--><!----><!--]--></div><div class="vp-navbar-end"><!--[--><!----><!--]--><!--[--><!----><div class="vp-nav-item vp-action"><a class="vp-action-link" href="https://github.com/banrenshan/banrenshan.github.io" target="_blank" rel="noopener noreferrer" aria-label="GitHub"><svg xmlns="http://www.w3.org/2000/svg" class="icon github-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="github icon" style="width:1.25rem;height:1.25rem;vertical-align:middle;"><path d="M511.957 21.333C241.024 21.333 21.333 240.981 21.333 512c0 216.832 140.544 400.725 335.574 465.664 24.49 4.395 32.256-10.07 32.256-23.083 0-11.69.256-44.245 0-85.205-136.448 29.61-164.736-64.64-164.736-64.64-22.315-56.704-54.4-71.765-54.4-71.765-44.587-30.464 3.285-29.824 3.285-29.824 49.195 3.413 75.179 50.517 75.179 50.517 43.776 75.008 114.816 53.333 142.762 40.79 4.523-31.66 17.152-53.377 31.19-65.537-108.971-12.458-223.488-54.485-223.488-242.602 0-53.547 19.114-97.323 50.517-131.67-5.035-12.33-21.93-62.293 4.779-129.834 0 0 41.258-13.184 134.912 50.346a469.803 469.803 0 0 1 122.88-16.554c41.642.213 83.626 5.632 122.88 16.554 93.653-63.488 134.784-50.346 134.784-50.346 26.752 67.541 9.898 117.504 4.864 129.834 31.402 34.347 50.474 78.123 50.474 131.67 0 188.586-114.73 230.016-224.042 242.09 17.578 15.232 33.578 44.672 33.578 90.454v135.85c0 13.142 7.936 27.606 32.854 22.87C862.25 912.597 1002.667 728.747 1002.667 512c0-271.019-219.648-490.667-490.71-490.667z"></path></svg></a></div><div class="vp-nav-item hide-in-mobile"><button type="button" id="appearance-switch"><svg xmlns="http://www.w3.org/2000/svg" class="icon auto-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="auto icon" style="display:block;"><path d="M512 992C246.92 992 32 777.08 32 512S246.92 32 512 32s480 214.92 480 480-214.92 480-480 480zm0-840c-198.78 0-360 161.22-360 360 0 198.84 161.22 360 360 360s360-161.16 360-360c0-198.78-161.22-360-360-360zm0 660V212c165.72 0 300 134.34 300 300 0 165.72-134.28 300-300 300z"></path></svg><svg xmlns="http://www.w3.org/2000/svg" class="icon dark-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="dark icon" style="display:none;"><path d="M524.8 938.667h-4.267a439.893 439.893 0 0 1-313.173-134.4 446.293 446.293 0 0 1-11.093-597.334A432.213 432.213 0 0 1 366.933 90.027a42.667 42.667 0 0 1 45.227 9.386 42.667 42.667 0 0 1 10.24 42.667 358.4 358.4 0 0 0 82.773 375.893 361.387 361.387 0 0 0 376.747 82.774 42.667 42.667 0 0 1 54.187 55.04 433.493 433.493 0 0 1-99.84 154.88 438.613 438.613 0 0 1-311.467 128z"></path></svg><svg xmlns="http://www.w3.org/2000/svg" class="icon light-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="light icon" style="display:none;"><path d="M952 552h-80a40 40 0 0 1 0-80h80a40 40 0 0 1 0 80zM801.88 280.08a41 41 0 0 1-57.96-57.96l57.96-58a41.04 41.04 0 0 1 58 58l-58 57.96zM512 752a240 240 0 1 1 0-480 240 240 0 0 1 0 480zm0-560a40 40 0 0 1-40-40V72a40 40 0 0 1 80 0v80a40 40 0 0 1-40 40zm-289.88 88.08-58-57.96a41.04 41.04 0 0 1 58-58l57.96 58a41 41 0 0 1-57.96 57.96zM192 512a40 40 0 0 1-40 40H72a40 40 0 0 1 0-80h80a40 40 0 0 1 40 40zm30.12 231.92a41 41 0 0 1 57.96 57.96l-57.96 58a41.04 41.04 0 0 1-58-58l58-57.96zM512 832a40 40 0 0 1 40 40v80a40 40 0 0 1-80 0v-80a40 40 0 0 1 40-40zm289.88-88.08 58 57.96a41.04 41.04 0 0 1-58 58l-57.96-58a41 41 0 0 1 57.96-57.96z"></path></svg></button></div><!----><!--]--><!--[--><!----><!--]--><button type="button" class="vp-toggle-navbar-button" aria-label="Toggle Navbar" aria-expanded="false" aria-controls="nav-screen"><span><span class="vp-top"></span><span class="vp-middle"></span><span class="vp-bottom"></span></span></button></div></header><!----><!--]--><!----><div class="toggle-sidebar-wrapper"><span class="arrow start"></span></div><aside id="sidebar" class="vp-sidebar"><!--[--><!----><!--]--><ul class="vp-sidebar-links"><li><section class="vp-sidebar-group"><p class="vp-sidebar-header clickable"><span class="font-icon icon fa-fw fa-sm fas fa-laptop-code" style=""></span><a class="route-link nav-link vp-sidebar-title" href="/gudie/" aria-label="æŒ‡å—"><!---->æŒ‡å—<!----></a><!----></p><ul class="vp-sidebar-links"><li><a class="route-link nav-link vp-sidebar-link vp-sidebar-page" href="/gudie/12-autosys.html" aria-label="AutoSys"><!---->AutoSys<!----></a></li><li><a class="route-link nav-link vp-sidebar-link vp-sidebar-page" href="/gudie/01-flyway.html" aria-label="flywayæŒ‡å—"><!---->flywayæŒ‡å—<!----></a></li><li><a class="route-link nav-link vp-sidebar-link vp-sidebar-page" href="/gudie/15-Hibernate.html" aria-label="Hibernate æŒ‡å—"><!---->Hibernate æŒ‡å—<!----></a></li><li><a class="route-link nav-link vp-sidebar-link vp-sidebar-page" href="/gudie/02-jsonassert.html" aria-label="JSONassertæŒ‡å—"><!---->JSONassertæŒ‡å—<!----></a></li><li><a class="route-link nav-link vp-sidebar-link vp-sidebar-page" href="/gudie/05-jsonpath.html" aria-label="JsonPath æŒ‡å—"><!---->JsonPath æŒ‡å—<!----></a></li><li><a class="route-link nav-link vp-sidebar-link vp-sidebar-page" href="/gudie/03-Junit5.html" aria-label="JUnit5æŒ‡å—"><!---->JUnit5æŒ‡å—<!----></a></li><li><a class="route-link nav-link vp-sidebar-link vp-sidebar-page" href="/gudie/04-mocktio.html" aria-label="mocktioæŒ‡å—"><!---->mocktioæŒ‡å—<!----></a></li><li><a class="route-link nav-link vp-sidebar-link vp-sidebar-page" href="/gudie/17-OpenShift%E8%B7%AF%E7%94%B1.html" aria-label="OpenShift è·¯ç”±"><!---->OpenShift è·¯ç”±<!----></a></li><li><a class="route-link nav-link vp-sidebar-link vp-sidebar-page" href="/gudie/07-oracle.html" aria-label="OracleåŸºç¡€ æŒ‡å—"><!---->OracleåŸºç¡€ æŒ‡å—<!----></a></li><li><a class="route-link nav-link vp-sidebar-link vp-sidebar-page" href="/gudie/spring-data-redis.html" aria-label="redisæ”¯æŒ"><!---->redisæ”¯æŒ<!----></a></li><li><a class="route-link nav-link vp-sidebar-link vp-sidebar-page" href="/gudie/spring-data-jpa.html" aria-label="Spring Data Repositories"><!---->Spring Data Repositories<!----></a></li><li><a class="route-link nav-link vp-sidebar-link vp-sidebar-page" href="/gudie/14-spring-integration.html" aria-label="Spring Integration æŒ‡å—"><!---->Spring Integration æŒ‡å—<!----></a></li><li><a class="route-link nav-link vp-sidebar-link vp-sidebar-page" href="/gudie/13-spring-retry%E5%AE%98%E6%96%B9%E6%8C%87%E5%8D%97.html" aria-label="Spring Retry æŒ‡å—"><!---->Spring Retry æŒ‡å—<!----></a></li><li><a class="route-link nav-link vp-sidebar-link vp-sidebar-page" href="/gudie/06-spring-cloud-common.html" aria-label="Spring-CLoud-Common"><!---->Spring-CLoud-Common<!----></a></li><li><a class="route-link nav-link vp-sidebar-link vp-sidebar-page" href="/gudie/mysql%E4%BC%98%E5%8C%96.html" aria-label="sqlè¯­å¥ä¸Šçš„ä¼˜åŒ–"><!---->sqlè¯­å¥ä¸Šçš„ä¼˜åŒ–<!----></a></li><li><a class="route-link nav-link vp-sidebar-link vp-sidebar-page" href="/gudie/11-%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1.html" aria-label="åˆ†å¸ƒå¼äº‹åŠ¡"><!---->åˆ†å¸ƒå¼äº‹åŠ¡<!----></a></li><li><a class="route-link nav-link vp-sidebar-link vp-sidebar-page" href="/gudie/10-%E5%A4%9A%E7%BA%BF%E7%A8%8B.html" aria-label="å¤šçº¿ç¨‹"><!---->å¤šçº¿ç¨‹<!----></a></li><li><a class="route-link nav-link vp-sidebar-link vp-sidebar-page" href="/gudie/mysql%E9%AB%98%E7%BA%A7.html" aria-label="å®‰è£…"><!---->å®‰è£…<!----></a></li><li><a class="route-link nav-link vp-sidebar-link vp-sidebar-page" href="/gudie/16-%E5%BC%80%E5%8F%91%E7%8E%AF%E5%A2%83.html" aria-label="å¼€å‘ç¯å¢ƒ"><!---->å¼€å‘ç¯å¢ƒ<!----></a></li><li><a class="route-link nav-link vp-sidebar-link vp-sidebar-page" href="/gudie/08-%E5%BF%AB%E6%8D%B7%E9%94%AE.html" aria-label="å¿«æ·é”®"><!---->å¿«æ·é”®<!----></a></li><li><a class="route-link nav-link vp-sidebar-link vp-sidebar-page" href="/gudie/mysql%E7%B4%A2%E5%BC%95.html" aria-label="æ¦‚è¿°"><!---->æ¦‚è¿°<!----></a></li><li><a class="route-link nav-link vp-sidebar-link vp-sidebar-page" href="/gudie/mysql%E8%BF%90%E7%BB%B4%E5%92%8C%E7%9B%91%E6%8E%A7.html" aria-label="ç›‘æ§"><!---->ç›‘æ§<!----></a></li><li><a class="route-link nav-link vp-sidebar-link vp-sidebar-page" href="/gudie/09-%E7%BC%96%E7%A8%8B%E8%A7%84%E8%8C%83.html" aria-label="ç¼–ç¨‹è§„èŒƒ"><!---->ç¼–ç¨‹è§„èŒƒ<!----></a></li><li><a class="route-link nav-link vp-sidebar-link vp-sidebar-page" href="/gudie/00-%E9%87%91%E8%9E%8D%E7%9F%A5%E8%AF%86.html" aria-label="é‡‘èçŸ¥è¯†"><!---->é‡‘èçŸ¥è¯†<!----></a></li></ul></section></li><li><section class="vp-sidebar-group"><p class="vp-sidebar-header active"><span class="font-icon icon fa-fw fa-sm fas fa-book" style=""></span><span class="vp-sidebar-title">æ–‡ç« </span><!----></p><ul class="vp-sidebar-links"><li><a class="route-link nav-link active vp-sidebar-link vp-sidebar-page active" href="/post/AirFlow.html" aria-label="AirFlow"><!---->AirFlow<!----></a></li><li><a class="route-link nav-link vp-sidebar-link vp-sidebar-page" href="/post/ER%E5%9B%BE.html" aria-label="ERå›¾"><!---->ERå›¾<!----></a></li><li><a class="route-link nav-link vp-sidebar-link vp-sidebar-page" href="/post/filebeat.html" aria-label="filebeat"><!---->filebeat<!----></a></li><li><a class="route-link nav-link vp-sidebar-link vp-sidebar-page" href="/post/go%E8%AF%AD%E8%A8%80.html" aria-label="goåŸºç¡€è¯­æ³•"><!---->goåŸºç¡€è¯­æ³•<!----></a></li><li><a class="route-link nav-link vp-sidebar-link vp-sidebar-page" href="/post/gradle-depedency.html" aria-label="gradle ä¾èµ–è§£æ"><!---->gradle ä¾èµ–è§£æ<!----></a></li><li><a class="route-link nav-link vp-sidebar-link vp-sidebar-page" href="/post/gradle-basic.html" aria-label="gradle-basic"><!---->gradle-basic<!----></a></li><li><a class="route-link nav-link vp-sidebar-link vp-sidebar-page" href="/post/gradle-java.html" aria-label="gradle-java"><!---->gradle-java<!----></a></li><li><a class="route-link nav-link vp-sidebar-link vp-sidebar-page" href="/post/grafana-1.html" aria-label="grafana1"><!---->grafana1<!----></a></li><li><a class="route-link nav-link vp-sidebar-link vp-sidebar-page" href="/post/grafana.html" aria-label="grafana2"><!---->grafana2<!----></a></li><li><a class="route-link nav-link vp-sidebar-link vp-sidebar-page" href="/post/java%E6%8E%A5%E5%8F%A3.html" aria-label="Java æ¥å£"><!---->Java æ¥å£<!----></a></li><li><a class="route-link nav-link vp-sidebar-link vp-sidebar-page" href="/post/java%E6%97%A5%E6%9C%9F.html" aria-label="Java æ—¥æœŸ API"><!---->Java æ—¥æœŸ API<!----></a></li><li><a class="route-link nav-link vp-sidebar-link vp-sidebar-page" href="/post/java%E6%B3%A8%E8%A7%A3.html" aria-label="Java æ³¨è§£"><!---->Java æ³¨è§£<!----></a></li><li><a class="route-link nav-link vp-sidebar-link vp-sidebar-page" href="/post/loki.html" aria-label="loki"><!---->loki<!----></a></li><li><a class="route-link nav-link vp-sidebar-link vp-sidebar-page" href="/post/nginx.html" aria-label="nginx"><!---->nginx<!----></a></li><li><a class="route-link nav-link vp-sidebar-link vp-sidebar-page" href="/post/Resilience4j.html" aria-label="Resilience4j"><!---->Resilience4j<!----></a></li><li><a class="route-link nav-link vp-sidebar-link vp-sidebar-page" href="/post/zero-copy.html" aria-label="zero-copy"><!---->zero-copy<!----></a></li><li><a class="route-link nav-link vp-sidebar-link vp-sidebar-page" href="/post/%E5%A4%9A%E7%BA%BF%E7%A8%8B-Exchanger.html" aria-label="å¤šçº¿ç¨‹-Exchanger"><!---->å¤šçº¿ç¨‹-Exchanger<!----></a></li><li><a class="route-link nav-link vp-sidebar-link vp-sidebar-page" href="/post/remoteConnection.html" aria-label="è¿œç¨‹ç®¡ç†åè®®"><!---->è¿œç¨‹ç®¡ç†åè®®<!----></a></li></ul></section></li><li><section class="vp-sidebar-group"><p class="vp-sidebar-header"><span class="font-icon icon fa-fw fa-sm fas fa-book" style=""></span><span class="vp-sidebar-title">Go</span><!----></p><ul class="vp-sidebar-links"><li><a class="route-link nav-link vp-sidebar-link vp-sidebar-page" href="/Go/go-Context.html" aria-label="Go Context"><!---->Go Context<!----></a></li><li><a class="route-link nav-link vp-sidebar-link vp-sidebar-page" href="/Go/go%E6%A0%87%E5%87%86%E5%BA%93-json.html" aria-label="Go Json"><!---->Go Json<!----></a></li><li><a class="route-link nav-link vp-sidebar-link vp-sidebar-page" href="/Go/go%E6%A0%87%E5%87%86%E5%BA%93-time.html" aria-label="Go Time"><!---->Go Time<!----></a></li><li><a class="route-link nav-link vp-sidebar-link vp-sidebar-page" href="/Go/go%E5%91%BD%E4%BB%A4%E8%A1%8C.html" aria-label="Go å‘½ä»¤è¡Œ"><!---->Go å‘½ä»¤è¡Œ<!----></a></li><li><a class="route-link nav-link vp-sidebar-link vp-sidebar-page" href="/Go/go%E5%9F%BA%E7%A1%80.html" aria-label="Go åŸºç¡€"><!---->Go åŸºç¡€<!----></a></li><li><a class="route-link nav-link vp-sidebar-link vp-sidebar-page" href="/Go/go%E5%B9%B6%E5%8F%91.html" aria-label="Go å¹¶å‘"><!---->Go å¹¶å‘<!----></a></li><li><a class="route-link nav-link vp-sidebar-link vp-sidebar-page" href="/Go/go%E6%A8%A1%E5%9D%97.html" aria-label="Go æ¨¡å—"><!---->Go æ¨¡å—<!----></a></li><li><a class="route-link nav-link vp-sidebar-link vp-sidebar-page" href="/Go/go%E9%9D%A2%E5%90%91%E5%AF%B9%E8%B1%A1.html" aria-label="Go é¢å‘å¯¹è±¡"><!---->Go é¢å‘å¯¹è±¡<!----></a></li><li><a class="route-link nav-link vp-sidebar-link vp-sidebar-page" href="/Go/go%E6%B3%9B%E5%9E%8B.html" aria-label="Goæ³›å‹"><!---->Goæ³›å‹<!----></a></li><li><a class="route-link nav-link vp-sidebar-link vp-sidebar-page" href="/Go/go%E7%8E%AF%E5%A2%83.html" aria-label="Goç¯å¢ƒ"><!---->Goç¯å¢ƒ<!----></a></li><li><a class="route-link nav-link vp-sidebar-link vp-sidebar-page" href="/Go/k8s-client-go.html" aria-label="Kubernate Go"><!---->Kubernate Go<!----></a></li></ul></section></li><li><section class="vp-sidebar-group"><p class="vp-sidebar-header"><span class="font-icon icon fa-fw fa-sm fas fa-book" style=""></span><span class="vp-sidebar-title">äº‘æŠ€æœ¯</span><!----></p><ul class="vp-sidebar-links"><li><a class="route-link nav-link vp-sidebar-link vp-sidebar-page" href="/cloud/helm.html" aria-label="Helm æŒ‡å—"><!---->Helm æŒ‡å—<!----></a></li><li><a class="route-link nav-link vp-sidebar-link vp-sidebar-page" href="/cloud/istio.html" aria-label="Istio æŒ‡å—"><!---->Istio æŒ‡å—<!----></a></li><li><a class="route-link nav-link vp-sidebar-link vp-sidebar-page" href="/cloud/minikube.html" aria-label="minikube æŒ‡å—"><!---->minikube æŒ‡å—<!----></a></li></ul></section></li><li><section class="vp-sidebar-group"><p class="vp-sidebar-header"><span class="font-icon icon fa-fw fa-sm fas fa-book" style=""></span><span class="vp-sidebar-title">Python</span><!----></p><ul class="vp-sidebar-links"><li><a class="route-link nav-link vp-sidebar-link vp-sidebar-page" href="/Python/%E8%99%9A%E6%8B%9F%E7%8E%AF%E5%A2%83.html" aria-label="è™šæ‹Ÿç¯å¢ƒ"><!---->è™šæ‹Ÿç¯å¢ƒ<!----></a></li></ul></section></li><li><section class="vp-sidebar-group"><p class="vp-sidebar-header"><span class="font-icon icon fa-fw fa-sm fas fa-book" style=""></span><span class="vp-sidebar-title">Tools</span><!----></p><ul class="vp-sidebar-links"><li><a class="route-link nav-link vp-sidebar-link vp-sidebar-page" href="/tool/Vscode.html" aria-label="Vscode"><!---->Vscode<!----></a></li><li><a class="route-link nav-link vp-sidebar-link vp-sidebar-page" href="/tool/%E4%BB%A3%E7%90%86.html" aria-label="å„ç§ä»£ç†è®¾ç½®"><!---->å„ç§ä»£ç†è®¾ç½®<!----></a></li></ul></section></li><li><section class="vp-sidebar-group"><p class="vp-sidebar-header"><span class="font-icon icon fa-fw fa-sm fas fa-book" style=""></span><span class="vp-sidebar-title">Spring</span><!----></p><ul class="vp-sidebar-links"><li><a class="route-link nav-link vp-sidebar-link vp-sidebar-page" href="/Spring/ews%E9%82%AE%E7%AE%B1.html" aria-label="ews é‚®ç®±API"><!---->ews é‚®ç®±API<!----></a></li><li><a class="route-link nav-link vp-sidebar-link vp-sidebar-page" href="/Spring/gradle.html" aria-label="GradleæŒ‡å—"><!---->GradleæŒ‡å—<!----></a></li><li><a class="route-link nav-link vp-sidebar-link vp-sidebar-page" href="/Spring/%E6%A0%A1%E9%AA%8C%E6%B3%A8%E8%A7%A3.html" aria-label="Spring Validation"><!---->Spring Validation<!----></a></li><li><a class="route-link nav-link vp-sidebar-link vp-sidebar-page" href="/Spring/spring%E4%BA%8B%E5%8A%A1.html" aria-label="Spring äº‹åŠ¡"><!---->Spring äº‹åŠ¡<!----></a></li></ul></section></li></ul><!--[--><!----><!--]--></aside><!--[--><main id="main-content" class="vp-page"><!--[--><!--[--><!----><!--]--><!----><nav class="vp-breadcrumb disable"></nav><div class="vp-page-title"><h1><!---->AirFlow</h1><div class="page-info"><span class="page-author-info" aria-label="ä½œè€…ğŸ–Š" data-balloon-pos="up"><svg xmlns="http://www.w3.org/2000/svg" class="icon author-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="author icon"><path d="M649.6 633.6c86.4-48 147.2-144 147.2-249.6 0-160-128-288-288-288s-288 128-288 288c0 108.8 57.6 201.6 147.2 249.6-121.6 48-214.4 153.6-240 288-3.2 9.6 0 19.2 6.4 25.6 3.2 9.6 12.8 12.8 22.4 12.8h704c9.6 0 19.2-3.2 25.6-12.8 6.4-6.4 9.6-16 6.4-25.6-25.6-134.4-121.6-240-243.2-288z"></path></svg><span><a class="page-author-item" href="https://github.com/banrenshan" target="_blank" rel="noopener noreferrer">banrenshan</a></span><span property="author" content="banrenshan"></span></span><!----><span class="page-date-info" aria-label="å†™ä½œæ—¥æœŸğŸ“…" data-balloon-pos="up"><svg xmlns="http://www.w3.org/2000/svg" class="icon calendar-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="calendar icon"><path d="M716.4 110.137c0-18.753-14.72-33.473-33.472-33.473-18.753 0-33.473 14.72-33.473 33.473v33.473h66.993v-33.473zm-334.87 0c0-18.753-14.72-33.473-33.473-33.473s-33.52 14.72-33.52 33.473v33.473h66.993v-33.473zm468.81 33.52H716.4v100.465c0 18.753-14.72 33.473-33.472 33.473a33.145 33.145 0 01-33.473-33.473V143.657H381.53v100.465c0 18.753-14.72 33.473-33.473 33.473a33.145 33.145 0 01-33.473-33.473V143.657H180.6A134.314 134.314 0 0046.66 277.595v535.756A134.314 134.314 0 00180.6 947.289h669.74a134.36 134.36 0 00133.94-133.938V277.595a134.314 134.314 0 00-133.94-133.938zm33.473 267.877H147.126a33.145 33.145 0 01-33.473-33.473c0-18.752 14.72-33.473 33.473-33.473h736.687c18.752 0 33.472 14.72 33.472 33.473a33.145 33.145 0 01-33.472 33.473z"></path></svg><span><!----></span><meta property="datePublished" content="2023-10-08T00:00:00.000Z"></span><span class="page-pageview-info" aria-label="è®¿é—®é‡ğŸ”¢" data-balloon-pos="up"><svg xmlns="http://www.w3.org/2000/svg" class="icon eye-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="eye icon"><path d="M992 512.096c0-5.76-.992-10.592-1.28-11.136-.192-2.88-1.152-8.064-2.08-10.816-.256-.672-.544-1.376-.832-2.08-.48-1.568-1.024-3.104-1.6-4.32C897.664 290.112 707.104 160 512 160c-195.072 0-385.632 130.016-473.76 322.592-1.056 2.112-1.792 4.096-2.272 5.856a55.512 55.512 0 00-.64 1.6c-1.76 5.088-1.792 8.64-1.632 7.744-.832 3.744-1.568 11.168-1.568 11.168-.224 2.272-.224 4.032.032 6.304 0 0 .736 6.464 1.088 7.808.128 1.824.576 4.512 1.12 6.976h-.032c.448 2.08 1.12 4.096 1.984 6.08.48 1.536.992 2.976 1.472 4.032C126.432 733.856 316.992 864 512 864c195.136 0 385.696-130.048 473.216-321.696 1.376-2.496 2.24-4.832 2.848-6.912.256-.608.48-1.184.672-1.728 1.536-4.48 1.856-8.32 1.728-8.32l-.032.032c.608-3.104 1.568-7.744 1.568-13.28zM512 672c-88.224 0-160-71.776-160-160s71.776-160 160-160 160 71.776 160 160-71.776 160-160 160z"></path></svg><span id="ArtalkPV" class="vp-pageview waline-pageview-count" data-path="/post/AirFlow.html" data-page-key="/post/AirFlow.html">...</span></span><span class="page-reading-time-info" aria-label="é˜…è¯»æ—¶é—´âŒ›" data-balloon-pos="up"><svg xmlns="http://www.w3.org/2000/svg" class="icon timer-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="timer icon"><path d="M799.387 122.15c4.402-2.978 7.38-7.897 7.38-13.463v-1.165c0-8.933-7.38-16.312-16.312-16.312H256.33c-8.933 0-16.311 7.38-16.311 16.312v1.165c0 5.825 2.977 10.874 7.637 13.592 4.143 194.44 97.22 354.963 220.201 392.763-122.204 37.542-214.893 196.511-220.2 389.397-4.661 5.049-7.638 11.651-7.638 19.03v5.825h566.49v-5.825c0-7.379-2.849-13.981-7.509-18.9-5.049-193.016-97.867-351.985-220.2-389.527 123.24-37.67 216.446-198.453 220.588-392.892zM531.16 450.445v352.632c117.674 1.553 211.787 40.778 211.787 88.676H304.097c0-48.286 95.149-87.382 213.728-88.676V450.445c-93.077-3.107-167.901-81.297-167.901-177.093 0-8.803 6.99-15.793 15.793-15.793 8.803 0 15.794 6.99 15.794 15.793 0 80.261 63.69 145.635 142.01 145.635s142.011-65.374 142.011-145.635c0-8.803 6.99-15.793 15.794-15.793s15.793 6.99 15.793 15.793c0 95.019-73.789 172.82-165.96 177.093z"></path></svg><span>å¤§çº¦ 50 åˆ†é’Ÿ</span><meta property="timeRequired" content="PT50M"></span><!----><!----></div><hr></div><div class="vp-toc-placeholder"><aside id="toc"><!--[--><!----><!--]--><div class="vp-toc-header">æ­¤é¡µå†…å®¹<button type="button" class="print-button" title="æ‰“å°"><svg xmlns="http://www.w3.org/2000/svg" class="icon print-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="print icon"><path d="M819.2 364.8h-44.8V128c0-17.067-14.933-32-32-32H281.6c-17.067 0-32 14.933-32 32v236.8h-44.8C145.067 364.8 96 413.867 96 473.6v192c0 59.733 49.067 108.8 108.8 108.8h44.8V896c0 17.067 14.933 32 32 32h460.8c17.067 0 32-14.933 32-32V774.4h44.8c59.733 0 108.8-49.067 108.8-108.8v-192c0-59.733-49.067-108.8-108.8-108.8zM313.6 160h396.8v204.8H313.6V160zm396.8 704H313.6V620.8h396.8V864zM864 665.6c0 25.6-19.2 44.8-44.8 44.8h-44.8V588.8c0-17.067-14.933-32-32-32H281.6c-17.067 0-32 14.933-32 32v121.6h-44.8c-25.6 0-44.8-19.2-44.8-44.8v-192c0-25.6 19.2-44.8 44.8-44.8h614.4c25.6 0 44.8 19.2 44.8 44.8v192z"></path></svg></button><div class="arrow end"></div></div><div class="vp-toc-wrapper"><ul class="vp-toc-list"><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#é»˜è®¤å‚æ•°-default-args">é»˜è®¤å‚æ•° ï¼š default_args</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#å®ä¾‹åŒ–dag">å®ä¾‹åŒ–DAG</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level2" href="#operators">Operators</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level2" href="#ä»»åŠ¡">ä»»åŠ¡</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level2" href="#jinjaæ¨¡æ¿">Jinjaæ¨¡æ¿</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level2" href="#æ–‡æ¡£">æ–‡æ¡£</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level2" href="#ä»»åŠ¡ä¾èµ–å…³ç³»">ä»»åŠ¡ä¾èµ–å…³ç³»</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level2" href="#æ—¶åŒº">æ—¶åŒº</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level2" href="#æµ‹è¯•">æµ‹è¯•</a></li><li><ul class="vp-toc-list"><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#éªŒè¯">éªŒè¯</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#è¿è¡Œä»»åŠ¡">è¿è¡Œä»»åŠ¡</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#backfill-å›å¡«">Backfill(å›å¡«)</a></li><!----><!--]--></ul></li><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level2" href="#taskflow">TaskFlow</a></li><li><ul class="vp-toc-list"><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#é‡ç”¨">é‡ç”¨</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#ä½¿ç”¨å…·æœ‰å¤æ‚-å†²çªpythonä¾èµ–å…³ç³»çš„taskflow-api">ä½¿ç”¨å…·æœ‰å¤æ‚/å†²çªPythonä¾èµ–å…³ç³»çš„TaskFlow API</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#ä¸ä¼ æ„Ÿå™¨-sensor-æ“ä½œç¬¦ä¸€èµ·ä½¿ç”¨taskflow-api">ä¸ä¼ æ„Ÿå™¨ï¼ˆSensor ï¼‰æ“ä½œç¬¦ä¸€èµ·ä½¿ç”¨TaskFlow API</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#å¤šè¾“å‡ºæ¨ç†">å¤šè¾“å‡ºæ¨ç†</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#æ·»åŠ è£…é¥°ä»»åŠ¡å’Œä¼ ç»Ÿä»»åŠ¡ä¹‹é—´çš„ä¾èµ–å…³ç³»">æ·»åŠ è£…é¥°ä»»åŠ¡å’Œä¼ ç»Ÿä»»åŠ¡ä¹‹é—´çš„ä¾èµ–å…³ç³»</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#åœ¨è£…é¥°å’Œä¼ ç»Ÿä»»åŠ¡ä¹‹é—´æ¶ˆè´¹xcoms">åœ¨è£…é¥°å’Œä¼ ç»Ÿä»»åŠ¡ä¹‹é—´æ¶ˆè´¹XComs</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#è®¿é—®è£…é¥°ä»»åŠ¡ä¸­çš„ä¸Šä¸‹æ–‡å˜é‡">è®¿é—®è£…é¥°ä»»åŠ¡ä¸­çš„ä¸Šä¸‹æ–‡å˜é‡</a></li><!----><!--]--></ul></li><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level2" href="#åˆå§‹è®¾ç½®">åˆå§‹è®¾ç½®</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level2" href="#å·¥ä½œè´Ÿè½½">å·¥ä½œè´Ÿè½½</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level2" href="#æ§åˆ¶æµç¨‹">æ§åˆ¶æµç¨‹</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level2" href="#ç”¨æˆ·ç•Œé¢">ç”¨æˆ·ç•Œé¢</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level2" href="#å£°æ˜dag">å£°æ˜DAG</a></li><li><ul class="vp-toc-list"><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#ä»»åŠ¡ä¾èµ–">ä»»åŠ¡ä¾èµ–</a></li><!----><!--]--></ul></li><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level2" href="#åŠ è½½dag">åŠ è½½DAG</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level2" href="#è¿è¡Œdag">è¿è¡ŒDAG</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level2" href="#é»˜è®¤å‚æ•°">é»˜è®¤å‚æ•°</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level2" href="#æ§åˆ¶æµç¨‹-1">æ§åˆ¶æµç¨‹</a></li><li><ul class="vp-toc-list"><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#åˆ†æ”¯">åˆ†æ”¯</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#latest-only">Latest Only</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#ä¾èµ–äºè¿‡å»">ä¾èµ–äºè¿‡å»</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#è§¦å‘å™¨è§„åˆ™">è§¦å‘å™¨è§„åˆ™</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#setup-and-teardown">Setup and teardown</a></li><!----><!--]--></ul></li><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level2" href="#åŠ¨æ€dag">åŠ¨æ€DAG</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level2" href="#dagå¯è§†åŒ–">DAGå¯è§†åŒ–</a></li><li><ul class="vp-toc-list"><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#ä»»åŠ¡ç»„">ä»»åŠ¡ç»„</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#è¾¹æ ‡ç­¾">è¾¹æ ‡ç­¾</a></li><!----><!--]--></ul></li><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level2" href="#dagå’Œä»»åŠ¡æ–‡æ¡£">DAGå’Œä»»åŠ¡æ–‡æ¡£</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level2" href="#subdags">SubDAGs</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level2" href="#æ‰“åŒ…dag">æ‰“åŒ…DAG</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level2" href="#dag-ä¾èµ–">DAG ä¾èµ–</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level2" href="#dagæš‚åœã€åœç”¨å’Œåˆ é™¤">DAGæš‚åœã€åœç”¨å’Œåˆ é™¤</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level2" href="#ç±»å‹">ç±»å‹</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level2" href="#kubernetes-executor">Kubernetes Executor</a></li><li><ul class="vp-toc-list"><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#ä¸»è¦é…ç½®">ä¸»è¦é…ç½®</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#åœ¨æŒä¹…å·ä¸­å­˜å‚¨dag">åœ¨æŒä¹…å·ä¸­å­˜å‚¨DAGï¼š</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#ä»gitä¸­æå–dag">ä»gitä¸­æå–DAG:</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#podè¦†ç›–">podè¦†ç›–</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#è°ƒè¯•kubernetespodoperator">è°ƒè¯•KubernetesPodOperator</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#å‚æ•°ä¼˜å…ˆçº§">å‚æ•°ä¼˜å…ˆçº§</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#å¦‚ä½•åœ¨podä¸­ä½¿ç”¨é›†ç¾¤configmapsã€secretså’Œvolumes">å¦‚ä½•åœ¨Podä¸­ä½¿ç”¨é›†ç¾¤ConfigMapsã€Secretså’ŒVolumesï¼Ÿ</a></li><!----><!--]--></ul></li><!--]--></ul><div class="vp-toc-marker" style="top:-1.7rem;"></div></div><!--[--><!----><!--]--></aside></div><!--[--><!----><!--]--><div class="theme-hope-content"><p>Airflowæ˜¯ä¸€ä¸ªç”¨äºå¼€å‘ã€è°ƒåº¦å’Œç›‘æ§ <strong>é¢å‘æ‰¹å¤„ç†çš„å·¥ä½œæµ</strong> çš„å¼€æºå¹³å°ã€‚<strong>ä¸»è¦ç‰¹ç‚¹æ˜¯æ‰€æœ‰å·¥ä½œæµéƒ½æ˜¯ç”¨Pythonä»£ç å®šä¹‰çš„</strong>ã€‚</p><h1 id="å¿«é€Ÿå…¥é—¨" tabindex="-1"><a class="header-anchor" href="#å¿«é€Ÿå…¥é—¨"><span>å¿«é€Ÿå…¥é—¨</span></a></h1><div class="language-python line-numbers-mode" data-ext="py" data-title="py"><pre class="language-python"><code><span class="token keyword">from</span> datetime <span class="token keyword">import</span> datetime

<span class="token keyword">from</span> airflow <span class="token keyword">import</span> DAG
<span class="token keyword">from</span> airflow<span class="token punctuation">.</span>decorators <span class="token keyword">import</span> task
<span class="token keyword">from</span> airflow<span class="token punctuation">.</span>operators<span class="token punctuation">.</span>bash <span class="token keyword">import</span> BashOperator

<span class="token comment"># A DAG represents a workflow, a collection of tasks</span>
<span class="token keyword">with</span> DAG<span class="token punctuation">(</span>dag_id<span class="token operator">=</span><span class="token string">&quot;demo&quot;</span><span class="token punctuation">,</span> start_date<span class="token operator">=</span>datetime<span class="token punctuation">(</span><span class="token number">2022</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> schedule<span class="token operator">=</span><span class="token string">&quot;0 0 * * *&quot;</span><span class="token punctuation">)</span> <span class="token keyword">as</span> dag<span class="token punctuation">:</span>

    <span class="token comment"># Tasks are represented as operators</span>
    hello <span class="token operator">=</span> BashOperator<span class="token punctuation">(</span>task_id<span class="token operator">=</span><span class="token string">&quot;hello&quot;</span><span class="token punctuation">,</span> bash_command<span class="token operator">=</span><span class="token string">&quot;echo hello&quot;</span><span class="token punctuation">)</span>

    <span class="token decorator annotation punctuation">@task</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">def</span> <span class="token function">airflow</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;airflow&quot;</span><span class="token punctuation">)</span>

    <span class="token comment"># Set dependencies between tasks</span>
    hello <span class="token operator">&gt;&gt;</span> airflow<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ol><li><p>ä¸€ä¸ªåä¸º <code>demo</code> çš„DAGï¼Œä»2022å¹´1æœˆ1æ—¥å¼€å§‹ï¼Œæ¯å¤©è¿è¡Œä¸€æ¬¡ã€‚DAGæ˜¯Airflowå¯¹å·¥ä½œæµçš„è¡¨ç¤ºã€‚</p></li><li><p>ä¸¤ä¸ªä»»åŠ¡ï¼Œä¸€ä¸ªæ˜¯è¿è¡ŒBashè„šæœ¬çš„BashOperatorï¼Œå¦ä¸€ä¸ªæ˜¯ä½¿ç”¨@task decoratorå®šä¹‰çš„Pythonå‡½æ•°</p></li><li><p><code>&gt;&gt;</code> åœ¨ä»»åŠ¡ä¹‹é—´ï¼Œå®šä¹‰äº†ä¸€ä¸ªä¾èµ–é¡¹ï¼Œå¹¶æ§åˆ¶ä»»åŠ¡çš„æ‰§è¡Œé¡ºåº</p></li></ol><p>Airflowè¯„ä¼°æ­¤è„šæœ¬ï¼Œå¹¶æŒ‰è®¾å®šçš„é—´éš”å’Œå®šä¹‰çš„é¡ºåºæ‰§è¡Œä»»åŠ¡ã€‚<code>demo</code> DAGçš„çŠ¶æ€åœ¨webç•Œé¢ä¸­å¯è§ï¼š</p><figure><img src="/assets/demo_graph_view-Bwp2ELhg.png" alt="Demo DAG in the Graph View, showing the status of one DAG run" tabindex="0" loading="lazy"><figcaption>Demo DAG in the Graph View, showing the status of one DAG run</figcaption></figure><p>æœ¬ä¾‹æ¼”ç¤ºäº†ä¸€ä¸ªç®€å•çš„Bashå’ŒPythonè„šæœ¬ï¼Œä½†è¿™äº›ä»»åŠ¡å¯ä»¥è¿è¡Œä»»ä½•ä»£ç ã€‚å¯ä»¥è¿è¡ŒSparkä½œä¸šã€åœ¨ä¸¤ä¸ªå­˜å‚¨æ¡¶ä¹‹é—´ç§»åŠ¨æ•°æ®æˆ–å‘é€ç”µå­é‚®ä»¶ã€‚åŒæ ·çš„ç»“æ„ä¹Ÿå¯ä»¥éšç€æ—¶é—´çš„æ¨ç§»è€Œè¿è¡Œï¼š</p><figure><img src="/assets/demo_grid_view-DFFl8V2H.png" alt="Demo DAG in the Grid View, showing the status of all DAG runs" tabindex="0" loading="lazy"><figcaption>Demo DAG in the Grid View, showing the status of all DAG runs</figcaption></figure><p>æ¯åˆ—è¡¨ç¤ºä¸€ä¸ªDAGè¿è¡Œã€‚è¿™æ˜¯Airflowä¸­æœ€å¸¸ç”¨çš„ä¸¤ä¸ªè§†å›¾ï¼Œä½†è¿˜æœ‰å…¶ä»–å‡ ä¸ªè§†å›¾å¯ä»¥è®©æ‚¨æ·±å…¥äº†è§£å·¥ä½œæµçš„çŠ¶æ€ã€‚</p><p>Airflow æ˜¯ä¸€ä¸ªæ‰¹å¤„ç†å·¥ä½œæµç¼–æ’å¹³å°ã€‚Airflowæ¡†æ¶åŒ…å«å¯ä¸è®¸å¤šæŠ€æœ¯è¿æ¥çš„operators ï¼Œå¹¶ä¸”å¯è½»æ¾æ‰©å±•ä»¥ä¸æ–°æŠ€æœ¯è¿æ¥ã€‚å¦‚æœæ‚¨çš„å·¥ä½œæµæœ‰ä¸€ä¸ªæ˜ç¡®çš„å¼€å§‹å’Œç»“æŸï¼Œå¹¶ä¸”ä»¥å®šæœŸé—´éš”è¿è¡Œï¼Œåˆ™å¯ä»¥å°†å…¶ç¼–ç¨‹ä¸ºDAGã€‚</p><p>AirflowåŒ…æ‹¬ä»¥ä¸‹æ ¸å¿ƒç»„ä»¶ï¼š</p><ol><li><p>webserver</p></li><li><p>scheduler</p></li><li><p>CLI</p></li></ol><p>Providers åŒ…åŒ…æ‹¬ä¸ç¬¬ä¸‰æ–¹é¡¹ç›®çš„é›†æˆã€‚å®ƒä»¬çš„ç‰ˆæœ¬å’Œå‘å¸ƒç‹¬ç«‹äºApache Airflowæ ¸å¿ƒåŒ…ã€‚</p><p>wsl ubuntu å®‰è£…python</p><div class="language-bash line-numbers-mode" data-ext="sh" data-title="sh"><pre class="language-bash"><code><span class="token function">sudo</span> <span class="token function">apt</span> remove python3 <span class="token comment"># ç§»é™¤é»˜è®¤å®‰è£…çš„3.10</span>
<span class="token function">sudo</span> <span class="token function">apt</span> autoremove
<span class="token function">sudo</span> <span class="token function">ln</span> <span class="token parameter variable">-s</span> /usr/bin/python3.9 /usr/bin/python
<span class="token function">sudo</span> <span class="token function">apt</span> <span class="token function">install</span> python3-pip
pip config <span class="token builtin class-name">set</span> global.index-url https://pypi.tuna.tsinghua.edu.cn/simple

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h1 id="å®‰è£…" tabindex="-1"><a class="header-anchor" href="#å®‰è£…"><span>å®‰è£…</span></a></h1><ul><li>éœ€è¦å®‰è£…python3ç¯å¢ƒ</li><li>éœ€è¦ pip åŒ…å®‰è£…å·¥å…·</li></ul><ol><li><p>è®¾ç½®Homeï¼ˆå¯é€‰ï¼‰</p><p>Airflowéœ€è¦ä¸»ç›®å½•ï¼Œä½¿ç”¨AIRFLOW_HOMEç¯å¢ƒå˜é‡é…ç½®ï¼Œé»˜è®¤æƒ…å†µä¸‹ä½¿ç”¨<code>~/airflow</code>ã€‚</p><div class="language-bash line-numbers-mode" data-ext="sh" data-title="sh"><pre class="language-bash"><code><span class="token builtin class-name">export</span> <span class="token assign-left variable">AIRFLOW_HOME</span><span class="token operator">=~</span>/airflow
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div></li><li><p>ä½¿ç”¨çº¦æŸæ–‡ä»¶å®‰è£…Airflowï¼Œè¯¥æ–‡ä»¶æ˜¯æ ¹æ®æˆ‘ä»¬ä¼ é€’çš„URLç¡®å®šçš„ï¼š</p><div class="language-bash line-numbers-mode" data-ext="sh" data-title="sh"><pre class="language-bash"><code><span class="token assign-left variable">AIRFLOW_VERSION</span><span class="token operator">=</span><span class="token number">2.7</span>.2
<span class="token assign-left variable">PYTHON_VERSION</span><span class="token operator">=</span><span class="token string">&quot;<span class="token variable"><span class="token variable">$(</span>python <span class="token parameter variable">--version</span> <span class="token operator">|</span> <span class="token function">cut</span> <span class="token parameter variable">-d</span> <span class="token string">&quot; &quot;</span> <span class="token parameter variable">-f</span> <span class="token number">2</span> <span class="token operator">|</span> <span class="token function">cut</span> <span class="token parameter variable">-d</span> <span class="token string">&quot;.&quot;</span> <span class="token parameter variable">-f</span> <span class="token number">1</span>-2<span class="token variable">)</span></span>&quot;</span>
<span class="token assign-left variable">CONSTRAINT_URL</span><span class="token operator">=</span><span class="token string">&quot;https://raw.githubusercontent.com/apache/airflow/constraints-<span class="token variable">${AIRFLOW_VERSION}</span>/constraints-<span class="token variable">${PYTHON_VERSION}</span>.txt&quot;</span>
pip <span class="token function">install</span> <span class="token string">&quot;apache-airflow==<span class="token variable">${AIRFLOW_VERSION}</span>&quot;</span> <span class="token parameter variable">--constraint</span> <span class="token string">&quot;<span class="token variable">${CONSTRAINT_URL}</span>&quot;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li><li><p>å¯åŠ¨, åˆå§‹åŒ–æ•°æ®åº“ï¼Œåˆ›å»ºä¸€ä¸ªç”¨æˆ·ï¼Œå¹¶å¯åŠ¨æ‰€æœ‰ç»„ä»¶ã€‚</p><div class="language-bash line-numbers-mode" data-ext="sh" data-title="sh"><pre class="language-bash"><code><span class="token builtin class-name">export</span> <span class="token assign-left variable"><span class="token environment constant">PATH</span></span><span class="token operator">=</span><span class="token environment constant">PATH</span>:/home/zzq/.local/bin <span class="token comment">#é…ç½®airflowçš„cli ç›®å½•</span>
airflow standalone
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><blockquote><p>å¦‚æœè¦æ‰‹åŠ¨è¿è¡ŒAirflowçš„å„ä¸ªéƒ¨ä»¶ï¼Œè€Œä¸æ˜¯ä½¿ç”¨ä¸€ä½“å¼ç‹¬ç«‹å‘½ä»¤ï¼Œåˆ™å¯ä»¥è¿è¡Œï¼š</p><div class="language-bash line-numbers-mode" data-ext="sh" data-title="sh"><pre class="language-bash"><code>airflow db migrate

airflow <span class="token function">users</span> create <span class="token punctuation">\</span>
    <span class="token parameter variable">--username</span> admin <span class="token punctuation">\</span>
    <span class="token parameter variable">--firstname</span> Peter <span class="token punctuation">\</span>
    <span class="token parameter variable">--lastname</span> Parker <span class="token punctuation">\</span>
    <span class="token parameter variable">--role</span> Admin <span class="token punctuation">\</span>
    <span class="token parameter variable">--email</span> spiderman@superhero.org

airflow webserver <span class="token parameter variable">--port</span> <span class="token number">8080</span>

airflow scheduler
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></blockquote></li><li><p>è®¿é—®UIï¼šlocalhost:8080 ï¼Œç”¨æˆ·åå’Œå¯†ç åœ¨æ§åˆ¶å°æ‰“å°ã€‚</p><blockquote><p>è¿è¡Œè¿™äº›å‘½ä»¤åï¼ŒAirflowå°†åˆ›å»º<code>$AIRFLOW_HOME</code>æ–‡ä»¶å¤¹ï¼Œå¹¶ä½¿ç”¨é»˜è®¤å€¼åˆ›å»º<code>airflow.cfg</code>æ–‡ä»¶ï¼Œè¿™å°†ä½¿æ‚¨å¿«é€Ÿè¿è¡Œã€‚æ‚¨å¯ä»¥ä½¿ç”¨ç¯å¢ƒå˜é‡è¦†ç›–é»˜è®¤å€¼ã€‚</p><p>æ‚¨å¯ä»¥åœ¨<code>$AIRFLOW_HOME/airflow.cfg</code>ä¸­æ£€æŸ¥æ–‡ä»¶ï¼Œä¹Ÿå¯ä»¥åœ¨UIä¸Šé€šè¿‡<code>Admin-&gt;Configuration</code>èœå•æ£€æŸ¥æ–‡ä»¶ã€‚</p><p>WebæœåŠ¡å™¨çš„PIDæ–‡ä»¶å°†å­˜å‚¨åœ¨<code>$AIRFLOW_HOME/airflow-webserver.pid</code>ä¸­ï¼Œå¦‚æœç”±systemdå¯åŠ¨ï¼Œåˆ™å­˜å‚¨åœ¨<code>/run/airflow/webserver.pid</code>ä¸­</p><p>é»˜è®¤ï¼ŒAirflowä½¿ç”¨äº†ä¸€ä¸ªSQLiteæ•°æ®åº“ã€‚å› ä¸ºä½¿ç”¨è¿™ä¸ªæ•°æ®åº“åç«¯ä¸å¯èƒ½è¿›è¡Œå¹¶è¡ŒåŒ–ï¼Œæ‰€ä»¥å®ƒä¸SequentialExecutorååŒå·¥ä½œï¼Œåè€…å°†ä»…æŒ‰é¡ºåºè¿è¡Œä»»åŠ¡å®ä¾‹ã€‚</p></blockquote></li><li><p>ä»¥ä¸‹æ˜¯ä¸€äº›å°†è§¦å‘ä¸€äº›ä»»åŠ¡å®ä¾‹çš„å‘½ä»¤ã€‚å½“æ‚¨è¿è¡Œä¸‹é¢çš„å‘½ä»¤æ—¶ï¼Œæ‚¨åº”è¯¥èƒ½å¤Ÿåœ¨<code>example_bash_operator</code> DAGä¸­çœ‹åˆ°ä½œä¸šçš„çŠ¶æ€æ›´æ”¹ã€‚</p><div class="language-bash line-numbers-mode" data-ext="sh" data-title="sh"><pre class="language-bash"><code><span class="token comment"># run your first task instance</span>
airflow tasks <span class="token builtin class-name">test</span> example_bash_operator runme_0 <span class="token number">2015</span>-01-01
<span class="token comment"># run a backfill over 2 days</span>
airflow dags backfill example_bash_operator <span class="token punctuation">\</span>
    --start-date <span class="token number">2015</span>-01-01 <span class="token punctuation">\</span>
    --end-date <span class="token number">2015</span>-01-02
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li></ol><h1 id="åŸºç¡€æ¦‚å¿µ" tabindex="-1"><a class="header-anchor" href="#åŸºç¡€æ¦‚å¿µ"><span>åŸºç¡€æ¦‚å¿µ</span></a></h1><div class="language-bash line-numbers-mode" data-ext="sh" data-title="sh"><pre class="language-bash"><code>
from datetime <span class="token function">import</span> datetime, timedelta
from textwrap <span class="token function">import</span> dedent

<span class="token comment"># The DAG object; we&#39;ll need this to instantiate a DAG</span>
from airflow <span class="token function">import</span> DAG

<span class="token comment"># Operators; we need this to operate!</span>
from airflow.operators.bash <span class="token function">import</span> BashOperator
with DAG<span class="token punctuation">(</span>
    <span class="token string">&quot;tutorial&quot;</span>,
    <span class="token comment"># These args will get passed on to each operator</span>
    <span class="token comment"># You can override them on a per-task basis during operator initialization</span>
    <span class="token assign-left variable">default_args</span><span class="token operator">=</span><span class="token punctuation">{</span>
        <span class="token string">&quot;depends_on_past&quot;</span><span class="token builtin class-name">:</span> False,
        <span class="token string">&quot;email&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">[</span><span class="token string">&quot;airflow@example.com&quot;</span><span class="token punctuation">]</span>,
        <span class="token string">&quot;email_on_failure&quot;</span><span class="token builtin class-name">:</span> False,
        <span class="token string">&quot;email_on_retry&quot;</span><span class="token builtin class-name">:</span> False,
        <span class="token string">&quot;retries&quot;</span><span class="token builtin class-name">:</span> <span class="token number">1</span>,
        <span class="token string">&quot;retry_delay&quot;</span><span class="token builtin class-name">:</span> timedelta<span class="token punctuation">(</span>minutes<span class="token operator">=</span><span class="token number">5</span><span class="token punctuation">)</span>,
        <span class="token comment"># &#39;queue&#39;: &#39;bash_queue&#39;,</span>
        <span class="token comment"># &#39;pool&#39;: &#39;backfill&#39;,</span>
        <span class="token comment"># &#39;priority_weight&#39;: 10,</span>
        <span class="token comment"># &#39;end_date&#39;: datetime(2016, 1, 1),</span>
        <span class="token comment"># &#39;wait_for_downstream&#39;: False,</span>
        <span class="token comment"># &#39;sla&#39;: timedelta(hours=2),</span>
        <span class="token comment"># &#39;execution_timeout&#39;: timedelta(seconds=300),</span>
        <span class="token comment"># &#39;on_failure_callback&#39;: some_function, # or list of functions</span>
        <span class="token comment"># &#39;on_success_callback&#39;: some_other_function, # or list of functions</span>
        <span class="token comment"># &#39;on_retry_callback&#39;: another_function, # or list of functions</span>
        <span class="token comment"># &#39;sla_miss_callback&#39;: yet_another_function, # or list of functions</span>
        <span class="token comment"># &#39;trigger_rule&#39;: &#39;all_success&#39;</span>
    <span class="token punctuation">}</span>,
    <span class="token assign-left variable">description</span><span class="token operator">=</span><span class="token string">&quot;A simple tutorial DAG&quot;</span>,
    <span class="token assign-left variable">schedule</span><span class="token operator">=</span>timedelta<span class="token punctuation">(</span>days<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>,
    <span class="token assign-left variable">start_date</span><span class="token operator">=</span>datetime<span class="token punctuation">(</span><span class="token number">2021</span>, <span class="token number">1</span>, <span class="token number">1</span><span class="token punctuation">)</span>,
    <span class="token assign-left variable">catchup</span><span class="token operator">=</span>False,
    <span class="token assign-left variable">tags</span><span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">&quot;example&quot;</span><span class="token punctuation">]</span>,
<span class="token punctuation">)</span> as dag:

    <span class="token comment"># t1, t2 and t3 are examples of tasks created by instantiating operators</span>
    t1 <span class="token operator">=</span> BashOperator<span class="token punctuation">(</span>
        <span class="token assign-left variable">task_id</span><span class="token operator">=</span><span class="token string">&quot;print_date&quot;</span>,
        <span class="token assign-left variable">bash_command</span><span class="token operator">=</span><span class="token string">&quot;date&quot;</span>,
    <span class="token punctuation">)</span>

    t2 <span class="token operator">=</span> BashOperator<span class="token punctuation">(</span>
        <span class="token assign-left variable">task_id</span><span class="token operator">=</span><span class="token string">&quot;sleep&quot;</span>,
        <span class="token assign-left variable">depends_on_past</span><span class="token operator">=</span>False,
        <span class="token assign-left variable">bash_command</span><span class="token operator">=</span><span class="token string">&quot;sleep 5&quot;</span>,
        <span class="token assign-left variable">retries</span><span class="token operator">=</span><span class="token number">3</span>,
    <span class="token punctuation">)</span>
    t1.doc_md <span class="token operator">=</span> dedent<span class="token punctuation">(</span>
        <span class="token string">&quot;&quot;</span>&quot;<span class="token punctuation">\</span>
    <span class="token comment">#### Task Documentation</span>
    You can document your task using the attributes <span class="token variable"><span class="token variable">`</span>doc_md<span class="token variable">`</span></span> <span class="token punctuation">(</span>markdown<span class="token punctuation">)</span>,
    <span class="token variable"><span class="token variable">`</span>doc<span class="token variable">`</span></span> <span class="token punctuation">(</span>plain text<span class="token punctuation">)</span>, <span class="token variable"><span class="token variable">`</span>doc_rst<span class="token variable">`</span></span>, <span class="token variable"><span class="token variable">`</span>doc_json<span class="token variable">`</span></span>, <span class="token variable"><span class="token variable">`</span>doc_yaml<span class="token variable">`</span></span> <span class="token function">which</span> gets
    rendered <span class="token keyword">in</span> the UI&#39;s Task Instance Details page.
    <span class="token operator">!</span><span class="token punctuation">[</span>img<span class="token punctuation">]</span><span class="token punctuation">(</span>http://montcs.bloomu.edu/~bobmon/Semesters/2012-01/491/import%20soul.png<span class="token punctuation">)</span>
    **Image Credit:** Randall Munroe, <span class="token punctuation">[</span>XKCD<span class="token punctuation">]</span><span class="token punctuation">(</span>https://xkcd.com/license.html<span class="token punctuation">)</span>
    <span class="token string">&quot;&quot;</span>&quot;
    <span class="token punctuation">)</span>

    dag.doc_md <span class="token operator">=</span> __doc__  <span class="token comment"># providing that you have a docstring at the beginning of the DAG; OR</span>
    dag.doc_md <span class="token operator">=</span> <span class="token string">&quot;&quot;</span>&quot;
    This is a documentation placed anywhere
    <span class="token string">&quot;&quot;</span>&quot;  <span class="token comment"># otherwise, type it like this</span>
    templated_command <span class="token operator">=</span> dedent<span class="token punctuation">(</span>
        <span class="token string">&quot;&quot;</span>&quot;
    <span class="token punctuation">{</span>% <span class="token keyword">for</span> <span class="token for-or-select variable">i</span> <span class="token keyword">in</span> range<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span> %<span class="token punctuation">}</span>
        <span class="token builtin class-name">echo</span> <span class="token string">&quot;{{ ds }}&quot;</span>
        <span class="token builtin class-name">echo</span> <span class="token string">&quot;{{ macros.ds_add(ds, 7)}}&quot;</span>
    <span class="token punctuation">{</span>% endfor %<span class="token punctuation">}</span>
    <span class="token string">&quot;&quot;</span>&quot;
    <span class="token punctuation">)</span>

    t3 <span class="token operator">=</span> BashOperator<span class="token punctuation">(</span>
        <span class="token assign-left variable">task_id</span><span class="token operator">=</span><span class="token string">&quot;templated&quot;</span>,
        <span class="token assign-left variable">depends_on_past</span><span class="token operator">=</span>False,
        <span class="token assign-left variable">bash_command</span><span class="token operator">=</span>templated_command,
    <span class="token punctuation">)</span>

    t1 <span class="token operator">&gt;&gt;</span> <span class="token punctuation">[</span>t2, t3<span class="token punctuation">]</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>è¿™æ˜¯ä¸€ä¸ªDAGå®šä¹‰æ–‡ä»¶ï¼Œä½¿ç”¨pythonä»£ç ç¼–å†™ã€‚äººä»¬æœ‰æ—¶ä¼šè®¤ä¸ºDAGå®šä¹‰æ–‡ä»¶æ˜¯ä»–ä»¬å¯ä»¥è¿›è¡Œä¸€äº›å®é™…æ•°æ®å¤„ç†çš„åœ°æ–¹â€”â€”äº‹å®å¹¶éå¦‚æ­¤ï¼è„šæœ¬çš„ç›®çš„æ˜¯å®šä¹‰ä¸€ä¸ªDAGå¯¹è±¡ã€‚å®ƒéœ€è¦å¿«é€Ÿè¯„ä¼°ï¼ˆç§’ï¼Œè€Œä¸æ˜¯åˆ†é’Ÿï¼‰ï¼Œå› ä¸ºè°ƒåº¦ç¨‹åºä¼šå®šæœŸæ‰§è¡Œå®ƒä»¥åæ˜ æ›´æ”¹ï¼ˆå¦‚æœæœ‰çš„è¯ï¼‰</p><h3 id="é»˜è®¤å‚æ•°-default-args" tabindex="-1"><a class="header-anchor" href="#é»˜è®¤å‚æ•°-default-args"><span>é»˜è®¤å‚æ•° ï¼š default_args</span></a></h3><p>åœ¨åˆ›å»ºä¸€ä¸ªDAGå’Œä¸€äº›ä»»åŠ¡æ—¶ï¼Œæˆ‘ä»¬å¯ä»¥é€‰æ‹©æ˜¾å¼åœ°å°†ä¸€ç»„å‚æ•°ä¼ é€’ç»™æ¯ä¸ªä»»åŠ¡çš„æ„é€ å‡½æ•°ï¼ˆè¿™å°†å˜å¾—å¤šä½™ï¼‰ï¼Œæˆ–è€…ï¼ˆæ›´å¥½ï¼ï¼‰æˆ‘ä»¬å¯ä»¥å®šä¹‰ä¸€ä¸ªé»˜è®¤å‚æ•°å­—å…¸ï¼Œä»¥ä¾¿åœ¨åˆ›å»ºä»»åŠ¡æ—¶ä½¿ç”¨ã€‚</p><p>æœ‰å…³BaseOperatorå‚æ•°åŠå…¶ä½œç”¨çš„æ›´å¤šä¿¡æ¯ï¼Œè¯·å‚é˜…<code>airflow.models.BaseOperator</code>æ–‡æ¡£ã€‚</p><h3 id="å®ä¾‹åŒ–dag" tabindex="-1"><a class="header-anchor" href="#å®ä¾‹åŒ–dag"><span>å®ä¾‹åŒ–DAG</span></a></h3><p>æˆ‘ä»¬éœ€è¦ä¸€ä¸ªDAGå¯¹è±¡æ¥åŒ…è£¹æˆ‘ä»¬çš„ä»»åŠ¡ã€‚åœ¨è¿™é‡Œï¼Œæˆ‘ä»¬ä¼ é€’ä¸€ä¸ªå®šä¹‰dag_idçš„å­—ç¬¦ä¸²ï¼Œdag_idæ˜¯dagçš„å”¯ä¸€æ ‡è¯†ç¬¦ã€‚æˆ‘ä»¬è¿˜ä¼ é€’äº†æˆ‘ä»¬åˆšåˆšå®šä¹‰çš„é»˜è®¤å‚æ•°å­—å…¸ï¼Œå¹¶ä¸ºDAGå®šä¹‰äº†ä¸€ä¸ª1å¤©çš„è°ƒåº¦é—´éš”ã€‚</p><h2 id="operators" tabindex="-1"><a class="header-anchor" href="#operators"><span>Operators</span></a></h2><p>operator å®šä¹‰Airflowè¦å®Œæˆçš„å·¥ä½œå•å…ƒã€‚ä½¿ç”¨æ“ä½œç¬¦æ˜¯åœ¨Airflowä¸­å®šä¹‰ä»»åŠ¡çš„ç»å…¸æ–¹æ³•ã€‚å¯¹äºæŸäº›ç”¨ä¾‹ï¼Œæœ€å¥½ä½¿ç”¨TaskFlow APIæ¥å®šä¹‰Pythonä¸Šä¸‹æ–‡ä¸­çš„ä»»åŠ¡ï¼Œå¦‚ä½¿ç”¨TaskFlowä¸­æ‰€è¿°ã€‚ç›®å‰ï¼Œä½¿ç”¨æ“ä½œç¬¦æœ‰åŠ©äºåœ¨DAGä»£ç ä¸­å¯è§†åŒ–ä»»åŠ¡ä¾èµ–å…³ç³»ã€‚</p><p>æ‰€æœ‰æ“ä½œç¬¦éƒ½ç»§æ‰¿è‡ªBaseOperatorã€‚ä¸€äº›æœ€æµè¡Œçš„æ“ä½œç¬¦æ˜¯PythonOperatorã€BashOperatorå’ŒKubernetsPodOperatorã€‚</p><p>Airflowæ ¹æ®æ‚¨ä¼ é€’ç»™æ“ä½œç¬¦çš„å‚æ•°å®Œæˆå·¥ä½œã€‚åœ¨æœ¬æ•™ç¨‹ä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨BashOperatoræ¥è¿è¡Œä¸€äº›bashè„šæœ¬ã€‚</p><h2 id="ä»»åŠ¡" tabindex="-1"><a class="header-anchor" href="#ä»»åŠ¡"><span>ä»»åŠ¡</span></a></h2><p>è¦åœ¨DAGä¸­ä½¿ç”¨æ“ä½œç¬¦ï¼Œå¿…é¡»å°†å…¶å®ä¾‹åŒ–ä¸ºä»»åŠ¡ã€‚ä»»åŠ¡å†³å®šå¦‚ä½•åœ¨DAGçš„ä¸Šä¸‹æ–‡ä¸­æ‰§è¡Œæ“ä½œç¬¦çš„å·¥ä½œã€‚</p><p>åœ¨ä¸Šé¢çš„ç¤ºä¾‹ä¸­ï¼Œæˆ‘ä»¬å°†BashOperatorå®ä¾‹åŒ–ä¸ºä¸¤ä¸ªç‹¬ç«‹çš„ä»»åŠ¡ï¼Œä»¥ä¾¿è¿è¡Œä¸¤ä¸ªå•ç‹¬çš„bashè„šæœ¬ã€‚æ¯ä¸ªå®ä¾‹åŒ–çš„ç¬¬ä¸€ä¸ªå‚æ•°task_idå……å½“ä»»åŠ¡çš„å”¯ä¸€æ ‡è¯†ç¬¦ã€‚</p><p>ä»»åŠ¡å‚æ•°çš„ä¼˜å…ˆçº§è§„åˆ™å¦‚ä¸‹ï¼š</p><ul><li><p>æ˜¾å¼ä¼ é€’çš„å‚æ•°</p></li><li><p>default_argså­—å…¸ä¸­å­˜åœ¨çš„å€¼</p></li><li><p>æ“ä½œç¬¦çš„é»˜è®¤å€¼ï¼ˆå¦‚æœå­˜åœ¨ï¼‰</p></li></ul><blockquote><p>ä»»åŠ¡å¿…é¡»åŒ…å«æˆ–ç»§æ‰¿å‚æ•°task_idå’Œownerï¼Œå¦åˆ™Airflowå°†å¼•å‘å¼‚å¸¸ã€‚</p></blockquote><h2 id="jinjaæ¨¡æ¿" tabindex="-1"><a class="header-anchor" href="#jinjaæ¨¡æ¿"><span>Jinjaæ¨¡æ¿</span></a></h2><p>Airflowåˆ©ç”¨äº†Jinja Templateingçš„å¼ºå¤§åŠŸèƒ½ï¼Œå¹¶ä¸ºç®¡é“ä½œè€…æä¾›äº†ä¸€ç»„å†…ç½®å‚æ•°å’Œå®ã€‚Airflowè¿˜ä¸ºç®¡é“ä½œè€…æä¾›äº†é’©å­ï¼Œä»¥å®šä¹‰ä»–ä»¬è‡ªå·±çš„å‚æ•°ã€å®å’Œæ¨¡æ¿ã€‚ æœ¬æ•™ç¨‹å‡ ä¹æ²¡æœ‰è§¦åŠå¦‚ä½•åœ¨Airflowä¸­ä½¿ç”¨æ¨¡æ¿ï¼Œä½†æœ¬èŠ‚çš„ç›®æ ‡æ˜¯è®©æ‚¨çŸ¥é“è¯¥åŠŸèƒ½çš„å­˜åœ¨ï¼Œç†Ÿæ‚‰åŒèŠ±æ‹¬å·ï¼Œå¹¶æŒ‡å‘æœ€å¸¸è§çš„æ¨¡æ¿å˜é‡ï¼š ã€‚</p><p>è¯·æ³¨æ„ï¼Œtemplated_commandåœ¨<code>ï½›% %ï½</code>å—ä¸­åŒ…å«ä»£ç é€»è¾‘ï¼Œå¼•ç”¨åƒï½›<code>ï½›dsï½ï½</code>è¿™æ ·çš„å‚æ•°ï¼Œå¹¶è°ƒç”¨åƒ<code>ï½›macros.ds_adï¼ˆdsï¼Œ7ï¼‰ï½</code>ä¸­é‚£æ ·çš„å‡½æ•°ã€‚</p><p>æ–‡ä»¶ä¹Ÿå¯ä»¥ä¼ é€’ç»™bash_commandå‚æ•°ï¼Œå¦‚<code>bash_command=&#39;templated_command.sh&#39;</code>ï¼Œå…¶ä¸­æ–‡ä»¶ä½ç½®ç›¸å¯¹äºåŒ…å«ç®¡é“æ–‡ä»¶çš„ç›®å½•ï¼ˆåœ¨æœ¬ä¾‹ä¸­ä¸ºtutorial.pyï¼‰ã€‚ä¹Ÿå¯ä»¥æŒ‡å®šå…¶ä»–ä½ç½®ã€‚</p><p>ä½¿ç”¨ç›¸åŒçš„DAGæ„é€ å‡½æ•°è°ƒç”¨ï¼Œå¯ä»¥å®šä¹‰user_defined_tmacrosï¼Œä»è€Œå¯ä»¥æŒ‡å®šè‡ªå·±çš„å˜é‡ã€‚ä¾‹å¦‚ï¼Œå°†<code>dict(foo=&#39;bar&#39;)</code>ä¼ é€’ç»™æ­¤å‚æ•°å…è®¸æ‚¨åœ¨æ¨¡æ¿ä¸­ä½¿ç”¨<code>ï½›ï½›fooï½ï½</code>ã€‚æ­¤å¤–ï¼ŒæŒ‡å®šuser_defined_filterså…è®¸æ‚¨æ³¨å†Œè‡ªå·±çš„è¿‡æ»¤å™¨ã€‚ä¾‹å¦‚ï¼Œå°†<code>dict(hello=lambda name: &#39;Hello %s&#39; % name)</code>ä¼ é€’åˆ°æ­¤å‚æ•°å…è®¸æ‚¨åœ¨æ¨¡æ¿ä¸­ä½¿ç”¨<code>{{ &#39;world&#39; | hello }}</code>ã€‚æœ‰å…³è‡ªå®šä¹‰è¿‡æ»¤å™¨çš„æ›´å¤šä¿¡æ¯ï¼Œè¯·å‚é˜…Jinjaæ–‡æ¡£ã€‚</p><h2 id="æ–‡æ¡£" tabindex="-1"><a class="header-anchor" href="#æ–‡æ¡£"><span>æ–‡æ¡£</span></a></h2><p>æˆ‘ä»¬å¯ä»¥ä¸ºDAGæˆ–æ¯ä¸ªä»»åŠ¡æ·»åŠ æ–‡æ¡£ã€‚åˆ°ç›®å‰ä¸ºæ­¢ï¼ŒDAGæ–‡æ¡£åªæ”¯æŒmarkdownï¼Œè€Œä»»åŠ¡æ–‡æ¡£æ”¯æŒçº¯æ–‡æœ¬ã€markdownã€reStructuredTextã€jsonå’Œyamlã€‚DAGæ–‡æ¡£å¯ä»¥ä½œä¸ºæ–‡æ¡£å­—ç¬¦ä¸²å†™å…¥DAGæ–‡ä»¶çš„å¼€å¤´ï¼ˆæ¨èï¼‰ï¼Œä¹Ÿå¯ä»¥å†™å…¥æ–‡ä»¶ä¸­çš„ä»»ä½•å…¶ä»–ä½ç½®ã€‚</p><figure><img src="/assets/task_doc-CsZrP6gX.png" alt="../_images/task_doc.png" tabindex="0" loading="lazy"><figcaption>../_images/task_doc.png</figcaption></figure><h2 id="ä»»åŠ¡ä¾èµ–å…³ç³»" tabindex="-1"><a class="header-anchor" href="#ä»»åŠ¡ä¾èµ–å…³ç³»"><span>ä»»åŠ¡ä¾èµ–å…³ç³»</span></a></h2><p>æˆ‘ä»¬æœ‰ç›¸äº’ä¸ä¾èµ–çš„ä»»åŠ¡t1ã€t2å’Œt3ã€‚ä»¥ä¸‹æ˜¯å®šä¹‰å®ƒä»¬ä¹‹é—´ä¾èµ–å…³ç³»çš„å‡ ç§æ–¹æ³•ï¼š</p><div class="language-python line-numbers-mode" data-ext="py" data-title="py"><pre class="language-python"><code>t1<span class="token punctuation">.</span>set_downstream<span class="token punctuation">(</span>t2<span class="token punctuation">)</span>

<span class="token comment"># This means that t2 will depend on t1</span>
<span class="token comment"># running successfully to run.</span>
<span class="token comment"># It is equivalent to:</span>
t2<span class="token punctuation">.</span>set_upstream<span class="token punctuation">(</span>t1<span class="token punctuation">)</span>

<span class="token comment"># The bit shift operator can also be</span>
<span class="token comment"># used to chain operations:</span>
t1 <span class="token operator">&gt;&gt;</span> t2

<span class="token comment"># And the upstream dependency with the</span>
<span class="token comment"># bit shift operator:</span>
t2 <span class="token operator">&lt;&lt;</span> t1

<span class="token comment"># Chaining multiple dependencies becomes</span>
<span class="token comment"># concise with the bit shift operator:</span>
t1 <span class="token operator">&gt;&gt;</span> t2 <span class="token operator">&gt;&gt;</span> t3

<span class="token comment"># A list of tasks can also be set as</span>
<span class="token comment"># dependencies. These operations</span>
<span class="token comment"># all have the same effect:</span>
t1<span class="token punctuation">.</span>set_downstream<span class="token punctuation">(</span><span class="token punctuation">[</span>t2<span class="token punctuation">,</span> t3<span class="token punctuation">]</span><span class="token punctuation">)</span>
t1 <span class="token operator">&gt;&gt;</span> <span class="token punctuation">[</span>t2<span class="token punctuation">,</span> t3<span class="token punctuation">]</span>
<span class="token punctuation">[</span>t2<span class="token punctuation">,</span> t3<span class="token punctuation">]</span> <span class="token operator">&lt;&lt;</span> t1
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><blockquote><p>è¯·æ³¨æ„ï¼Œåœ¨æ‰§è¡Œè„šæœ¬æ—¶ï¼Œå½“Airflowåœ¨DAGä¸­æ‰¾åˆ°å¾ªç¯æˆ–ä¾èµ–é¡¹è¢«å¤šæ¬¡å¼•ç”¨æ—¶ï¼Œå®ƒå°†å¼•å‘å¼‚å¸¸ã€‚</p></blockquote><h2 id="æ—¶åŒº" tabindex="-1"><a class="header-anchor" href="#æ—¶åŒº"><span>æ—¶åŒº</span></a></h2><p>åˆ›å»ºä¸€ä¸ªæ—¶åŒºæ„ŸçŸ¥DAGéå¸¸ç®€å•ã€‚åªè¦ç¡®ä¿ä½¿ç”¨<code>pendulum</code>åˆ›å»ºå¸¦æœ‰æ—¶åŒºçš„æ—¶é—´å³å¯ã€‚ä¸è¦è¯•å›¾ä½¿ç”¨æ ‡å‡†åº“æ—¶åŒºï¼Œå› ä¸ºä¼—æ‰€å‘¨çŸ¥å®ƒä»¬æœ‰å±€é™æ€§ï¼Œæˆ‘ä»¬æ•…æ„ä¸å…è®¸åœ¨DAGä¸­ä½¿ç”¨å®ƒä»¬ã€‚</p><h2 id="æµ‹è¯•" tabindex="-1"><a class="header-anchor" href="#æµ‹è¯•"><span>æµ‹è¯•</span></a></h2><h3 id="éªŒè¯" tabindex="-1"><a class="header-anchor" href="#éªŒè¯"><span>éªŒè¯</span></a></h3><p>å‡è®¾æˆ‘ä»¬å°†ä¸Šé¢çš„ä»£ç ä¿å­˜åœ¨airflow.cfgä¸­å¼•ç”¨çš„DAGæ–‡ä»¶å¤¹ä¸­ã€‚DAGçš„é»˜è®¤ä½ç½®ä¸º<code>~/airflow/DAGs</code>ã€‚</p><div class="language-bash line-numbers-mode" data-ext="sh" data-title="sh"><pre class="language-bash"><code>python ~/airflow/dags/tutorial.py
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>å¦‚æœè„šæœ¬æ²¡æœ‰å¼•å‘å¼‚å¸¸ï¼Œåˆ™è¡¨ç¤ºæ‚¨æ²¡æœ‰åšä»»ä½•å¯æ€•çš„é”™è¯¯ï¼Œå¹¶ä¸”æ‚¨çš„Airflowç¯å¢ƒåœ¨æŸç§ç¨‹åº¦ä¸Šæ˜¯å¥å…¨çš„ã€‚</p><p>è®©æˆ‘ä»¬è¿è¡Œä¸€äº›å‘½ä»¤æ¥è¿›ä¸€æ­¥éªŒè¯è¿™ä¸ªè„šæœ¬ã€‚</p><div class="language-bash line-numbers-mode" data-ext="sh" data-title="sh"><pre class="language-bash"><code><span class="token comment"># initialize the database tables</span>
airflow db migrate

<span class="token comment"># print the list of active DAGs</span>
airflow dags list

<span class="token comment"># prints the list of tasks in the &quot;tutorial&quot; DAG</span>
airflow tasks list tutorial

<span class="token comment"># prints the hierarchy of tasks in the &quot;tutorial&quot; DAG</span>
airflow tasks list tutorial <span class="token parameter variable">--tree</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="è¿è¡Œä»»åŠ¡" tabindex="-1"><a class="header-anchor" href="#è¿è¡Œä»»åŠ¡"><span>è¿è¡Œä»»åŠ¡</span></a></h3><p>è®©æˆ‘ä»¬é€šè¿‡è¿è¡Œç‰¹å®šæ—¥æœŸçš„å®é™…ä»»åŠ¡å®ä¾‹æ¥è¿›è¡Œæµ‹è¯•ã€‚åœ¨æ­¤ä¸Šä¸‹æ–‡ä¸­æŒ‡å®šçš„æ—¥æœŸç§°ä¸ºé€»è¾‘æ—¥æœŸï¼ˆå‡ºäºå†å²åŸå› ï¼Œä¹Ÿç§°ä¸ºæ‰§è¡Œæ—¥æœŸï¼‰ï¼Œå®ƒæ¨¡æ‹Ÿè°ƒåº¦ç¨‹åºåœ¨ç‰¹å®šæ—¥æœŸå’Œæ—¶é—´è¿è¡Œä»»åŠ¡æˆ–DAGï¼Œå³ä½¿å®ƒç°åœ¨ç‰©ç†ä¸Šä¼šè¿è¡Œï¼ˆæˆ–åœ¨æ»¡è¶³å…¶ä¾èµ–å…³ç³»æ—¶ï¼‰ã€‚</p><div class="language-bash line-numbers-mode" data-ext="sh" data-title="sh"><pre class="language-bash"><code><span class="token comment"># command layout: command subcommand [dag_id] [task_id] [(optional) date]</span>

<span class="token comment"># testing print_date</span>
airflow tasks <span class="token builtin class-name">test</span> tutorial print_date <span class="token number">2015</span>-06-01

<span class="token comment"># testing sleep</span>
airflow tasks <span class="token builtin class-name">test</span> tutorial <span class="token function">sleep</span> <span class="token number">2015</span>-06-01
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ç°åœ¨è¿˜è®°å¾—æˆ‘ä»¬ä¹‹å‰å¯¹æ¨¡æ¿åšäº†ä»€ä¹ˆå—ï¼Ÿé€šè¿‡è¿è¡Œä»¥ä¸‹å‘½ä»¤æŸ¥çœ‹å¦‚ä½•æ¸²æŸ“å’Œæ‰§è¡Œæ­¤æ¨¡æ¿ï¼š</p><div class="language-bash line-numbers-mode" data-ext="sh" data-title="sh"><pre class="language-bash"><code><span class="token comment"># testing templated</span>
airflow tasks <span class="token builtin class-name">test</span> tutorial templated <span class="token number">2015</span>-06-01
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p>è¿™å°†å¯¼è‡´æ˜¾ç¤ºè¯¦ç»†çš„äº‹ä»¶æ—¥å¿—ï¼Œå¹¶æœ€ç»ˆè¿è¡Œbashå‘½ä»¤å¹¶æ‰“å°ç»“æœã€‚</p><p>è¯·æ³¨æ„ï¼Œairflow tasks testå‘½ä»¤åœ¨æœ¬åœ°è¿è¡Œä»»åŠ¡å®ä¾‹ï¼Œå°†å…¶æ—¥å¿—è¾“å‡ºåˆ°stdoutï¼ˆåœ¨å±å¹•ä¸Šï¼‰ï¼Œä¸æ¶‰åŠä¾èµ–å…³ç³»ï¼Œä¹Ÿä¸å°†çŠ¶æ€ï¼ˆæ­£åœ¨è¿è¡Œã€æˆåŠŸã€å¤±è´¥â€¦ï¼‰ä¸æ•°æ®åº“é€šä¿¡ã€‚å®ƒåªå…è®¸æµ‹è¯•å•ä¸ªä»»åŠ¡å®ä¾‹ã€‚</p><p>è¿™åŒæ ·é€‚ç”¨äºdagsæµ‹è¯•ï¼Œä½†åœ¨DAGçº§åˆ«ä¸Šã€‚å®ƒå¯¹ç»™å®šçš„DAG idæ‰§è¡Œä¸€æ¬¡DAGè¿è¡Œã€‚è™½ç„¶å®ƒç¡®å®è€ƒè™‘äº†ä»»åŠ¡ä¾èµ–æ€§ï¼Œä½†æ²¡æœ‰åœ¨æ•°æ®åº“ä¸­æ³¨å†Œä»»ä½•çŠ¶æ€ã€‚</p><h3 id="backfill-å›å¡«" tabindex="-1"><a class="header-anchor" href="#backfill-å›å¡«"><span>Backfill(å›å¡«)</span></a></h3><p>ä¸€åˆ‡çœ‹èµ·æ¥éƒ½å¾ˆå¥½ï¼Œæ‰€ä»¥è®©æˆ‘ä»¬è¿›è¡Œå›å¡«ã€‚å›å¡«å°†å°Šé‡æ‚¨çš„ä¾èµ–å…³ç³»ï¼Œå°†æ—¥å¿—å‘é€åˆ°æ–‡ä»¶ä¸­ï¼Œå¹¶ä¸æ•°æ®åº“å¯¹è¯ä»¥è®°å½•çŠ¶æ€ã€‚å¦‚æœä½ æœ‰ä¸€ä¸ªç½‘ç»œæœåŠ¡å™¨ï¼Œä½ å°†èƒ½å¤Ÿè·Ÿè¸ªè¿›åº¦ã€‚å¦‚æœæ‚¨æœ‰å…´è¶£åœ¨å›å¡«è¿‡ç¨‹ä¸­ç›´è§‚åœ°è·Ÿè¸ªè¿›åº¦ï¼Œairflow webserverå°†å¯åŠ¨ä¸€ä¸ªwebæœåŠ¡å™¨ã€‚</p><p>è¯·æ³¨æ„ï¼Œå¦‚æœä½¿ç”¨depends_on_past=Trueï¼Œåˆ™å•ä¸ªä»»åŠ¡å®ä¾‹å°†å–å†³äºå…¶ä¸Šä¸€ä¸ªä»»åŠ¡å®ä¾‹ï¼ˆå³æ ¹æ®é€»è¾‘æ—¥æœŸçš„ä¸Šä¸€ä¸ªï¼‰çš„æˆåŠŸç‡ã€‚é€»è¾‘æ—¥æœŸç­‰äºstart_dateçš„ä»»åŠ¡å®ä¾‹å°†å¿½ç•¥æ­¤ä¾èµ–å…³ç³»ï¼Œå› ä¸ºä¸ä¼šä¸ºå®ƒä»¬åˆ›å»ºè¿‡å»çš„ä»»åŠ¡å®ä¾‹ã€‚</p><p>åœ¨ä½¿ç”¨depends_on_past=Trueæ—¶ï¼Œæ‚¨å¯èƒ½è¿˜éœ€è¦è€ƒè™‘wait_for_downstream=Trueã€‚depends_on_past=Trueä¼šå¯¼è‡´ä»»åŠ¡å®ä¾‹ä¾èµ–äºå…¶ä¸Šä¸€ä¸ªtask_instanceçš„æˆåŠŸï¼Œè€Œwait_for_downstream=Trueä¼šå¯¼è‡´ä¸€ä¸ªä»»åŠ¡å®ä¾‹ä¹Ÿä¼šç­‰å¾…ä¸Šä¸€ä¸ªä»»åŠ¡ç¤ºä¾‹ä¸‹æ¸¸çš„æ‰€æœ‰ä»»åŠ¡å®ä¾‹æˆåŠŸã€‚</p><p>æ­¤ä¸Šä¸‹æ–‡ä¸­çš„æ—¥æœŸèŒƒå›´æ˜¯start_dateå’Œend_dateï¼ˆå¯é€‰ï¼‰ï¼Œç”¨äºä½¿ç”¨æ­¤DAGä¸­çš„ä»»åŠ¡å®ä¾‹å¡«å……è¿è¡Œè®¡åˆ’ã€‚</p><div class="language-bash line-numbers-mode" data-ext="sh" data-title="sh"><pre class="language-bash"><code><span class="token comment"># optional, start a web server in debug mode in the background</span>
<span class="token comment"># airflow webserver --debug &amp;</span>

<span class="token comment"># start your backfill on a date range</span>
airflow dags backfill tutorial <span class="token punctuation">\</span>
    --start-date <span class="token number">2015</span>-06-01 <span class="token punctuation">\</span>
    --end-date <span class="token number">2015</span>-06-07
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="taskflow" tabindex="-1"><a class="header-anchor" href="#taskflow"><span>TaskFlow</span></a></h2><div class="language-python line-numbers-mode" data-ext="py" data-title="py"><pre class="language-python"><code>
<span class="token keyword">import</span> json

<span class="token keyword">import</span> pendulum

<span class="token keyword">from</span> airflow<span class="token punctuation">.</span>decorators <span class="token keyword">import</span> dag<span class="token punctuation">,</span> task
<span class="token decorator annotation punctuation">@dag</span><span class="token punctuation">(</span>
    schedule<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span>
    start_date<span class="token operator">=</span>pendulum<span class="token punctuation">.</span>datetime<span class="token punctuation">(</span><span class="token number">2021</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> tz<span class="token operator">=</span><span class="token string">&quot;UTC&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    catchup<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span>
    tags<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">&quot;example&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">tutorial_taskflow_api</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">&quot;&quot;&quot;
    ### TaskFlow API Tutorial Documentation
    This is a simple data pipeline example which demonstrates the use of
    the TaskFlow API using three simple tasks for Extract, Transform, and Load.
    Documentation that goes along with the Airflow TaskFlow API tutorial is
    located
    [here](https://airflow.apache.org/docs/apache-airflow/stable/tutorial_taskflow_api.html)
    &quot;&quot;&quot;</span>
    <span class="token decorator annotation punctuation">@task</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">def</span> <span class="token function">extract</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">&quot;&quot;&quot;
        #### Extract task
        A simple Extract task to get data ready for the rest of the data
        pipeline. In this case, getting data is simulated by reading from a
        hardcoded JSON string.
        &quot;&quot;&quot;</span>
        data_string <span class="token operator">=</span> <span class="token string">&#39;{&quot;1001&quot;: 301.27, &quot;1002&quot;: 433.21, &quot;1003&quot;: 502.22}&#39;</span>

        order_data_dict <span class="token operator">=</span> json<span class="token punctuation">.</span>loads<span class="token punctuation">(</span>data_string<span class="token punctuation">)</span>
        <span class="token keyword">return</span> order_data_dict
    <span class="token decorator annotation punctuation">@task</span><span class="token punctuation">(</span>multiple_outputs<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
    <span class="token keyword">def</span> <span class="token function">transform</span><span class="token punctuation">(</span>order_data_dict<span class="token punctuation">:</span> <span class="token builtin">dict</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">&quot;&quot;&quot;
        #### Transform task
        A simple Transform task which takes in the collection of order data and
        computes the total order value.
        &quot;&quot;&quot;</span>
        total_order_value <span class="token operator">=</span> <span class="token number">0</span>

        <span class="token keyword">for</span> value <span class="token keyword">in</span> order_data_dict<span class="token punctuation">.</span>values<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            total_order_value <span class="token operator">+=</span> value

        <span class="token keyword">return</span> <span class="token punctuation">{</span><span class="token string">&quot;total_order_value&quot;</span><span class="token punctuation">:</span> total_order_value<span class="token punctuation">}</span>
    <span class="token decorator annotation punctuation">@task</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">def</span> <span class="token function">load</span><span class="token punctuation">(</span>total_order_value<span class="token punctuation">:</span> <span class="token builtin">float</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">&quot;&quot;&quot;
        #### Load task
        A simple Load task which takes in the result of the Transform task and
        instead of saving it to end user review, just prints it out.
        &quot;&quot;&quot;</span>

        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f&quot;Total order value is: </span><span class="token interpolation"><span class="token punctuation">{</span>total_order_value<span class="token punctuation">:</span><span class="token format-spec">.2f</span><span class="token punctuation">}</span></span><span class="token string">&quot;</span></span><span class="token punctuation">)</span>
    order_data <span class="token operator">=</span> extract<span class="token punctuation">(</span><span class="token punctuation">)</span>
    order_summary <span class="token operator">=</span> transform<span class="token punctuation">(</span>order_data<span class="token punctuation">)</span>
    load<span class="token punctuation">(</span>order_summary<span class="token punctuation">[</span><span class="token string">&quot;total_order_value&quot;</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
tutorial_taskflow_api<span class="token punctuation">(</span><span class="token punctuation">)</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>æˆ‘ä»¬æ­£åœ¨åˆ›å»ºä¸€ä¸ªDAGï¼Œå®ƒæ˜¯ä»»åŠ¡ä¹‹é—´å…·æœ‰ä¾èµ–å…³ç³»çš„ä»»åŠ¡çš„é›†åˆã€‚è¿™æ˜¯ä¸€ä¸ªéå¸¸ç®€å•çš„å®šä¹‰ï¼Œå› ä¸ºæˆ‘ä»¬åªå¸Œæœ›åœ¨ä½¿ç”¨Airflowæ„å»ºDAGæ—¶è¿è¡ŒDAGï¼Œè€Œä¸éœ€è¦ä»»ä½•é‡è¯•æˆ–å¤æ‚çš„è°ƒåº¦ã€‚åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œè¯·æ³¨æ„ï¼Œæˆ‘ä»¬ä½¿ç”¨@DAGè£…é¥°å™¨åˆ›å»ºè¿™ä¸ªDAGï¼ŒPythonå‡½æ•°åå……å½“DAGæ ‡è¯†ç¬¦ã€‚</p><p>åœ¨è¿™ä¸ªæ•°æ®ç®¡é“ä¸­ï¼Œä½¿ç”¨@task decoratoråŸºäºPythonå‡½æ•°åˆ›å»ºä»»åŠ¡ï¼Œå¦‚ä¸‹æ‰€ç¤ºã€‚å‡½æ•°åç§°å……å½“ä»»åŠ¡çš„å”¯ä¸€æ ‡è¯†ç¬¦ã€‚</p><p>ä»»åŠ¡ä¹‹é—´çš„ä¾èµ–å…³ç³»ä»¥åŠè¿™äº›ä»»åŠ¡ä¹‹é—´çš„æ•°æ®ä¼ é€’éƒ½ç”±Airflowå¤„ç†ï¼Œè¿™äº›ä»»åŠ¡å¯èƒ½åœ¨ç½‘ç»œä¸Šä¸åŒèŠ‚ç‚¹ä¸Šçš„ä¸åŒå·¥ä½œçº¿ç¨‹ä¸Šè¿è¡Œã€‚</p><h3 id="é‡ç”¨" tabindex="-1"><a class="header-anchor" href="#é‡ç”¨"><span>é‡ç”¨</span></a></h3><p>è£…é¥°ä»»åŠ¡æ˜¯çµæ´»çš„ã€‚æ‚¨å¯ä»¥åœ¨å¤šä¸ªDAGä¸­é‡ç”¨ä¿®é¥°çš„ä»»åŠ¡ï¼Œè¦†ç›–task_id, <code>queue</code>, poolç­‰ä»»åŠ¡å‚æ•°ã€‚ ä»¥ä¸‹æ˜¯å¦‚ä½•åœ¨å¤šä¸ªDAGä¸­é‡ç”¨è£…é¥°ä»»åŠ¡çš„ç¤ºä¾‹ï¼š</p><div class="language-python line-numbers-mode" data-ext="py" data-title="py"><pre class="language-python"><code><span class="token keyword">from</span> airflow<span class="token punctuation">.</span>decorators <span class="token keyword">import</span> task<span class="token punctuation">,</span> dag
<span class="token keyword">from</span> datetime <span class="token keyword">import</span> datetime


<span class="token decorator annotation punctuation">@task</span>
<span class="token keyword">def</span> <span class="token function">add_task</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f&quot;Task args: x=</span><span class="token interpolation"><span class="token punctuation">{</span>x<span class="token punctuation">}</span></span><span class="token string">, y=</span><span class="token interpolation"><span class="token punctuation">{</span>y<span class="token punctuation">}</span></span><span class="token string">&quot;</span></span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> x <span class="token operator">+</span> y


<span class="token decorator annotation punctuation">@dag</span><span class="token punctuation">(</span>start_date<span class="token operator">=</span>datetime<span class="token punctuation">(</span><span class="token number">2022</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">mydag</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    start <span class="token operator">=</span> add_task<span class="token punctuation">.</span>override<span class="token punctuation">(</span>task_id<span class="token operator">=</span><span class="token string">&quot;start&quot;</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span>
    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        start <span class="token operator">&gt;&gt;</span> add_task<span class="token punctuation">.</span>override<span class="token punctuation">(</span>task_id<span class="token operator">=</span><span class="token string-interpolation"><span class="token string">f&quot;add_start_</span><span class="token interpolation"><span class="token punctuation">{</span>i<span class="token punctuation">}</span></span><span class="token string">&quot;</span></span><span class="token punctuation">)</span><span class="token punctuation">(</span>start<span class="token punctuation">,</span> i<span class="token punctuation">)</span>


<span class="token decorator annotation punctuation">@dag</span><span class="token punctuation">(</span>start_date<span class="token operator">=</span>datetime<span class="token punctuation">(</span><span class="token number">2022</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">mydag2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    start <span class="token operator">=</span> add_task<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span>
    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        start <span class="token operator">&gt;&gt;</span> add_task<span class="token punctuation">.</span>override<span class="token punctuation">(</span>task_id<span class="token operator">=</span><span class="token string-interpolation"><span class="token string">f&quot;new_add_task_</span><span class="token interpolation"><span class="token punctuation">{</span>i<span class="token punctuation">}</span></span><span class="token string">&quot;</span></span><span class="token punctuation">)</span><span class="token punctuation">(</span>start<span class="token punctuation">,</span> i<span class="token punctuation">)</span>


first_dag <span class="token operator">=</span> mydag<span class="token punctuation">(</span><span class="token punctuation">)</span>
second_dag <span class="token operator">=</span> mydag2<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>æ‚¨ä¹Ÿå¯ä»¥å¯¼å…¥ä¸Šé¢çš„add_taskï¼Œå¹¶åœ¨å¦ä¸€ä¸ªDAGæ–‡ä»¶ä¸­ä½¿ç”¨å®ƒã€‚å‡è®¾add_taskä»£ç ä½äºä¸€ä¸ªåä¸ºcommon.pyçš„æ–‡ä»¶ä¸­:</p><div class="language-python line-numbers-mode" data-ext="py" data-title="py"><pre class="language-python"><code><span class="token keyword">from</span> common <span class="token keyword">import</span> add_task
<span class="token keyword">from</span> airflow<span class="token punctuation">.</span>decorators <span class="token keyword">import</span> dag
<span class="token keyword">from</span> datetime <span class="token keyword">import</span> datetime


<span class="token decorator annotation punctuation">@dag</span><span class="token punctuation">(</span>start_date<span class="token operator">=</span>datetime<span class="token punctuation">(</span><span class="token number">2022</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">use_add_task</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    start <span class="token operator">=</span> add_task<span class="token punctuation">.</span>override<span class="token punctuation">(</span>priority_weight<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span>
    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        start <span class="token operator">&gt;&gt;</span> add_task<span class="token punctuation">.</span>override<span class="token punctuation">(</span>task_id<span class="token operator">=</span><span class="token string-interpolation"><span class="token string">f&quot;new_add_task_</span><span class="token interpolation"><span class="token punctuation">{</span>i<span class="token punctuation">}</span></span><span class="token string">&quot;</span></span><span class="token punctuation">,</span> retries<span class="token operator">=</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">(</span>start<span class="token punctuation">,</span> i<span class="token punctuation">)</span>


created_dag <span class="token operator">=</span> use_add_task<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="ä½¿ç”¨å…·æœ‰å¤æ‚-å†²çªpythonä¾èµ–å…³ç³»çš„taskflow-api" tabindex="-1"><a class="header-anchor" href="#ä½¿ç”¨å…·æœ‰å¤æ‚-å†²çªpythonä¾èµ–å…³ç³»çš„taskflow-api"><span>ä½¿ç”¨å…·æœ‰å¤æ‚/å†²çªPythonä¾èµ–å…³ç³»çš„TaskFlow API</span></a></h3><p>å¯¹äºä¸‹é¢æè¿°çš„æ‰€æœ‰ä¿®é¥°å‡½æ•°çš„æƒ…å†µï¼Œæ‚¨å¿…é¡»ç¡®ä¿è¿™äº›å‡½æ•°æ˜¯å¯åºåˆ—åŒ–çš„ï¼Œå¹¶ä¸”å®ƒä»¬åªå¯¹æ‚¨ä½¿ç”¨çš„å…¶ä»–ä¾èµ–é¡¹ä½¿ç”¨æœ¬åœ°å¯¼å…¥ã€‚è¿™äº›å¯¼å…¥çš„é™„åŠ åº“å¿…é¡»åœ¨ç›®æ ‡ç¯å¢ƒä¸­å¯ç”¨â€”â€”å®ƒä»¬ä¸éœ€è¦åœ¨ä¸»Airflowç¯å¢ƒä¸­å¯ç”¨ã€‚</p><p>æ‚¨åº”è¯¥ä½¿ç”¨å“ªç§è¿ç®—ç¬¦å–å†³äºä»¥ä¸‹å‡ ä¸ªå› ç´ ï¼š</p><ul><li>ä½¿ç”¨Dockerå¼•æ“è¿˜æ˜¯Kubernetesè¿è¡ŒAirflow</li><li>æ˜¯å¦å¯ä»¥è´Ÿæ‹…åŠ¨æ€åˆ›å»ºå…·æœ‰æ–°ä¾èµ–é¡¹çš„è™šæ‹Ÿç¯å¢ƒçš„å¼€é”€</li><li>æ˜¯å¦å¯ä»¥ä¸ºæ‰€æœ‰Airflowç»„ä»¶éƒ¨ç½²é¢„å…ˆå­˜åœ¨çš„ã€ä¸å¯å˜çš„Pythonç¯å¢ƒã€‚</li></ul><p>è¿™äº›é€‰é¡¹åº”è¯¥ä¸ºé‚£äº›å¸Œæœ›ä¿æŒå·¥ä½œæµç¨‹æ›´ç®€å•ã€æ›´PythonåŒ–çš„ç”¨æˆ·æä¾›æ›´å¤§çš„çµæ´»æ€§ï¼Œå¹¶å…è®¸æ‚¨åœ¨DAGæœ¬èº«ä¸­ä¿ç•™DAGçš„å®Œæ•´é€»è¾‘ã€‚</p><h4 id="ä¸ºæ¯ä¸ªä»»åŠ¡åŠ¨æ€åˆ›å»ºvirtualenv" tabindex="-1"><a class="header-anchor" href="#ä¸ºæ¯ä¸ªä»»åŠ¡åŠ¨æ€åˆ›å»ºvirtualenv"><span>ä¸ºæ¯ä¸ªä»»åŠ¡åŠ¨æ€åˆ›å»ºVirtualenv</span></a></h4><p>æœ€ç®€å•çš„æ–¹æ³•æ˜¯åœ¨åŒä¸€å°æœºå™¨ä¸ŠåŠ¨æ€åœ°ï¼ˆæ¯æ¬¡è¿è¡Œä»»åŠ¡æ—¶ï¼‰åˆ›å»ºä¸€ä¸ªå•ç‹¬çš„è™šæ‹Ÿç¯å¢ƒï¼Œæ‚¨å¯ä»¥ä½¿ç”¨<code>@task.virtualenv</code>è£…é¥°å™¨ã€‚decoratorå…è®¸æ‚¨ä½¿ç”¨è‡ªå®šä¹‰åº“åŠ¨æ€åˆ›å»ºä¸€ä¸ªæ–°çš„virtualenvï¼Œç”šè‡³å¯ä»¥ä½¿ç”¨ä¸åŒçš„Pythonç‰ˆæœ¬æ¥è¿è¡Œæ‚¨çš„å‡½æ•°ã€‚</p><div class="language-python line-numbers-mode" data-ext="py" data-title="py"><pre class="language-python"><code>    <span class="token decorator annotation punctuation">@task<span class="token punctuation">.</span>virtualenv</span><span class="token punctuation">(</span>
        task_id<span class="token operator">=</span><span class="token string">&quot;virtualenv_python&quot;</span><span class="token punctuation">,</span> requirements<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">&quot;colorama==0.4.0&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span> system_site_packages<span class="token operator">=</span><span class="token boolean">False</span>
    <span class="token punctuation">)</span>
    <span class="token keyword">def</span> <span class="token function">callable_virtualenv</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">&quot;&quot;&quot;
        Example function that will be performed in a virtual environment.

        Importing at the module level ensures that it will not attempt to import the
        library before it is installed.
        &quot;&quot;&quot;</span>
        <span class="token keyword">from</span> time <span class="token keyword">import</span> sleep

        <span class="token keyword">from</span> colorama <span class="token keyword">import</span> Back<span class="token punctuation">,</span> Fore<span class="token punctuation">,</span> Style

        <span class="token keyword">print</span><span class="token punctuation">(</span>Fore<span class="token punctuation">.</span>RED <span class="token operator">+</span> <span class="token string">&quot;some red text&quot;</span><span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span>Back<span class="token punctuation">.</span>GREEN <span class="token operator">+</span> <span class="token string">&quot;and with a green background&quot;</span><span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span>Style<span class="token punctuation">.</span>DIM <span class="token operator">+</span> <span class="token string">&quot;and in dim text&quot;</span><span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span>Style<span class="token punctuation">.</span>RESET_ALL<span class="token punctuation">)</span>
        <span class="token keyword">for</span> _ <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span>Style<span class="token punctuation">.</span>DIM <span class="token operator">+</span> <span class="token string">&quot;Please wait...&quot;</span><span class="token punctuation">,</span> flush<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
            sleep<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;Finished&quot;</span><span class="token punctuation">)</span>

    virtualenv_task <span class="token operator">=</span> callable_virtualenv<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="ä½¿ç”¨å¸¦æœ‰é¢„è£…ä¾èµ–é¡¹çš„pythonç¯å¢ƒ" tabindex="-1"><a class="header-anchor" href="#ä½¿ç”¨å¸¦æœ‰é¢„è£…ä¾èµ–é¡¹çš„pythonç¯å¢ƒ"><span>ä½¿ç”¨å¸¦æœ‰é¢„è£…ä¾èµ–é¡¹çš„Pythonç¯å¢ƒ</span></a></h4><p>æ›´å¤æ‚çš„<code>@task.external_python</code> decoratorå…è®¸æ‚¨åœ¨é¢„å®šä¹‰çš„ã€ä¸å¯å˜çš„virtualenvï¼ˆæˆ–åœ¨æ²¡æœ‰virtualenvçš„ç³»ç»Ÿçº§å®‰è£…çš„pythonäºŒè¿›åˆ¶æ–‡ä»¶ï¼‰ä¸­è¿è¡ŒAirflowä»»åŠ¡ã€‚è¿™ä¸ªvirtualenvæˆ–ç³»ç»Ÿpythonä¹Ÿå¯ä»¥å®‰è£…ä¸åŒçš„è‡ªå®šä¹‰åº“é›†ï¼Œå¹¶ä¸”å¿…é¡»åœ¨æ‰€æœ‰å¯ä»¥åœ¨åŒä¸€ä½ç½®æ‰§è¡Œä»»åŠ¡çš„å·¥ä½œè€…ä¸­æä¾›ã€‚</p><div class="language-python line-numbers-mode" data-ext="py" data-title="py"><pre class="language-python"><code>    <span class="token decorator annotation punctuation">@task<span class="token punctuation">.</span>external_python</span><span class="token punctuation">(</span>task_id<span class="token operator">=</span><span class="token string">&quot;external_python&quot;</span><span class="token punctuation">,</span> python<span class="token operator">=</span>PATH_TO_PYTHON_BINARY<span class="token punctuation">)</span>
    <span class="token keyword">def</span> <span class="token function">callable_external_python</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">&quot;&quot;&quot;
        Example function that will be performed in a virtual environment.

        Importing at the module level ensures that it will not attempt to import the
        library before it is installed.
        &quot;&quot;&quot;</span>
        <span class="token keyword">import</span> sys
        <span class="token keyword">from</span> time <span class="token keyword">import</span> sleep

        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f&quot;Running task via </span><span class="token interpolation"><span class="token punctuation">{</span>sys<span class="token punctuation">.</span>executable<span class="token punctuation">}</span></span><span class="token string">&quot;</span></span><span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;Sleeping&quot;</span><span class="token punctuation">)</span>
        <span class="token keyword">for</span> _ <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;Please wait...&quot;</span><span class="token punctuation">,</span> flush<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
            sleep<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;Finished&quot;</span><span class="token punctuation">)</span>

    external_python_task <span class="token operator">=</span> callable_external_python<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="ä½¿ç”¨dockerè¿ç®—ç¬¦è¿›è¡Œä¾èµ–åˆ†ç¦»" tabindex="-1"><a class="header-anchor" href="#ä½¿ç”¨dockerè¿ç®—ç¬¦è¿›è¡Œä¾èµ–åˆ†ç¦»"><span>ä½¿ç”¨Dockerè¿ç®—ç¬¦è¿›è¡Œä¾èµ–åˆ†ç¦»</span></a></h4><p>å¦‚æœä½ çš„Airflowå·¥ä½œäººå‘˜å¯ä»¥è®¿é—®dockerå¼•æ“ï¼Œä½ å¯ä»¥ä½¿ç”¨DockerOperatorå¹¶æ·»åŠ ä»»ä½•æ‰€éœ€çš„å‚æ•°æ¥æ­£ç¡®è¿è¡Œä»»åŠ¡ã€‚è¯·æ³¨æ„ï¼Œdockeræ˜ åƒå¿…é¡»å®‰è£…ä¸€ä¸ªå¯å·¥ä½œçš„Pythonï¼Œå¹¶å°†bashå‘½ä»¤ä½œä¸ºcommandå‚æ•°ã€‚</p><div class="language-python line-numbers-mode" data-ext="py" data-title="py"><pre class="language-python"><code><span class="token decorator annotation punctuation">@task<span class="token punctuation">.</span>docker</span><span class="token punctuation">(</span>image<span class="token operator">=</span><span class="token string">&quot;python:3.9-slim-bullseye&quot;</span><span class="token punctuation">,</span> multiple_outputs<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">transform</span><span class="token punctuation">(</span>order_data_dict<span class="token punctuation">:</span> <span class="token builtin">dict</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">&quot;&quot;&quot;
    #### Transform task
    A simple Transform task which takes in the collection of order data and
    computes the total order value.
    &quot;&quot;&quot;</span>
    total_order_value <span class="token operator">=</span> <span class="token number">0</span>

    <span class="token keyword">for</span> value <span class="token keyword">in</span> order_data_dict<span class="token punctuation">.</span>values<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        total_order_value <span class="token operator">+=</span> value

    <span class="token keyword">return</span> <span class="token punctuation">{</span><span class="token string">&quot;total_order_value&quot;</span><span class="token punctuation">:</span> total_order_value<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="ä½¿ç”¨kubernetes-podè¿ç®—ç¬¦è¿›è¡Œä¾èµ–åˆ†ç¦»" tabindex="-1"><a class="header-anchor" href="#ä½¿ç”¨kubernetes-podè¿ç®—ç¬¦è¿›è¡Œä¾èµ–åˆ†ç¦»"><span>ä½¿ç”¨Kubernetes Podè¿ç®—ç¬¦è¿›è¡Œä¾èµ–åˆ†ç¦»</span></a></h4><p>å¦‚æœæ‚¨çš„Airflowå·¥ä½œäººå‘˜å¯ä»¥è®¿é—®Kubernetesï¼Œé‚£ä¹ˆæ‚¨å¯ä»¥ä½¿ç”¨KubernetsPodOperatorå¹¶æ·»åŠ ä»»ä½•æ‰€éœ€çš„å‚æ•°æ¥æ­£ç¡®è¿è¡Œä»»åŠ¡ã€‚</p><div class="language-python line-numbers-mode" data-ext="py" data-title="py"><pre class="language-python"><code><span class="token decorator annotation punctuation">@task<span class="token punctuation">.</span>kubernetes</span><span class="token punctuation">(</span>
    image<span class="token operator">=</span><span class="token string">&quot;python:3.8-slim-buster&quot;</span><span class="token punctuation">,</span>
    name<span class="token operator">=</span><span class="token string">&quot;k8s_test&quot;</span><span class="token punctuation">,</span>
    namespace<span class="token operator">=</span><span class="token string">&quot;default&quot;</span><span class="token punctuation">,</span>
    in_cluster<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span>
    config_file<span class="token operator">=</span><span class="token string">&quot;/path/to/.kube/config&quot;</span><span class="token punctuation">,</span>
<span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">execute_in_k8s_pod</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">import</span> time

    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;Hello from k8s pod&quot;</span><span class="token punctuation">)</span>
    time<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>

<span class="token decorator annotation punctuation">@task<span class="token punctuation">.</span>kubernetes</span><span class="token punctuation">(</span>image<span class="token operator">=</span><span class="token string">&quot;python:3.8-slim-buster&quot;</span><span class="token punctuation">,</span> namespace<span class="token operator">=</span><span class="token string">&quot;default&quot;</span><span class="token punctuation">,</span> in_cluster<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">print_pattern</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    n <span class="token operator">=</span> <span class="token number">5</span>
    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> n<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token comment"># inner loop to handle number of columns</span>
        <span class="token comment"># values changing acc. to outer loop</span>
        <span class="token keyword">for</span> j <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token comment"># printing stars</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;* &quot;</span><span class="token punctuation">,</span> end<span class="token operator">=</span><span class="token string">&quot;&quot;</span><span class="token punctuation">)</span>

        <span class="token comment"># ending line after each row</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;\r&quot;</span><span class="token punctuation">)</span>

execute_in_k8s_pod_instance <span class="token operator">=</span> execute_in_k8s_pod<span class="token punctuation">(</span><span class="token punctuation">)</span>
print_pattern_instance <span class="token operator">=</span> print_pattern<span class="token punctuation">(</span><span class="token punctuation">)</span>

execute_in_k8s_pod_instance <span class="token operator">&gt;&gt;</span> print_pattern_instance
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="ä¸ä¼ æ„Ÿå™¨-sensor-æ“ä½œç¬¦ä¸€èµ·ä½¿ç”¨taskflow-api" tabindex="-1"><a class="header-anchor" href="#ä¸ä¼ æ„Ÿå™¨-sensor-æ“ä½œç¬¦ä¸€èµ·ä½¿ç”¨taskflow-api"><span>ä¸ä¼ æ„Ÿå™¨ï¼ˆSensor ï¼‰æ“ä½œç¬¦ä¸€èµ·ä½¿ç”¨TaskFlow API</span></a></h3><p>æ‚¨å¯ä»¥åº”ç”¨@task.sensor decoratorå°†å¸¸è§„Pythonå‡½æ•°è½¬æ¢ä¸ºBaseSensorOperatorç±»çš„å®ä¾‹ã€‚Pythonå‡½æ•°å®ç°pokeé€»è¾‘ï¼Œå¹¶åƒBaseSensorOperatorä¸­çš„pokeï¼ˆï¼‰æ–¹æ³•é‚£æ ·è¿”å›PokeReturnValueç±»çš„å®ä¾‹ã€‚åœ¨Airflow 2.3ä¸­ï¼Œä¼ æ„Ÿå™¨æ“ä½œå‘˜å°†èƒ½å¤Ÿè¿”å›XCOMå€¼ã€‚è¿™æ˜¯é€šè¿‡åœ¨pokeï¼ˆï¼‰æ–¹æ³•çš„æœ«å°¾è¿”å›PokeReturnValueå¯¹è±¡çš„å®ä¾‹æ¥å®ç°çš„ï¼š</p><div class="language-python line-numbers-mode" data-ext="py" data-title="py"><pre class="language-python"><code><span class="token keyword">from</span> airflow<span class="token punctuation">.</span>sensors<span class="token punctuation">.</span>base <span class="token keyword">import</span> PokeReturnValue


<span class="token keyword">class</span> <span class="token class-name">SensorWithXcomValue</span><span class="token punctuation">(</span>BaseSensorOperator<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">poke</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> context<span class="token punctuation">:</span> Context<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> Union<span class="token punctuation">[</span><span class="token builtin">bool</span><span class="token punctuation">,</span> PokeReturnValue<span class="token punctuation">]</span><span class="token punctuation">:</span>
        <span class="token comment"># ...</span>
        is_done <span class="token operator">=</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>  <span class="token comment"># set to true if the sensor should stop poking.</span>
        xcom_value <span class="token operator">=</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>  <span class="token comment"># return value of the sensor operator to be pushed to XCOM.</span>
        <span class="token keyword">return</span> PokeReturnValue<span class="token punctuation">(</span>is_done<span class="token punctuation">,</span> xcom_value<span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="å¤šè¾“å‡ºæ¨ç†" tabindex="-1"><a class="header-anchor" href="#å¤šè¾“å‡ºæ¨ç†"><span>å¤šè¾“å‡ºæ¨ç†</span></a></h3><p>ä»»åŠ¡è¿˜å¯ä»¥é€šè¿‡ä½¿ç”¨ dict Pythonç±»å‹æ¥æ¨æ–­å¤šä¸ªè¾“å‡ºã€‚</p><div class="language-python line-numbers-mode" data-ext="py" data-title="py"><pre class="language-python"><code><span class="token decorator annotation punctuation">@task</span>
<span class="token keyword">def</span> <span class="token function">identity_dict</span><span class="token punctuation">(</span>x<span class="token punctuation">:</span> <span class="token builtin">int</span><span class="token punctuation">,</span> y<span class="token punctuation">:</span> <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token builtin">dict</span><span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">,</span> <span class="token builtin">int</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
    <span class="token keyword">return</span> <span class="token punctuation">{</span><span class="token string">&quot;x&quot;</span><span class="token punctuation">:</span> x<span class="token punctuation">,</span> <span class="token string">&quot;y&quot;</span><span class="token punctuation">:</span> y<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>é€šè¿‡å¯¹å‡½æ•°è¿”å›ç±»å‹ä½¿ç”¨é”®å…¥Dictï¼Œmultiple_outputså‚æ•°å°†è‡ªåŠ¨è®¾ç½®ä¸ºtrueã€‚</p><blockquote><p>æ³¨æ„ï¼Œå¦‚æœæ‰‹åŠ¨è®¾ç½®multiple_outputså‚æ•°ï¼Œåˆ™ä¼šç¦ç”¨æ¨ç†å¹¶ä½¿ç”¨å‚æ•°å€¼ã€‚</p></blockquote><h3 id="æ·»åŠ è£…é¥°ä»»åŠ¡å’Œä¼ ç»Ÿä»»åŠ¡ä¹‹é—´çš„ä¾èµ–å…³ç³»" tabindex="-1"><a class="header-anchor" href="#æ·»åŠ è£…é¥°ä»»åŠ¡å’Œä¼ ç»Ÿä»»åŠ¡ä¹‹é—´çš„ä¾èµ–å…³ç³»"><span>æ·»åŠ è£…é¥°ä»»åŠ¡å’Œä¼ ç»Ÿä»»åŠ¡ä¹‹é—´çš„ä¾èµ–å…³ç³»</span></a></h3><p>ä¸Šé¢çš„æ•™ç¨‹å±•ç¤ºäº†å¦‚ä½•åœ¨TaskFlowå‡½æ•°ä¹‹é—´åˆ›å»ºä¾èµ–å…³ç³»ã€‚ä½†æ˜¯ï¼Œä¹Ÿå¯ä»¥åœ¨ä¼ ç»Ÿä»»åŠ¡ï¼ˆå¦‚BashOperatoræˆ–FileSensorï¼‰å’ŒTaskFlowå‡½æ•°ä¹‹é—´è®¾ç½®ä¾èµ–å…³ç³»ã€‚</p><div class="language-python line-numbers-mode" data-ext="py" data-title="py"><pre class="language-python"><code><span class="token decorator annotation punctuation">@task</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">extract_from_file</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">&quot;&quot;&quot;
    #### Extract from file task
    A simple Extract task to get data ready for the rest of the data
    pipeline, by reading the data from a file into a pandas dataframe
    &quot;&quot;&quot;</span>
    order_data_file <span class="token operator">=</span> <span class="token string">&quot;/tmp/order_data.csv&quot;</span>
    order_data_df <span class="token operator">=</span> pd<span class="token punctuation">.</span>read_csv<span class="token punctuation">(</span>order_data_file<span class="token punctuation">)</span>


file_task <span class="token operator">=</span> FileSensor<span class="token punctuation">(</span>task_id<span class="token operator">=</span><span class="token string">&quot;check_file&quot;</span><span class="token punctuation">,</span> filepath<span class="token operator">=</span><span class="token string">&quot;/tmp/order_data.csv&quot;</span><span class="token punctuation">)</span>
order_data <span class="token operator">=</span> extract_from_file<span class="token punctuation">(</span><span class="token punctuation">)</span>

file_task <span class="token operator">&gt;&gt;</span> order_data
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>åœ¨ä¸Šé¢çš„ä»£ç å—ä¸­ï¼Œä¸€ä¸ªæ–°çš„TaskFlowå‡½æ•°è¢«å®šä¹‰ä¸ºextract_from_fileï¼Œå®ƒä»å·²çŸ¥çš„æ–‡ä»¶ä½ç½®è¯»å–æ•°æ®ã€‚åœ¨ä¸»DAGä¸­ï¼Œå®šä¹‰äº†ä¸€ä¸ªæ–°çš„FileSensorä»»åŠ¡æ¥æ£€æŸ¥è¯¥æ–‡ä»¶ã€‚è¯·æ³¨æ„ï¼Œè¿™æ˜¯ä¸€ä¸ªç­‰å¾…æ–‡ä»¶çš„ä¼ æ„Ÿå™¨ä»»åŠ¡ã€‚æœ€åï¼ŒæŒ‡å®šäº†æ­¤Sensorä»»åŠ¡å’ŒTaskFlowå‡½æ•°ä¹‹é—´çš„ä¾èµ–å…³ç³»ã€‚</p><h3 id="åœ¨è£…é¥°å’Œä¼ ç»Ÿä»»åŠ¡ä¹‹é—´æ¶ˆè´¹xcoms" tabindex="-1"><a class="header-anchor" href="#åœ¨è£…é¥°å’Œä¼ ç»Ÿä»»åŠ¡ä¹‹é—´æ¶ˆè´¹xcoms"><span>åœ¨è£…é¥°å’Œä¼ ç»Ÿä»»åŠ¡ä¹‹é—´æ¶ˆè´¹XComs</span></a></h3><h3 id="è®¿é—®è£…é¥°ä»»åŠ¡ä¸­çš„ä¸Šä¸‹æ–‡å˜é‡" tabindex="-1"><a class="header-anchor" href="#è®¿é—®è£…é¥°ä»»åŠ¡ä¸­çš„ä¸Šä¸‹æ–‡å˜é‡"><span>è®¿é—®è£…é¥°ä»»åŠ¡ä¸­çš„ä¸Šä¸‹æ–‡å˜é‡</span></a></h3><p>å½“è¿è¡Œå¯è°ƒç”¨ç¨‹åºæ—¶ï¼ŒAirflowå°†ä¼ é€’ä¸€ç»„å¯åœ¨å‡½æ•°ä¸­ä½¿ç”¨çš„å…³é”®å­—å‚æ•°ã€‚è¿™ç»„kwargä¸æ‚¨å¯ä»¥åœ¨Jinjaæ¨¡æ¿ä¸­ä½¿ç”¨çš„å†…å®¹å®Œå…¨å¯¹åº”ã€‚ä¸ºäº†å®ç°è¿™ä¸€ç‚¹ï¼Œæ‚¨éœ€è¦åœ¨å‡½æ•°å¤´ä¸­å®šä¹‰**kwargsï¼Œæˆ–è€…æ‚¨å¯ä»¥ç›´æ¥æ·»åŠ æƒ³è¦è·å¾—çš„å…³é”®å­—å‚æ•°â€”â€”ä¾‹å¦‚ï¼Œä½¿ç”¨ä¸‹é¢çš„ä»£ç ï¼Œæ‚¨çš„å¯è°ƒç”¨å¯¹è±¡å°†è·å¾—tiå’Œnext_dsä¸Šä¸‹æ–‡å˜é‡çš„å€¼ã€‚è¯·æ³¨æ„ï¼Œå½“ä½¿ç”¨æ˜¾å¼å…³é”®å­—å‚æ•°æ—¶ï¼Œå¿…é¡»åœ¨å‡½æ•°å¤´ä¸­å°†å…¶è®¾ä¸ºå¯é€‰å‚æ•°ï¼Œä»¥é¿å…åœ¨DAGè§£æè¿‡ç¨‹ä¸­å‡ºç°TypeErrorå¼‚å¸¸ï¼Œå› ä¸ºè¿™äº›å€¼åœ¨ä»»åŠ¡æ‰§è¡Œä¹‹å‰ä¸å¯ç”¨ã€‚</p><p>ä½¿ç”¨æ˜ç¡®çš„å‚æ•°ï¼š</p><div class="language-python line-numbers-mode" data-ext="py" data-title="py"><pre class="language-python"><code><span class="token decorator annotation punctuation">@task</span>
<span class="token keyword">def</span> <span class="token function">my_python_callable</span><span class="token punctuation">(</span>ti<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> next_ds<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">pass</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ä½¿ç”¨kwargsï¼š</p><div class="language-python line-numbers-mode" data-ext="py" data-title="py"><pre class="language-python"><code><span class="token decorator annotation punctuation">@task</span>
<span class="token keyword">def</span> <span class="token function">my_python_callable</span><span class="token punctuation">(</span><span class="token operator">**</span>kwargs<span class="token punctuation">)</span><span class="token punctuation">:</span>
    ti <span class="token operator">=</span> kwargs<span class="token punctuation">[</span><span class="token string">&quot;ti&quot;</span><span class="token punctuation">]</span>
    next_ds <span class="token operator">=</span> kwargs<span class="token punctuation">[</span><span class="token string">&quot;next_ds&quot;</span><span class="token punctuation">]</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>æ­¤å¤–ï¼Œæœ‰æ—¶æ‚¨å¯èƒ½å¸Œæœ›è®¿é—®å †æ ˆæ·±å¤„çš„æŸä¸ªä¸Šä¸‹æ–‡ï¼Œä½†ä¸å¸Œæœ›ä¼ é€’å¯è°ƒç”¨ä»»åŠ¡ä¸­çš„ä¸Šä¸‹æ–‡å˜é‡ã€‚æ‚¨ä»ç„¶å¯ä»¥é€šè¿‡get_current_contextæ–¹æ³•è®¿é—®æ‰§è¡Œä¸Šä¸‹æ–‡ã€‚</p><div class="language-python line-numbers-mode" data-ext="py" data-title="py"><pre class="language-python"><code><span class="token keyword">from</span> airflow<span class="token punctuation">.</span>operators<span class="token punctuation">.</span>python <span class="token keyword">import</span> get_current_context


<span class="token keyword">def</span> <span class="token function">some_function_in_your_library</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    context <span class="token operator">=</span> get_current_context<span class="token punctuation">(</span><span class="token punctuation">)</span>
    ti <span class="token operator">=</span> context<span class="token punctuation">[</span><span class="token string">&quot;ti&quot;</span><span class="token punctuation">]</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>å½“å‰ä¸Šä¸‹æ–‡åªèƒ½åœ¨ä»»åŠ¡æ‰§è¡ŒæœŸé—´è®¿é—®ã€‚åœ¨æ‰§è¡Œå‰æˆ–æ‰§è¡Œåï¼Œä¸Šä¸‹æ–‡ä¸å¯è®¿é—®ã€‚åœ¨æ‰§è¡Œä¸Šä¸‹æ–‡ä¹‹å¤–è°ƒç”¨æ­¤æ–¹æ³•å°†å¼•å‘é”™è¯¯ã€‚</p><h1 id="æ„å»ºpip" tabindex="-1"><a class="header-anchor" href="#æ„å»ºpip"><span>æ„å»ºpip</span></a></h1><p>è®©æˆ‘ä»¬çœ‹å¦ä¸€ä¸ªä¾‹å­ï¼šæˆ‘ä»¬éœ€è¦ä»åœ¨çº¿æ‰˜ç®¡çš„æ–‡ä»¶ä¸­è·å–ä¸€äº›æ•°æ®ï¼Œå¹¶å°†å…¶æ’å…¥æœ¬åœ°æ•°æ®åº“ã€‚æˆ‘ä»¬è¿˜éœ€è¦è€ƒè™‘åœ¨æ’å…¥æ—¶åˆ é™¤é‡å¤çš„è¡Œã€‚</p><h2 id="åˆå§‹è®¾ç½®" tabindex="-1"><a class="header-anchor" href="#åˆå§‹è®¾ç½®"><span>åˆå§‹è®¾ç½®</span></a></h2><p>æˆ‘ä»¬éœ€è¦å®‰è£…Dockerï¼š</p><div class="language-bash line-numbers-mode" data-ext="sh" data-title="sh"><pre class="language-bash"><code><span class="token comment"># Download the docker-compose.yaml file</span>
<span class="token function">curl</span> <span class="token parameter variable">-LfO</span> <span class="token string">&#39;https://airflow.apache.org/docs/apache-airflow/stable/docker-compose.yaml&#39;</span>

<span class="token comment"># Make expected directories and set an expected environment variable</span>
<span class="token function">mkdir</span> <span class="token parameter variable">-p</span> ./dags ./logs ./plugins
<span class="token builtin class-name">echo</span> <span class="token parameter variable">-e</span> <span class="token string">&quot;AIRFLOW_UID=<span class="token variable"><span class="token variable">$(</span><span class="token function">id</span> <span class="token parameter variable">-u</span><span class="token variable">)</span></span>&quot;</span> <span class="token operator">&gt;</span> .env

<span class="token comment"># Initialize the database</span>
<span class="token function">docker-compose</span> up airflow-init

<span class="token comment"># Start up all services</span>
<span class="token function">docker-compose</span> up
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>æ‰€æœ‰æœåŠ¡å¯åŠ¨åï¼Œweb UIå°†åœ¨ä»¥ä¸‹ä½ç½®å¯ç”¨ï¼šhttp://localhost:8080.é»˜è®¤å¸æˆ·å…·æœ‰ç”¨æˆ·åairflowå’Œå¯†ç airflowã€‚</p><p>æˆ‘ä»¬è¿˜éœ€è¦åˆ›å»ºä¸€ä¸ªåˆ°postgresdbçš„è¿æ¥ã€‚è¦é€šè¿‡web UIåˆ›å»ºä¸€ä¸ªï¼Œè¯·ä»â€œAdminâ€èœå•ä¸­é€‰æ‹©â€œConnectionsâ€ï¼Œç„¶åå•å‡»åŠ å·å°†<code>Add a new record</code> æ·»åŠ åˆ°è¿æ¥åˆ—è¡¨ä¸­ã€‚</p><p>å¡«å†™å¦‚ä¸‹æ‰€ç¤ºçš„å­—æ®µã€‚è¯·æ³¨æ„Connection Idå€¼ï¼Œæˆ‘ä»¬å°†æŠŠå®ƒä½œä¸ºpostgres_conn_Id kwargçš„å‚æ•°ä¼ é€’:</p><ul><li>Connection Id: tutorial_pg_conn</li><li>Connection Type: postgres</li><li>Host: postgres</li><li>Schema: airflow</li><li>Login: airflow</li><li>Password: airflow</li><li>Port: 5432</li></ul><h1 id="æ¶æ„" tabindex="-1"><a class="header-anchor" href="#æ¶æ„"><span>æ¶æ„</span></a></h1><p>Airflowæ˜¯ä¸€ä¸ªå…è®¸æ‚¨æ„å»ºå’Œè¿è¡Œå·¥ä½œæµçš„å¹³å°ã€‚å·¥ä½œæµè¢«è¡¨ç¤ºä¸ºDAGï¼ˆæœ‰å‘æ— å¾ªç¯å›¾ï¼‰ï¼ŒåŒ…å«ç§°ä¸ºä»»åŠ¡çš„å•ç‹¬å•å…ƒï¼Œå¹¶è€ƒè™‘äº†ä»»åŠ¡çš„ä¾èµ–å…³ç³»å’Œæ•°æ®æµã€‚</p><figure><img src="/assets/edge_label_example-BqdSRJr2.png" alt="An example Airflow DAG, rendered in Graph" tabindex="0" loading="lazy"><figcaption>An example Airflow DAG, rendered in Graph</figcaption></figure><p>DAGæŒ‡å®šä»»åŠ¡ä¹‹é—´çš„ä¾èµ–å…³ç³»ï¼Œä»¥åŠæ‰§è¡Œä»»åŠ¡å’Œè¿è¡Œé‡è¯•çš„é¡ºåºï¼›ä»»åŠ¡æœ¬èº«æè¿°äº†è¦åšä»€ä¹ˆï¼Œä¾‹å¦‚è·å–æ•°æ®ã€è¿è¡Œåˆ†æã€è§¦å‘å…¶ä»–ç³»ç»Ÿ ç­‰ç­‰ã€‚</p><p>Airflowé€šå¸¸ç”±ä»¥ä¸‹éƒ¨ä»¶ç»„æˆï¼š</p><ul><li>è°ƒåº¦ç¨‹åºï¼ˆ<a href="https://airflow.apache.org/docs/apache-airflow/stable/administration-and-deployment/scheduler.html" target="_blank" rel="noopener noreferrer">scheduler<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a>ï¼‰ï¼Œè§¦å‘ä»»åŠ¡ï¼Œå¹¶å°†ä»»åŠ¡æäº¤ç»™æ‰§è¡Œå™¨ã€‚</li><li>æ‰§è¡Œå™¨ï¼ˆ<a href="https://airflow.apache.org/docs/apache-airflow/stable/core-concepts/executor/index.html" target="_blank" rel="noopener noreferrer">executor<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a>ï¼‰ï¼Œè¿è¡Œä»»åŠ¡ã€‚</li><li>WebæœåŠ¡å™¨ï¼Œå®ƒæä¾›äº†ä¸€ä¸ªæ–¹ä¾¿çš„ç”¨æˆ·ç•Œé¢æ¥æ£€æŸ¥ã€è§¦å‘å’Œè°ƒè¯•DAGå’Œä»»åŠ¡çš„è¡Œä¸ºã€‚</li><li>DAGæ–‡ä»¶çš„æ–‡ä»¶å¤¹ï¼Œç”±è°ƒåº¦ç¨‹åºå’Œæ‰§è¡Œç¨‹åºï¼ˆä»¥åŠæ‰§è¡Œç¨‹åºæ‹¥æœ‰çš„ä»»ä½•å·¥ä½œè€…ï¼‰è¯»å–</li><li>ä¸€ä¸ªå…ƒæ•°æ®æ•°æ®åº“ï¼Œç”±è°ƒåº¦å™¨ã€æ‰§è¡Œå™¨å’ŒWebæœåŠ¡å™¨ç”¨æ¥å­˜å‚¨çŠ¶æ€ã€‚</li></ul><figure><img src="/assets/arch-diag-basic-CV2siP8f.png" alt="../_images/arch-diag-basic.png" tabindex="0" loading="lazy"><figcaption>../_images/arch-diag-basic.png</figcaption></figure><p>å¤§å¤šæ•°æ‰§è¡Œå™¨é€šå¸¸è¿˜ä¼šå¼•å…¥å…¶ä»–ç»„ä»¶ï¼Œè®©ä»–ä»¬ä¸å·¥ä½œäººå‘˜äº¤è°ˆï¼Œæ¯”å¦‚ä»»åŠ¡é˜Ÿåˆ—ã€‚</p><h2 id="å·¥ä½œè´Ÿè½½" tabindex="-1"><a class="header-anchor" href="#å·¥ä½œè´Ÿè½½"><span>å·¥ä½œè´Ÿè½½</span></a></h2><p>DAGè¿è¡Œä¸€ç³»åˆ—ä»»åŠ¡ï¼Œæ‚¨å°†çœ‹åˆ°ä¸‰ç§å¸¸è§ç±»å‹çš„ä»»åŠ¡ï¼š</p><ul><li>æ“ä½œç¬¦ï¼ˆ<a href="https://airflow.apache.org/docs/apache-airflow/stable/core-concepts/operators.html" target="_blank" rel="noopener noreferrer">Operators<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a>ï¼‰ï¼Œé¢„å®šä¹‰çš„ä»»åŠ¡ï¼Œæ‚¨å¯ä»¥å¿«é€Ÿä¸²åœ¨ä¸€èµ·æ„å»ºDAGçš„å¤§éƒ¨åˆ†ã€‚</li><li>ä¼ æ„Ÿå™¨ï¼ˆ<a href="https://airflow.apache.org/docs/apache-airflow/stable/core-concepts/sensors.html" target="_blank" rel="noopener noreferrer">Sensors<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a>ï¼‰ï¼Œæ“ä½œç¬¦çš„ä¸€ä¸ªç‰¹æ®Šå­ç±»ï¼Œå®Œå…¨æ˜¯ä¸ºäº†ç­‰å¾…å¤–éƒ¨äº‹ä»¶å‘ç”Ÿã€‚</li><li>TaskFlow @taskï¼Œå°†è‡ªå®šä¹‰Pythonå‡½æ•°åŒ…è£…æˆtaskã€‚</li></ul><p>åœ¨å†…éƒ¨ï¼Œè¿™äº›å®é™…ä¸Šéƒ½æ˜¯Airflowçš„BaseOperatorçš„å­ç±»ï¼ŒTaskå’ŒOperatorçš„æ¦‚å¿µåœ¨æŸç§ç¨‹åº¦ä¸Šæ˜¯å¯äº’æ¢çš„ï¼Œä½†å°†å®ƒä»¬è§†ä¸ºå•ç‹¬çš„æ¦‚å¿µæ˜¯æœ‰ç”¨çš„â€”â€”æœ¬è´¨ä¸Šï¼ŒOperatorså’ŒSensorsæ˜¯æ¨¡æ¿ï¼Œå½“ä½ åœ¨DAGæ–‡ä»¶ä¸­è°ƒç”¨ä¸€ä¸ªæ¨¡æ¿æ—¶ï¼Œå°±ç”Ÿæˆäº†Taskã€‚</p><h2 id="æ§åˆ¶æµç¨‹" tabindex="-1"><a class="header-anchor" href="#æ§åˆ¶æµç¨‹"><span>æ§åˆ¶æµç¨‹</span></a></h2><p>DAGè¢«è®¾è®¡ä¸ºå¤šæ¬¡è¿è¡Œï¼Œå¹¶ä¸”å®ƒä»¬çš„å¤šæ¬¡è¿è¡Œå¯ä»¥å¹¶è¡Œè¿›è¡Œã€‚DAGæ˜¯å‚æ•°åŒ–çš„ï¼Œæ€»æ˜¯åŒ…æ‹¬å®ƒä»¬<strong>è¿è¡Œçš„é—´éš”</strong>ï¼ˆæ•°æ®é—´éš”ï¼‰ï¼Œä½†ä¹Ÿæœ‰å…¶ä»–å¯é€‰å‚æ•°ã€‚</p><p>ä»»åŠ¡ä¹‹é—´æœ‰å£°æ˜çš„ä¾èµ–å…³ç³»:</p><div class="language-bash line-numbers-mode" data-ext="sh" data-title="sh"><pre class="language-bash"><code>first_task <span class="token operator">&gt;&gt;</span> <span class="token punctuation">[</span>second_task, third_task<span class="token punctuation">]</span>
fourth_task <span class="token operator">&lt;&lt;</span> third_task
first_task.set_downstream<span class="token punctuation">(</span><span class="token punctuation">[</span>second_task, third_task<span class="token punctuation">]</span><span class="token punctuation">)</span>
fourth_task.set_upstream<span class="token punctuation">(</span>third_task<span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>è¿™äº›ä¾èµ–å…³ç³»æ„æˆäº†å›¾å½¢çš„<strong>è¾¹</strong>ï¼Œä»¥åŠAirflowå¦‚ä½•ç¡®å®šä»»åŠ¡çš„è¿è¡Œé¡ºåºã€‚é»˜è®¤æƒ…å†µä¸‹ï¼Œä»»åŠ¡å°†ç­‰å¾…æ‰€æœ‰ä¸Šæ¸¸ä»»åŠ¡æˆåŠŸåæ‰èƒ½è¿è¡Œï¼Œä½†è¿™å¯ä»¥ä½¿ç”¨<code>Branching</code>ã€<code>LatestOnly</code>å’Œ<code>Trigger Rules</code>ç­‰åŠŸèƒ½è¿›è¡Œè‡ªå®šä¹‰ã€‚</p><p>è¦åœ¨ä»»åŠ¡ä¹‹é—´ä¼ é€’æ•°æ®ï¼Œæ‚¨æœ‰ä¸‰ä¸ªé€‰é¡¹ï¼š</p><ul><li>XComsï¼ˆäº¤å‰é€šä¿¡ï¼‰ï¼Œä¸€ä¸ªå¯ä»¥è®©ä»»åŠ¡æ¨é€å’Œæå–å°‘é‡å…ƒæ•°æ®çš„ç³»ç»Ÿã€‚</li><li>ä»å­˜å‚¨æœåŠ¡ï¼ˆæ‚¨è¿è¡Œçš„å­˜å‚¨æœåŠ¡æˆ–å…¬å…±äº‘çš„ä¸€éƒ¨åˆ†ï¼‰ä¸Šä¼ å’Œä¸‹è½½å¤§æ–‡ä»¶</li><li>TaskFlow APIé€šè¿‡éšå¼XComsåœ¨ä»»åŠ¡ä¹‹é—´è‡ªåŠ¨ä¼ é€’æ•°æ®</li></ul><p>å½“ç©ºé—´å¯ç”¨æ—¶ï¼ŒAirflowä¼šå‘é€ä»»åŠ¡åœ¨Workersä¸Šè¿è¡Œï¼Œå› æ­¤æ— æ³•ä¿è¯DAGä¸­çš„æ‰€æœ‰ä»»åŠ¡éƒ½ä¼šåœ¨åŒä¸€ä¸ªworkeræˆ–åŒä¸€å°æœºå™¨ä¸Šè¿è¡Œã€‚</p><p>å½“ä½ æ„å»ºDAGæ—¶ï¼Œå®ƒä»¬å¯èƒ½ä¼šå˜å¾—éå¸¸å¤æ‚ï¼Œå› æ­¤Airflowæä¾›äº†å‡ ç§æœºåˆ¶æ¥ä½¿å…¶æ›´å…·å¯ç”¨æ€§â€”â€”SubDAGå¯ä»¥è®©ä½ åˆ¶ä½œ<strong>å¯é‡å¤ä½¿ç”¨çš„DAG</strong>ï¼Œä½ å¯ä»¥åµŒå…¥å…¶ä»–DAGä¸­ï¼Œè€ŒTaskGroupså¯ä»¥è®©ä½ åœ¨UIä¸­<strong>å¯¹ä»»åŠ¡è¿›è¡Œå¯è§†åŒ–åˆ†ç»„</strong>ã€‚</p><p>è¿˜æœ‰ä¸€äº›åŠŸèƒ½å¯ä»¥è®©æ‚¨ä»¥Connections&amp;Hooksçš„å½¢å¼è½»æ¾åœ°é¢„é…ç½®å¯¹ä¸­å¤®èµ„æºï¼ˆå¦‚æ•°æ®å­˜å‚¨ï¼‰çš„è®¿é—®ï¼Œä¹Ÿå¯ä»¥é€šè¿‡Poolsé™åˆ¶å¹¶å‘æ€§ã€‚</p><h2 id="ç”¨æˆ·ç•Œé¢" tabindex="-1"><a class="header-anchor" href="#ç”¨æˆ·ç•Œé¢"><span>ç”¨æˆ·ç•Œé¢</span></a></h2><p>Airflowæä¾›äº†ä¸€ä¸ªç”¨æˆ·ç•Œé¢ï¼Œå¯ä»¥è®©æ‚¨æŸ¥çœ‹DAGåŠå…¶ä»»åŠ¡æ­£åœ¨åšä»€ä¹ˆï¼Œè§¦å‘DAGçš„è¿è¡Œï¼ŒæŸ¥çœ‹æ—¥å¿—ï¼Œå¹¶å¯¹DAGçš„é—®é¢˜è¿›è¡Œä¸€äº›æœ‰é™çš„è°ƒè¯•å’Œè§£å†³ã€‚</p><figure><img src="/assets/dags-DKbC27lc.png" alt="../_images/dags.png" tabindex="0" loading="lazy"><figcaption>../_images/dags.png</figcaption></figure><h1 id="dag" tabindex="-1"><a class="header-anchor" href="#dag"><span>DAG</span></a></h1><p>DAGï¼ˆæœ‰å‘æ— å¾ªç¯å›¾ï¼‰æ˜¯Airflowçš„æ ¸å¿ƒæ¦‚å¿µï¼Œå®ƒå°†ä»»åŠ¡ç»„ç»‡åœ¨ä¸€èµ·ï¼Œç”¨ä¾èµ–å…³ç³»è¿›è¡Œç»„ç»‡ï¼Œä»¥è¯´æ˜å®ƒä»¬åº”è¯¥å¦‚ä½•è¿è¡Œã€‚</p><figure><img src="/assets/basic-dag-CmyNim0B.png" alt="../_images/basic-dag.png" tabindex="0" loading="lazy"><figcaption>../_images/basic-dag.png</figcaption></figure><p>å®ƒå®šä¹‰äº†å››ä¸ªä»»åŠ¡â€”â€”Aã€Bã€Cå’ŒDâ€”â€”å¹¶è§„å®šäº†å®ƒä»¬å¿…é¡»è¿è¡Œçš„é¡ºåºï¼Œä»¥åŠä¾èµ–å…³ç³»ã€‚å®ƒè¿˜å°†è¯´æ˜DAGçš„è¿è¡Œé¢‘ç‡â€”â€”å¯èƒ½æ˜¯<code>ä»æ˜å¤©å¼€å§‹æ¯5åˆ†é’Ÿ</code>ï¼Œä¹Ÿå¯èƒ½æ˜¯<code>è‡ª2020å¹´1æœˆ1æ—¥èµ·æ¯å¤©</code>ã€‚</p><blockquote><p>DAGæœ¬èº«å¹¶ä¸å…³å¿ƒä»»åŠ¡å†…éƒ¨å‘ç”Ÿçš„äº‹æƒ…ï¼›å®ƒåªå…³å¿ƒå¦‚ä½•æ‰§è¡Œå®ƒä»¬â€”â€”è¿è¡Œå®ƒä»¬çš„é¡ºåºã€é‡è¯•æ¬¡æ•°ã€æ˜¯å¦è¶…æ—¶ç­‰ç­‰ã€‚</p></blockquote><h2 id="å£°æ˜dag" tabindex="-1"><a class="header-anchor" href="#å£°æ˜dag"><span>å£°æ˜DAG</span></a></h2><p>æœ‰ä¸‰ç§æ–¹æ³•å¯ä»¥å£°æ˜DAG:</p><ol><li><p>æ‚¨å¯ä»¥ä½¿ç”¨ä¸Šä¸‹æ–‡ç®¡ç†å™¨ï¼Œå®ƒå°†å…¶ä¸­çš„ä»»ä½•å†…å®¹éšå¼æ·»åŠ åˆ°DAGï¼š</p><div class="language-python line-numbers-mode" data-ext="py" data-title="py"><pre class="language-python"><code> <span class="token keyword">import</span> datetime

 <span class="token keyword">from</span> airflow <span class="token keyword">import</span> DAG
 <span class="token keyword">from</span> airflow<span class="token punctuation">.</span>operators<span class="token punctuation">.</span>empty <span class="token keyword">import</span> EmptyOperator

 <span class="token keyword">with</span> DAG<span class="token punctuation">(</span>
     dag_id<span class="token operator">=</span><span class="token string">&quot;my_dag_name&quot;</span><span class="token punctuation">,</span>
     start_date<span class="token operator">=</span>datetime<span class="token punctuation">.</span>datetime<span class="token punctuation">(</span><span class="token number">2021</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
     schedule<span class="token operator">=</span><span class="token string">&quot;@daily&quot;</span><span class="token punctuation">,</span>
 <span class="token punctuation">)</span><span class="token punctuation">:</span>
     EmptyOperator<span class="token punctuation">(</span>task_id<span class="token operator">=</span><span class="token string">&quot;task&quot;</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li><li><p>ä½¿ç”¨æ ‡å‡†æ„é€ å‡½æ•°ï¼Œå°†DAGä¼ é€’ç»™æ‚¨ä½¿ç”¨çš„ä»»ä½•è¿ç®—ç¬¦ï¼š</p><div class="language-python line-numbers-mode" data-ext="py" data-title="py"><pre class="language-python"><code> <span class="token keyword">import</span> datetime

 <span class="token keyword">from</span> airflow <span class="token keyword">import</span> DAG
 <span class="token keyword">from</span> airflow<span class="token punctuation">.</span>operators<span class="token punctuation">.</span>empty <span class="token keyword">import</span> EmptyOperator

 my_dag <span class="token operator">=</span> DAG<span class="token punctuation">(</span>
     dag_id<span class="token operator">=</span><span class="token string">&quot;my_dag_name&quot;</span><span class="token punctuation">,</span>
     start_date<span class="token operator">=</span>datetime<span class="token punctuation">.</span>datetime<span class="token punctuation">(</span><span class="token number">2021</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
     schedule<span class="token operator">=</span><span class="token string">&quot;@daily&quot;</span><span class="token punctuation">,</span>
 <span class="token punctuation">)</span>
 EmptyOperator<span class="token punctuation">(</span>task_id<span class="token operator">=</span><span class="token string">&quot;task&quot;</span><span class="token punctuation">,</span> dag<span class="token operator">=</span>my_dag<span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li><li><p>ä½¿ç”¨@dag decoratorå°†å‡½æ•°è½¬æ¢ä¸ºdagç”Ÿæˆå™¨ï¼š</p><div class="language-python line-numbers-mode" data-ext="py" data-title="py"><pre class="language-python"><code><span class="token keyword">import</span> datetime

<span class="token keyword">from</span> airflow<span class="token punctuation">.</span>decorators <span class="token keyword">import</span> dag
<span class="token keyword">from</span> airflow<span class="token punctuation">.</span>operators<span class="token punctuation">.</span>empty <span class="token keyword">import</span> EmptyOperator


<span class="token decorator annotation punctuation">@dag</span><span class="token punctuation">(</span>start_date<span class="token operator">=</span>datetime<span class="token punctuation">.</span>datetime<span class="token punctuation">(</span><span class="token number">2021</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> schedule<span class="token operator">=</span><span class="token string">&quot;@daily&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">generate_dag</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    EmptyOperator<span class="token punctuation">(</span>task_id<span class="token operator">=</span><span class="token string">&quot;task&quot;</span><span class="token punctuation">)</span>


generate_dag<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li></ol><p>DAGæ²¡æœ‰è¦è¿è¡Œçš„ä»»åŠ¡å°±ä»€ä¹ˆéƒ½ä¸æ˜¯ï¼Œå®ƒä»¬é€šå¸¸ä»¥Operatorsã€Sensorsæˆ–TaskFlowçš„å½¢å¼å‡ºç°ã€‚</p><h3 id="ä»»åŠ¡ä¾èµ–" tabindex="-1"><a class="header-anchor" href="#ä»»åŠ¡ä¾èµ–"><span>ä»»åŠ¡ä¾èµ–</span></a></h3><p><strong>ä»»åŠ¡/æ“ä½œç¬¦</strong> é€šå¸¸ä¸ä¼šç‹¬è‡ªç”Ÿæ´»ï¼›å®ƒä¾èµ–äºå…¶ä»–ä»»åŠ¡ï¼ˆä¸Šæ¸¸ä»»åŠ¡ï¼‰ï¼Œå…¶ä»–ä»»åŠ¡ä¾èµ–äºå®ƒï¼ˆä¸‹æ¸¸ä»»åŠ¡ï¼‰ã€‚å£°æ˜ä»»åŠ¡ä¹‹é—´çš„è¿™äº›ä¾èµ–å…³ç³»æ„æˆäº†DAGç»“æ„ï¼ˆæœ‰å‘æ— ç¯å›¾çš„è¾¹ï¼‰ã€‚</p><p>æœ‰ä¸¤ç§ä¸»è¦çš„æ–¹æ³•æ¥å£°æ˜å„ä¸ªä»»åŠ¡çš„ä¾èµ–å…³ç³»ã€‚å»ºè®®ä½¿ç”¨<code>&gt;&gt;</code>å’Œ<code>&lt;&lt;</code>è¿ç®—ç¬¦ï¼š</p><div class="language-python line-numbers-mode" data-ext="py" data-title="py"><pre class="language-python"><code>first_task <span class="token operator">&gt;&gt;</span> <span class="token punctuation">[</span>second_task<span class="token punctuation">,</span> third_task<span class="token punctuation">]</span>
third_task <span class="token operator">&lt;&lt;</span> fourth_task
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p>æˆ–è€…ï¼Œæ‚¨ä¹Ÿå¯ä»¥ä½¿ç”¨æ›´æ˜ç¡®çš„set_upstreamå’Œset_downstreamæ–¹æ³•ï¼š</p><div class="language-python line-numbers-mode" data-ext="py" data-title="py"><pre class="language-python"><code>first_task<span class="token punctuation">.</span>set_downstream<span class="token punctuation">(</span>second_task<span class="token punctuation">,</span> third_task<span class="token punctuation">)</span>
third_task<span class="token punctuation">.</span>set_upstream<span class="token punctuation">(</span>fourth_task<span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p>è¿˜æœ‰ä¸€äº›å¿«æ·æ–¹å¼å¯ä»¥å£°æ˜æ›´å¤æ‚çš„ä¾èµ–å…³ç³»ã€‚å¦‚æœä½ æƒ³è®©ä¸¤ä¸ªä»»åŠ¡åˆ—è¡¨ç›¸äº’ä¾èµ–ï¼Œä½ ä¸èƒ½ä½¿ç”¨ä¸Šé¢çš„ä»»ä½•ä¸€ç§æ–¹æ³•ï¼Œæ‰€ä»¥ä½ éœ€è¦ä½¿ç”¨<code>cross_downstream</code>ï¼š</p><div class="language-python line-numbers-mode" data-ext="py" data-title="py"><pre class="language-python"><code><span class="token keyword">from</span> airflow<span class="token punctuation">.</span>models<span class="token punctuation">.</span>baseoperator <span class="token keyword">import</span> cross_downstream

<span class="token comment"># Replaces</span>
<span class="token comment"># [op1, op2] &gt;&gt; op3</span>
<span class="token comment"># [op1, op2] &gt;&gt; op4</span>
cross_downstream<span class="token punctuation">(</span><span class="token punctuation">[</span>op1<span class="token punctuation">,</span> op2<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>op3<span class="token punctuation">,</span> op4<span class="token punctuation">]</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>å¦‚æœæ‚¨æƒ³å°†ä¾èµ–é¡¹é“¾æ¥åœ¨ä¸€èµ·ï¼Œå¯ä»¥ä½¿ç”¨chainï¼š</p><div class="language-python line-numbers-mode" data-ext="py" data-title="py"><pre class="language-python"><code><span class="token keyword">from</span> airflow<span class="token punctuation">.</span>models<span class="token punctuation">.</span>baseoperator <span class="token keyword">import</span> chain

<span class="token comment"># Replaces op1 &gt;&gt; op2 &gt;&gt; op3 &gt;&gt; op4</span>
chain<span class="token punctuation">(</span>op1<span class="token punctuation">,</span> op2<span class="token punctuation">,</span> op3<span class="token punctuation">,</span> op4<span class="token punctuation">)</span>

<span class="token comment"># You can also do it dynamically</span>
chain<span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">[</span>EmptyOperator<span class="token punctuation">(</span>task_id<span class="token operator">=</span><span class="token string">&#39;op&#39;</span> <span class="token operator">+</span> i<span class="token punctuation">)</span> <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>Chainè¿˜å¯ä»¥å¯¹ç›¸åŒå¤§å°çš„åˆ—è¡¨è¿›è¡Œæˆå¯¹ä¾èµ–ï¼ˆè¿™ä¸cross_downstreamåˆ›å»ºçš„äº¤å‰ä¾èµ–ä¸åŒï¼ï¼‰ï¼š</p><div class="language-python line-numbers-mode" data-ext="py" data-title="py"><pre class="language-python"><code><span class="token keyword">from</span> airflow<span class="token punctuation">.</span>models<span class="token punctuation">.</span>baseoperator <span class="token keyword">import</span> chain

<span class="token comment"># Replaces</span>
<span class="token comment"># op1 &gt;&gt; op2 &gt;&gt; op4 &gt;&gt; op6</span>
<span class="token comment"># op1 &gt;&gt; op3 &gt;&gt; op5 &gt;&gt; op6</span>
chain<span class="token punctuation">(</span>op1<span class="token punctuation">,</span> <span class="token punctuation">[</span>op2<span class="token punctuation">,</span> op3<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>op4<span class="token punctuation">,</span> op5<span class="token punctuation">]</span><span class="token punctuation">,</span> op6<span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="åŠ è½½dag" tabindex="-1"><a class="header-anchor" href="#åŠ è½½dag"><span>åŠ è½½DAG</span></a></h2><p>Airflowä»Pythonæºæ–‡ä»¶åŠ è½½DAGï¼Œå¹¶åœ¨å…¶é…ç½®çš„DAG_FOLDERä¸­æŸ¥æ‰¾è¿™äº›æ–‡ä»¶ã€‚</p><p>è¿™æ„å‘³ç€æ‚¨å¯ä»¥ä¸ºæ¯ä¸ªPythonæ–‡ä»¶å®šä¹‰å¤šä¸ªDAGï¼Œç”šè‡³å¯ä»¥ä½¿ç”¨å¯¼å…¥å°†ä¸€ä¸ªéå¸¸å¤æ‚çš„DAGåˆ†å¸ƒåœ¨å¤šä¸ªPythonæ–‡ä»¶ä¸­ã€‚</p><p>ä¸è¿‡ï¼Œè¯·æ³¨æ„ï¼Œå½“Airflowä»Pythonæ–‡ä»¶åŠ è½½DAGæ—¶ï¼Œå®ƒåªä¼šæ‹‰å–ä½œä¸ºDAGå®ä¾‹çš„é¡¶å±‚çš„ä»»ä½•å¯¹è±¡ã€‚ä¾‹å¦‚ï¼Œä»¥ä»¥ä¸‹DAGæ–‡ä»¶ä¸ºä¾‹ï¼š</p><div class="language-python line-numbers-mode" data-ext="py" data-title="py"><pre class="language-python"><code>dag_1 <span class="token operator">=</span> DAG<span class="token punctuation">(</span><span class="token string">&#39;this_dag_will_be_discovered&#39;</span><span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">my_function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    dag_2 <span class="token operator">=</span> DAG<span class="token punctuation">(</span><span class="token string">&#39;but_this_dag_will_not&#39;</span><span class="token punctuation">)</span>

my_function<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>å½“è®¿é—®æ–‡ä»¶æ—¶ï¼Œä¸¤ä¸ªDAGæ„é€ å‡½æ•°éƒ½ä¼šè¢«è°ƒç”¨ï¼Œä½†åªæœ‰DAG_1å¤„äºé¡¶çº§ï¼ˆåœ¨globalsï¼ˆï¼‰ä¸­ï¼‰ï¼Œå› æ­¤åªæœ‰å®ƒè¢«æ·»åŠ åˆ°Airflowä¸­ã€‚dag2æœªåŠ è½½ã€‚</p><blockquote><p>åœ¨DAG_FOLDERä¸­æœç´¢DAGæ—¶ï¼ŒAirflowåªå°†åŒ…å«å­—ç¬¦ä¸²Airflowå’ŒDAGï¼ˆä¸åŒºåˆ†å¤§å°å†™ï¼‰çš„Pythonæ–‡ä»¶è§†ä¸ºDAGã€‚è¦è€ƒè™‘æ‰€æœ‰Pythonæ–‡ä»¶ï¼Œè¯·ç¦ç”¨DAG_DISCOVERY_SAFE_MODEé…ç½®æ ‡å¿—ã€‚</p></blockquote><p>æ‚¨è¿˜å¯ä»¥åœ¨<code>DAG_FOLDER</code>æˆ–å…¶ä»»ä½•å­æ–‡ä»¶å¤¹ä¸­æä¾›.airflowignoreæ–‡ä»¶ï¼Œè¯¥æ–‡ä»¶æè¿°äº†åŠ è½½ç¨‹åºè¦å¿½ç•¥çš„æ–‡ä»¶æ¨¡å¼ã€‚å®ƒè¦†ç›–äº†å®ƒæ‰€åœ¨çš„ç›®å½•åŠå…¶ä¸‹çš„æ‰€æœ‰å­æ–‡ä»¶å¤¹ã€‚</p><p>å¦‚æœ.airflowignoreä¸èƒ½æ»¡è¶³æ‚¨çš„éœ€æ±‚ï¼Œå¹¶ä¸”æ‚¨æƒ³è¦ä¸€ç§æ›´çµæ´»çš„æ–¹å¼æ¥æ§åˆ¶æ˜¯å¦éœ€è¦ç”±Airflowè§£æpythonæ–‡ä»¶ã€‚æ‚¨å¯ä»¥é€šè¿‡åœ¨é…ç½®æ–‡ä»¶ä¸­è®¾ç½®<code>might_contain_dag_callable</code>æ¥æ’å…¥æ‚¨çš„å¯è°ƒç”¨æ–‡ä»¶ã€‚æ³¨æ„ï¼Œæ­¤å¯è°ƒç”¨é¡¹å°†æ›¿æ¢é»˜è®¤çš„Airflowå¯å‘å¼ï¼Œå³æ£€æŸ¥æ–‡ä»¶ä¸­çš„å­—ç¬¦ä¸²Airflowå’Œdagï¼ˆä¸åŒºåˆ†å¤§å°å†™ï¼‰ã€‚</p><div class="language-python line-numbers-mode" data-ext="py" data-title="py"><pre class="language-python"><code><span class="token keyword">def</span> <span class="token function">might_contain_dag</span><span class="token punctuation">(</span>file_path<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">,</span> zip_file<span class="token punctuation">:</span> zipfile<span class="token punctuation">.</span>ZipFile <span class="token operator">|</span> <span class="token boolean">None</span> <span class="token operator">=</span> <span class="token boolean">None</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token builtin">bool</span><span class="token punctuation">:</span>
    <span class="token comment"># Your logic to check if there are DAGs defined in the file_path</span>
    <span class="token comment"># Return True if the file_path needs to be parsed, otherwise False</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="è¿è¡Œdag" tabindex="-1"><a class="header-anchor" href="#è¿è¡Œdag"><span>è¿è¡ŒDAG</span></a></h2><p>DAGå°†ä»¥ä¸¤ç§æ–¹å¼ä¹‹ä¸€è¿è¡Œï¼š</p><ul><li>å½“æ‰‹åŠ¨æˆ–é€šè¿‡APIè§¦å‘å®ƒä»¬æ—¶</li><li>åœ¨å®šä¹‰çš„scheduleä¸Šï¼Œè¯¥scheduleè¢«å®šä¹‰ä¸ºDAGçš„ä¸€éƒ¨åˆ†</li></ul><p>scheduleä¸æ˜¯å¼ºåˆ¶çš„ï¼Œä½†å®šä¹‰scheduleæ˜¯å¾ˆå¸¸è§çš„ã€‚æ‚¨å¯ä»¥é€šè¿‡scheduleå‚æ•°æ¥å®šä¹‰å®ƒï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p><div class="language-python line-numbers-mode" data-ext="py" data-title="py"><pre class="language-python"><code><span class="token keyword">with</span> DAG<span class="token punctuation">(</span><span class="token string">&quot;my_daily_dag&quot;</span><span class="token punctuation">,</span> schedule<span class="token operator">=</span><span class="token string">&quot;@daily&quot;</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p>scheduleä½¿ç”¨ä»»ä½•æœ‰æ•ˆçš„Crontabè®¡åˆ’å€¼ï¼Œå› æ­¤æ‚¨ä¹Ÿå¯ä»¥æ‰§è¡Œä»¥ä¸‹æ“ä½œï¼š</p><div class="language-python line-numbers-mode" data-ext="py" data-title="py"><pre class="language-python"><code><span class="token keyword">with</span> DAG<span class="token punctuation">(</span><span class="token string">&quot;my_daily_dag&quot;</span><span class="token punctuation">,</span> schedule<span class="token operator">=</span><span class="token string">&quot;0 0 * * *&quot;</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p>æ¯æ¬¡è¿è¡ŒDAGæ—¶ï¼Œéƒ½ä¼šåˆ›å»ºè¯¥DAGçš„æ–°å®ä¾‹ï¼ŒAirflowç§°ä¹‹ä¸ºDAG runã€‚DAGè¿è¡Œå¯ä»¥å¯¹åŒä¸€ä¸ªDAGå¹¶è¡Œè¿è¡Œï¼Œæ¯ä¸ªDAGéƒ½æœ‰ä¸€ä¸ªå®šä¹‰çš„æ•°æ®é—´éš”ï¼Œç”¨äºæ ‡è¯†ä»»åŠ¡åº”è¯¥æ“ä½œçš„æ•°æ®å‘¨æœŸã€‚</p><p>DAGè¿è¡Œå°†åœ¨å¼€å§‹æ—¶å…·æœ‰å¼€å§‹æ—¥æœŸï¼Œåœ¨ç»“æŸæ—¶å…·æœ‰ç»“æŸæ—¥æœŸã€‚æ­¤æ—¶é—´æ®µæè¿°DAGå®é™…â€œè¿è¡Œâ€çš„æ—¶é—´é™¤äº†DAGè¿è¡Œçš„å¼€å§‹å’Œç»“æŸæ—¥æœŸå¤–ï¼Œè¿˜æœ‰ä¸€ä¸ªç§°ä¸ºé€»è¾‘æ—¥æœŸï¼ˆæ­£å¼åç§°ä¸ºæ‰§è¡Œæ—¥æœŸï¼‰çš„æ—¥æœŸï¼Œå®ƒæè¿°äº†DAGè¿è¡Œè®¡åˆ’æˆ–è§¦å‘çš„é¢„æœŸæ—¶é—´ã€‚ä¹‹æ‰€ä»¥ç§°ä¹‹ä¸ºé€»è¾‘ï¼Œæ˜¯å› ä¸ºå®ƒçš„æŠ½è±¡æ€§è´¨å…·æœ‰å¤šç§å«ä¹‰ï¼Œè¿™å–å†³äºDAGè¿è¡Œæœ¬èº«çš„ä¸Šä¸‹æ–‡ã€‚</p><p>ä¾‹å¦‚ï¼Œå¦‚æœDAGè¿è¡Œæ˜¯ç”±ç”¨æˆ·æ‰‹åŠ¨è§¦å‘çš„ï¼Œåˆ™å…¶é€»è¾‘æ—¥æœŸå°†æ˜¯è§¦å‘DAGè¿è¡Œçš„æ—¥æœŸå’Œæ—¶é—´ï¼Œå¹¶ä¸”è¯¥å€¼åº”ç­‰äºDAGè¿è¡Œå¼€å§‹æ—¥æœŸã€‚ç„¶è€Œï¼Œå½“DAGè¢«è‡ªåŠ¨è°ƒåº¦æ—¶ï¼Œåœ¨ç‰¹å®šçš„è°ƒåº¦é—´éš”åˆ°ä½çš„æƒ…å†µä¸‹ï¼Œé€»è¾‘æ—¥æœŸå°†æŒ‡ç¤ºå®ƒæ ‡è®°æ•°æ®é—´éš”å¼€å§‹çš„æ—¶é—´ï¼Œå…¶ä¸­DAGè¿è¡Œçš„å¼€å§‹æ—¥æœŸå°†æ˜¯é€»è¾‘æ—¥æœŸ+è°ƒåº¦é—´éš”ã€‚</p><h2 id="é»˜è®¤å‚æ•°" tabindex="-1"><a class="header-anchor" href="#é»˜è®¤å‚æ•°"><span>é»˜è®¤å‚æ•°</span></a></h2><p>é€šå¸¸ï¼ŒDAGä¸­çš„è®¸å¤šæ“ä½œç¬¦éœ€è¦ç›¸åŒçš„ä¸€ç»„é»˜è®¤å‚æ•°ï¼ˆä¾‹å¦‚é‡è¯•æ¬¡æ•°ï¼‰ã€‚ä¸å¿…ä¸ºæ¯ä¸ªæ“ä½œç¬¦å•ç‹¬æŒ‡å®šï¼Œè€Œæ˜¯å¯ä»¥åœ¨åˆ›å»ºDAGæ—¶å°†default_argsä¼ é€’ç»™DAGï¼ŒDAGå°†è‡ªåŠ¨å°†å®ƒä»¬åº”ç”¨äºä¸å…¶ç»‘å®šçš„ä»»ä½•è¿ç®—ç¬¦ï¼š</p><div class="language-python line-numbers-mode" data-ext="py" data-title="py"><pre class="language-python"><code><span class="token keyword">import</span> pendulum

<span class="token keyword">with</span> DAG<span class="token punctuation">(</span>
    dag_id<span class="token operator">=</span><span class="token string">&quot;my_dag&quot;</span><span class="token punctuation">,</span>
    start_date<span class="token operator">=</span>pendulum<span class="token punctuation">.</span>datetime<span class="token punctuation">(</span><span class="token number">2016</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    schedule<span class="token operator">=</span><span class="token string">&quot;@daily&quot;</span><span class="token punctuation">,</span>
    default_args<span class="token operator">=</span><span class="token punctuation">{</span><span class="token string">&quot;retries&quot;</span><span class="token punctuation">:</span> <span class="token number">2</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">)</span><span class="token punctuation">:</span>
    op <span class="token operator">=</span> BashOperator<span class="token punctuation">(</span>task_id<span class="token operator">=</span><span class="token string">&quot;hello_world&quot;</span><span class="token punctuation">,</span> bash_command<span class="token operator">=</span><span class="token string">&quot;Hello World!&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>op<span class="token punctuation">.</span>retries<span class="token punctuation">)</span>  <span class="token comment"># 2</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="æ§åˆ¶æµç¨‹-1" tabindex="-1"><a class="header-anchor" href="#æ§åˆ¶æµç¨‹-1"><span>æ§åˆ¶æµç¨‹</span></a></h2><p>é»˜è®¤æƒ…å†µä¸‹ï¼ŒDAGåªæœ‰åœ¨å®ƒæ‰€ä¾èµ–çš„æ‰€æœ‰ä»»åŠ¡éƒ½æˆåŠŸæ—¶æ‰ä¼šè¿è¡Œä»»åŠ¡ã€‚ä½†æ˜¯ï¼Œæœ‰å‡ ç§æ–¹æ³•å¯ä»¥å¯¹æ­¤è¿›è¡Œä¿®æ”¹ï¼š</p><ul><li>åˆ†æ”¯ï¼ˆ<a href="https://airflow.apache.org/docs/apache-airflow/stable/core-concepts/dags.html#concepts-branching" target="_blank" rel="noopener noreferrer">Branching<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a> ï¼‰-æ ¹æ®æ¡ä»¶é€‰æ‹©è¦ç§»åŠ¨åˆ°çš„ä»»åŠ¡</li><li>è§¦å‘å™¨è§„åˆ™ï¼ˆ<a href="https://airflow.apache.org/docs/apache-airflow/stable/core-concepts/dags.html#concepts-trigger-rules" target="_blank" rel="noopener noreferrer">Trigger Rules<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a> ï¼‰-è®¾ç½®DAGè¿è¡Œä»»åŠ¡çš„æ¡ä»¶</li><li>è®¾ç½®å’Œæ‹†å¸ï¼ˆ<a href="https://airflow.apache.org/docs/apache-airflow/stable/howto/setup-and-teardown.html" target="_blank" rel="noopener noreferrer">Setup and Teardown<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a> ï¼‰-å®šä¹‰è®¾ç½®å’Œæ‹†å¸å…³ç³»</li><li>Latest Only-ä¸€ç§ç‰¹æ®Šçš„åˆ†æ”¯å½¢å¼ï¼Œåªåœ¨å½“å‰è¿è¡Œçš„DAGä¸Šè¿è¡Œ</li><li>ä¾èµ–äºè¿‡å»ï¼ˆ<a href="https://airflow.apache.org/docs/apache-airflow/stable/core-concepts/dags.html#concepts-depends-on-past" target="_blank" rel="noopener noreferrer">Depends On Past<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a> ï¼‰-ä»»åŠ¡å¯ä»¥ä¾èµ–äºä»¥å‰è¿è¡Œçš„ä»»åŠ¡æœ¬èº«</li></ul><h3 id="åˆ†æ”¯" tabindex="-1"><a class="header-anchor" href="#åˆ†æ”¯"><span>åˆ†æ”¯</span></a></h3><p>æ‚¨å¯ä»¥åˆ©ç”¨åˆ†æ”¯æ¥å‘Šè¯‰DAGä¸è¦è¿è¡Œæ‰€æœ‰ä¾èµ–çš„ä»»åŠ¡ï¼Œè€Œæ˜¯é€‰æ‹©ä¸€ä¸ªæˆ–å¤šä¸ªè·¯å¾„ã€‚è¿™å°±æ˜¯@task.branchè£…é¥°å™¨çš„ç”¨æ­¦ä¹‹åœ°ã€‚ @task.branch decoratorä¸@taskéå¸¸ç›¸ä¼¼ï¼Œåªæ˜¯å®ƒå¸Œæœ›decoratedå‡½æ•°å‘ä»»åŠ¡è¿”å›IDï¼ˆæˆ–IDåˆ—è¡¨ï¼‰ã€‚å°†éµå¾ªæŒ‡å®šçš„ä»»åŠ¡ï¼Œè€Œè·³è¿‡æ‰€æœ‰å…¶ä»–è·¯å¾„ã€‚å®ƒè¿˜å¯ä»¥è¿”å›Noneä»¥è·³è¿‡æ‰€æœ‰ä¸‹æ¸¸ä»»åŠ¡ã€‚</p><p>@task.branchä¹Ÿå¯ä»¥ä¸XComsä¸€èµ·ä½¿ç”¨ï¼Œå…è®¸åˆ†æ”¯ä¸Šä¸‹æ–‡æ ¹æ®ä¸Šæ¸¸ä»»åŠ¡åŠ¨æ€å†³å®šè¦éµå¾ªå“ªä¸ªåˆ†æ”¯ã€‚ä¾‹å¦‚ï¼š</p><div class="language-python line-numbers-mode" data-ext="py" data-title="py"><pre class="language-python"><code><span class="token decorator annotation punctuation">@task<span class="token punctuation">.</span>branch</span><span class="token punctuation">(</span>task_id<span class="token operator">=</span><span class="token string">&quot;branch_task&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">branch_func</span><span class="token punctuation">(</span>ti<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    xcom_value <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>ti<span class="token punctuation">.</span>xcom_pull<span class="token punctuation">(</span>task_ids<span class="token operator">=</span><span class="token string">&quot;start_task&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> xcom_value <span class="token operator">&gt;=</span> <span class="token number">5</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token string">&quot;continue_task&quot;</span>
    <span class="token keyword">elif</span> xcom_value <span class="token operator">&gt;=</span> <span class="token number">3</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token string">&quot;stop_task&quot;</span>
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token boolean">None</span>


start_op <span class="token operator">=</span> BashOperator<span class="token punctuation">(</span>
    task_id<span class="token operator">=</span><span class="token string">&quot;start_task&quot;</span><span class="token punctuation">,</span>
    bash_command<span class="token operator">=</span><span class="token string">&quot;echo 5&quot;</span><span class="token punctuation">,</span>
    xcom_push<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>
    dag<span class="token operator">=</span>dag<span class="token punctuation">,</span>
<span class="token punctuation">)</span>

branch_op <span class="token operator">=</span> branch_func<span class="token punctuation">(</span><span class="token punctuation">)</span>

continue_op <span class="token operator">=</span> EmptyOperator<span class="token punctuation">(</span>task_id<span class="token operator">=</span><span class="token string">&quot;continue_task&quot;</span><span class="token punctuation">,</span> dag<span class="token operator">=</span>dag<span class="token punctuation">)</span>
stop_op <span class="token operator">=</span> EmptyOperator<span class="token punctuation">(</span>task_id<span class="token operator">=</span><span class="token string">&quot;stop_task&quot;</span><span class="token punctuation">,</span> dag<span class="token operator">=</span>dag<span class="token punctuation">)</span>

start_op <span class="token operator">&gt;&gt;</span> branch_op <span class="token operator">&gt;&gt;</span> <span class="token punctuation">[</span>continue_op<span class="token punctuation">,</span> stop_op<span class="token punctuation">]</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>å¦‚æœæ‚¨å¸Œæœ›ä½¿ç”¨åˆ†æ”¯åŠŸèƒ½å®ç°è‡ªå·±çš„è¿ç®—ç¬¦ï¼Œå¯ä»¥ä»BaseBranchOperatorç»§æ‰¿ï¼Œå®ƒçš„è¡Œä¸ºä¸@task.branch decoratorç±»ä¼¼ï¼Œä½†å¸Œæœ›æ‚¨æä¾›æ–¹æ³•choose_branchçš„å®ç°ã€‚</p><p>ä¸@task.branchçš„å¯è°ƒç”¨å‡½æ•°ä¸€æ ·ï¼Œæ­¤æ–¹æ³•å¯ä»¥è¿”å›ä¸‹æ¸¸ä»»åŠ¡çš„IDæˆ–ä»»åŠ¡IDåˆ—è¡¨ï¼Œè¿™äº›ä»»åŠ¡IDå°†è¢«è¿è¡Œï¼Œæ‰€æœ‰å…¶ä»–ä»»åŠ¡éƒ½å°†è¢«è·³è¿‡ã€‚å®ƒè¿˜å¯ä»¥è¿”å›Noneä»¥è·³è¿‡æ‰€æœ‰ä¸‹æ¸¸ä»»åŠ¡ï¼š</p><div class="language-python line-numbers-mode" data-ext="py" data-title="py"><pre class="language-python"><code><span class="token keyword">class</span> <span class="token class-name">MyBranchOperator</span><span class="token punctuation">(</span>BaseBranchOperator<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">choose_branch</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> context<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">&quot;&quot;&quot;
        Run an extra branch on the first day of the month
        &quot;&quot;&quot;</span>
        <span class="token keyword">if</span> context<span class="token punctuation">[</span><span class="token string">&#39;data_interval_start&#39;</span><span class="token punctuation">]</span><span class="token punctuation">.</span>day <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">:</span>
            <span class="token keyword">return</span> <span class="token punctuation">[</span><span class="token string">&#39;daily_task_id&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;monthly_task_id&#39;</span><span class="token punctuation">]</span>
        <span class="token keyword">elif</span> context<span class="token punctuation">[</span><span class="token string">&#39;data_interval_start&#39;</span><span class="token punctuation">]</span><span class="token punctuation">.</span>day <span class="token operator">==</span> <span class="token number">2</span><span class="token punctuation">:</span>
            <span class="token keyword">return</span> <span class="token string">&#39;daily_task_id&#39;</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            <span class="token keyword">return</span> <span class="token boolean">None</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="latest-only" tabindex="-1"><a class="header-anchor" href="#latest-only"><span>Latest Only</span></a></h3><p>Airflowçš„DAG runé€šå¸¸åœ¨ä¸å½“å‰æ—¥æœŸä¸åŒçš„æ—¥æœŸè¿è¡Œï¼Œä¾‹å¦‚ï¼Œåœ¨ä¸Šä¸ªæœˆçš„æ¯ä¸€å¤©è¿è¡Œä¸€ä»½DAGå‰¯æœ¬ä»¥å›å¡«ä¸€äº›æ•°æ®ã€‚</p><p>ä¸è¿‡ï¼Œåœ¨æŸäº›æƒ…å†µä¸‹ï¼Œä½ ä¸æƒ³è®©DAGçš„æŸäº›ï¼ˆæˆ–å…¨éƒ¨ï¼‰éƒ¨åˆ†åœ¨å‰ä¸€ä¸ªæ—¥æœŸè¿è¡Œï¼›åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæ‚¨å¯ä»¥ä½¿ç”¨LatestOnlyOperatorã€‚</p><p>å¦‚æœæ‚¨ä¸åœ¨â€œæœ€æ–°â€DAGè¿è¡Œä¸­ï¼ˆå¦‚æœå½“å‰å¢™ä¸Šçš„æ—¶é’Ÿæ—¶é—´åœ¨å…¶æ‰§è¡Œæ—¶é—´å’Œä¸‹ä¸€ä¸ªè®¡åˆ’æ‰§è¡Œæ—¶é—´ä¹‹é—´ï¼Œå¹¶ä¸”å®ƒä¸æ˜¯å¤–éƒ¨è§¦å‘çš„è¿è¡Œï¼‰ï¼Œåˆ™æ­¤ç‰¹æ®Šæ“ä½œç¬¦å°†è·³è¿‡å…¶ä¸‹æ¸¸çš„æ‰€æœ‰ä»»åŠ¡ã€‚</p><div class="language-python line-numbers-mode" data-ext="py" data-title="py"><pre class="language-python"><code><span class="token keyword">import</span> datetime

<span class="token keyword">import</span> pendulum

<span class="token keyword">from</span> airflow <span class="token keyword">import</span> DAG
<span class="token keyword">from</span> airflow<span class="token punctuation">.</span>operators<span class="token punctuation">.</span>empty <span class="token keyword">import</span> EmptyOperator
<span class="token keyword">from</span> airflow<span class="token punctuation">.</span>operators<span class="token punctuation">.</span>latest_only <span class="token keyword">import</span> LatestOnlyOperator
<span class="token keyword">from</span> airflow<span class="token punctuation">.</span>utils<span class="token punctuation">.</span>trigger_rule <span class="token keyword">import</span> TriggerRule

<span class="token keyword">with</span> DAG<span class="token punctuation">(</span>
    dag_id<span class="token operator">=</span><span class="token string">&quot;latest_only_with_trigger&quot;</span><span class="token punctuation">,</span>
    schedule<span class="token operator">=</span>datetime<span class="token punctuation">.</span>timedelta<span class="token punctuation">(</span>hours<span class="token operator">=</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    start_date<span class="token operator">=</span>pendulum<span class="token punctuation">.</span>datetime<span class="token punctuation">(</span><span class="token number">2021</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> tz<span class="token operator">=</span><span class="token string">&quot;UTC&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    catchup<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span>
    tags<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">&quot;example3&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">)</span> <span class="token keyword">as</span> dag<span class="token punctuation">:</span>
    latest_only <span class="token operator">=</span> LatestOnlyOperator<span class="token punctuation">(</span>task_id<span class="token operator">=</span><span class="token string">&quot;latest_only&quot;</span><span class="token punctuation">)</span>
    task1 <span class="token operator">=</span> EmptyOperator<span class="token punctuation">(</span>task_id<span class="token operator">=</span><span class="token string">&quot;task1&quot;</span><span class="token punctuation">)</span>
    task2 <span class="token operator">=</span> EmptyOperator<span class="token punctuation">(</span>task_id<span class="token operator">=</span><span class="token string">&quot;task2&quot;</span><span class="token punctuation">)</span>
    task3 <span class="token operator">=</span> EmptyOperator<span class="token punctuation">(</span>task_id<span class="token operator">=</span><span class="token string">&quot;task3&quot;</span><span class="token punctuation">)</span>
    task4 <span class="token operator">=</span> EmptyOperator<span class="token punctuation">(</span>task_id<span class="token operator">=</span><span class="token string">&quot;task4&quot;</span><span class="token punctuation">,</span> trigger_rule<span class="token operator">=</span>TriggerRule<span class="token punctuation">.</span>ALL_DONE<span class="token punctuation">)</span>

    latest_only <span class="token operator">&gt;&gt;</span> task1 <span class="token operator">&gt;&gt;</span> <span class="token punctuation">[</span>task3<span class="token punctuation">,</span> task4<span class="token punctuation">]</span>
    task2 <span class="token operator">&gt;&gt;</span> <span class="token punctuation">[</span>task3<span class="token punctuation">,</span> task4<span class="token punctuation">]</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>task1ç›´æ¥ä½äºlatest_onlyçš„ä¸‹æ¸¸ï¼Œå°†è·³è¿‡é™¤æœ€æ–°è¿è¡Œä¹‹å¤–çš„æ‰€æœ‰è¿è¡Œã€‚</li><li>task2å®Œå…¨ç‹¬ç«‹äºlatest_onlyï¼Œå¹¶ä¸”å°†åœ¨æ‰€æœ‰è®¡åˆ’çš„æ—¶æ®µä¸­è¿è¡Œ</li><li>task3ä½äºtask1å’Œtask2çš„ä¸‹æ¸¸ï¼Œç”±äºé»˜è®¤è§¦å‘è§„åˆ™ä¸ºall_successï¼Œå› æ­¤å°†ä»task1æ¥æ”¶çº§è”è·³è¿‡ã€‚</li><li>task4ä½äºtask1å’Œtask2çš„ä¸‹æ¸¸ï¼Œä½†ä¸ä¼šè·³è¿‡å®ƒï¼Œå› ä¸ºå®ƒçš„trigger_ruleè®¾ç½®ä¸ºall_doneã€‚</li></ul><figure><img src="/assets/latest_only_with_trigger-C0ACQePO.png" alt="../_images/latest_only_with_trigger.png" tabindex="0" loading="lazy"><figcaption>../_images/latest_only_with_trigger.png</figcaption></figure><h3 id="ä¾èµ–äºè¿‡å»" tabindex="-1"><a class="header-anchor" href="#ä¾èµ–äºè¿‡å»"><span>ä¾èµ–äºè¿‡å»</span></a></h3><p>æ‚¨ä¹Ÿå¯ä»¥è¯´ï¼Œåªæœ‰åœ¨ä¸Šä¸€æ¬¡DAGè¿è¡Œä¸­ä»»åŠ¡çš„ä¸Šä¸€æ¬¡è¿è¡ŒæˆåŠŸæ—¶ï¼Œä»»åŠ¡æ‰èƒ½è¿è¡Œã€‚è¦ä½¿ç”¨å®ƒï¼Œæ‚¨åªéœ€è¦å°†Taskä¸Šçš„dependens_on_plastå‚æ•°è®¾ç½®ä¸ºTrueã€‚</p><p>è¯·æ³¨æ„ï¼Œå¦‚æœæ‚¨åœ¨DAGç”Ÿå‘½çš„æœ€åˆé˜¶æ®µï¼ˆç‰¹åˆ«æ˜¯å®ƒçš„ç¬¬ä¸€æ¬¡è‡ªåŠ¨è¿è¡Œï¼‰è¿è¡ŒDAGï¼Œé‚£ä¹ˆTaskä»å°†è¿è¡Œï¼Œå› ä¸ºæ²¡æœ‰ä»¥å‰çš„è¿è¡Œå¯ä¾èµ–ã€‚</p><h3 id="è§¦å‘å™¨è§„åˆ™" tabindex="-1"><a class="header-anchor" href="#è§¦å‘å™¨è§„åˆ™"><span>è§¦å‘å™¨è§„åˆ™</span></a></h3><p>é»˜è®¤æƒ…å†µä¸‹ï¼ŒAirflowå°†ç­‰å¾…æ‰€æœ‰ä¸Šæ¸¸ï¼ˆç›´æ¥çˆ¶ä»»åŠ¡ï¼‰ä»»åŠ¡æˆåŠŸï¼Œç„¶åå†è¿è¡Œè¯¥ä»»åŠ¡ã€‚ç„¶è€Œï¼Œè¿™åªæ˜¯é»˜è®¤è¡Œä¸ºï¼Œæ‚¨å¯ä»¥ä½¿ç”¨Taskçš„trigger_ruleå‚æ•°æ¥æ§åˆ¶å®ƒã€‚trigger_ruleçš„é€‰é¡¹åŒ…æ‹¬ï¼š</p><ul><li>all_successï¼ˆé»˜è®¤ï¼‰ï¼šæ‰€æœ‰ä¸Šæ¸¸ä»»åŠ¡éƒ½å·²æˆåŠŸ</li><li>all_failedï¼šæ‰€æœ‰ä¸Šæ¸¸ä»»åŠ¡éƒ½å¤„äºå¤±è´¥æˆ–ä¸Šæ¸¸å¤±è´¥çŠ¶æ€</li><li>all_doneï¼šæ‰€æœ‰ä¸Šæ¸¸ä»»åŠ¡éƒ½å·²æ‰§è¡Œå®Œæ¯•</li><li>all_skipped:æ‰€æœ‰ä¸Šæ¸¸ä»»åŠ¡éƒ½å¤„äºè·³è¿‡çŠ¶æ€</li><li>one_failed:è‡³å°‘æœ‰ä¸€ä¸ªä¸Šæ¸¸ä»»åŠ¡å¤±è´¥ï¼ˆä¸ç­‰å¾…æ‰€æœ‰ä¸Šæ¸¸ä»»åŠ¡å®Œæˆï¼‰</li><li>one_success:è‡³å°‘æœ‰ä¸€ä¸ªä¸Šæ¸¸ä»»åŠ¡æˆåŠŸï¼ˆä¸ç­‰å¾…æ‰€æœ‰ä¸Šæ¸¸ä»»åŠ¡å®Œæˆï¼‰</li><li>one_done:è‡³å°‘æœ‰ä¸€ä¸ªä¸Šæ¸¸ä»»åŠ¡æˆåŠŸæˆ–å¤±è´¥</li><li>none_failedï¼šæ‰€æœ‰ä¸Šæ¸¸ä»»åŠ¡æ²¡æœ‰å¤±è´¥æˆ–upstream_failedï¼Œå³æ‰€æœ‰ä¸Šæ¸¸ä»»åŠ¡éƒ½å·²æˆåŠŸæˆ–è·³è¿‡</li><li>none_failed_min_one_successï¼šæ‰€æœ‰ä¸Šæ¸¸ä»»åŠ¡éƒ½æ²¡æœ‰å¤±è´¥æˆ–ä¸Šæ¸¸å¤±è´¥ï¼Œå¹¶ä¸”è‡³å°‘æœ‰ä¸€ä¸ªä¸Šæ¸¸ä»»åŠ¡æˆåŠŸã€‚</li><li>none_skippedï¼šæ²¡æœ‰ä¸Šæ¸¸ä»»åŠ¡å¤„äºè·³è¿‡çŠ¶æ€ï¼Œå³æ‰€æœ‰ä¸Šæ¸¸ä»»åŠ¡éƒ½å¤„äºæˆåŠŸã€å¤±è´¥æˆ–ä¸Šæ¸¸å¤±è´¥çŠ¶æ€ å§‹ç»ˆï¼šå®Œå…¨æ²¡æœ‰ä¾èµ–é¡¹ï¼Œéšæ—¶è¿è¡Œæ­¤ä»»åŠ¡</li></ul><blockquote><p>å¦‚æœæ‚¨æ„¿æ„ï¼Œä¹Ÿå¯ä»¥å°†å…¶ä¸â€œä¾èµ–è¿‡å»â€åŠŸèƒ½ç»“åˆä½¿ç”¨ã€‚</p></blockquote><p>é‡è¦çš„æ˜¯è¦æ³¨æ„è§¦å‘è§„åˆ™å’Œè·³è¿‡çš„ä»»åŠ¡ä¹‹é—´çš„äº¤äº’ï¼Œå°¤å…¶æ˜¯ä½œä¸ºåˆ†æ”¯æ“ä½œçš„ä¸€éƒ¨åˆ†è·³è¿‡çš„ä»»åŠ¡ã€‚æ‚¨å‡ ä¹ä»ä¸å¸Œæœ›åœ¨åˆ†æ”¯æ“ä½œçš„ä¸‹æ¸¸ä½¿ç”¨all_successæˆ–all_failedã€‚</p><p>è·³è¿‡çš„ä»»åŠ¡å°†é€šè¿‡è§¦å‘è§„åˆ™all_successå’Œall_failedçº§è”ï¼Œå¹¶å¯¼è‡´å®ƒä»¬ä¹Ÿè·³è¿‡ã€‚è€ƒè™‘ä»¥ä¸‹DAGï¼š</p><div class="language-python line-numbers-mode" data-ext="py" data-title="py"><pre class="language-python"><code><span class="token comment"># dags/branch_without_trigger.py</span>
<span class="token keyword">import</span> pendulum

<span class="token keyword">from</span> airflow<span class="token punctuation">.</span>decorators <span class="token keyword">import</span> task
<span class="token keyword">from</span> airflow<span class="token punctuation">.</span>models <span class="token keyword">import</span> DAG
<span class="token keyword">from</span> airflow<span class="token punctuation">.</span>operators<span class="token punctuation">.</span>empty <span class="token keyword">import</span> EmptyOperator

dag <span class="token operator">=</span> DAG<span class="token punctuation">(</span>
    dag_id<span class="token operator">=</span><span class="token string">&quot;branch_without_trigger&quot;</span><span class="token punctuation">,</span>
    schedule<span class="token operator">=</span><span class="token string">&quot;@once&quot;</span><span class="token punctuation">,</span>
    start_date<span class="token operator">=</span>pendulum<span class="token punctuation">.</span>datetime<span class="token punctuation">(</span><span class="token number">2019</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">28</span><span class="token punctuation">,</span> tz<span class="token operator">=</span><span class="token string">&quot;UTC&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">)</span>

run_this_first <span class="token operator">=</span> EmptyOperator<span class="token punctuation">(</span>task_id<span class="token operator">=</span><span class="token string">&quot;run_this_first&quot;</span><span class="token punctuation">,</span> dag<span class="token operator">=</span>dag<span class="token punctuation">)</span>


<span class="token decorator annotation punctuation">@task<span class="token punctuation">.</span>branch</span><span class="token punctuation">(</span>task_id<span class="token operator">=</span><span class="token string">&quot;branching&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">do_branching</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">return</span> <span class="token string">&quot;branch_a&quot;</span>


branching <span class="token operator">=</span> do_branching<span class="token punctuation">(</span><span class="token punctuation">)</span>

branch_a <span class="token operator">=</span> EmptyOperator<span class="token punctuation">(</span>task_id<span class="token operator">=</span><span class="token string">&quot;branch_a&quot;</span><span class="token punctuation">,</span> dag<span class="token operator">=</span>dag<span class="token punctuation">)</span>
follow_branch_a <span class="token operator">=</span> EmptyOperator<span class="token punctuation">(</span>task_id<span class="token operator">=</span><span class="token string">&quot;follow_branch_a&quot;</span><span class="token punctuation">,</span> dag<span class="token operator">=</span>dag<span class="token punctuation">)</span>

branch_false <span class="token operator">=</span> EmptyOperator<span class="token punctuation">(</span>task_id<span class="token operator">=</span><span class="token string">&quot;branch_false&quot;</span><span class="token punctuation">,</span> dag<span class="token operator">=</span>dag<span class="token punctuation">)</span>

join <span class="token operator">=</span> EmptyOperator<span class="token punctuation">(</span>task_id<span class="token operator">=</span><span class="token string">&quot;join&quot;</span><span class="token punctuation">,</span> dag<span class="token operator">=</span>dag<span class="token punctuation">)</span>

run_this_first <span class="token operator">&gt;&gt;</span> branching
branching <span class="token operator">&gt;&gt;</span> branch_a <span class="token operator">&gt;&gt;</span> follow_branch_a <span class="token operator">&gt;&gt;</span> join
branching <span class="token operator">&gt;&gt;</span> branch_false <span class="token operator">&gt;&gt;</span> join
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>joinä½äºfollow_branch_aå’Œbranch_falseçš„ä¸‹æ¸¸ã€‚è”æ¥ä»»åŠ¡å°†æ˜¾ç¤ºä¸ºå·²è·³è¿‡ï¼Œå› ä¸ºé»˜è®¤æƒ…å†µä¸‹å…¶trigger_ruleè®¾ç½®ä¸ºall_successï¼Œå¹¶ä¸”åˆ†æ”¯æ“ä½œå¯¼è‡´çš„è·³è¿‡å‘ä¸‹çº§è”ä»¥è·³è¿‡æ ‡è®°ä¸ºall_ssuccessçš„ä»»åŠ¡ã€‚</p><figure><img src="/assets/branch_without_trigger-1697962671809-17-CVrLg8Ns.png" alt="../_images/branch_without_trigger.png" tabindex="0" loading="lazy"><figcaption>../_images/branch_without_trigger.png</figcaption></figure><p>é€šè¿‡åœ¨è”æ¥ä»»åŠ¡ä¸­å°†trigger_ruleè®¾ç½®ä¸ºnone_failed_min_one_successï¼Œæˆ‘ä»¬å¯ä»¥è·å¾—é¢„æœŸçš„è¡Œä¸ºï¼š</p><figure><img src="/assets/branch_with_trigger-CcR1QyUP.png" alt="../_images/branch_with_trigger.png" tabindex="0" loading="lazy"><figcaption>../_images/branch_with_trigger.png</figcaption></figure><h3 id="setup-and-teardown" tabindex="-1"><a class="header-anchor" href="#setup-and-teardown"><span>Setup and teardown</span></a></h3><p>åœ¨æ•°æ®å·¥ä½œæµä¸­ï¼Œé€šå¸¸åˆ›å»ºä¸€ä¸ªèµ„æºï¼ˆå¦‚è®¡ç®—èµ„æºï¼‰ï¼Œä½¿ç”¨å®ƒæ¥åšä¸€äº›å·¥ä½œï¼Œç„¶åå°†å…¶æ‹†ä¸‹ã€‚Airflowæä¾›å®‰è£…å’Œæ‹†å¸ä»»åŠ¡æ¥æ”¯æŒè¿™ä¸€éœ€æ±‚ã€‚</p><h2 id="åŠ¨æ€dag" tabindex="-1"><a class="header-anchor" href="#åŠ¨æ€dag"><span>åŠ¨æ€DAG</span></a></h2><p>ç”±äºDAGæ˜¯ç”±Pythonä»£ç å®šä¹‰çš„ï¼Œå› æ­¤å®ƒä¸éœ€è¦æ˜¯çº¯ç²¹çš„å£°æ˜æ€§çš„ï¼›æ‚¨å¯ä»¥è‡ªç”±ä½¿ç”¨å¾ªç¯ã€å‡½æ•°ç­‰æ¥å®šä¹‰DAGã€‚ ä¾‹å¦‚ï¼Œè¿™é‡Œæœ‰ä¸€ä¸ªDAGï¼Œå®ƒä½¿ç”¨Forå¾ªç¯æ¥å®šä¹‰ä¸€äº›ä»»åŠ¡ï¼š</p><div class="language-python line-numbers-mode" data-ext="py" data-title="py"><pre class="language-python"><code> <span class="token keyword">with</span> DAG<span class="token punctuation">(</span><span class="token string">&quot;loop_example&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">:</span>

     first <span class="token operator">=</span> EmptyOperator<span class="token punctuation">(</span>task_id<span class="token operator">=</span><span class="token string">&quot;first&quot;</span><span class="token punctuation">)</span>
     last <span class="token operator">=</span> EmptyOperator<span class="token punctuation">(</span>task_id<span class="token operator">=</span><span class="token string">&quot;last&quot;</span><span class="token punctuation">)</span>

     options <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">&quot;branch_a&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;branch_b&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;branch_c&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;branch_d&quot;</span><span class="token punctuation">]</span>
     <span class="token keyword">for</span> option <span class="token keyword">in</span> options<span class="token punctuation">:</span>
         t <span class="token operator">=</span> EmptyOperator<span class="token punctuation">(</span>task_id<span class="token operator">=</span>option<span class="token punctuation">)</span>
         first <span class="token operator">&gt;&gt;</span> t <span class="token operator">&gt;&gt;</span> last
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ä¸€èˆ¬æ¥è¯´ï¼Œæˆ‘ä»¬å»ºè®®æ‚¨å°½é‡ä¿æŒDAGä»»åŠ¡çš„æ‹“æ‰‘ç»“æ„ï¼ˆå¸ƒå±€ï¼‰ç›¸å¯¹ç¨³å®šï¼›åŠ¨æ€DAGé€šå¸¸æ›´å¥½åœ°ç”¨äºåŠ¨æ€åŠ è½½é…ç½®é€‰é¡¹ã€‚</p><h2 id="dagå¯è§†åŒ–" tabindex="-1"><a class="header-anchor" href="#dagå¯è§†åŒ–"><span>DAGå¯è§†åŒ–</span></a></h2><p>å¦‚æœè¦æŸ¥çœ‹DAGçš„è§†è§‰è¡¨ç¤ºï¼Œæœ‰ä¸¤ä¸ªé€‰é¡¹ï¼š</p><ul><li>æ‚¨å¯ä»¥åœ¨UIä¸Šï¼Œå¯¼èˆªåˆ°DAGï¼Œç„¶åé€‰æ‹©Graph</li><li>æ‚¨å¯ä»¥è¿è¡Œå‘½ä»¤ <code>airflow dags show</code>ï¼Œå°†å…¶æ¸²æŸ“ä¸ºå›¾åƒæ–‡ä»¶</li></ul><p>éšç€æ‚¨å¼€å‘DAGï¼Œå®ƒä»¬å°†å˜å¾—è¶Šæ¥è¶Šå¤æ‚ï¼Œå› æ­¤æˆ‘ä»¬æä¾›äº†ä¸€äº›æ–¹æ³•æ¥ä¿®æ”¹è¿™äº›DAGè§†å›¾ï¼Œä½¿å…¶æ›´æ˜“äºç†è§£ã€‚</p><h3 id="ä»»åŠ¡ç»„" tabindex="-1"><a class="header-anchor" href="#ä»»åŠ¡ç»„"><span>ä»»åŠ¡ç»„</span></a></h3><p>â€œä»»åŠ¡ç»„â€å¯ç”¨äºåœ¨Graphè§†å›¾ä¸­å°†ä»»åŠ¡ç»„ç»‡ä¸ºå±‚æ¬¡ç»„ã€‚å®ƒå¯¹äºåˆ›å»ºé‡å¤å›¾æ¡ˆå’Œå‡å°‘è§†è§‰æ··ä¹±éå¸¸æœ‰ç”¨ã€‚</p><p>ä¸SubDAGä¸åŒï¼ŒTaskGroupsçº¯ç²¹æ˜¯ä¸€ä¸ªUIåˆ†ç»„æ¦‚å¿µã€‚TaskGroupsä¸­çš„ä»»åŠ¡ä½äºåŒä¸€ä¸ªåŸå§‹DAGä¸Šï¼Œå¹¶éµå®ˆæ‰€æœ‰DAGè®¾ç½®å’Œæ± é…ç½®ã€‚</p><figure><img src="/assets/task_group-DRdoDy8z.gif" alt="../_images/task_group.gif" tabindex="0" loading="lazy"><figcaption>../_images/task_group.gif</figcaption></figure><p>ä¾èµ–å…³ç³»å¯ä»¥åº”ç”¨äºå¸¦æœ‰&gt;&gt;å’Œ&lt;&lt;è¿ç®—ç¬¦çš„TaskGroupä¸­çš„æ‰€æœ‰ä»»åŠ¡ã€‚ä¾‹å¦‚ï¼Œä»¥ä¸‹ä»£ç å°†task1å’Œtask2æ”¾åœ¨TaskGroupç»„1ä¸­ï¼Œç„¶åå°†è¿™ä¸¤ä¸ªä»»åŠ¡éƒ½æ”¾åœ¨task3çš„ä¸Šæ¸¸ï¼š</p><div class="language-python line-numbers-mode" data-ext="py" data-title="py"><pre class="language-python"><code> <span class="token keyword">from</span> airflow<span class="token punctuation">.</span>decorators <span class="token keyword">import</span> task_group


 <span class="token decorator annotation punctuation">@task_group</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
 <span class="token keyword">def</span> <span class="token function">group1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
     task1 <span class="token operator">=</span> EmptyOperator<span class="token punctuation">(</span>task_id<span class="token operator">=</span><span class="token string">&quot;task1&quot;</span><span class="token punctuation">)</span>
     task2 <span class="token operator">=</span> EmptyOperator<span class="token punctuation">(</span>task_id<span class="token operator">=</span><span class="token string">&quot;task2&quot;</span><span class="token punctuation">)</span>


 task3 <span class="token operator">=</span> EmptyOperator<span class="token punctuation">(</span>task_id<span class="token operator">=</span><span class="token string">&quot;task3&quot;</span><span class="token punctuation">)</span>

 group1<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;&gt;</span> task3
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>TaskGroupä¹Ÿæ”¯æŒç±»ä¼¼DAGçš„default_argsï¼Œå®ƒå°†è¦†ç›–DAGçº§åˆ«çš„default_argï¼š</p><div class="language-python line-numbers-mode" data-ext="py" data-title="py"><pre class="language-python"><code><span class="token keyword">import</span> datetime

<span class="token keyword">from</span> airflow <span class="token keyword">import</span> DAG
<span class="token keyword">from</span> airflow<span class="token punctuation">.</span>decorators <span class="token keyword">import</span> task_group
<span class="token keyword">from</span> airflow<span class="token punctuation">.</span>operators<span class="token punctuation">.</span>bash <span class="token keyword">import</span> BashOperator
<span class="token keyword">from</span> airflow<span class="token punctuation">.</span>operators<span class="token punctuation">.</span>empty <span class="token keyword">import</span> EmptyOperator

<span class="token keyword">with</span> DAG<span class="token punctuation">(</span>
    dag_id<span class="token operator">=</span><span class="token string">&quot;dag1&quot;</span><span class="token punctuation">,</span>
    start_date<span class="token operator">=</span>datetime<span class="token punctuation">.</span>datetime<span class="token punctuation">(</span><span class="token number">2016</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    schedule<span class="token operator">=</span><span class="token string">&quot;@daily&quot;</span><span class="token punctuation">,</span>
    default_args<span class="token operator">=</span><span class="token punctuation">{</span><span class="token string">&quot;retries&quot;</span><span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">)</span><span class="token punctuation">:</span>

    <span class="token decorator annotation punctuation">@task_group</span><span class="token punctuation">(</span>default_args<span class="token operator">=</span><span class="token punctuation">{</span><span class="token string">&quot;retries&quot;</span><span class="token punctuation">:</span> <span class="token number">3</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token keyword">def</span> <span class="token function">group1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">&quot;&quot;&quot;This docstring will become the tooltip for the TaskGroup.&quot;&quot;&quot;</span>
        task1 <span class="token operator">=</span> EmptyOperator<span class="token punctuation">(</span>task_id<span class="token operator">=</span><span class="token string">&quot;task1&quot;</span><span class="token punctuation">)</span>
        task2 <span class="token operator">=</span> BashOperator<span class="token punctuation">(</span>task_id<span class="token operator">=</span><span class="token string">&quot;task2&quot;</span><span class="token punctuation">,</span> bash_command<span class="token operator">=</span><span class="token string">&quot;echo Hello World!&quot;</span><span class="token punctuation">,</span> retries<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span>task1<span class="token punctuation">.</span>retries<span class="token punctuation">)</span>  <span class="token comment"># 3</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span>task2<span class="token punctuation">.</span>retries<span class="token punctuation">)</span>  <span class="token comment"># 2</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>é»˜è®¤æƒ…å†µä¸‹ï¼Œå­ä»»åŠ¡/ä»»åŠ¡ç»„çš„idå‰ç¼€ä¸ºå…¶çˆ¶ä»»åŠ¡ç»„çš„group_idã€‚è¿™æœ‰åŠ©äºç¡®ä¿group_idå’Œtask_idåœ¨æ•´ä¸ªDAGä¸­çš„å”¯ä¸€æ€§ã€‚ è¦ç¦ç”¨å‰ç¼€ï¼Œè¯·åœ¨åˆ›å»ºTaskGroupæ—¶ä¼ é€’prefix_group_id=Falseï¼Œä½†è¯·æ³¨æ„ï¼Œæ‚¨ç°åœ¨å°†è´Ÿè´£ç¡®ä¿æ¯ä¸ªä»»åŠ¡å’Œç»„éƒ½æœ‰è‡ªå·±çš„å”¯ä¸€idã€‚</p><h3 id="è¾¹æ ‡ç­¾" tabindex="-1"><a class="header-anchor" href="#è¾¹æ ‡ç­¾"><span>è¾¹æ ‡ç­¾</span></a></h3><p>é™¤äº†å°†ä»»åŠ¡åˆ†ç»„å¤–ï¼Œè¿˜å¯ä»¥åœ¨Graphè§†å›¾ä¸­æ ‡è®°ä¸åŒä»»åŠ¡ä¹‹é—´çš„ä¾èµ–è¾¹-è¿™å¯¹äºDAGçš„åˆ†æ”¯åŒºåŸŸç‰¹åˆ«æœ‰ç”¨ï¼Œå› æ­¤å¯ä»¥æ ‡è®°æŸäº›åˆ†æ”¯å¯èƒ½è¿è¡Œçš„æ¡ä»¶ã€‚</p><p>è¦æ·»åŠ æ ‡ç­¾ï¼Œå¯ä»¥ç›´æ¥ä¸&gt;&gt;å’Œ&lt;&lt;è¿ç®—ç¬¦å†…è”ä½¿ç”¨å®ƒä»¬ï¼š</p><div class="language-python line-numbers-mode" data-ext="py" data-title="py"><pre class="language-python"><code><span class="token keyword">from</span> airflow<span class="token punctuation">.</span>utils<span class="token punctuation">.</span>edgemodifier <span class="token keyword">import</span> Label

my_task <span class="token operator">&gt;&gt;</span> Label<span class="token punctuation">(</span><span class="token string">&quot;When empty&quot;</span><span class="token punctuation">)</span> <span class="token operator">&gt;&gt;</span> other_task

<span class="token keyword">from</span> airflow<span class="token punctuation">.</span>utils<span class="token punctuation">.</span>edgemodifier <span class="token keyword">import</span> Label

my_task<span class="token punctuation">.</span>set_downstream<span class="token punctuation">(</span>other_task<span class="token punctuation">,</span> Label<span class="token punctuation">(</span><span class="token string">&quot;When empty&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ä¸‹é¢æ˜¯ä¸€ä¸ªDAGç¤ºä¾‹ï¼Œå®ƒè¯´æ˜äº†å¦‚ä½•æ ‡è®°ä¸åŒçš„åˆ†æ”¯ï¼š</p><figure><img src="/assets/edge_label_example-BqdSRJr2.png" alt="../_images/edge_label_example.png" tabindex="0" loading="lazy"><figcaption>../_images/edge_label_example.png</figcaption></figure><h2 id="dagå’Œä»»åŠ¡æ–‡æ¡£" tabindex="-1"><a class="header-anchor" href="#dagå’Œä»»åŠ¡æ–‡æ¡£"><span>DAGå’Œä»»åŠ¡æ–‡æ¡£</span></a></h2><p>å¯ä»¥å‘æ‚¨çš„DAGå’Œä»»åŠ¡å¯¹è±¡æ·»åŠ æ–‡æ¡£æˆ–æ³¨é‡Šï¼Œè¿™äº›æ–‡æ¡£æˆ–æ³¨é‡Šåœ¨webç•Œé¢ä¸­å¯è§ï¼ˆDAGçš„â€œå›¾å½¢â€å’Œâ€œæ ‘â€ï¼Œä»»åŠ¡çš„â€œä»»åŠ¡å®ä¾‹è¯¦ç»†ä¿¡æ¯â€ï¼‰ã€‚ å¦‚æœå®šä¹‰äº†ä¸€ç»„ç‰¹æ®Šçš„ä»»åŠ¡å±æ€§ï¼Œåˆ™è¿™äº›å±æ€§å°†è¢«å‘ˆç°ä¸ºä¸°å¯Œçš„å†…å®¹ï¼š</p><table><thead><tr><th>attribute</th><th>rendered to</th></tr></thead><tbody><tr><td>doc</td><td>monospace</td></tr><tr><td>doc_json</td><td>json</td></tr><tr><td>doc_yaml</td><td>yaml</td></tr><tr><td>doc_md</td><td>markdown</td></tr><tr><td>doc_rst</td><td>reStructuredText</td></tr></tbody></table><p>è¯·æ³¨æ„ï¼Œå¯¹äºDAGï¼Œdoc_mdæ˜¯å”¯ä¸€è§£é‡Šçš„å±æ€§ã€‚å¯¹äºDAGï¼Œå®ƒå¯ä»¥åŒ…å«å­—ç¬¦ä¸²æˆ–å¯¹æ¨¡æ¿æ–‡ä»¶çš„å¼•ç”¨ã€‚æ¨¡æ¿å¼•ç”¨ç”±ä»¥.mdç»“å°¾çš„strè¯†åˆ«ã€‚å¦‚æœæä¾›äº†ç›¸å¯¹è·¯å¾„ï¼Œå®ƒå°†ä»DAGæ–‡ä»¶çš„æ–‡ä»¶å¤¹å¼€å§‹ã€‚æ­¤å¤–ï¼Œæ¨¡æ¿æ–‡ä»¶å¿…é¡»å­˜åœ¨ï¼Œå¦åˆ™Airflowå°†å¼•å‘jinja2.exceptions.TemplateNotFoundå¼‚å¸¸ã€‚</p><p>å¦‚æœæ‚¨çš„ä»»åŠ¡æ˜¯ä»é…ç½®æ–‡ä»¶åŠ¨æ€æ„å»ºçš„ï¼Œè¿™ä¸€ç‚¹å°¤å…¶æœ‰ç”¨ï¼Œå› ä¸ºå®ƒå…è®¸æ‚¨åœ¨Airflowä¸­å…¬å¼€å¯¼è‡´ç›¸å…³ä»»åŠ¡çš„é…ç½®ï¼š</p><div class="language-python line-numbers-mode" data-ext="py" data-title="py"><pre class="language-python"><code><span class="token triple-quoted-string string">&quot;&quot;&quot;
### My great DAG
&quot;&quot;&quot;</span>
<span class="token keyword">import</span> pendulum

dag <span class="token operator">=</span> DAG<span class="token punctuation">(</span>
    <span class="token string">&quot;my_dag&quot;</span><span class="token punctuation">,</span>
    start_date<span class="token operator">=</span>pendulum<span class="token punctuation">.</span>datetime<span class="token punctuation">(</span><span class="token number">2021</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> tz<span class="token operator">=</span><span class="token string">&quot;UTC&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    schedule<span class="token operator">=</span><span class="token string">&quot;@daily&quot;</span><span class="token punctuation">,</span>
    catchup<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span>
<span class="token punctuation">)</span>
dag<span class="token punctuation">.</span>doc_md <span class="token operator">=</span> __doc__

t <span class="token operator">=</span> BashOperator<span class="token punctuation">(</span><span class="token string">&quot;foo&quot;</span><span class="token punctuation">,</span> dag<span class="token operator">=</span>dag<span class="token punctuation">)</span>
t<span class="token punctuation">.</span>doc_md <span class="token operator">=</span> <span class="token triple-quoted-string string">&quot;&quot;&quot;\
#Title&quot;
Here&#39;s a [url](www.airbnb.com)
&quot;&quot;&quot;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="subdags" tabindex="-1"><a class="header-anchor" href="#subdags"><span>SubDAGs</span></a></h2><p>æœ‰æ—¶ï¼Œä½ ä¼šå‘ç°ä½ ç»å¸¸å‘æ¯ä¸ªDAGæ·»åŠ å®Œå…¨ç›¸åŒçš„ä»»åŠ¡é›†ï¼Œæˆ–è€…ä½ æƒ³æŠŠå¾ˆå¤šä»»åŠ¡åˆ†ç»„åˆ°ä¸€ä¸ªå•ä¸€çš„é€»è¾‘å•å…ƒä¸­ã€‚è¿™å°±æ˜¯SubDAGçš„ä½œç”¨ã€‚ ä¾‹å¦‚ï¼Œè¿™é‡Œæœ‰ä¸€ä¸ªDAGï¼Œå®ƒåœ¨ä¸¤ä¸ªéƒ¨åˆ†ä¸­æœ‰å¾ˆå¤šå¹¶è¡Œä»»åŠ¡ï¼š</p><figure><img src="/assets/subdag_before-DqJdadit.png" alt="../_images/subdag_before.png" tabindex="0" loading="lazy"><figcaption>../_images/subdag_before.png</figcaption></figure><p>æˆ‘ä»¬å¯ä»¥å°†æ‰€æœ‰å¹¶è¡Œ<code>task-*</code>è¿ç®—ç¬¦ç»„åˆåˆ°ä¸€ä¸ªSubDAGä¸­ï¼Œè¿™æ ·å¾—åˆ°çš„DAGç±»ä¼¼äºä»¥ä¸‹å†…å®¹ï¼š</p><figure><img src="/assets/subdag_after-Ce3a9PEt.png" alt="../_images/subdag_after.png" tabindex="0" loading="lazy"><figcaption>../_images/subdag_after.png</figcaption></figure><p>è¯·æ³¨æ„ï¼ŒSubDAGè¿ç®—ç¬¦åº”è¯¥åŒ…å«ä¸€ä¸ªè¿”å›DAGå¯¹è±¡çš„å·¥å‚æ–¹æ³•ã€‚è¿™å°†é˜²æ­¢SubDAGåœ¨ä¸»UIä¸­è¢«è§†ä¸ºå•ç‹¬çš„DAGâ€”â€”è®°ä½ï¼Œå¦‚æœAirflowåœ¨Pythonæ–‡ä»¶çš„é¡¶å±‚çœ‹åˆ°ä¸€ä¸ªDAGï¼Œå®ƒå°†æŠŠå®ƒä½œä¸ºè‡ªå·±çš„DAGåŠ è½½ã€‚ä¾‹å¦‚ï¼š</p><div class="language-python line-numbers-mode" data-ext="py" data-title="py"><pre class="language-python"><code><span class="token keyword">import</span> pendulum

<span class="token keyword">from</span> airflow <span class="token keyword">import</span> DAG
<span class="token keyword">from</span> airflow<span class="token punctuation">.</span>operators<span class="token punctuation">.</span>empty <span class="token keyword">import</span> EmptyOperator


<span class="token keyword">def</span> <span class="token function">subdag</span><span class="token punctuation">(</span>parent_dag_name<span class="token punctuation">,</span> child_dag_name<span class="token punctuation">,</span> args<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> DAG<span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">&quot;&quot;&quot;
    Generate a DAG to be used as a subdag.

    :param str parent_dag_name: Id of the parent DAG
    :param str child_dag_name: Id of the child DAG
    :param dict args: Default arguments to provide to the subdag
    :return: DAG to use as a subdag
    &quot;&quot;&quot;</span>
    dag_subdag <span class="token operator">=</span> DAG<span class="token punctuation">(</span>
        dag_id<span class="token operator">=</span><span class="token string-interpolation"><span class="token string">f&quot;</span><span class="token interpolation"><span class="token punctuation">{</span>parent_dag_name<span class="token punctuation">}</span></span><span class="token string">.</span><span class="token interpolation"><span class="token punctuation">{</span>child_dag_name<span class="token punctuation">}</span></span><span class="token string">&quot;</span></span><span class="token punctuation">,</span>
        default_args<span class="token operator">=</span>args<span class="token punctuation">,</span>
        start_date<span class="token operator">=</span>pendulum<span class="token punctuation">.</span>datetime<span class="token punctuation">(</span><span class="token number">2021</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> tz<span class="token operator">=</span><span class="token string">&quot;UTC&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        catchup<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span>
        schedule<span class="token operator">=</span><span class="token string">&quot;@daily&quot;</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span>

    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        EmptyOperator<span class="token punctuation">(</span>
            task_id<span class="token operator">=</span><span class="token string-interpolation"><span class="token string">f&quot;</span><span class="token interpolation"><span class="token punctuation">{</span>child_dag_name<span class="token punctuation">}</span></span><span class="token string">-task-</span><span class="token interpolation"><span class="token punctuation">{</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">}</span></span><span class="token string">&quot;</span></span><span class="token punctuation">,</span>
            default_args<span class="token operator">=</span>args<span class="token punctuation">,</span>
            dag<span class="token operator">=</span>dag_subdag<span class="token punctuation">,</span>
        <span class="token punctuation">)</span>

    <span class="token keyword">return</span> dag_subdag


</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ç„¶åå¯ä»¥åœ¨ä¸»DAGæ–‡ä»¶ä¸­å¼•ç”¨æ­¤å­DAGï¼š</p><div class="language-python line-numbers-mode" data-ext="py" data-title="py"><pre class="language-python"><code><span class="token keyword">import</span> datetime

<span class="token keyword">from</span> airflow <span class="token keyword">import</span> DAG
<span class="token keyword">from</span> airflow<span class="token punctuation">.</span>example_dags<span class="token punctuation">.</span>subdags<span class="token punctuation">.</span>subdag <span class="token keyword">import</span> subdag
<span class="token keyword">from</span> airflow<span class="token punctuation">.</span>operators<span class="token punctuation">.</span>empty <span class="token keyword">import</span> EmptyOperator
<span class="token keyword">from</span> airflow<span class="token punctuation">.</span>operators<span class="token punctuation">.</span>subdag <span class="token keyword">import</span> SubDagOperator

DAG_NAME <span class="token operator">=</span> <span class="token string">&quot;example_subdag_operator&quot;</span>

<span class="token keyword">with</span> DAG<span class="token punctuation">(</span>
    dag_id<span class="token operator">=</span>DAG_NAME<span class="token punctuation">,</span>
    default_args<span class="token operator">=</span><span class="token punctuation">{</span><span class="token string">&quot;retries&quot;</span><span class="token punctuation">:</span> <span class="token number">2</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    start_date<span class="token operator">=</span>datetime<span class="token punctuation">.</span>datetime<span class="token punctuation">(</span><span class="token number">2022</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    schedule<span class="token operator">=</span><span class="token string">&quot;@once&quot;</span><span class="token punctuation">,</span>
    tags<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">&quot;example&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">)</span> <span class="token keyword">as</span> dag<span class="token punctuation">:</span>

    start <span class="token operator">=</span> EmptyOperator<span class="token punctuation">(</span>
        task_id<span class="token operator">=</span><span class="token string">&quot;start&quot;</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span>

    section_1 <span class="token operator">=</span> SubDagOperator<span class="token punctuation">(</span>
        task_id<span class="token operator">=</span><span class="token string">&quot;section-1&quot;</span><span class="token punctuation">,</span>
        subdag<span class="token operator">=</span>subdag<span class="token punctuation">(</span>DAG_NAME<span class="token punctuation">,</span> <span class="token string">&quot;section-1&quot;</span><span class="token punctuation">,</span> dag<span class="token punctuation">.</span>default_args<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span>

    some_other_task <span class="token operator">=</span> EmptyOperator<span class="token punctuation">(</span>
        task_id<span class="token operator">=</span><span class="token string">&quot;some-other-task&quot;</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span>

    section_2 <span class="token operator">=</span> SubDagOperator<span class="token punctuation">(</span>
        task_id<span class="token operator">=</span><span class="token string">&quot;section-2&quot;</span><span class="token punctuation">,</span>
        subdag<span class="token operator">=</span>subdag<span class="token punctuation">(</span>DAG_NAME<span class="token punctuation">,</span> <span class="token string">&quot;section-2&quot;</span><span class="token punctuation">,</span> dag<span class="token punctuation">.</span>default_args<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span>

    end <span class="token operator">=</span> EmptyOperator<span class="token punctuation">(</span>
        task_id<span class="token operator">=</span><span class="token string">&quot;end&quot;</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span>

    start <span class="token operator">&gt;&gt;</span> section_1 <span class="token operator">&gt;&gt;</span> some_other_task <span class="token operator">&gt;&gt;</span> section_2 <span class="token operator">&gt;&gt;</span> end
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>æ‚¨å¯ä»¥ä»ä¸»DAGçš„å›¾å½¢è§†å›¾æ”¾å¤§SubDagOperatorï¼Œä»¥æ˜¾ç¤ºSubDAGä¸­åŒ…å«çš„ä»»åŠ¡ï¼š</p><figure><img src="/assets/subdag_zoom-B2-Mx_fz.png" alt="../_images/subdag_zoom.png" tabindex="0" loading="lazy"><figcaption>../_images/subdag_zoom.png</figcaption></figure><p>ä½¿ç”¨SubDAGæ—¶çš„ä¸€äº›å…¶ä»–æç¤ºï¼š</p><ul><li>æŒ‰ç…§æƒ¯ä¾‹ï¼Œå­dagçš„dag_idåº”è¯¥ä»¥å…¶çˆ¶dagçš„åç§°å’Œä¸€ä¸ªç‚¹ï¼ˆparent.childï¼‰ä¸ºå‰ç¼€</li><li>æ‚¨åº”è¯¥é€šè¿‡å°†å‚æ•°ä¼ é€’ç»™SubDAGè¿ç®—ç¬¦æ¥åœ¨ä¸»DAGå’ŒSubDAGä¹‹é—´å…±äº«å‚æ•°ï¼ˆå¦‚ä¸Šæ‰€ç¤ºï¼‰</li><li>å­DAGå¿…é¡»æœ‰ä¸€ä¸ªæ—¶é—´è¡¨å¹¶å·²å¯ç”¨ã€‚å¦‚æœSubDAGçš„æ—¶é—´è¡¨è®¾ç½®ä¸ºNoneæˆ–@onceï¼Œåˆ™SubDAGå°†åœ¨ä¸æ‰§è¡Œä»»ä½•æ“ä½œçš„æƒ…å†µä¸‹æˆåŠŸã€‚</li><li>æ¸…é™¤SubDagOperatorä¹Ÿä¼šæ¸…é™¤å…¶ä¸­ä»»åŠ¡çš„çŠ¶æ€ã€‚</li><li>åœ¨SubDagOperatorä¸Šæ ‡è®°æˆåŠŸä¸ä¼šå½±å“å…¶ä¸­ä»»åŠ¡çš„çŠ¶æ€ã€‚</li><li>ä¸è¦åœ¨SubDAGä¸­çš„ä»»åŠ¡ä¸­ä½¿ç”¨â€œä¾èµ–äºè¿‡å»â€ï¼Œå› ä¸ºè¿™å¯èƒ½ä¼šä»¤äººå›°æƒ‘ã€‚</li><li>æ‚¨å¯ä»¥ä¸ºSubDAGæŒ‡å®šä¸€ä¸ªæ‰§è¡Œå™¨ã€‚å¦‚æœæ‚¨æƒ³åœ¨è¿›ç¨‹å†…è¿è¡ŒSubDAGå¹¶æœ‰æ•ˆåœ°å°†å…¶å¹¶è¡Œåº¦é™åˆ¶ä¸º1ï¼Œåˆ™é€šå¸¸ä½¿ç”¨SequenceExecutorã€‚ä½¿ç”¨LocalExecutorå¯èƒ½ä¼šæœ‰é—®é¢˜ï¼Œå› ä¸ºå®ƒå¯èƒ½ä¼šè¿‡åº¦è®¢é˜…æ‚¨çš„å·¥ä½œç¨‹åºï¼Œåœ¨ä¸€ä¸ªæ’æ§½ä¸­è¿è¡Œå¤šä¸ªä»»åŠ¡ã€‚</li></ul><h2 id="æ‰“åŒ…dag" tabindex="-1"><a class="header-anchor" href="#æ‰“åŒ…dag"><span>æ‰“åŒ…DAG</span></a></h2><p>è™½ç„¶æ›´ç®€å•çš„DAGé€šå¸¸åªåœ¨ä¸€ä¸ªPythonæ–‡ä»¶ä¸­ï¼Œä½†æ›´å¤æ‚çš„DAGå¯èƒ½åˆ†å¸ƒåœ¨å¤šä¸ªæ–‡ä»¶ä¸­ï¼Œå¹¶å…·æœ‰åº”éšé™„çš„ä¾èµ–é¡¹ï¼ˆâ€œvendoredâ€ï¼‰ï¼Œè¿™å¹¶ä¸ç½•è§ã€‚ æ‚¨å¯ä»¥ä½¿ç”¨æ ‡å‡†æ–‡ä»¶ç³»ç»Ÿå¸ƒå±€åœ¨DAG_FOLDERå†…éƒ¨å®Œæˆè¿™ä¸€åˆ‡ï¼Œä¹Ÿå¯ä»¥å°†DAGåŠå…¶æ‰€æœ‰Pythonæ–‡ä»¶æ‰“åŒ…ä¸ºä¸€ä¸ªzipæ–‡ä»¶ã€‚ä¾‹å¦‚ï¼Œæ‚¨å¯ä»¥å°†ä¸¤ä¸ªDAGä»¥åŠå®ƒä»¬æ‰€éœ€çš„ä¾èµ–é¡¹ä½œä¸ºåŒ…å«ä»¥ä¸‹å†…å®¹çš„zipæ–‡ä»¶ï¼š</p><div class="language-bash line-numbers-mode" data-ext="sh" data-title="sh"><pre class="language-bash"><code>my_dag1.py
my_dag2.py
package1/__init__.py
package1/functions.py
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>è¯·æ³¨æ„ï¼Œæ‰“åŒ…çš„DAGé™„å¸¦ä¸€äº›æ³¨æ„äº‹é¡¹ï¼š</p><ul><li>å¦‚æœä¸ºåºåˆ—åŒ–å¯ç”¨äº†pickling ï¼Œåˆ™ä¸èƒ½ä½¿ç”¨å®ƒä»¬</li><li>å®ƒä»¬ä¸èƒ½åŒ…å«å·²ç¼–è¯‘çš„åº“ï¼ˆä¾‹å¦‚libz.soï¼‰ï¼Œåªèƒ½åŒ…å«çº¯Python</li><li>å®ƒä»¬å°†æ’å…¥Pythonçš„sys.pathä¸­ï¼Œå¹¶ä¸”å¯ä»¥ç”±Airflowè¿›ç¨‹ä¸­çš„ä»»ä½•å…¶ä»–ä»£ç å¯¼å…¥ï¼Œå› æ­¤è¯·ç¡®ä¿åŒ…åç§°ä¸ä¼šä¸ç³»ç»Ÿä¸Šå·²å®‰è£…çš„å…¶ä»–åŒ…å†²çªã€‚</li></ul><p>ä¸€èˆ¬æ¥è¯´ï¼Œå¦‚æœæ‚¨æœ‰ä¸€ç»„å¤æ‚çš„å·²ç¼–è¯‘ä¾èµ–é¡¹å’Œæ¨¡å—ï¼Œé‚£ä¹ˆæœ€å¥½ä½¿ç”¨Python virtualenvç³»ç»Ÿï¼Œå¹¶ä½¿ç”¨pipåœ¨ç›®æ ‡ç³»ç»Ÿä¸Šå®‰è£…å¿…è¦çš„åŒ…ã€‚</p><h2 id="dag-ä¾èµ–" tabindex="-1"><a class="header-anchor" href="#dag-ä¾èµ–"><span>DAG ä¾èµ–</span></a></h2><p>è™½ç„¶DAGä¸­ä»»åŠ¡ä¹‹é—´çš„ä¾èµ–å…³ç³»æ˜¯é€šè¿‡ä¸Šæ¸¸å’Œä¸‹æ¸¸å…³ç³»æ˜ç¡®å®šä¹‰çš„ï¼Œä½†DAGä¹‹é—´çš„ä¾èµ–æ€§æœ‰ç‚¹å¤æ‚ã€‚é€šå¸¸ï¼Œæœ‰ä¸¤ç§æ–¹å¼å¯ä»¥ä½¿ä¸€ä¸ªDAGä¾èµ–äºå¦ä¸€ä¸ªï¼š</p><ul><li>triggering - <a href="https://airflow.apache.org/docs/apache-airflow/stable/_api/airflow/operators/trigger_dagrun/index.html#airflow.operators.trigger_dagrun.TriggerDagRunOperator" target="_blank" rel="noopener noreferrer"><code>TriggerDagRunOperator</code><span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></li><li>waiting - <code>ExternalTaskSensor</code></li></ul><p>å¦å¤–çš„å›°éš¾æ˜¯ï¼Œä¸€ä¸ªDAGå¯èƒ½ä¼šç­‰å¾…æˆ–è§¦å‘å…·æœ‰ä¸åŒæ•°æ®é—´éš”çš„å…¶ä»–DAGçš„å¤šæ¬¡è¿è¡Œã€‚Dagä¾èµ–å…³ç³»è§†å›¾èœå•-&gt;æµè§ˆ-&gt;Dagä¾èµ–å…³ç³»æœ‰åŠ©äºå¯è§†åŒ–Dagä¹‹é—´çš„ä¾èµ–å…³ç³»ã€‚ä¾èµ–å…³ç³»ç”±è°ƒåº¦ç¨‹åºåœ¨DAGåºåˆ—åŒ–æœŸé—´è®¡ç®—ï¼ŒWebæœåŠ¡å™¨ä½¿ç”¨å®ƒä»¬æ¥æ„å»ºä¾èµ–å…³ç³»å›¾ã€‚</p><p>ä¾èµ–æ£€æµ‹å™¨æ˜¯å¯é…ç½®çš„ï¼Œå› æ­¤æ‚¨å¯ä»¥å®ç°è‡ªå·±çš„é€»è¾‘ï¼Œè€Œä¸æ˜¯DependencyDetectorä¸­çš„é»˜è®¤é€»è¾‘</p><h2 id="dagæš‚åœã€åœç”¨å’Œåˆ é™¤" tabindex="-1"><a class="header-anchor" href="#dagæš‚åœã€åœç”¨å’Œåˆ é™¤"><span>DAGæš‚åœã€åœç”¨å’Œåˆ é™¤</span></a></h2><p>å½“æ¶‰åŠåˆ°â€œæœªè¿è¡Œâ€æ—¶ï¼ŒDAGæœ‰å‡ ç§çŠ¶æ€ã€‚DAGå¯ä»¥æš‚åœã€åœç”¨ï¼Œæœ€åå¯ä»¥åˆ é™¤DAGçš„æ‰€æœ‰å…ƒæ•°æ®ã€‚</p><p>å½“Dagå­˜åœ¨äºDAGS_FOLDERä¸­æ—¶ï¼Œå¯ä»¥é€šè¿‡UIæš‚åœå®ƒï¼Œè°ƒåº¦å™¨å°†å…¶å­˜å‚¨åœ¨æ•°æ®åº“ä¸­ï¼Œä½†ç”¨æˆ·é€‰æ‹©é€šè¿‡UIç¦ç”¨å®ƒã€‚â€œæš‚åœâ€å’Œâ€œå–æ¶ˆæš‚åœâ€æ“ä½œå¯é€šè¿‡UIå’ŒAPIä½¿ç”¨ã€‚è®¡åˆ’ç¨‹åºä¸å®‰æ’æš‚åœçš„DAGï¼Œä½†æ‚¨å¯ä»¥é€šè¿‡UIè§¦å‘å®ƒä»¬ä»¥è¿›è¡Œæ‰‹åŠ¨è¿è¡Œã€‚åœ¨UIä¸­ï¼Œæ‚¨å¯ä»¥çœ‹åˆ°Paused DAGï¼ˆåœ¨Pausedé€‰é¡¹å¡ä¸­ï¼‰ã€‚æœªæš‚åœçš„DAGå¯ä»¥åœ¨æ´»åŠ¨é€‰é¡¹å¡ä¸­æ‰¾åˆ°ã€‚</p><p>Dagå¯ä»¥é€šè¿‡ä»DAGS_FOLDERä¸­åˆ é™¤æ¥åœç”¨ï¼ˆä¸è¦å°†å…¶ä¸UIä¸­çš„Activeæ ‡è®°æ··æ·†ï¼‰ã€‚å½“è°ƒåº¦å™¨è§£æDAGS_FOLDERå¹¶é”™è¿‡å®ƒä¹‹å‰çœ‹åˆ°å¹¶å­˜å‚¨åœ¨æ•°æ®åº“ä¸­çš„DAGæ—¶ï¼Œå®ƒå°†è®¾ç½®ä¸ºåœç”¨ã€‚DAGçš„å…ƒæ•°æ®å’Œå†å²è®°å½•ä¸ºåœç”¨çš„DAGä¿ç•™ï¼Œå½“DAGè¢«é‡æ–°æ·»åŠ åˆ°DAGs_FOLDERæ—¶ï¼Œå®ƒå°†å†æ¬¡è¢«æ¿€æ´»ï¼Œå†å²è®°å½•å°†å¯è§ã€‚ä¸èƒ½é€šè¿‡UIæˆ–APIæ¿€æ´»/åœç”¨DAGï¼Œåªèƒ½é€šè¿‡ä»DAGS_FOLDERä¸­åˆ é™¤æ–‡ä»¶æ¥å®Œæˆã€‚å†ä¸€æ¬¡ï¼Œå½“è°ƒåº¦ç¨‹åºåœç”¨DAGæ—¶ï¼ŒDAGå†å²è¿è¡Œçš„æ•°æ®ä¸ä¼šä¸¢å¤±ã€‚è¯·æ³¨æ„ï¼Œæ°”æµUIä¸­çš„â€œæ´»åŠ¨â€é€‰é¡¹å¡æŒ‡çš„æ˜¯æœªæ¿€æ´»å’Œæœªæš‚åœçš„DAGï¼Œå› æ­¤æœ€åˆå¯èƒ½ä¼šæœ‰ç‚¹æ··ä¹±ã€‚</p><p>ä½ åœ¨UIä¸­çœ‹ä¸åˆ°åœç”¨çš„DAGâ€”â€”æœ‰æ—¶ä½ å¯ä»¥çœ‹åˆ°å†å²è¿è¡Œï¼Œä½†å½“ä½ è¯•å›¾æŸ¥çœ‹è¿™äº›DAGçš„ä¿¡æ¯æ—¶ï¼Œä½ ä¼šçœ‹åˆ°DAGä¸¢å¤±çš„é”™è¯¯ã€‚</p><p>æ‚¨ä¹Ÿå¯ä»¥ä½¿ç”¨UIæˆ–APIä»å…ƒæ•°æ®æ•°æ®åº“ä¸­åˆ é™¤DAGå…ƒæ•°æ®ï¼Œä½†è¿™å¹¶ä¸æ€»æ˜¯å¯¼è‡´DAGä»UIä¸­æ¶ˆå¤±-è¿™åœ¨æœ€åˆå¯èƒ½ä¹Ÿæœ‰ç‚¹ä»¤äººå›°æƒ‘ã€‚å¦‚æœåˆ é™¤å…ƒæ•°æ®æ—¶DAGä»åœ¨DAGS_FOLDERä¸­ï¼Œåˆ™DAGå°†é‡æ–°å‡ºç°ï¼Œå› ä¸ºSchedulerå°†è§£ææ–‡ä»¶å¤¹ï¼Œåªåˆ é™¤DAGçš„å†å²è¿è¡Œä¿¡æ¯ã€‚</p><p>è¿™ä¸€åˆ‡éƒ½æ„å‘³ç€ï¼Œå¦‚æœä½ æƒ³çœŸæ­£åˆ é™¤DAGåŠå…¶æ‰€æœ‰å†å²å…ƒæ•°æ®ï¼Œä½ éœ€è¦åˆ†ä¸‰ä¸ªæ­¥éª¤æ¥å®Œæˆï¼š</p><ol><li>æš‚åœDAG</li><li>é€šè¿‡UIæˆ–APIä»æ•°æ®åº“ä¸­åˆ é™¤å†å²å…ƒæ•°æ®</li><li>ä»DAGS_FOLDERä¸­åˆ é™¤DAGæ–‡ä»¶ï¼Œå¹¶ç­‰å¾…å®ƒå˜ä¸ºéæ´»åŠ¨çŠ¶æ€</li></ol><h1 id="executor" tabindex="-1"><a class="header-anchor" href="#executor"><span>Executor</span></a></h1><p>airflowä¸€æ¬¡åªèƒ½é…ç½®ä¸€ä¸ªæ‰§è¡Œå™¨ï¼›è¿™æ˜¯ç”±é…ç½®æ–‡ä»¶çš„[core]éƒ¨åˆ†ä¸­çš„executoré€‰é¡¹è®¾ç½®çš„ã€‚å†…ç½®æ‰§è¡Œå™¨é€šè¿‡åç§°è¿›è¡Œå¼•ç”¨ï¼Œä¾‹å¦‚ï¼š</p><div class="language-bash line-numbers-mode" data-ext="sh" data-title="sh"><pre class="language-bash"><code><span class="token punctuation">[</span>core<span class="token punctuation">]</span>
executor <span class="token operator">=</span> KubernetesExecutor
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p>å¦‚æœæ‚¨æƒ³æ£€æŸ¥å½“å‰è®¾ç½®äº†å“ªä¸ªæ‰§è¡Œå™¨ï¼š</p><div class="language-bash line-numbers-mode" data-ext="sh" data-title="sh"><pre class="language-bash"><code>$ airflow config get-value core executor
SequentialExecutor
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="ç±»å‹" tabindex="-1"><a class="header-anchor" href="#ç±»å‹"><span>ç±»å‹</span></a></h2><p>æœ‰ä¸¤ç§ç±»å‹çš„æ‰§è¡Œå™¨ï¼š</p><ul><li>åœ¨æœ¬åœ°è¿è¡Œä»»åŠ¡ï¼ˆåœ¨è°ƒåº¦ç¨‹åºè¿›ç¨‹å†…ï¼‰</li><li>è¿œç¨‹è¿è¡Œä»»åŠ¡ï¼ˆé€šå¸¸é€šè¿‡å·¥ä½œçº¿ç¨‹æ± ï¼‰ã€‚</li></ul><p>é»˜è®¤æƒ…å†µä¸‹ï¼ŒAirflowé…ç½®æœ‰SequenceExecutorï¼Œè¿™æ˜¯ä¸€ä¸ªæœ¬åœ°æ‰§è¡Œå™¨ï¼Œä¹Ÿæ˜¯æœ€å®‰å…¨çš„æ‰§è¡Œé€‰é¡¹ï¼Œä½†æˆ‘ä»¬å¼ºçƒˆå»ºè®®æ‚¨å°†å…¶æ›´æ”¹ä¸ºå°å‹å•æœºå®‰è£…çš„LocalExecutoræˆ–å¤šæœº/äº‘å®‰è£…çš„è¿œç¨‹æ‰§è¡Œå™¨ä¹‹ä¸€ã€‚</p><p><strong>Local Executors</strong></p><ul><li><a href="https://airflow.apache.org/docs/apache-airflow/stable/core-concepts/executor/debug.html" target="_blank" rel="noopener noreferrer">Testing DAGs with dag.test()<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></li><li><a href="https://airflow.apache.org/docs/apache-airflow/stable/core-concepts/executor/debug.html#debugging-airflow-dags-on-the-command-line" target="_blank" rel="noopener noreferrer">Debugging Airflow DAGs on the command line<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></li><li><a href="https://airflow.apache.org/docs/apache-airflow/stable/core-concepts/executor/debug.html#debug-executor-deprecated" target="_blank" rel="noopener noreferrer">Debug Executor (deprecated)<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></li><li><a href="https://airflow.apache.org/docs/apache-airflow/stable/core-concepts/executor/local.html" target="_blank" rel="noopener noreferrer">Local Executor<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></li><li><a href="https://airflow.apache.org/docs/apache-airflow/stable/core-concepts/executor/sequential.html" target="_blank" rel="noopener noreferrer">Sequential Executor<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></li></ul><p><strong>Remote Executors</strong></p><ul><li><a href="https://airflow.apache.org/docs/apache-airflow/stable/core-concepts/executor/celery.html" target="_blank" rel="noopener noreferrer">Celery Executor<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></li><li><a href="https://airflow.apache.org/docs/apache-airflow/stable/core-concepts/executor/celery_kubernetes.html" target="_blank" rel="noopener noreferrer">CeleryKubernetes Executor<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></li><li><a href="https://airflow.apache.org/docs/apache-airflow/stable/core-concepts/executor/dask.html" target="_blank" rel="noopener noreferrer">Dask Executor<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></li><li><a href="https://airflow.apache.org/docs/apache-airflow/stable/core-concepts/executor/kubernetes.html" target="_blank" rel="noopener noreferrer">Kubernetes Executor<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></li><li><a href="https://airflow.apache.org/docs/apache-airflow/stable/core-concepts/executor/local_kubernetes.html" target="_blank" rel="noopener noreferrer">LocalKubernetes Executor<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></li></ul><h2 id="kubernetes-executor" tabindex="-1"><a class="header-anchor" href="#kubernetes-executor"><span>Kubernetes Executor</span></a></h2><p>Kubernetesæ‰§è¡Œå™¨åœ¨Kuberneteé›†ç¾¤ä¸Šè‡ªå·±çš„podä¸­è¿è¡Œæ¯ä¸ªä»»åŠ¡å®ä¾‹ã€‚</p><p>KubernetesExecutoråœ¨Airflow Schedulerä¸­ä½œä¸ºä¸€ä¸ªè¿›ç¨‹è¿è¡Œã€‚è°ƒåº¦å™¨æœ¬èº«ä¸ä¸€å®šéœ€è¦åœ¨Kubernetesä¸Šè¿è¡Œï¼Œä½†ç¡®å®éœ€è¦è®¿é—®Kuberneteé›†ç¾¤ã€‚</p><p>KubernetesExecutoråœ¨åç«¯éœ€è¦ä¸€ä¸ªésqliteæ•°æ®åº“ã€‚</p><p>å½“DAGæäº¤ä»»åŠ¡æ—¶ï¼ŒKubernetesExecutorä»Kubernetes APIè¯·æ±‚ä¸€ä¸ªworker podã€‚ç„¶åworker podè¿è¡Œä»»åŠ¡ï¼ŒæŠ¥å‘Šç»“æœå¹¶ç»ˆæ­¢ã€‚</p><figure><img src="/assets/arch-diag-kubernetes-06VkmkmB.png" alt="../../_images/arch-diag-kubernetes.png" tabindex="0" loading="lazy"><figcaption>../../_images/arch-diag-kubernetes.png</figcaption></figure><p>ä¸‹é¢æ˜¾ç¤ºäº†åœ¨Kubernetesé›†ç¾¤ä¸­äº”ä¸ªèŠ‚ç‚¹çš„åˆ†å¸ƒå¼é›†åˆä¸Šè¿è¡Œçš„Airflowéƒ¨ç½²çš„ä¸€ä¸ªç¤ºä¾‹ï¼š</p><figure><img src="/assets/arch-diag-kubernetes2-CXf74wU-.png" alt="../../_images/arch-diag-kubernetes2.png" tabindex="0" loading="lazy"><figcaption>../../_images/arch-diag-kubernetes2.png</figcaption></figure><p>ä¸å¸¸è§„Airflowä½“ç³»ç»“æ„ä¸€è‡´ï¼ŒWorkerséœ€è¦è®¿é—®DAGæ–‡ä»¶ï¼Œä»¥æ‰§è¡Œè¿™äº›DAGä¸­çš„ä»»åŠ¡å¹¶ä¸å…ƒæ•°æ®å­˜å‚¨åº“äº¤äº’ã€‚æ­¤å¤–ï¼Œéœ€è¦åœ¨Airflowé…ç½®æ–‡ä»¶ä¸­æŒ‡å®šç‰¹å®šäºKubernetes Executorçš„é…ç½®ä¿¡æ¯ï¼Œå¦‚å·¥ä½œå‘½åç©ºé—´å’Œæ˜ åƒä¿¡æ¯ã€‚</p><p>æ­¤å¤–ï¼ŒKubernetes Executorå…è®¸ä½¿ç”¨Executoré…ç½®åœ¨æ¯ä¸ªä»»åŠ¡çš„åŸºç¡€ä¸ŠæŒ‡å®šé™„åŠ åŠŸèƒ½ã€‚</p><figure><img src="/assets/k8s-happy-path-BG-R5Say.png" alt="../../_images/k8s-happy-path.png" tabindex="0" loading="lazy"><figcaption>../../_images/k8s-happy-path.png</figcaption></figure><h3 id="ä¸»è¦é…ç½®" tabindex="-1"><a class="header-anchor" href="#ä¸»è¦é…ç½®"><span>ä¸»è¦é…ç½®</span></a></h3><ul><li>pod_template_fileï¼šè¦è‡ªå®šä¹‰ç”¨äºk8sæ‰§è¡Œå™¨å·¥ä½œè¿›ç¨‹çš„podï¼Œå¯ä»¥åˆ›å»ºä¸€ä¸ªpodæ¨¡æ¿æ–‡ä»¶ã€‚æ‚¨å¿…é¡»åœ¨airflow.cfgçš„kubernetes_executoréƒ¨åˆ†çš„pod_template_fileé€‰é¡¹ä¸­æä¾›æ¨¡æ¿æ–‡ä»¶çš„è·¯å¾„ã€‚Airflowå¯¹podæ¨¡æ¿æ–‡ä»¶æœ‰ä¸¤ä¸ªä¸¥æ ¼çš„è¦æ±‚ï¼šåŸºç¡€é•œåƒå’Œpodåç§°ã€‚</li><li>åŸºç¡€é•œåƒï¼špod_template_fileå¿…é¡»åœ¨spec.channels[0]ä½ç½®æœ‰ä¸€ä¸ªåä¸ºbaseçš„å®¹å™¨ï¼Œå¹¶ä¸”å¿…é¡»æŒ‡å®šå…¶æ˜ åƒã€‚æ‚¨å¯ä»¥åœ¨è¯¥å¿…éœ€å®¹å™¨ä¹‹åè‡ªç”±åˆ›å»ºsidecarå®¹å™¨ï¼Œä½†Airflowå‡å®šè¾…åŠ©å®¹å™¨å­˜åœ¨äºå®¹å™¨é˜µåˆ—çš„å¼€å¤´ï¼Œå¹¶å‡å®šå®¹å™¨å‘½åä¸ºbaseã€‚</li><li>podåç§°ï¼špodçš„å…ƒæ•°æ®åç§°å¿…é¡»åœ¨æ¨¡æ¿æ–‡ä»¶ä¸­è®¾ç½®ã€‚è¯¥å­—æ®µå°†å§‹ç»ˆåœ¨podå¯åŠ¨æ—¶åŠ¨æ€è®¾ç½®ï¼Œä»¥ç¡®ä¿æ‰€æœ‰podçš„å”¯ä¸€æ€§ã€‚ä½†æ˜¯ï¼Œå®ƒå¿…é¡»åŒ…å«åœ¨æ¨¡æ¿ä¸­ï¼Œä¸èƒ½ç•™ç©ºã€‚</li></ul><div class="language-yaml line-numbers-mode" data-ext="yml" data-title="yml"><pre class="language-yaml"><code><span class="token punctuation">---</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Pod
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> placeholder<span class="token punctuation">-</span>name
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">containers</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">env</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> AIRFLOW__CORE__EXECUTOR
          <span class="token key atrule">value</span><span class="token punctuation">:</span> LocalExecutor
        <span class="token comment"># Hard Coded Airflow Envs</span>
        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> AIRFLOW__CORE__FERNET_KEY
          <span class="token key atrule">valueFrom</span><span class="token punctuation">:</span>
            <span class="token key atrule">secretKeyRef</span><span class="token punctuation">:</span>
              <span class="token key atrule">name</span><span class="token punctuation">:</span> RELEASE<span class="token punctuation">-</span>NAME<span class="token punctuation">-</span>fernet<span class="token punctuation">-</span>key
              <span class="token key atrule">key</span><span class="token punctuation">:</span> fernet<span class="token punctuation">-</span>key
        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> AIRFLOW__DATABASE__SQL_ALCHEMY_CONN
          <span class="token key atrule">valueFrom</span><span class="token punctuation">:</span>
            <span class="token key atrule">secretKeyRef</span><span class="token punctuation">:</span>
              <span class="token key atrule">name</span><span class="token punctuation">:</span> RELEASE<span class="token punctuation">-</span>NAME<span class="token punctuation">-</span>airflow<span class="token punctuation">-</span>metadata
              <span class="token key atrule">key</span><span class="token punctuation">:</span> connection
        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> AIRFLOW_CONN_AIRFLOW_DB
          <span class="token key atrule">valueFrom</span><span class="token punctuation">:</span>
            <span class="token key atrule">secretKeyRef</span><span class="token punctuation">:</span>
              <span class="token key atrule">name</span><span class="token punctuation">:</span> RELEASE<span class="token punctuation">-</span>NAME<span class="token punctuation">-</span>airflow<span class="token punctuation">-</span>metadata
              <span class="token key atrule">key</span><span class="token punctuation">:</span> connection
      <span class="token key atrule">image</span><span class="token punctuation">:</span> dummy_image
      <span class="token key atrule">imagePullPolicy</span><span class="token punctuation">:</span> IfNotPresent
      <span class="token key atrule">name</span><span class="token punctuation">:</span> base
      <span class="token key atrule">volumeMounts</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> <span class="token string">&quot;/opt/airflow/logs&quot;</span>
          <span class="token key atrule">name</span><span class="token punctuation">:</span> airflow<span class="token punctuation">-</span>logs
        <span class="token punctuation">-</span> <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /opt/airflow/airflow.cfg
          <span class="token key atrule">name</span><span class="token punctuation">:</span> airflow<span class="token punctuation">-</span>config
          <span class="token key atrule">readOnly</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
          <span class="token key atrule">subPath</span><span class="token punctuation">:</span> airflow.cfg
  <span class="token key atrule">restartPolicy</span><span class="token punctuation">:</span> Never
  <span class="token key atrule">securityContext</span><span class="token punctuation">:</span>
    <span class="token key atrule">runAsUser</span><span class="token punctuation">:</span> <span class="token number">50000</span>
    <span class="token key atrule">fsGroup</span><span class="token punctuation">:</span> <span class="token number">50000</span>
  <span class="token key atrule">serviceAccountName</span><span class="token punctuation">:</span> <span class="token string">&quot;RELEASE-NAME-worker-serviceaccount&quot;</span>
  <span class="token key atrule">volumes</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">emptyDir</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
      <span class="token key atrule">name</span><span class="token punctuation">:</span> airflow<span class="token punctuation">-</span>logs
    <span class="token punctuation">-</span> <span class="token key atrule">configMap</span><span class="token punctuation">:</span>
        <span class="token key atrule">name</span><span class="token punctuation">:</span> RELEASE<span class="token punctuation">-</span>NAME<span class="token punctuation">-</span>airflow<span class="token punctuation">-</span>config
      <span class="token key atrule">name</span><span class="token punctuation">:</span> airflow<span class="token punctuation">-</span>config
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="åœ¨æŒä¹…å·ä¸­å­˜å‚¨dag" tabindex="-1"><a class="header-anchor" href="#åœ¨æŒä¹…å·ä¸­å­˜å‚¨dag"><span>åœ¨æŒä¹…å·ä¸­å­˜å‚¨DAGï¼š</span></a></h3><div class="language-yaml line-numbers-mode" data-ext="yml" data-title="yml"><pre class="language-yaml"><code><span class="token punctuation">---</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Pod
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> placeholder<span class="token punctuation">-</span>name
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">containers</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">env</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> AIRFLOW__CORE__EXECUTOR
          <span class="token key atrule">value</span><span class="token punctuation">:</span> LocalExecutor
        <span class="token comment"># Hard Coded Airflow Envs</span>
        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> AIRFLOW__CORE__FERNET_KEY
          <span class="token key atrule">valueFrom</span><span class="token punctuation">:</span>
            <span class="token key atrule">secretKeyRef</span><span class="token punctuation">:</span>
              <span class="token key atrule">name</span><span class="token punctuation">:</span> RELEASE<span class="token punctuation">-</span>NAME<span class="token punctuation">-</span>fernet<span class="token punctuation">-</span>key
              <span class="token key atrule">key</span><span class="token punctuation">:</span> fernet<span class="token punctuation">-</span>key
        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> AIRFLOW__DATABASE__SQL_ALCHEMY_CONN
          <span class="token key atrule">valueFrom</span><span class="token punctuation">:</span>
            <span class="token key atrule">secretKeyRef</span><span class="token punctuation">:</span>
              <span class="token key atrule">name</span><span class="token punctuation">:</span> RELEASE<span class="token punctuation">-</span>NAME<span class="token punctuation">-</span>airflow<span class="token punctuation">-</span>metadata
              <span class="token key atrule">key</span><span class="token punctuation">:</span> connection
        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> AIRFLOW_CONN_AIRFLOW_DB
          <span class="token key atrule">valueFrom</span><span class="token punctuation">:</span>
            <span class="token key atrule">secretKeyRef</span><span class="token punctuation">:</span>
              <span class="token key atrule">name</span><span class="token punctuation">:</span> RELEASE<span class="token punctuation">-</span>NAME<span class="token punctuation">-</span>airflow<span class="token punctuation">-</span>metadata
              <span class="token key atrule">key</span><span class="token punctuation">:</span> connection
      <span class="token key atrule">image</span><span class="token punctuation">:</span> dummy_image
      <span class="token key atrule">imagePullPolicy</span><span class="token punctuation">:</span> IfNotPresent
      <span class="token key atrule">name</span><span class="token punctuation">:</span> base
      <span class="token key atrule">volumeMounts</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> <span class="token string">&quot;/opt/airflow/logs&quot;</span>
          <span class="token key atrule">name</span><span class="token punctuation">:</span> airflow<span class="token punctuation">-</span>logs
        <span class="token punctuation">-</span> <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /opt/airflow/dags
          <span class="token key atrule">name</span><span class="token punctuation">:</span> airflow<span class="token punctuation">-</span>dags
          <span class="token key atrule">readOnly</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
        <span class="token punctuation">-</span> <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /opt/airflow/airflow.cfg
          <span class="token key atrule">name</span><span class="token punctuation">:</span> airflow<span class="token punctuation">-</span>config
          <span class="token key atrule">readOnly</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
          <span class="token key atrule">subPath</span><span class="token punctuation">:</span> airflow.cfg
  <span class="token key atrule">restartPolicy</span><span class="token punctuation">:</span> Never
  <span class="token key atrule">securityContext</span><span class="token punctuation">:</span>
    <span class="token key atrule">runAsUser</span><span class="token punctuation">:</span> <span class="token number">50000</span>
    <span class="token key atrule">fsGroup</span><span class="token punctuation">:</span> <span class="token number">50000</span>
  <span class="token key atrule">serviceAccountName</span><span class="token punctuation">:</span> <span class="token string">&quot;RELEASE-NAME-worker-serviceaccount&quot;</span>
  <span class="token key atrule">volumes</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> airflow<span class="token punctuation">-</span>dags
      <span class="token key atrule">persistentVolumeClaim</span><span class="token punctuation">:</span>
        <span class="token key atrule">claimName</span><span class="token punctuation">:</span> RELEASE<span class="token punctuation">-</span>NAME<span class="token punctuation">-</span>dags
    <span class="token punctuation">-</span> <span class="token key atrule">emptyDir</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
      <span class="token key atrule">name</span><span class="token punctuation">:</span> airflow<span class="token punctuation">-</span>logs
    <span class="token punctuation">-</span> <span class="token key atrule">configMap</span><span class="token punctuation">:</span>
        <span class="token key atrule">name</span><span class="token punctuation">:</span> RELEASE<span class="token punctuation">-</span>NAME<span class="token punctuation">-</span>airflow<span class="token punctuation">-</span>config
      <span class="token key atrule">name</span><span class="token punctuation">:</span> airflow<span class="token punctuation">-</span>config
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="ä»gitä¸­æå–dag" tabindex="-1"><a class="header-anchor" href="#ä»gitä¸­æå–dag"><span>ä»gitä¸­æå–DAG:</span></a></h3><div class="language-yaml line-numbers-mode" data-ext="yml" data-title="yml"><pre class="language-yaml"><code><span class="token punctuation">---</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Pod
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> dummy<span class="token punctuation">-</span>name
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">initContainers</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> git<span class="token punctuation">-</span>sync
      <span class="token key atrule">image</span><span class="token punctuation">:</span> <span class="token string">&quot;registry.k8s.io/git-sync/git-sync:v3.6.3&quot;</span>
      <span class="token key atrule">env</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> GIT_SYNC_BRANCH
          <span class="token key atrule">value</span><span class="token punctuation">:</span> <span class="token string">&quot;v2-2-stable&quot;</span>
        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> GIT_SYNC_REPO
          <span class="token key atrule">value</span><span class="token punctuation">:</span> <span class="token string">&quot;https://github.com/apache/airflow.git&quot;</span>
        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> GIT_SYNC_DEPTH
          <span class="token key atrule">value</span><span class="token punctuation">:</span> <span class="token string">&quot;1&quot;</span>
        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> GIT_SYNC_ROOT
          <span class="token key atrule">value</span><span class="token punctuation">:</span> <span class="token string">&quot;/git&quot;</span>
        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> GIT_SYNC_DEST
          <span class="token key atrule">value</span><span class="token punctuation">:</span> <span class="token string">&quot;repo&quot;</span>
        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> GIT_SYNC_ADD_USER
          <span class="token key atrule">value</span><span class="token punctuation">:</span> <span class="token string">&quot;true&quot;</span>
        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> GIT_SYNC_ONE_TIME
          <span class="token key atrule">value</span><span class="token punctuation">:</span> <span class="token string">&quot;true&quot;</span>
      <span class="token key atrule">volumeMounts</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> airflow<span class="token punctuation">-</span>dags
          <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /git
  <span class="token key atrule">containers</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">env</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> AIRFLOW__CORE__EXECUTOR
          <span class="token key atrule">value</span><span class="token punctuation">:</span> LocalExecutor
        <span class="token comment"># Hard Coded Airflow Envs</span>
        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> AIRFLOW__CORE__FERNET_KEY
          <span class="token key atrule">valueFrom</span><span class="token punctuation">:</span>
            <span class="token key atrule">secretKeyRef</span><span class="token punctuation">:</span>
              <span class="token key atrule">name</span><span class="token punctuation">:</span> RELEASE<span class="token punctuation">-</span>NAME<span class="token punctuation">-</span>fernet<span class="token punctuation">-</span>key
              <span class="token key atrule">key</span><span class="token punctuation">:</span> fernet<span class="token punctuation">-</span>key
        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> AIRFLOW__DATABASE__SQL_ALCHEMY_CONN
          <span class="token key atrule">valueFrom</span><span class="token punctuation">:</span>
            <span class="token key atrule">secretKeyRef</span><span class="token punctuation">:</span>
              <span class="token key atrule">name</span><span class="token punctuation">:</span> RELEASE<span class="token punctuation">-</span>NAME<span class="token punctuation">-</span>airflow<span class="token punctuation">-</span>metadata
              <span class="token key atrule">key</span><span class="token punctuation">:</span> connection
        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> AIRFLOW_CONN_AIRFLOW_DB
          <span class="token key atrule">valueFrom</span><span class="token punctuation">:</span>
            <span class="token key atrule">secretKeyRef</span><span class="token punctuation">:</span>
              <span class="token key atrule">name</span><span class="token punctuation">:</span> RELEASE<span class="token punctuation">-</span>NAME<span class="token punctuation">-</span>airflow<span class="token punctuation">-</span>metadata
              <span class="token key atrule">key</span><span class="token punctuation">:</span> connection
      <span class="token key atrule">image</span><span class="token punctuation">:</span> dummy_image
      <span class="token key atrule">imagePullPolicy</span><span class="token punctuation">:</span> IfNotPresent
      <span class="token key atrule">name</span><span class="token punctuation">:</span> base
      <span class="token key atrule">volumeMounts</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> <span class="token string">&quot;/opt/airflow/logs&quot;</span>
          <span class="token key atrule">name</span><span class="token punctuation">:</span> airflow<span class="token punctuation">-</span>logs
        <span class="token punctuation">-</span> <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /opt/airflow/dags
          <span class="token key atrule">name</span><span class="token punctuation">:</span> airflow<span class="token punctuation">-</span>dags
          <span class="token key atrule">subPath</span><span class="token punctuation">:</span> repo/airflow/example_dags
          <span class="token key atrule">readOnly</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>
        <span class="token punctuation">-</span> <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /opt/airflow/airflow.cfg
          <span class="token key atrule">name</span><span class="token punctuation">:</span> airflow<span class="token punctuation">-</span>config
          <span class="token key atrule">readOnly</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
          <span class="token key atrule">subPath</span><span class="token punctuation">:</span> airflow.cfg
  <span class="token key atrule">restartPolicy</span><span class="token punctuation">:</span> Never
  <span class="token key atrule">securityContext</span><span class="token punctuation">:</span>
    <span class="token key atrule">runAsUser</span><span class="token punctuation">:</span> <span class="token number">50000</span>
    <span class="token key atrule">fsGroup</span><span class="token punctuation">:</span> <span class="token number">50000</span>
  <span class="token key atrule">serviceAccountName</span><span class="token punctuation">:</span> <span class="token string">&quot;RELEASE-NAME-worker-serviceaccount&quot;</span>
  <span class="token key atrule">volumes</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> airflow<span class="token punctuation">-</span>dags
      <span class="token key atrule">emptyDir</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> airflow<span class="token punctuation">-</span>logs
      <span class="token key atrule">emptyDir</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
    <span class="token punctuation">-</span> <span class="token key atrule">configMap</span><span class="token punctuation">:</span>
        <span class="token key atrule">name</span><span class="token punctuation">:</span> RELEASE<span class="token punctuation">-</span>NAME<span class="token punctuation">-</span>airflow<span class="token punctuation">-</span>config
      <span class="token key atrule">name</span><span class="token punctuation">:</span> airflow<span class="token punctuation">-</span>config
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="podè¦†ç›–" tabindex="-1"><a class="header-anchor" href="#podè¦†ç›–"><span>podè¦†ç›–</span></a></h3><p>å½“ä½¿ç”¨KubernetesExecutoræ—¶ï¼ŒAirflowæä¾›äº†åœ¨æ¯ä¸ªä»»åŠ¡çš„åŸºç¡€ä¸Šè¦†ç›–ç³»ç»Ÿé»˜è®¤å€¼çš„èƒ½åŠ›ã€‚è¦ä½¿ç”¨æ­¤åŠŸèƒ½ï¼Œè¯·åˆ›å»ºä¸€ä¸ªKubernetes V1podå¯¹è±¡å¹¶å¡«å†™æ‰€éœ€çš„è¦†ç›–ã€‚è¯·æ³¨æ„ï¼Œåœ¨å¯åŠ¨V1podä¹‹å‰ï¼Œè°ƒåº¦ç¨‹åºå°†è¦†ç›–å®ƒçš„metadata.nameå’Œcontainer[0].argsã€‚</p><p>è¦è¦†ç›–KubernetesExecutorå¯åŠ¨çš„podçš„åŸºæœ¬å®¹å™¨ï¼Œè¯·åˆ›å»ºä¸€ä¸ªå¸¦æœ‰å•ä¸ªå®¹å™¨çš„V1podï¼Œå¹¶æŒ‰å¦‚ä¸‹æ–¹å¼è¦†ç›–å­—æ®µï¼š</p><div class="language-python line-numbers-mode" data-ext="py" data-title="py"><pre class="language-python"><code>        executor_config_volume_mount <span class="token operator">=</span> <span class="token punctuation">{</span>
            <span class="token string">&quot;pod_override&quot;</span><span class="token punctuation">:</span> k8s<span class="token punctuation">.</span>V1Pod<span class="token punctuation">(</span>
                spec<span class="token operator">=</span>k8s<span class="token punctuation">.</span>V1PodSpec<span class="token punctuation">(</span>
                    containers<span class="token operator">=</span><span class="token punctuation">[</span>
                        k8s<span class="token punctuation">.</span>V1Container<span class="token punctuation">(</span>
                            name<span class="token operator">=</span><span class="token string">&quot;base&quot;</span><span class="token punctuation">,</span>
                            volume_mounts<span class="token operator">=</span><span class="token punctuation">[</span>
                                k8s<span class="token punctuation">.</span>V1VolumeMount<span class="token punctuation">(</span>mount_path<span class="token operator">=</span><span class="token string">&quot;/foo/&quot;</span><span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">&quot;example-kubernetes-test-volume&quot;</span><span class="token punctuation">)</span>
                            <span class="token punctuation">]</span><span class="token punctuation">,</span>
                        <span class="token punctuation">)</span>
                    <span class="token punctuation">]</span><span class="token punctuation">,</span>
                    volumes<span class="token operator">=</span><span class="token punctuation">[</span>
                        k8s<span class="token punctuation">.</span>V1Volume<span class="token punctuation">(</span>
                            name<span class="token operator">=</span><span class="token string">&quot;example-kubernetes-test-volume&quot;</span><span class="token punctuation">,</span>
                            host_path<span class="token operator">=</span>k8s<span class="token punctuation">.</span>V1HostPathVolumeSource<span class="token punctuation">(</span>path<span class="token operator">=</span><span class="token string">&quot;/tmp/&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                        <span class="token punctuation">)</span>
                    <span class="token punctuation">]</span><span class="token punctuation">,</span>
                <span class="token punctuation">)</span>
            <span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span>

        <span class="token decorator annotation punctuation">@task</span><span class="token punctuation">(</span>executor_config<span class="token operator">=</span>executor_config_volume_mount<span class="token punctuation">)</span>
        <span class="token keyword">def</span> <span class="token function">test_volume_mount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token triple-quoted-string string">&quot;&quot;&quot;
            Tests whether the volume has been mounted.
            &quot;&quot;&quot;</span>

            <span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">&quot;/foo/volume_mount_test.txt&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;w&quot;</span><span class="token punctuation">)</span> <span class="token keyword">as</span> foo<span class="token punctuation">:</span>
                foo<span class="token punctuation">.</span>write<span class="token punctuation">(</span><span class="token string">&quot;Hello&quot;</span><span class="token punctuation">)</span>

            return_code <span class="token operator">=</span> os<span class="token punctuation">.</span>system<span class="token punctuation">(</span><span class="token string">&quot;cat /foo/volume_mount_test.txt&quot;</span><span class="token punctuation">)</span>
            <span class="token keyword">if</span> return_code <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">:</span>
                <span class="token keyword">raise</span> ValueError<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f&quot;Error when checking volume mount. Return code </span><span class="token interpolation"><span class="token punctuation">{</span>return_code<span class="token punctuation">}</span></span><span class="token string">&quot;</span></span><span class="token punctuation">)</span>

        volume_task <span class="token operator">=</span> test_volume_mount<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>è¯·æ³¨æ„ï¼Œä»¥ä¸‹å­—æ®µå°†è¢«æ‰©å±•ï¼Œè€Œä¸æ˜¯è¦†ç›–ã€‚ From <em>spec</em>: volumes, and init_containers. From <em>container</em>: volume mounts, environment variables, ports, and devices.</p><p>è¦å°†sidecarå®¹å™¨æ·»åŠ åˆ°å¯åŠ¨çš„podä¸­ï¼Œè¯·åˆ›å»ºä¸€ä¸ªV1podï¼Œå…¶ä¸­ç¬¬ä¸€ä¸ªå®¹å™¨ä¸ºç©ºï¼Œåç§°ä¸ºbaseï¼Œç¬¬äºŒä¸ªå®¹å™¨åŒ…å«æ‰€éœ€çš„sidecarã€‚</p><div class="language-yaml line-numbers-mode" data-ext="yml" data-title="yml"><pre class="language-yaml"><code>        executor_config_sidecar = <span class="token punctuation">{</span>
            <span class="token key atrule">&quot;pod_override&quot;</span><span class="token punctuation">:</span> k8s.V1Pod(
                spec=k8s.V1PodSpec(
                    containers=<span class="token punctuation">[</span>
                        k8s.V1Container(
                            name=&quot;base&quot;<span class="token punctuation">,</span>
                            volume_mounts=<span class="token punctuation">[</span>k8s.V1VolumeMount(mount_path=&quot;/shared/&quot;<span class="token punctuation">,</span> name=&quot;shared<span class="token punctuation">-</span>empty<span class="token punctuation">-</span>dir&quot;)<span class="token punctuation">]</span><span class="token punctuation">,</span>
                        )<span class="token punctuation">,</span>
                        k8s.V1Container(
                            name=&quot;sidecar&quot;<span class="token punctuation">,</span>
                            image=&quot;ubuntu&quot;<span class="token punctuation">,</span>
                            args=<span class="token punctuation">[</span><span class="token string">&#39;echo &quot;retrieved from mount&quot; &gt; /shared/test.txt&#39;</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                            command=<span class="token punctuation">[</span><span class="token string">&quot;bash&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;-cx&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                            volume_mounts=<span class="token punctuation">[</span>k8s.V1VolumeMount(mount_path=&quot;/shared/&quot;<span class="token punctuation">,</span> name=&quot;shared<span class="token punctuation">-</span>empty<span class="token punctuation">-</span>dir&quot;)<span class="token punctuation">]</span><span class="token punctuation">,</span>
                        )<span class="token punctuation">,</span>
                    <span class="token punctuation">]</span><span class="token punctuation">,</span>
                    volumes=<span class="token punctuation">[</span>
                        k8s.V1Volume(name=&quot;shared<span class="token punctuation">-</span>empty<span class="token punctuation">-</span>dir&quot;<span class="token punctuation">,</span> empty_dir=k8s.V1EmptyDirVolumeSource())<span class="token punctuation">,</span>
                    <span class="token punctuation">]</span><span class="token punctuation">,</span>
                )
            )<span class="token punctuation">,</span>
        <span class="token punctuation">}</span>

        @task(executor_config=executor_config_sidecar)
        <span class="token key atrule">def test_sharedvolume_mount()</span><span class="token punctuation">:</span>
            &quot;&quot;&quot;
            Tests whether the volume has been mounted.
            &quot;&quot;&quot;
            <span class="token key atrule">for i in range(5)</span><span class="token punctuation">:</span>
                <span class="token key atrule">try</span><span class="token punctuation">:</span>
                    return_code = os.system(&quot;cat /shared/test.txt&quot;)
                    <span class="token key atrule">if return_code != 0</span><span class="token punctuation">:</span>
                        raise ValueError(f&quot;Error when checking volume mount. Return code <span class="token punctuation">{</span>return_code<span class="token punctuation">}</span>&quot;)
                <span class="token key atrule">except ValueError as e</span><span class="token punctuation">:</span>
                    <span class="token key atrule">if i &gt; 4</span><span class="token punctuation">:</span>
                        raise e

        sidecar_task = test_sharedvolume_mount()
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>è¿˜å¯ä»¥æŒ‰ä»»åŠ¡åˆ›å»ºè‡ªå®šä¹‰pod_template_fileï¼Œä»¥ä¾¿åœ¨å¤šä¸ªä»»åŠ¡ä¹‹é—´å›æ”¶ç›¸åŒçš„åŸºå€¼ã€‚è¿™å°†æ›¿æ¢airflow.cfgä¸­å‘½åçš„é»˜è®¤pod_template_fileï¼Œç„¶åä½¿ç”¨pod_overrideè¦†ç›–è¯¥æ¨¡æ¿ã€‚</p><div class="language-python line-numbers-mode" data-ext="py" data-title="py"><pre class="language-python"><code><span class="token keyword">import</span> os

<span class="token keyword">import</span> pendulum

<span class="token keyword">from</span> airflow <span class="token keyword">import</span> DAG
<span class="token keyword">from</span> airflow<span class="token punctuation">.</span>decorators <span class="token keyword">import</span> task
<span class="token keyword">from</span> airflow<span class="token punctuation">.</span>example_dags<span class="token punctuation">.</span>libs<span class="token punctuation">.</span>helper <span class="token keyword">import</span> print_stuff
<span class="token keyword">from</span> airflow<span class="token punctuation">.</span>settings <span class="token keyword">import</span> AIRFLOW_HOME

<span class="token keyword">from</span> kubernetes<span class="token punctuation">.</span>client <span class="token keyword">import</span> models <span class="token keyword">as</span> k8s

<span class="token keyword">with</span> DAG<span class="token punctuation">(</span>
    dag_id<span class="token operator">=</span><span class="token string">&quot;example_pod_template_file&quot;</span><span class="token punctuation">,</span>
    schedule<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span>
    start_date<span class="token operator">=</span>pendulum<span class="token punctuation">.</span>datetime<span class="token punctuation">(</span><span class="token number">2021</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> tz<span class="token operator">=</span><span class="token string">&quot;UTC&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    catchup<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span>
    tags<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">&quot;example3&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">)</span> <span class="token keyword">as</span> dag<span class="token punctuation">:</span>
    executor_config_template <span class="token operator">=</span> <span class="token punctuation">{</span>
        <span class="token string">&quot;pod_template_file&quot;</span><span class="token punctuation">:</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>AIRFLOW_HOME<span class="token punctuation">,</span> <span class="token string">&quot;pod_templates/basic_template.yaml&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token string">&quot;pod_override&quot;</span><span class="token punctuation">:</span> k8s<span class="token punctuation">.</span>V1Pod<span class="token punctuation">(</span>metadata<span class="token operator">=</span>k8s<span class="token punctuation">.</span>V1ObjectMeta<span class="token punctuation">(</span>labels<span class="token operator">=</span><span class="token punctuation">{</span><span class="token string">&quot;release&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;stable&quot;</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span>

    <span class="token decorator annotation punctuation">@task</span><span class="token punctuation">(</span>executor_config<span class="token operator">=</span>executor_config_template<span class="token punctuation">)</span>
    <span class="token keyword">def</span> <span class="token function">task_with_template</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        print_stuff<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h1 id="kubernetespodoperator" tabindex="-1"><a class="header-anchor" href="#kubernetespodoperator"><span>KubernetesPodOperator</span></a></h1><p>KubernetePodOperatorä½¿ç”¨Kubernetes APIåœ¨Kubernetesé›†ç¾¤ä¸­å¯åŠ¨ä¸€ä¸ªpodã€‚é€šè¿‡æä¾›ä¸€ä¸ªé•œåƒURLå’Œä¸€ä¸ªå¸¦æœ‰å¯é€‰å‚æ•°çš„å‘½ä»¤ï¼Œæ“ä½œç¬¦ä½¿ç”¨Kube Pythonå®¢æˆ·ç«¯ç”Ÿæˆä¸€ä¸ªKubernetes APIè¯·æ±‚ï¼Œè¯¥è¯·æ±‚åŠ¨æ€å¯åŠ¨è¿™äº›å•ç‹¬çš„podsã€‚ç”¨æˆ·å¯ä»¥ä½¿ç”¨config_fileå‚æ•°æŒ‡å®škubeconfigæ–‡ä»¶ï¼Œå¦åˆ™æ“ä½œç¬¦å°†é»˜è®¤ä¸º~/.kube/configã€‚</p><p>KubernetsPodOperatoræ”¯æŒä»»åŠ¡çº§åˆ«çš„èµ„æºé…ç½®ï¼Œå¯¹äºæ— æ³•é€šè¿‡å…¬å…±PyPIå­˜å‚¨åº“è·å¾—çš„è‡ªå®šä¹‰Pythonä¾èµ–å…³ç³»ï¼Œå®ƒæ˜¯æœ€ä½³çš„ã€‚å®ƒè¿˜å…è®¸ç”¨æˆ·ä½¿ç”¨pod_template_fileå‚æ•°æä¾›æ¨¡æ¿YAMLæ–‡ä»¶ã€‚æœ€ç»ˆï¼Œå®ƒå…è®¸Airflowå……å½“å·¥ä½œåè°ƒäººâ€”â€”æ— è®ºè¿™äº›å·¥ä½œæ˜¯ç”¨ä»€ä¹ˆè¯­è¨€å†™çš„</p><h3 id="è°ƒè¯•kubernetespodoperator" tabindex="-1"><a class="header-anchor" href="#è°ƒè¯•kubernetespodoperator"><span>è°ƒè¯•KubernetesPodOperator</span></a></h3><p>æ‚¨å¯ä»¥æ‰“å°å‡ºpodçš„Kubernetesæ¸…å•ï¼Œè¯¥æ¸…å•å°†åœ¨è¿è¡Œæ—¶é€šè¿‡åœ¨æ“ä½œç¬¦çš„å®ä¾‹ä¸Šè°ƒç”¨dry_runï¼ˆï¼‰æ¥åˆ›å»ºã€‚</p><div class="language-python line-numbers-mode" data-ext="py" data-title="py"><pre class="language-python"><code><span class="token keyword">from</span> airflow<span class="token punctuation">.</span>providers<span class="token punctuation">.</span>cncf<span class="token punctuation">.</span>kubernetes<span class="token punctuation">.</span>operators<span class="token punctuation">.</span>pod <span class="token keyword">import</span> KubernetesPodOperator

k <span class="token operator">=</span> KubernetesPodOperator<span class="token punctuation">(</span>
    name<span class="token operator">=</span><span class="token string">&quot;hello-dry-run&quot;</span><span class="token punctuation">,</span>
    image<span class="token operator">=</span><span class="token string">&quot;debian&quot;</span><span class="token punctuation">,</span>
    cmds<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">&quot;bash&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;-cx&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    arguments<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">&quot;echo&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;10&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    labels<span class="token operator">=</span><span class="token punctuation">{</span><span class="token string">&quot;foo&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;bar&quot;</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    task_id<span class="token operator">=</span><span class="token string">&quot;dry_run_demo&quot;</span><span class="token punctuation">,</span>
    do_xcom_push<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>
<span class="token punctuation">)</span>

k<span class="token punctuation">.</span>dry_run<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="å‚æ•°ä¼˜å…ˆçº§" tabindex="-1"><a class="header-anchor" href="#å‚æ•°ä¼˜å…ˆçº§"><span>å‚æ•°ä¼˜å…ˆçº§</span></a></h3><ul><li><p>KPO argument</p></li><li><p>full pod spec</p></li><li><p>pod template file</p></li><li><p>airflow connection.</p></li></ul><p>å¯¹äºåç§°ç©ºé—´ï¼Œå¦‚æœæ²¡æœ‰é€šè¿‡è¿™äº›æ–¹æ³•ä¸­çš„ä»»ä½•ä¸€ä¸ªæä¾›åç§°ç©ºé—´ï¼Œé‚£ä¹ˆæˆ‘ä»¬å°†é¦–å…ˆå°è¯•è·å–å½“å‰åç§°ç©ºé—´ï¼ˆå¦‚æœä»»åŠ¡å·²ç»åœ¨kubernetesä¸­è¿è¡Œï¼‰ï¼Œå¦åˆ™æˆ‘ä»¬å°†ä½¿ç”¨defaultåç§°ç©ºé—´ã€‚</p><p>å¯¹äºpodåç§°ï¼Œå¦‚æœæ²¡æœ‰æ˜ç¡®æä¾›ï¼Œæˆ‘ä»¬å°†ä½¿ç”¨task_idã€‚é»˜è®¤æƒ…å†µä¸‹ä¼šæ·»åŠ ä¸€ä¸ªéšæœºåç¼€ã€‚</p><h3 id="å¦‚ä½•åœ¨podä¸­ä½¿ç”¨é›†ç¾¤configmapsã€secretså’Œvolumes" tabindex="-1"><a class="header-anchor" href="#å¦‚ä½•åœ¨podä¸­ä½¿ç”¨é›†ç¾¤configmapsã€secretså’Œvolumes"><span>å¦‚ä½•åœ¨Podä¸­ä½¿ç”¨é›†ç¾¤ConfigMapsã€Secretså’ŒVolumesï¼Ÿ</span></a></h3><p>è¦æ·»åŠ ConfigMapsã€Volumeså’Œå…¶ä»–KubernetesåŸç”Ÿå¯¹è±¡ï¼Œæˆ‘ä»¬å»ºè®®æ‚¨å¯¼å…¥Kuberneteæ¨¡å‹APIï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p><div class="language-python line-numbers-mode" data-ext="py" data-title="py"><pre class="language-python"><code><span class="token keyword">from</span> kubernetes<span class="token punctuation">.</span>client <span class="token keyword">import</span> models <span class="token keyword">as</span> k8s
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>é€šè¿‡è¿™ä¸ªAPIå¯¹è±¡ï¼Œæ‚¨å¯ä»¥ä»¥pythonç±»çš„å½¢å¼è®¿é—®æ‰€æœ‰Kubernetes APIå¯¹è±¡ã€‚ä½¿ç”¨æ­¤æ–¹æ³•å°†ç¡®ä¿æ­£ç¡®æ€§å’Œç±»å‹å®‰å…¨æ€§ã€‚è™½ç„¶æˆ‘ä»¬åˆ é™¤äº†å‡ ä¹æ‰€æœ‰çš„Kubernetesä¾¿åˆ©ç±»ï¼Œä½†æˆ‘ä»¬ä¿ç•™äº†Secretç±»ï¼Œä»¥ç®€åŒ–ç”ŸæˆSecretå·/envå˜é‡çš„è¿‡ç¨‹:</p><div class="language-python line-numbers-mode" data-ext="py" data-title="py"><pre class="language-python"><code>secret_file <span class="token operator">=</span> Secret<span class="token punctuation">(</span><span class="token string">&quot;volume&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;/etc/sql_conn&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;airflow-secrets&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;sql_alchemy_conn&quot;</span><span class="token punctuation">)</span>
secret_env <span class="token operator">=</span> Secret<span class="token punctuation">(</span><span class="token string">&quot;env&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;SQL_CONN&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;airflow-secrets&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;sql_alchemy_conn&quot;</span><span class="token punctuation">)</span>
secret_all_keys <span class="token operator">=</span> Secret<span class="token punctuation">(</span><span class="token string">&quot;env&quot;</span><span class="token punctuation">,</span> <span class="token boolean">None</span><span class="token punctuation">,</span> <span class="token string">&quot;airflow-secrets-2&quot;</span><span class="token punctuation">)</span>
volume_mount <span class="token operator">=</span> k8s<span class="token punctuation">.</span>V1VolumeMount<span class="token punctuation">(</span>
    name<span class="token operator">=</span><span class="token string">&quot;test-volume&quot;</span><span class="token punctuation">,</span> mount_path<span class="token operator">=</span><span class="token string">&quot;/root/mount_file&quot;</span><span class="token punctuation">,</span> sub_path<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> read_only<span class="token operator">=</span><span class="token boolean">True</span>
<span class="token punctuation">)</span>

configmaps <span class="token operator">=</span> <span class="token punctuation">[</span>
    k8s<span class="token punctuation">.</span>V1EnvFromSource<span class="token punctuation">(</span>config_map_ref<span class="token operator">=</span>k8s<span class="token punctuation">.</span>V1ConfigMapEnvSource<span class="token punctuation">(</span>name<span class="token operator">=</span><span class="token string">&quot;test-configmap-1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    k8s<span class="token punctuation">.</span>V1EnvFromSource<span class="token punctuation">(</span>config_map_ref<span class="token operator">=</span>k8s<span class="token punctuation">.</span>V1ConfigMapEnvSource<span class="token punctuation">(</span>name<span class="token operator">=</span><span class="token string">&quot;test-configmap-2&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">]</span>

volume <span class="token operator">=</span> k8s<span class="token punctuation">.</span>V1Volume<span class="token punctuation">(</span>
    name<span class="token operator">=</span><span class="token string">&quot;test-volume&quot;</span><span class="token punctuation">,</span>
    persistent_volume_claim<span class="token operator">=</span>k8s<span class="token punctuation">.</span>V1PersistentVolumeClaimVolumeSource<span class="token punctuation">(</span>claim_name<span class="token operator">=</span><span class="token string">&quot;test-volume&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">)</span>

port <span class="token operator">=</span> k8s<span class="token punctuation">.</span>V1ContainerPort<span class="token punctuation">(</span>name<span class="token operator">=</span><span class="token string">&quot;http&quot;</span><span class="token punctuation">,</span> container_port<span class="token operator">=</span><span class="token number">80</span><span class="token punctuation">)</span>

init_container_volume_mounts <span class="token operator">=</span> <span class="token punctuation">[</span>
    k8s<span class="token punctuation">.</span>V1VolumeMount<span class="token punctuation">(</span>mount_path<span class="token operator">=</span><span class="token string">&quot;/etc/foo&quot;</span><span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">&quot;test-volume&quot;</span><span class="token punctuation">,</span> sub_path<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> read_only<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
<span class="token punctuation">]</span>

init_environments <span class="token operator">=</span> <span class="token punctuation">[</span>k8s<span class="token punctuation">.</span>V1EnvVar<span class="token punctuation">(</span>name<span class="token operator">=</span><span class="token string">&quot;key1&quot;</span><span class="token punctuation">,</span> value<span class="token operator">=</span><span class="token string">&quot;value1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span> k8s<span class="token punctuation">.</span>V1EnvVar<span class="token punctuation">(</span>name<span class="token operator">=</span><span class="token string">&quot;key2&quot;</span><span class="token punctuation">,</span> value<span class="token operator">=</span><span class="token string">&quot;value2&quot;</span><span class="token punctuation">)</span><span class="token punctuation">]</span>

init_container <span class="token operator">=</span> k8s<span class="token punctuation">.</span>V1Container<span class="token punctuation">(</span>
    name<span class="token operator">=</span><span class="token string">&quot;init-container&quot;</span><span class="token punctuation">,</span>
    image<span class="token operator">=</span><span class="token string">&quot;ubuntu:16.04&quot;</span><span class="token punctuation">,</span>
    env<span class="token operator">=</span>init_environments<span class="token punctuation">,</span>
    volume_mounts<span class="token operator">=</span>init_container_volume_mounts<span class="token punctuation">,</span>
    command<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">&quot;bash&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;-cx&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    args<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">&quot;echo 10&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">)</span>

affinity <span class="token operator">=</span> k8s<span class="token punctuation">.</span>V1Affinity<span class="token punctuation">(</span>
    node_affinity<span class="token operator">=</span>k8s<span class="token punctuation">.</span>V1NodeAffinity<span class="token punctuation">(</span>
        preferred_during_scheduling_ignored_during_execution<span class="token operator">=</span><span class="token punctuation">[</span>
            k8s<span class="token punctuation">.</span>V1PreferredSchedulingTerm<span class="token punctuation">(</span>
                weight<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span>
                preference<span class="token operator">=</span>k8s<span class="token punctuation">.</span>V1NodeSelectorTerm<span class="token punctuation">(</span>
                    match_expressions<span class="token operator">=</span><span class="token punctuation">[</span>
                        k8s<span class="token punctuation">.</span>V1NodeSelectorRequirement<span class="token punctuation">(</span>key<span class="token operator">=</span><span class="token string">&quot;disktype&quot;</span><span class="token punctuation">,</span> operator<span class="token operator">=</span><span class="token string">&quot;In&quot;</span><span class="token punctuation">,</span> values<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">&quot;ssd&quot;</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
                    <span class="token punctuation">]</span>
                <span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token punctuation">)</span>
        <span class="token punctuation">]</span>
    <span class="token punctuation">)</span><span class="token punctuation">,</span>
    pod_affinity<span class="token operator">=</span>k8s<span class="token punctuation">.</span>V1PodAffinity<span class="token punctuation">(</span>
        required_during_scheduling_ignored_during_execution<span class="token operator">=</span><span class="token punctuation">[</span>
            k8s<span class="token punctuation">.</span>V1WeightedPodAffinityTerm<span class="token punctuation">(</span>
                weight<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span>
                pod_affinity_term<span class="token operator">=</span>k8s<span class="token punctuation">.</span>V1PodAffinityTerm<span class="token punctuation">(</span>
                    label_selector<span class="token operator">=</span>k8s<span class="token punctuation">.</span>V1LabelSelector<span class="token punctuation">(</span>
                        match_expressions<span class="token operator">=</span><span class="token punctuation">[</span>
                            k8s<span class="token punctuation">.</span>V1LabelSelectorRequirement<span class="token punctuation">(</span>key<span class="token operator">=</span><span class="token string">&quot;security&quot;</span><span class="token punctuation">,</span> operator<span class="token operator">=</span><span class="token string">&quot;In&quot;</span><span class="token punctuation">,</span> values<span class="token operator">=</span><span class="token string">&quot;S1&quot;</span><span class="token punctuation">)</span>
                        <span class="token punctuation">]</span>
                    <span class="token punctuation">)</span><span class="token punctuation">,</span>
                    topology_key<span class="token operator">=</span><span class="token string">&quot;failure-domain.beta.kubernetes.io/zone&quot;</span><span class="token punctuation">,</span>
                <span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token punctuation">)</span>
        <span class="token punctuation">]</span>
    <span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">)</span>

tolerations <span class="token operator">=</span> <span class="token punctuation">[</span>k8s<span class="token punctuation">.</span>V1Toleration<span class="token punctuation">(</span>key<span class="token operator">=</span><span class="token string">&quot;key&quot;</span><span class="token punctuation">,</span> operator<span class="token operator">=</span><span class="token string">&quot;Equal&quot;</span><span class="token punctuation">,</span> value<span class="token operator">=</span><span class="token string">&quot;value&quot;</span><span class="token punctuation">)</span><span class="token punctuation">]</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>é»˜è®¤æƒ…å†µä¸‹ï¼ŒKubernetsPodOperatorå°†æŸ¥æ‰¾Dockerhubä¸Šå…¬å¼€æ‰˜ç®¡çš„å›¾åƒã€‚è¦ä»ä¸“ç”¨æ³¨å†Œè¡¨ï¼ˆå¦‚ECRã€GCRã€Quayæˆ–å…¶ä»–æ³¨å†Œè¡¨ï¼‰ä¸­æå–æ˜ åƒï¼Œå¿…é¡»åˆ›å»ºä¸€ä¸ªKubernetes Secretï¼Œè¯¥Secretè¡¨ç¤ºä»image_pull_secretså‚æ•°ä¸­æŒ‡å®šçš„ä¸“ç”¨æ³¨å†Œè¡¨è®¿é—®æ˜ åƒçš„å‡­æ®ã€‚</p><div class="language-python line-numbers-mode" data-ext="py" data-title="py"><pre class="language-python"><code>    quay_k8s <span class="token operator">=</span> KubernetesPodOperator<span class="token punctuation">(</span>
        namespace<span class="token operator">=</span><span class="token string">&quot;default&quot;</span><span class="token punctuation">,</span>
        image<span class="token operator">=</span><span class="token string">&quot;quay.io/apache/bash&quot;</span><span class="token punctuation">,</span>
        image_pull_secrets<span class="token operator">=</span><span class="token punctuation">[</span>k8s<span class="token punctuation">.</span>V1LocalObjectReference<span class="token punctuation">(</span><span class="token string">&quot;testquay&quot;</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        cmds<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">&quot;bash&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;-cx&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        arguments<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">&quot;echo&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;10&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;echo pwd&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        labels<span class="token operator">=</span><span class="token punctuation">{</span><span class="token string">&quot;foo&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;bar&quot;</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
        name<span class="token operator">=</span><span class="token string">&quot;airflow-private-image-pod&quot;</span><span class="token punctuation">,</span>
        on_finish_action<span class="token operator">=</span><span class="token string">&quot;delete_pod&quot;</span><span class="token punctuation">,</span>
        in_cluster<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>
        task_id<span class="token operator">=</span><span class="token string">&quot;task-two&quot;</span><span class="token punctuation">,</span>
        get_logs<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>KubernetsPodOperatorå¤„ç†XComå€¼çš„æ–¹å¼ä¸å…¶ä»–è¿ç®—ç¬¦ä¸åŒã€‚ä¸ºäº†ä»Podä¼ é€’XComå€¼ï¼Œå¿…é¡»å°†do_xcom_pushæŒ‡å®šä¸ºTrueã€‚è¿™å°†åˆ›å»ºä¸€ä¸ªä¸Podä¸€èµ·è¿è¡Œçš„sidecarå®¹å™¨ã€‚Podå¿…é¡»å°†XComå€¼å†™å…¥/airflow/xcom/return.jsonä½ç½®ã€‚</p><div class="language-yaml line-numbers-mode" data-ext="yml" data-title="yml"><pre class="language-yaml"><code>    write_xcom = KubernetesPodOperator(
        namespace=&quot;default&quot;<span class="token punctuation">,</span>
        image=&quot;alpine&quot;<span class="token punctuation">,</span>
        cmds=<span class="token punctuation">[</span><span class="token string">&quot;sh&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;-c&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;mkdir -p /airflow/xcom/;echo &#39;[1,2,3,4]&#39; &gt; /airflow/xcom/return.json&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        name=&quot;write<span class="token punctuation">-</span>xcom&quot;<span class="token punctuation">,</span>
        do_xcom_push=True<span class="token punctuation">,</span>
        on_finish_action=&quot;delete_pod&quot;<span class="token punctuation">,</span>
        in_cluster=True<span class="token punctuation">,</span>
        task_id=&quot;write<span class="token punctuation">-</span>xcom&quot;<span class="token punctuation">,</span>
        get_logs=True<span class="token punctuation">,</span>
    )

    pod_task_xcom_result = BashOperator(
        bash_command=&quot;echo \&quot;<span class="token punctuation">{</span><span class="token punctuation">{</span> task_instance.xcom_pull(&#39;write<span class="token punctuation">-</span>xcom&#39;)<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token punctuation">}</span><span class="token punctuation">}</span>\&quot;&quot;<span class="token punctuation">,</span>
        task_id=&quot;pod_task_xcom_result&quot;<span class="token punctuation">,</span>
    )

    write_xcom <span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span> pod_task_xcom_result
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>å†™å…¥/dev/terminationæ—¥å¿—çš„ä»»ä½•å†…å®¹éƒ½å°†ç”±Kubernetesæ£€ç´¢ï¼Œå¹¶åœ¨ä»»åŠ¡å¤±è´¥æ—¶åŒ…å«åœ¨å¼‚å¸¸æ¶ˆæ¯ä¸­ã€‚</p><div class="language-yaml line-numbers-mode" data-ext="yml" data-title="yml"><pre class="language-yaml"><code>k = KubernetesPodOperator(
    task_id=&quot;test_error_message&quot;<span class="token punctuation">,</span>
    image=&quot;alpine&quot;<span class="token punctuation">,</span>
    cmds=<span class="token punctuation">[</span><span class="token string">&quot;/bin/sh&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    arguments=<span class="token punctuation">[</span><span class="token string">&quot;-c&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;echo hello world; echo Custom error &gt; /dev/termination-log; exit 1;&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    name=&quot;test<span class="token punctuation">-</span>error<span class="token punctuation">-</span>message&quot;<span class="token punctuation">,</span>
    email=&quot;airflow@example.com&quot;<span class="token punctuation">,</span>
    email_on_failure=True<span class="token punctuation">,</span>
)
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></div><!--[--><!----><!--]--><footer class="vp-page-meta"><div class="vp-meta-item edit-link"><a href="https://github.com/banrenshan/banrenshan.github.io/edit/main/src/post/AirFlow.md" rel="noopener noreferrer" target="_blank" aria-label="åœ¨ GitHub ä¸Šç¼–è¾‘æ­¤é¡µ" class="nav-link vp-meta-label"><!--[--><svg xmlns="http://www.w3.org/2000/svg" class="icon edit-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="edit icon"><path d="M430.818 653.65a60.46 60.46 0 0 1-50.96-93.281l71.69-114.012 7.773-10.365L816.038 80.138A60.46 60.46 0 0 1 859.225 62a60.46 60.46 0 0 1 43.186 18.138l43.186 43.186a60.46 60.46 0 0 1 0 86.373L588.879 565.55l-8.637 8.637-117.466 68.234a60.46 60.46 0 0 1-31.958 11.229z"></path><path d="M728.802 962H252.891A190.883 190.883 0 0 1 62.008 771.98V296.934a190.883 190.883 0 0 1 190.883-192.61h267.754a60.46 60.46 0 0 1 0 120.92H252.891a69.962 69.962 0 0 0-69.098 69.099V771.98a69.962 69.962 0 0 0 69.098 69.098h475.911A69.962 69.962 0 0 0 797.9 771.98V503.363a60.46 60.46 0 1 1 120.922 0V771.98A190.883 190.883 0 0 1 728.802 962z"></path></svg><!--]-->åœ¨ GitHub ä¸Šç¼–è¾‘æ­¤é¡µ<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span><!----></a></div><div class="vp-meta-item git-info"><div class="update-time"><span class="vp-meta-label">ä¸Šæ¬¡ç¼–è¾‘äº: </span><!----></div><div class="contributors"><span class="vp-meta-label">è´¡çŒ®è€…: </span><!--[--><!--[--><span class="vp-meta-info" title="email: 1367508819@qq.com">banrenshan</span><!--]--><!--]--></div></div></footer><nav class="vp-page-nav"><!----><a class="route-link nav-link next" href="/post/ER%E5%9B%BE.html" aria-label="ERå›¾"><div class="hint">ä¸‹ä¸€é¡µ<span class="arrow end"></span></div><div class="link">ERå›¾<!----></div></a></nav><!----><!--[--><!----><!--]--><!--]--></main><!--]--><!----></div><!--]--><!--]--><!--[--><!----><!--]--><!--]--></div>
    <script type="module" src="/assets/app-DMMI-IL5.js" defer></script>
  </body>
</html>
