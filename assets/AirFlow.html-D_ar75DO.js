import{_ as o}from"./plugin-vue_export-helper-DlAUqK2U.js";import{r as i,o as l,c,b as n,t as u,d as s,e as t,a as e}from"./app-Crw0g0C7.js";const r="/assets/demo_graph_view-Bwp2ELhg.png",d="/assets/demo_grid_view-DFFl8V2H.png",k="/assets/task_doc-CsZrP6gX.png",v="/assets/edge_label_example-BqdSRJr2.png",m="/assets/arch-diag-basic-CV2siP8f.png",b="/assets/dags-DKbC27lc.png",g="/assets/basic-dag-CmyNim0B.png",h="/assets/latest_only_with_trigger-C0ACQePO.png",_="/assets/branch_without_trigger-1697962671809-17-CVrLg8Ns.png",y="/assets/branch_with_trigger-CcR1QyUP.png",f="/assets/task_group-DRdoDy8z.gif",q="/assets/edge_label_example-BqdSRJr2.png",w="/assets/subdag_before-DqJdadit.png",A="/assets/subdag_after-Ce3a9PEt.png",D="/assets/subdag_zoom-B2-Mx_fz.png",x="/assets/arch-diag-kubernetes-06VkmkmB.png",G="/assets/arch-diag-kubernetes2-CXf74wU-.png",E="/assets/k8s-happy-path-BG-R5Say.png",O={},P=e(`<p>Airflow是一个用于开发、调度和监控 <strong>面向批处理的工作流</strong> 的开源平台。<strong>主要特点是所有工作流都是用Python代码定义的</strong>。</p><h1 id="快速入门" tabindex="-1"><a class="header-anchor" href="#快速入门"><span>快速入门</span></a></h1><div class="language-python line-numbers-mode" data-ext="py" data-title="py"><pre class="language-python"><code><span class="token keyword">from</span> datetime <span class="token keyword">import</span> datetime

<span class="token keyword">from</span> airflow <span class="token keyword">import</span> DAG
<span class="token keyword">from</span> airflow<span class="token punctuation">.</span>decorators <span class="token keyword">import</span> task
<span class="token keyword">from</span> airflow<span class="token punctuation">.</span>operators<span class="token punctuation">.</span>bash <span class="token keyword">import</span> BashOperator

<span class="token comment"># A DAG represents a workflow, a collection of tasks</span>
<span class="token keyword">with</span> DAG<span class="token punctuation">(</span>dag_id<span class="token operator">=</span><span class="token string">&quot;demo&quot;</span><span class="token punctuation">,</span> start_date<span class="token operator">=</span>datetime<span class="token punctuation">(</span><span class="token number">2022</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> schedule<span class="token operator">=</span><span class="token string">&quot;0 0 * * *&quot;</span><span class="token punctuation">)</span> <span class="token keyword">as</span> dag<span class="token punctuation">:</span>

    <span class="token comment"># Tasks are represented as operators</span>
    hello <span class="token operator">=</span> BashOperator<span class="token punctuation">(</span>task_id<span class="token operator">=</span><span class="token string">&quot;hello&quot;</span><span class="token punctuation">,</span> bash_command<span class="token operator">=</span><span class="token string">&quot;echo hello&quot;</span><span class="token punctuation">)</span>

    <span class="token decorator annotation punctuation">@task</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">def</span> <span class="token function">airflow</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;airflow&quot;</span><span class="token punctuation">)</span>

    <span class="token comment"># Set dependencies between tasks</span>
    hello <span class="token operator">&gt;&gt;</span> airflow<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ol><li><p>一个名为 <code>demo</code> 的DAG，从2022年1月1日开始，每天运行一次。DAG是Airflow对工作流的表示。</p></li><li><p>两个任务，一个是运行Bash脚本的BashOperator，另一个是使用@task decorator定义的Python函数</p></li><li><p><code>&gt;&gt;</code> 在任务之间，定义了一个依赖项，并控制任务的执行顺序</p></li></ol><p>Airflow评估此脚本，并按设定的间隔和定义的顺序执行任务。<code>demo</code> DAG的状态在web界面中可见：</p><figure><img src="`+r+'" alt="Demo DAG in the Graph View, showing the status of one DAG run" tabindex="0" loading="lazy"><figcaption>Demo DAG in the Graph View, showing the status of one DAG run</figcaption></figure><p>本例演示了一个简单的Bash和Python脚本，但这些任务可以运行任何代码。可以运行Spark作业、在两个存储桶之间移动数据或发送电子邮件。同样的结构也可以随着时间的推移而运行：</p><figure><img src="'+d+`" alt="Demo DAG in the Grid View, showing the status of all DAG runs" tabindex="0" loading="lazy"><figcaption>Demo DAG in the Grid View, showing the status of all DAG runs</figcaption></figure><p>每列表示一个DAG运行。这是Airflow中最常用的两个视图，但还有其他几个视图可以让您深入了解工作流的状态。</p><p>Airflow 是一个批处理工作流编排平台。Airflow框架包含可与许多技术连接的operators ，并且可轻松扩展以与新技术连接。如果您的工作流有一个明确的开始和结束，并且以定期间隔运行，则可以将其编程为DAG。</p><p>Airflow包括以下核心组件：</p><ol><li><p>webserver</p></li><li><p>scheduler</p></li><li><p>CLI</p></li></ol><p>Providers 包包括与第三方项目的集成。它们的版本和发布独立于Apache Airflow核心包。</p><p>wsl ubuntu 安装python</p><div class="language-bash line-numbers-mode" data-ext="sh" data-title="sh"><pre class="language-bash"><code><span class="token function">sudo</span> <span class="token function">apt</span> remove python3 <span class="token comment"># 移除默认安装的3.10</span>
<span class="token function">sudo</span> <span class="token function">apt</span> autoremove
<span class="token function">sudo</span> <span class="token function">ln</span> <span class="token parameter variable">-s</span> /usr/bin/python3.9 /usr/bin/python
<span class="token function">sudo</span> <span class="token function">apt</span> <span class="token function">install</span> python3-pip
pip config <span class="token builtin class-name">set</span> global.index-url https://pypi.tuna.tsinghua.edu.cn/simple

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h1 id="安装" tabindex="-1"><a class="header-anchor" href="#安装"><span>安装</span></a></h1><ul><li>需要安装python3环境</li><li>需要 pip 包安装工具</li></ul><ol><li><p>设置Home（可选）</p><p>Airflow需要主目录，使用AIRFLOW_HOME环境变量配置，默认情况下使用<code>~/airflow</code>。</p><div class="language-bash line-numbers-mode" data-ext="sh" data-title="sh"><pre class="language-bash"><code><span class="token builtin class-name">export</span> <span class="token assign-left variable">AIRFLOW_HOME</span><span class="token operator">=~</span>/airflow
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div></li><li><p>使用约束文件安装Airflow，该文件是根据我们传递的URL确定的：</p><div class="language-bash line-numbers-mode" data-ext="sh" data-title="sh"><pre class="language-bash"><code><span class="token assign-left variable">AIRFLOW_VERSION</span><span class="token operator">=</span><span class="token number">2.7</span>.2
<span class="token assign-left variable">PYTHON_VERSION</span><span class="token operator">=</span><span class="token string">&quot;<span class="token variable"><span class="token variable">$(</span>python <span class="token parameter variable">--version</span> <span class="token operator">|</span> <span class="token function">cut</span> <span class="token parameter variable">-d</span> <span class="token string">&quot; &quot;</span> <span class="token parameter variable">-f</span> <span class="token number">2</span> <span class="token operator">|</span> <span class="token function">cut</span> <span class="token parameter variable">-d</span> <span class="token string">&quot;.&quot;</span> <span class="token parameter variable">-f</span> <span class="token number">1</span>-2<span class="token variable">)</span></span>&quot;</span>
<span class="token assign-left variable">CONSTRAINT_URL</span><span class="token operator">=</span><span class="token string">&quot;https://raw.githubusercontent.com/apache/airflow/constraints-<span class="token variable">\${AIRFLOW_VERSION}</span>/constraints-<span class="token variable">\${PYTHON_VERSION}</span>.txt&quot;</span>
pip <span class="token function">install</span> <span class="token string">&quot;apache-airflow==<span class="token variable">\${AIRFLOW_VERSION}</span>&quot;</span> <span class="token parameter variable">--constraint</span> <span class="token string">&quot;<span class="token variable">\${CONSTRAINT_URL}</span>&quot;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li><li><p>启动, 初始化数据库，创建一个用户，并启动所有组件。</p><div class="language-bash line-numbers-mode" data-ext="sh" data-title="sh"><pre class="language-bash"><code><span class="token builtin class-name">export</span> <span class="token assign-left variable"><span class="token environment constant">PATH</span></span><span class="token operator">=</span><span class="token environment constant">PATH</span>:/home/zzq/.local/bin <span class="token comment">#配置airflow的cli 目录</span>
airflow standalone
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><blockquote><p>如果要手动运行Airflow的各个部件，而不是使用一体式独立命令，则可以运行：</p><div class="language-bash line-numbers-mode" data-ext="sh" data-title="sh"><pre class="language-bash"><code>airflow db migrate

airflow <span class="token function">users</span> create <span class="token punctuation">\\</span>
    <span class="token parameter variable">--username</span> admin <span class="token punctuation">\\</span>
    <span class="token parameter variable">--firstname</span> Peter <span class="token punctuation">\\</span>
    <span class="token parameter variable">--lastname</span> Parker <span class="token punctuation">\\</span>
    <span class="token parameter variable">--role</span> Admin <span class="token punctuation">\\</span>
    <span class="token parameter variable">--email</span> spiderman@superhero.org

airflow webserver <span class="token parameter variable">--port</span> <span class="token number">8080</span>

airflow scheduler
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></blockquote></li><li><p>访问UI：localhost:8080 ，用户名和密码在控制台打印。</p><blockquote><p>运行这些命令后，Airflow将创建<code>$AIRFLOW_HOME</code>文件夹，并使用默认值创建<code>airflow.cfg</code>文件，这将使您快速运行。您可以使用环境变量覆盖默认值。</p><p>您可以在<code>$AIRFLOW_HOME/airflow.cfg</code>中检查文件，也可以在UI上通过<code>Admin-&gt;Configuration</code>菜单检查文件。</p><p>Web服务器的PID文件将存储在<code>$AIRFLOW_HOME/airflow-webserver.pid</code>中，如果由systemd启动，则存储在<code>/run/airflow/webserver.pid</code>中</p><p>默认，Airflow使用了一个SQLite数据库。因为使用这个数据库后端不可能进行并行化，所以它与SequentialExecutor协同工作，后者将仅按顺序运行任务实例。</p></blockquote></li><li><p>以下是一些将触发一些任务实例的命令。当您运行下面的命令时，您应该能够在<code>example_bash_operator</code> DAG中看到作业的状态更改。</p><div class="language-bash line-numbers-mode" data-ext="sh" data-title="sh"><pre class="language-bash"><code><span class="token comment"># run your first task instance</span>
airflow tasks <span class="token builtin class-name">test</span> example_bash_operator runme_0 <span class="token number">2015</span>-01-01
<span class="token comment"># run a backfill over 2 days</span>
airflow dags backfill example_bash_operator <span class="token punctuation">\\</span>
    --start-date <span class="token number">2015</span>-01-01 <span class="token punctuation">\\</span>
    --end-date <span class="token number">2015</span>-01-02
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li></ol><h1 id="基础概念" tabindex="-1"><a class="header-anchor" href="#基础概念"><span>基础概念</span></a></h1><div class="language-bash line-numbers-mode" data-ext="sh" data-title="sh"><pre class="language-bash"><code>
from datetime <span class="token function">import</span> datetime, timedelta
from textwrap <span class="token function">import</span> dedent

<span class="token comment"># The DAG object; we&#39;ll need this to instantiate a DAG</span>
from airflow <span class="token function">import</span> DAG

<span class="token comment"># Operators; we need this to operate!</span>
from airflow.operators.bash <span class="token function">import</span> BashOperator
with DAG<span class="token punctuation">(</span>
    <span class="token string">&quot;tutorial&quot;</span>,
    <span class="token comment"># These args will get passed on to each operator</span>
    <span class="token comment"># You can override them on a per-task basis during operator initialization</span>
    <span class="token assign-left variable">default_args</span><span class="token operator">=</span><span class="token punctuation">{</span>
        <span class="token string">&quot;depends_on_past&quot;</span><span class="token builtin class-name">:</span> False,
        <span class="token string">&quot;email&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">[</span><span class="token string">&quot;airflow@example.com&quot;</span><span class="token punctuation">]</span>,
        <span class="token string">&quot;email_on_failure&quot;</span><span class="token builtin class-name">:</span> False,
        <span class="token string">&quot;email_on_retry&quot;</span><span class="token builtin class-name">:</span> False,
        <span class="token string">&quot;retries&quot;</span><span class="token builtin class-name">:</span> <span class="token number">1</span>,
        <span class="token string">&quot;retry_delay&quot;</span><span class="token builtin class-name">:</span> timedelta<span class="token punctuation">(</span>minutes<span class="token operator">=</span><span class="token number">5</span><span class="token punctuation">)</span>,
        <span class="token comment"># &#39;queue&#39;: &#39;bash_queue&#39;,</span>
        <span class="token comment"># &#39;pool&#39;: &#39;backfill&#39;,</span>
        <span class="token comment"># &#39;priority_weight&#39;: 10,</span>
        <span class="token comment"># &#39;end_date&#39;: datetime(2016, 1, 1),</span>
        <span class="token comment"># &#39;wait_for_downstream&#39;: False,</span>
        <span class="token comment"># &#39;sla&#39;: timedelta(hours=2),</span>
        <span class="token comment"># &#39;execution_timeout&#39;: timedelta(seconds=300),</span>
        <span class="token comment"># &#39;on_failure_callback&#39;: some_function, # or list of functions</span>
        <span class="token comment"># &#39;on_success_callback&#39;: some_other_function, # or list of functions</span>
        <span class="token comment"># &#39;on_retry_callback&#39;: another_function, # or list of functions</span>
        <span class="token comment"># &#39;sla_miss_callback&#39;: yet_another_function, # or list of functions</span>
        <span class="token comment"># &#39;trigger_rule&#39;: &#39;all_success&#39;</span>
    <span class="token punctuation">}</span>,
    <span class="token assign-left variable">description</span><span class="token operator">=</span><span class="token string">&quot;A simple tutorial DAG&quot;</span>,
    <span class="token assign-left variable">schedule</span><span class="token operator">=</span>timedelta<span class="token punctuation">(</span>days<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>,
    <span class="token assign-left variable">start_date</span><span class="token operator">=</span>datetime<span class="token punctuation">(</span><span class="token number">2021</span>, <span class="token number">1</span>, <span class="token number">1</span><span class="token punctuation">)</span>,
    <span class="token assign-left variable">catchup</span><span class="token operator">=</span>False,
    <span class="token assign-left variable">tags</span><span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">&quot;example&quot;</span><span class="token punctuation">]</span>,
<span class="token punctuation">)</span> as dag:

    <span class="token comment"># t1, t2 and t3 are examples of tasks created by instantiating operators</span>
    t1 <span class="token operator">=</span> BashOperator<span class="token punctuation">(</span>
        <span class="token assign-left variable">task_id</span><span class="token operator">=</span><span class="token string">&quot;print_date&quot;</span>,
        <span class="token assign-left variable">bash_command</span><span class="token operator">=</span><span class="token string">&quot;date&quot;</span>,
    <span class="token punctuation">)</span>

    t2 <span class="token operator">=</span> BashOperator<span class="token punctuation">(</span>
        <span class="token assign-left variable">task_id</span><span class="token operator">=</span><span class="token string">&quot;sleep&quot;</span>,
        <span class="token assign-left variable">depends_on_past</span><span class="token operator">=</span>False,
        <span class="token assign-left variable">bash_command</span><span class="token operator">=</span><span class="token string">&quot;sleep 5&quot;</span>,
        <span class="token assign-left variable">retries</span><span class="token operator">=</span><span class="token number">3</span>,
    <span class="token punctuation">)</span>
    t1.doc_md <span class="token operator">=</span> dedent<span class="token punctuation">(</span>
        <span class="token string">&quot;&quot;</span>&quot;<span class="token punctuation">\\</span>
    <span class="token comment">#### Task Documentation</span>
    You can document your task using the attributes <span class="token variable"><span class="token variable">\`</span>doc_md<span class="token variable">\`</span></span> <span class="token punctuation">(</span>markdown<span class="token punctuation">)</span>,
    <span class="token variable"><span class="token variable">\`</span>doc<span class="token variable">\`</span></span> <span class="token punctuation">(</span>plain text<span class="token punctuation">)</span>, <span class="token variable"><span class="token variable">\`</span>doc_rst<span class="token variable">\`</span></span>, <span class="token variable"><span class="token variable">\`</span>doc_json<span class="token variable">\`</span></span>, <span class="token variable"><span class="token variable">\`</span>doc_yaml<span class="token variable">\`</span></span> <span class="token function">which</span> gets
    rendered <span class="token keyword">in</span> the UI&#39;s Task Instance Details page.
    <span class="token operator">!</span><span class="token punctuation">[</span>img<span class="token punctuation">]</span><span class="token punctuation">(</span>http://montcs.bloomu.edu/~bobmon/Semesters/2012-01/491/import%20soul.png<span class="token punctuation">)</span>
    **Image Credit:** Randall Munroe, <span class="token punctuation">[</span>XKCD<span class="token punctuation">]</span><span class="token punctuation">(</span>https://xkcd.com/license.html<span class="token punctuation">)</span>
    <span class="token string">&quot;&quot;</span>&quot;
    <span class="token punctuation">)</span>

    dag.doc_md <span class="token operator">=</span> __doc__  <span class="token comment"># providing that you have a docstring at the beginning of the DAG; OR</span>
    dag.doc_md <span class="token operator">=</span> <span class="token string">&quot;&quot;</span>&quot;
    This is a documentation placed anywhere
    <span class="token string">&quot;&quot;</span>&quot;  <span class="token comment"># otherwise, type it like this</span>
    templated_command <span class="token operator">=</span> dedent<span class="token punctuation">(</span>
        <span class="token string">&quot;&quot;</span>&quot;
    <span class="token punctuation">{</span>% <span class="token keyword">for</span> <span class="token for-or-select variable">i</span> <span class="token keyword">in</span> range<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span> %<span class="token punctuation">}</span>
        <span class="token builtin class-name">echo</span> <span class="token string">&quot;{{ ds }}&quot;</span>
        <span class="token builtin class-name">echo</span> <span class="token string">&quot;{{ macros.ds_add(ds, 7)}}&quot;</span>
    <span class="token punctuation">{</span>% endfor %<span class="token punctuation">}</span>
    <span class="token string">&quot;&quot;</span>&quot;
    <span class="token punctuation">)</span>

    t3 <span class="token operator">=</span> BashOperator<span class="token punctuation">(</span>
        <span class="token assign-left variable">task_id</span><span class="token operator">=</span><span class="token string">&quot;templated&quot;</span>,
        <span class="token assign-left variable">depends_on_past</span><span class="token operator">=</span>False,
        <span class="token assign-left variable">bash_command</span><span class="token operator">=</span>templated_command,
    <span class="token punctuation">)</span>

    t1 <span class="token operator">&gt;&gt;</span> <span class="token punctuation">[</span>t2, t3<span class="token punctuation">]</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>这是一个DAG定义文件，使用python代码编写。人们有时会认为DAG定义文件是他们可以进行一些实际数据处理的地方——事实并非如此！脚本的目的是定义一个DAG对象。它需要快速评估（秒，而不是分钟），因为调度程序会定期执行它以反映更改（如果有的话）</p><h3 id="默认参数-default-args" tabindex="-1"><a class="header-anchor" href="#默认参数-default-args"><span>默认参数 ： default_args</span></a></h3><p>在创建一个DAG和一些任务时，我们可以选择显式地将一组参数传递给每个任务的构造函数（这将变得多余），或者（更好！）我们可以定义一个默认参数字典，以便在创建任务时使用。</p><p>有关BaseOperator参数及其作用的更多信息，请参阅<code>airflow.models.BaseOperator</code>文档。</p><h3 id="实例化dag" tabindex="-1"><a class="header-anchor" href="#实例化dag"><span>实例化DAG</span></a></h3><p>我们需要一个DAG对象来包裹我们的任务。在这里，我们传递一个定义dag_id的字符串，dag_id是dag的唯一标识符。我们还传递了我们刚刚定义的默认参数字典，并为DAG定义了一个1天的调度间隔。</p><h2 id="operators" tabindex="-1"><a class="header-anchor" href="#operators"><span>Operators</span></a></h2><p>operator 定义Airflow要完成的工作单元。使用操作符是在Airflow中定义任务的经典方法。对于某些用例，最好使用TaskFlow API来定义Python上下文中的任务，如使用TaskFlow中所述。目前，使用操作符有助于在DAG代码中可视化任务依赖关系。</p><p>所有操作符都继承自BaseOperator。一些最流行的操作符是PythonOperator、BashOperator和KubernetsPodOperator。</p><p>Airflow根据您传递给操作符的参数完成工作。在本教程中，我们使用BashOperator来运行一些bash脚本。</p><h2 id="任务" tabindex="-1"><a class="header-anchor" href="#任务"><span>任务</span></a></h2><p>要在DAG中使用操作符，必须将其实例化为任务。任务决定如何在DAG的上下文中执行操作符的工作。</p><p>在上面的示例中，我们将BashOperator实例化为两个独立的任务，以便运行两个单独的bash脚本。每个实例化的第一个参数task_id充当任务的唯一标识符。</p><p>任务参数的优先级规则如下：</p><ul><li><p>显式传递的参数</p></li><li><p>default_args字典中存在的值</p></li><li><p>操作符的默认值（如果存在）</p></li></ul><blockquote><p>任务必须包含或继承参数task_id和owner，否则Airflow将引发异常。</p></blockquote><h2 id="jinja模板" tabindex="-1"><a class="header-anchor" href="#jinja模板"><span>Jinja模板</span></a></h2>`,37),T=e('<p>请注意，templated_command在<code>｛% %｝</code>块中包含代码逻辑，引用像｛<code>｛ds｝｝</code>这样的参数，并调用像<code>｛macros.ds_ad（ds，7）｝</code>中那样的函数。</p><p>文件也可以传递给bash_command参数，如<code>bash_command=&#39;templated_command.sh&#39;</code>，其中文件位置相对于包含管道文件的目录（在本例中为tutorial.py）。也可以指定其他位置。</p><p>使用相同的DAG构造函数调用，可以定义user_defined_tmacros，从而可以指定自己的变量。例如，将<code>dict(foo=&#39;bar&#39;)</code>传递给此参数允许您在模板中使用<code>｛｛foo｝｝</code>。此外，指定user_defined_filters允许您注册自己的过滤器。例如，将<code>dict(hello=lambda name: &#39;Hello %s&#39; % name)</code>传递到此参数允许您在模板中使用<code>{{ &#39;world&#39; | hello }}</code>。有关自定义过滤器的更多信息，请参阅Jinja文档。</p><h2 id="文档" tabindex="-1"><a class="header-anchor" href="#文档"><span>文档</span></a></h2><p>我们可以为DAG或每个任务添加文档。到目前为止，DAG文档只支持markdown，而任务文档支持纯文本、markdown、reStructuredText、json和yaml。DAG文档可以作为文档字符串写入DAG文件的开头（推荐），也可以写入文件中的任何其他位置。</p><figure><img src="'+k+`" alt="../_images/task_doc.png" tabindex="0" loading="lazy"><figcaption>../_images/task_doc.png</figcaption></figure><h2 id="任务依赖关系" tabindex="-1"><a class="header-anchor" href="#任务依赖关系"><span>任务依赖关系</span></a></h2><p>我们有相互不依赖的任务t1、t2和t3。以下是定义它们之间依赖关系的几种方法：</p><div class="language-python line-numbers-mode" data-ext="py" data-title="py"><pre class="language-python"><code>t1<span class="token punctuation">.</span>set_downstream<span class="token punctuation">(</span>t2<span class="token punctuation">)</span>

<span class="token comment"># This means that t2 will depend on t1</span>
<span class="token comment"># running successfully to run.</span>
<span class="token comment"># It is equivalent to:</span>
t2<span class="token punctuation">.</span>set_upstream<span class="token punctuation">(</span>t1<span class="token punctuation">)</span>

<span class="token comment"># The bit shift operator can also be</span>
<span class="token comment"># used to chain operations:</span>
t1 <span class="token operator">&gt;&gt;</span> t2

<span class="token comment"># And the upstream dependency with the</span>
<span class="token comment"># bit shift operator:</span>
t2 <span class="token operator">&lt;&lt;</span> t1

<span class="token comment"># Chaining multiple dependencies becomes</span>
<span class="token comment"># concise with the bit shift operator:</span>
t1 <span class="token operator">&gt;&gt;</span> t2 <span class="token operator">&gt;&gt;</span> t3

<span class="token comment"># A list of tasks can also be set as</span>
<span class="token comment"># dependencies. These operations</span>
<span class="token comment"># all have the same effect:</span>
t1<span class="token punctuation">.</span>set_downstream<span class="token punctuation">(</span><span class="token punctuation">[</span>t2<span class="token punctuation">,</span> t3<span class="token punctuation">]</span><span class="token punctuation">)</span>
t1 <span class="token operator">&gt;&gt;</span> <span class="token punctuation">[</span>t2<span class="token punctuation">,</span> t3<span class="token punctuation">]</span>
<span class="token punctuation">[</span>t2<span class="token punctuation">,</span> t3<span class="token punctuation">]</span> <span class="token operator">&lt;&lt;</span> t1
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><blockquote><p>请注意，在执行脚本时，当Airflow在DAG中找到循环或依赖项被多次引用时，它将引发异常。</p></blockquote><h2 id="时区" tabindex="-1"><a class="header-anchor" href="#时区"><span>时区</span></a></h2><p>创建一个时区感知DAG非常简单。只要确保使用<code>pendulum</code>创建带有时区的时间即可。不要试图使用标准库时区，因为众所周知它们有局限性，我们故意不允许在DAG中使用它们。</p><h2 id="测试" tabindex="-1"><a class="header-anchor" href="#测试"><span>测试</span></a></h2><h3 id="验证" tabindex="-1"><a class="header-anchor" href="#验证"><span>验证</span></a></h3><p>假设我们将上面的代码保存在airflow.cfg中引用的DAG文件夹中。DAG的默认位置为<code>~/airflow/DAGs</code>。</p><div class="language-bash line-numbers-mode" data-ext="sh" data-title="sh"><pre class="language-bash"><code>python ~/airflow/dags/tutorial.py
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>如果脚本没有引发异常，则表示您没有做任何可怕的错误，并且您的Airflow环境在某种程度上是健全的。</p><p>让我们运行一些命令来进一步验证这个脚本。</p><div class="language-bash line-numbers-mode" data-ext="sh" data-title="sh"><pre class="language-bash"><code><span class="token comment"># initialize the database tables</span>
airflow db migrate

<span class="token comment"># print the list of active DAGs</span>
airflow dags list

<span class="token comment"># prints the list of tasks in the &quot;tutorial&quot; DAG</span>
airflow tasks list tutorial

<span class="token comment"># prints the hierarchy of tasks in the &quot;tutorial&quot; DAG</span>
airflow tasks list tutorial <span class="token parameter variable">--tree</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="运行任务" tabindex="-1"><a class="header-anchor" href="#运行任务"><span>运行任务</span></a></h3><p>让我们通过运行特定日期的实际任务实例来进行测试。在此上下文中指定的日期称为逻辑日期（出于历史原因，也称为执行日期），它模拟调度程序在特定日期和时间运行任务或DAG，即使它现在物理上会运行（或在满足其依赖关系时）。</p><div class="language-bash line-numbers-mode" data-ext="sh" data-title="sh"><pre class="language-bash"><code><span class="token comment"># command layout: command subcommand [dag_id] [task_id] [(optional) date]</span>

<span class="token comment"># testing print_date</span>
airflow tasks <span class="token builtin class-name">test</span> tutorial print_date <span class="token number">2015</span>-06-01

<span class="token comment"># testing sleep</span>
airflow tasks <span class="token builtin class-name">test</span> tutorial <span class="token function">sleep</span> <span class="token number">2015</span>-06-01
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>现在还记得我们之前对模板做了什么吗？通过运行以下命令查看如何渲染和执行此模板：</p><div class="language-bash line-numbers-mode" data-ext="sh" data-title="sh"><pre class="language-bash"><code><span class="token comment"># testing templated</span>
airflow tasks <span class="token builtin class-name">test</span> tutorial templated <span class="token number">2015</span>-06-01
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p>这将导致显示详细的事件日志，并最终运行bash命令并打印结果。</p><p>请注意，airflow tasks test命令在本地运行任务实例，将其日志输出到stdout（在屏幕上），不涉及依赖关系，也不将状态（正在运行、成功、失败…）与数据库通信。它只允许测试单个任务实例。</p><p>这同样适用于dags测试，但在DAG级别上。它对给定的DAG id执行一次DAG运行。虽然它确实考虑了任务依赖性，但没有在数据库中注册任何状态。</p><h3 id="backfill-回填" tabindex="-1"><a class="header-anchor" href="#backfill-回填"><span>Backfill(回填)</span></a></h3><p>一切看起来都很好，所以让我们进行回填。回填将尊重您的依赖关系，将日志发送到文件中，并与数据库对话以记录状态。如果你有一个网络服务器，你将能够跟踪进度。如果您有兴趣在回填过程中直观地跟踪进度，airflow webserver将启动一个web服务器。</p><p>请注意，如果使用depends_on_past=True，则单个任务实例将取决于其上一个任务实例（即根据逻辑日期的上一个）的成功率。逻辑日期等于start_date的任务实例将忽略此依赖关系，因为不会为它们创建过去的任务实例。</p><p>在使用depends_on_past=True时，您可能还需要考虑wait_for_downstream=True。depends_on_past=True会导致任务实例依赖于其上一个task_instance的成功，而wait_for_downstream=True会导致一个任务实例也会等待上一个任务示例下游的所有任务实例成功。</p><p>此上下文中的日期范围是start_date和end_date（可选），用于使用此DAG中的任务实例填充运行计划。</p><div class="language-bash line-numbers-mode" data-ext="sh" data-title="sh"><pre class="language-bash"><code><span class="token comment"># optional, start a web server in debug mode in the background</span>
<span class="token comment"># airflow webserver --debug &amp;</span>

<span class="token comment"># start your backfill on a date range</span>
airflow dags backfill tutorial <span class="token punctuation">\\</span>
    --start-date <span class="token number">2015</span>-06-01 <span class="token punctuation">\\</span>
    --end-date <span class="token number">2015</span>-06-07
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="taskflow" tabindex="-1"><a class="header-anchor" href="#taskflow"><span>TaskFlow</span></a></h2><div class="language-python line-numbers-mode" data-ext="py" data-title="py"><pre class="language-python"><code>
<span class="token keyword">import</span> json

<span class="token keyword">import</span> pendulum

<span class="token keyword">from</span> airflow<span class="token punctuation">.</span>decorators <span class="token keyword">import</span> dag<span class="token punctuation">,</span> task
<span class="token decorator annotation punctuation">@dag</span><span class="token punctuation">(</span>
    schedule<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span>
    start_date<span class="token operator">=</span>pendulum<span class="token punctuation">.</span>datetime<span class="token punctuation">(</span><span class="token number">2021</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> tz<span class="token operator">=</span><span class="token string">&quot;UTC&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    catchup<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span>
    tags<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">&quot;example&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">tutorial_taskflow_api</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">&quot;&quot;&quot;
    ### TaskFlow API Tutorial Documentation
    This is a simple data pipeline example which demonstrates the use of
    the TaskFlow API using three simple tasks for Extract, Transform, and Load.
    Documentation that goes along with the Airflow TaskFlow API tutorial is
    located
    [here](https://airflow.apache.org/docs/apache-airflow/stable/tutorial_taskflow_api.html)
    &quot;&quot;&quot;</span>
    <span class="token decorator annotation punctuation">@task</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">def</span> <span class="token function">extract</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">&quot;&quot;&quot;
        #### Extract task
        A simple Extract task to get data ready for the rest of the data
        pipeline. In this case, getting data is simulated by reading from a
        hardcoded JSON string.
        &quot;&quot;&quot;</span>
        data_string <span class="token operator">=</span> <span class="token string">&#39;{&quot;1001&quot;: 301.27, &quot;1002&quot;: 433.21, &quot;1003&quot;: 502.22}&#39;</span>

        order_data_dict <span class="token operator">=</span> json<span class="token punctuation">.</span>loads<span class="token punctuation">(</span>data_string<span class="token punctuation">)</span>
        <span class="token keyword">return</span> order_data_dict
    <span class="token decorator annotation punctuation">@task</span><span class="token punctuation">(</span>multiple_outputs<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
    <span class="token keyword">def</span> <span class="token function">transform</span><span class="token punctuation">(</span>order_data_dict<span class="token punctuation">:</span> <span class="token builtin">dict</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">&quot;&quot;&quot;
        #### Transform task
        A simple Transform task which takes in the collection of order data and
        computes the total order value.
        &quot;&quot;&quot;</span>
        total_order_value <span class="token operator">=</span> <span class="token number">0</span>

        <span class="token keyword">for</span> value <span class="token keyword">in</span> order_data_dict<span class="token punctuation">.</span>values<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            total_order_value <span class="token operator">+=</span> value

        <span class="token keyword">return</span> <span class="token punctuation">{</span><span class="token string">&quot;total_order_value&quot;</span><span class="token punctuation">:</span> total_order_value<span class="token punctuation">}</span>
    <span class="token decorator annotation punctuation">@task</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">def</span> <span class="token function">load</span><span class="token punctuation">(</span>total_order_value<span class="token punctuation">:</span> <span class="token builtin">float</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">&quot;&quot;&quot;
        #### Load task
        A simple Load task which takes in the result of the Transform task and
        instead of saving it to end user review, just prints it out.
        &quot;&quot;&quot;</span>

        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f&quot;Total order value is: </span><span class="token interpolation"><span class="token punctuation">{</span>total_order_value<span class="token punctuation">:</span><span class="token format-spec">.2f</span><span class="token punctuation">}</span></span><span class="token string">&quot;</span></span><span class="token punctuation">)</span>
    order_data <span class="token operator">=</span> extract<span class="token punctuation">(</span><span class="token punctuation">)</span>
    order_summary <span class="token operator">=</span> transform<span class="token punctuation">(</span>order_data<span class="token punctuation">)</span>
    load<span class="token punctuation">(</span>order_summary<span class="token punctuation">[</span><span class="token string">&quot;total_order_value&quot;</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
tutorial_taskflow_api<span class="token punctuation">(</span><span class="token punctuation">)</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>我们正在创建一个DAG，它是任务之间具有依赖关系的任务的集合。这是一个非常简单的定义，因为我们只希望在使用Airflow构建DAG时运行DAG，而不需要任何重试或复杂的调度。在这个例子中，请注意，我们使用@DAG装饰器创建这个DAG，Python函数名充当DAG标识符。</p><p>在这个数据管道中，使用@task decorator基于Python函数创建任务，如下所示。函数名称充当任务的唯一标识符。</p><p>任务之间的依赖关系以及这些任务之间的数据传递都由Airflow处理，这些任务可能在网络上不同节点上的不同工作线程上运行。</p><h3 id="重用" tabindex="-1"><a class="header-anchor" href="#重用"><span>重用</span></a></h3><p>装饰任务是灵活的。您可以在多个DAG中重用修饰的任务，覆盖task_id, <code>queue</code>, pool等任务参数。 以下是如何在多个DAG中重用装饰任务的示例：</p><div class="language-python line-numbers-mode" data-ext="py" data-title="py"><pre class="language-python"><code><span class="token keyword">from</span> airflow<span class="token punctuation">.</span>decorators <span class="token keyword">import</span> task<span class="token punctuation">,</span> dag
<span class="token keyword">from</span> datetime <span class="token keyword">import</span> datetime


<span class="token decorator annotation punctuation">@task</span>
<span class="token keyword">def</span> <span class="token function">add_task</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f&quot;Task args: x=</span><span class="token interpolation"><span class="token punctuation">{</span>x<span class="token punctuation">}</span></span><span class="token string">, y=</span><span class="token interpolation"><span class="token punctuation">{</span>y<span class="token punctuation">}</span></span><span class="token string">&quot;</span></span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> x <span class="token operator">+</span> y


<span class="token decorator annotation punctuation">@dag</span><span class="token punctuation">(</span>start_date<span class="token operator">=</span>datetime<span class="token punctuation">(</span><span class="token number">2022</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">mydag</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    start <span class="token operator">=</span> add_task<span class="token punctuation">.</span>override<span class="token punctuation">(</span>task_id<span class="token operator">=</span><span class="token string">&quot;start&quot;</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span>
    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        start <span class="token operator">&gt;&gt;</span> add_task<span class="token punctuation">.</span>override<span class="token punctuation">(</span>task_id<span class="token operator">=</span><span class="token string-interpolation"><span class="token string">f&quot;add_start_</span><span class="token interpolation"><span class="token punctuation">{</span>i<span class="token punctuation">}</span></span><span class="token string">&quot;</span></span><span class="token punctuation">)</span><span class="token punctuation">(</span>start<span class="token punctuation">,</span> i<span class="token punctuation">)</span>


<span class="token decorator annotation punctuation">@dag</span><span class="token punctuation">(</span>start_date<span class="token operator">=</span>datetime<span class="token punctuation">(</span><span class="token number">2022</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">mydag2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    start <span class="token operator">=</span> add_task<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span>
    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        start <span class="token operator">&gt;&gt;</span> add_task<span class="token punctuation">.</span>override<span class="token punctuation">(</span>task_id<span class="token operator">=</span><span class="token string-interpolation"><span class="token string">f&quot;new_add_task_</span><span class="token interpolation"><span class="token punctuation">{</span>i<span class="token punctuation">}</span></span><span class="token string">&quot;</span></span><span class="token punctuation">)</span><span class="token punctuation">(</span>start<span class="token punctuation">,</span> i<span class="token punctuation">)</span>


first_dag <span class="token operator">=</span> mydag<span class="token punctuation">(</span><span class="token punctuation">)</span>
second_dag <span class="token operator">=</span> mydag2<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>您也可以导入上面的add_task，并在另一个DAG文件中使用它。假设add_task代码位于一个名为common.py的文件中:</p><div class="language-python line-numbers-mode" data-ext="py" data-title="py"><pre class="language-python"><code><span class="token keyword">from</span> common <span class="token keyword">import</span> add_task
<span class="token keyword">from</span> airflow<span class="token punctuation">.</span>decorators <span class="token keyword">import</span> dag
<span class="token keyword">from</span> datetime <span class="token keyword">import</span> datetime


<span class="token decorator annotation punctuation">@dag</span><span class="token punctuation">(</span>start_date<span class="token operator">=</span>datetime<span class="token punctuation">(</span><span class="token number">2022</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">use_add_task</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    start <span class="token operator">=</span> add_task<span class="token punctuation">.</span>override<span class="token punctuation">(</span>priority_weight<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span>
    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        start <span class="token operator">&gt;&gt;</span> add_task<span class="token punctuation">.</span>override<span class="token punctuation">(</span>task_id<span class="token operator">=</span><span class="token string-interpolation"><span class="token string">f&quot;new_add_task_</span><span class="token interpolation"><span class="token punctuation">{</span>i<span class="token punctuation">}</span></span><span class="token string">&quot;</span></span><span class="token punctuation">,</span> retries<span class="token operator">=</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">(</span>start<span class="token punctuation">,</span> i<span class="token punctuation">)</span>


created_dag <span class="token operator">=</span> use_add_task<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="使用具有复杂-冲突python依赖关系的taskflow-api" tabindex="-1"><a class="header-anchor" href="#使用具有复杂-冲突python依赖关系的taskflow-api"><span>使用具有复杂/冲突Python依赖关系的TaskFlow API</span></a></h3><p>对于下面描述的所有修饰函数的情况，您必须确保这些函数是可序列化的，并且它们只对您使用的其他依赖项使用本地导入。这些导入的附加库必须在目标环境中可用——它们不需要在主Airflow环境中可用。</p><p>您应该使用哪种运算符取决于以下几个因素：</p><ul><li>使用Docker引擎还是Kubernetes运行Airflow</li><li>是否可以负担动态创建具有新依赖项的虚拟环境的开销</li><li>是否可以为所有Airflow组件部署预先存在的、不可变的Python环境。</li></ul><p>这些选项应该为那些希望保持工作流程更简单、更Python化的用户提供更大的灵活性，并允许您在DAG本身中保留DAG的完整逻辑。</p><h4 id="为每个任务动态创建virtualenv" tabindex="-1"><a class="header-anchor" href="#为每个任务动态创建virtualenv"><span>为每个任务动态创建Virtualenv</span></a></h4><p>最简单的方法是在同一台机器上动态地（每次运行任务时）创建一个单独的虚拟环境，您可以使用<code>@task.virtualenv</code>装饰器。decorator允许您使用自定义库动态创建一个新的virtualenv，甚至可以使用不同的Python版本来运行您的函数。</p><div class="language-python line-numbers-mode" data-ext="py" data-title="py"><pre class="language-python"><code>    <span class="token decorator annotation punctuation">@task<span class="token punctuation">.</span>virtualenv</span><span class="token punctuation">(</span>
        task_id<span class="token operator">=</span><span class="token string">&quot;virtualenv_python&quot;</span><span class="token punctuation">,</span> requirements<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">&quot;colorama==0.4.0&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span> system_site_packages<span class="token operator">=</span><span class="token boolean">False</span>
    <span class="token punctuation">)</span>
    <span class="token keyword">def</span> <span class="token function">callable_virtualenv</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">&quot;&quot;&quot;
        Example function that will be performed in a virtual environment.

        Importing at the module level ensures that it will not attempt to import the
        library before it is installed.
        &quot;&quot;&quot;</span>
        <span class="token keyword">from</span> time <span class="token keyword">import</span> sleep

        <span class="token keyword">from</span> colorama <span class="token keyword">import</span> Back<span class="token punctuation">,</span> Fore<span class="token punctuation">,</span> Style

        <span class="token keyword">print</span><span class="token punctuation">(</span>Fore<span class="token punctuation">.</span>RED <span class="token operator">+</span> <span class="token string">&quot;some red text&quot;</span><span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span>Back<span class="token punctuation">.</span>GREEN <span class="token operator">+</span> <span class="token string">&quot;and with a green background&quot;</span><span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span>Style<span class="token punctuation">.</span>DIM <span class="token operator">+</span> <span class="token string">&quot;and in dim text&quot;</span><span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span>Style<span class="token punctuation">.</span>RESET_ALL<span class="token punctuation">)</span>
        <span class="token keyword">for</span> _ <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span>Style<span class="token punctuation">.</span>DIM <span class="token operator">+</span> <span class="token string">&quot;Please wait...&quot;</span><span class="token punctuation">,</span> flush<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
            sleep<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;Finished&quot;</span><span class="token punctuation">)</span>

    virtualenv_task <span class="token operator">=</span> callable_virtualenv<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="使用带有预装依赖项的python环境" tabindex="-1"><a class="header-anchor" href="#使用带有预装依赖项的python环境"><span>使用带有预装依赖项的Python环境</span></a></h4><p>更复杂的<code>@task.external_python</code> decorator允许您在预定义的、不可变的virtualenv（或在没有virtualenv的系统级安装的python二进制文件）中运行Airflow任务。这个virtualenv或系统python也可以安装不同的自定义库集，并且必须在所有可以在同一位置执行任务的工作者中提供。</p><div class="language-python line-numbers-mode" data-ext="py" data-title="py"><pre class="language-python"><code>    <span class="token decorator annotation punctuation">@task<span class="token punctuation">.</span>external_python</span><span class="token punctuation">(</span>task_id<span class="token operator">=</span><span class="token string">&quot;external_python&quot;</span><span class="token punctuation">,</span> python<span class="token operator">=</span>PATH_TO_PYTHON_BINARY<span class="token punctuation">)</span>
    <span class="token keyword">def</span> <span class="token function">callable_external_python</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">&quot;&quot;&quot;
        Example function that will be performed in a virtual environment.

        Importing at the module level ensures that it will not attempt to import the
        library before it is installed.
        &quot;&quot;&quot;</span>
        <span class="token keyword">import</span> sys
        <span class="token keyword">from</span> time <span class="token keyword">import</span> sleep

        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f&quot;Running task via </span><span class="token interpolation"><span class="token punctuation">{</span>sys<span class="token punctuation">.</span>executable<span class="token punctuation">}</span></span><span class="token string">&quot;</span></span><span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;Sleeping&quot;</span><span class="token punctuation">)</span>
        <span class="token keyword">for</span> _ <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;Please wait...&quot;</span><span class="token punctuation">,</span> flush<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
            sleep<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;Finished&quot;</span><span class="token punctuation">)</span>

    external_python_task <span class="token operator">=</span> callable_external_python<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="使用docker运算符进行依赖分离" tabindex="-1"><a class="header-anchor" href="#使用docker运算符进行依赖分离"><span>使用Docker运算符进行依赖分离</span></a></h4><p>如果你的Airflow工作人员可以访问docker引擎，你可以使用DockerOperator并添加任何所需的参数来正确运行任务。请注意，docker映像必须安装一个可工作的Python，并将bash命令作为command参数。</p><div class="language-python line-numbers-mode" data-ext="py" data-title="py"><pre class="language-python"><code><span class="token decorator annotation punctuation">@task<span class="token punctuation">.</span>docker</span><span class="token punctuation">(</span>image<span class="token operator">=</span><span class="token string">&quot;python:3.9-slim-bullseye&quot;</span><span class="token punctuation">,</span> multiple_outputs<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">transform</span><span class="token punctuation">(</span>order_data_dict<span class="token punctuation">:</span> <span class="token builtin">dict</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">&quot;&quot;&quot;
    #### Transform task
    A simple Transform task which takes in the collection of order data and
    computes the total order value.
    &quot;&quot;&quot;</span>
    total_order_value <span class="token operator">=</span> <span class="token number">0</span>

    <span class="token keyword">for</span> value <span class="token keyword">in</span> order_data_dict<span class="token punctuation">.</span>values<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        total_order_value <span class="token operator">+=</span> value

    <span class="token keyword">return</span> <span class="token punctuation">{</span><span class="token string">&quot;total_order_value&quot;</span><span class="token punctuation">:</span> total_order_value<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="使用kubernetes-pod运算符进行依赖分离" tabindex="-1"><a class="header-anchor" href="#使用kubernetes-pod运算符进行依赖分离"><span>使用Kubernetes Pod运算符进行依赖分离</span></a></h4><p>如果您的Airflow工作人员可以访问Kubernetes，那么您可以使用KubernetsPodOperator并添加任何所需的参数来正确运行任务。</p><div class="language-python line-numbers-mode" data-ext="py" data-title="py"><pre class="language-python"><code><span class="token decorator annotation punctuation">@task<span class="token punctuation">.</span>kubernetes</span><span class="token punctuation">(</span>
    image<span class="token operator">=</span><span class="token string">&quot;python:3.8-slim-buster&quot;</span><span class="token punctuation">,</span>
    name<span class="token operator">=</span><span class="token string">&quot;k8s_test&quot;</span><span class="token punctuation">,</span>
    namespace<span class="token operator">=</span><span class="token string">&quot;default&quot;</span><span class="token punctuation">,</span>
    in_cluster<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span>
    config_file<span class="token operator">=</span><span class="token string">&quot;/path/to/.kube/config&quot;</span><span class="token punctuation">,</span>
<span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">execute_in_k8s_pod</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">import</span> time

    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;Hello from k8s pod&quot;</span><span class="token punctuation">)</span>
    time<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>

<span class="token decorator annotation punctuation">@task<span class="token punctuation">.</span>kubernetes</span><span class="token punctuation">(</span>image<span class="token operator">=</span><span class="token string">&quot;python:3.8-slim-buster&quot;</span><span class="token punctuation">,</span> namespace<span class="token operator">=</span><span class="token string">&quot;default&quot;</span><span class="token punctuation">,</span> in_cluster<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">print_pattern</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    n <span class="token operator">=</span> <span class="token number">5</span>
    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> n<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token comment"># inner loop to handle number of columns</span>
        <span class="token comment"># values changing acc. to outer loop</span>
        <span class="token keyword">for</span> j <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token comment"># printing stars</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;* &quot;</span><span class="token punctuation">,</span> end<span class="token operator">=</span><span class="token string">&quot;&quot;</span><span class="token punctuation">)</span>

        <span class="token comment"># ending line after each row</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;\\r&quot;</span><span class="token punctuation">)</span>

execute_in_k8s_pod_instance <span class="token operator">=</span> execute_in_k8s_pod<span class="token punctuation">(</span><span class="token punctuation">)</span>
print_pattern_instance <span class="token operator">=</span> print_pattern<span class="token punctuation">(</span><span class="token punctuation">)</span>

execute_in_k8s_pod_instance <span class="token operator">&gt;&gt;</span> print_pattern_instance
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="与传感器-sensor-操作符一起使用taskflow-api" tabindex="-1"><a class="header-anchor" href="#与传感器-sensor-操作符一起使用taskflow-api"><span>与传感器（Sensor ）操作符一起使用TaskFlow API</span></a></h3><p>您可以应用@task.sensor decorator将常规Python函数转换为BaseSensorOperator类的实例。Python函数实现poke逻辑，并像BaseSensorOperator中的poke（）方法那样返回PokeReturnValue类的实例。在Airflow 2.3中，传感器操作员将能够返回XCOM值。这是通过在poke（）方法的末尾返回PokeReturnValue对象的实例来实现的：</p><div class="language-python line-numbers-mode" data-ext="py" data-title="py"><pre class="language-python"><code><span class="token keyword">from</span> airflow<span class="token punctuation">.</span>sensors<span class="token punctuation">.</span>base <span class="token keyword">import</span> PokeReturnValue


<span class="token keyword">class</span> <span class="token class-name">SensorWithXcomValue</span><span class="token punctuation">(</span>BaseSensorOperator<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">poke</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> context<span class="token punctuation">:</span> Context<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> Union<span class="token punctuation">[</span><span class="token builtin">bool</span><span class="token punctuation">,</span> PokeReturnValue<span class="token punctuation">]</span><span class="token punctuation">:</span>
        <span class="token comment"># ...</span>
        is_done <span class="token operator">=</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>  <span class="token comment"># set to true if the sensor should stop poking.</span>
        xcom_value <span class="token operator">=</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>  <span class="token comment"># return value of the sensor operator to be pushed to XCOM.</span>
        <span class="token keyword">return</span> PokeReturnValue<span class="token punctuation">(</span>is_done<span class="token punctuation">,</span> xcom_value<span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="多输出推理" tabindex="-1"><a class="header-anchor" href="#多输出推理"><span>多输出推理</span></a></h3><p>任务还可以通过使用 dict Python类型来推断多个输出。</p><div class="language-python line-numbers-mode" data-ext="py" data-title="py"><pre class="language-python"><code><span class="token decorator annotation punctuation">@task</span>
<span class="token keyword">def</span> <span class="token function">identity_dict</span><span class="token punctuation">(</span>x<span class="token punctuation">:</span> <span class="token builtin">int</span><span class="token punctuation">,</span> y<span class="token punctuation">:</span> <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token builtin">dict</span><span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">,</span> <span class="token builtin">int</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
    <span class="token keyword">return</span> <span class="token punctuation">{</span><span class="token string">&quot;x&quot;</span><span class="token punctuation">:</span> x<span class="token punctuation">,</span> <span class="token string">&quot;y&quot;</span><span class="token punctuation">:</span> y<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>通过对函数返回类型使用键入Dict，multiple_outputs参数将自动设置为true。</p><blockquote><p>注意，如果手动设置multiple_outputs参数，则会禁用推理并使用参数值。</p></blockquote><h3 id="添加装饰任务和传统任务之间的依赖关系" tabindex="-1"><a class="header-anchor" href="#添加装饰任务和传统任务之间的依赖关系"><span>添加装饰任务和传统任务之间的依赖关系</span></a></h3><p>上面的教程展示了如何在TaskFlow函数之间创建依赖关系。但是，也可以在传统任务（如BashOperator或FileSensor）和TaskFlow函数之间设置依赖关系。</p><div class="language-python line-numbers-mode" data-ext="py" data-title="py"><pre class="language-python"><code><span class="token decorator annotation punctuation">@task</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">extract_from_file</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">&quot;&quot;&quot;
    #### Extract from file task
    A simple Extract task to get data ready for the rest of the data
    pipeline, by reading the data from a file into a pandas dataframe
    &quot;&quot;&quot;</span>
    order_data_file <span class="token operator">=</span> <span class="token string">&quot;/tmp/order_data.csv&quot;</span>
    order_data_df <span class="token operator">=</span> pd<span class="token punctuation">.</span>read_csv<span class="token punctuation">(</span>order_data_file<span class="token punctuation">)</span>


file_task <span class="token operator">=</span> FileSensor<span class="token punctuation">(</span>task_id<span class="token operator">=</span><span class="token string">&quot;check_file&quot;</span><span class="token punctuation">,</span> filepath<span class="token operator">=</span><span class="token string">&quot;/tmp/order_data.csv&quot;</span><span class="token punctuation">)</span>
order_data <span class="token operator">=</span> extract_from_file<span class="token punctuation">(</span><span class="token punctuation">)</span>

file_task <span class="token operator">&gt;&gt;</span> order_data
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>在上面的代码块中，一个新的TaskFlow函数被定义为extract_from_file，它从已知的文件位置读取数据。在主DAG中，定义了一个新的FileSensor任务来检查该文件。请注意，这是一个等待文件的传感器任务。最后，指定了此Sensor任务和TaskFlow函数之间的依赖关系。</p><h3 id="在装饰和传统任务之间消费xcoms" tabindex="-1"><a class="header-anchor" href="#在装饰和传统任务之间消费xcoms"><span>在装饰和传统任务之间消费XComs</span></a></h3><h3 id="访问装饰任务中的上下文变量" tabindex="-1"><a class="header-anchor" href="#访问装饰任务中的上下文变量"><span>访问装饰任务中的上下文变量</span></a></h3><p>当运行可调用程序时，Airflow将传递一组可在函数中使用的关键字参数。这组kwarg与您可以在Jinja模板中使用的内容完全对应。为了实现这一点，您需要在函数头中定义**kwargs，或者您可以直接添加想要获得的关键字参数——例如，使用下面的代码，您的可调用对象将获得ti和next_ds上下文变量的值。请注意，当使用显式关键字参数时，必须在函数头中将其设为可选参数，以避免在DAG解析过程中出现TypeError异常，因为这些值在任务执行之前不可用。</p><p>使用明确的参数：</p><div class="language-python line-numbers-mode" data-ext="py" data-title="py"><pre class="language-python"><code><span class="token decorator annotation punctuation">@task</span>
<span class="token keyword">def</span> <span class="token function">my_python_callable</span><span class="token punctuation">(</span>ti<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> next_ds<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">pass</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>使用kwargs：</p><div class="language-python line-numbers-mode" data-ext="py" data-title="py"><pre class="language-python"><code><span class="token decorator annotation punctuation">@task</span>
<span class="token keyword">def</span> <span class="token function">my_python_callable</span><span class="token punctuation">(</span><span class="token operator">**</span>kwargs<span class="token punctuation">)</span><span class="token punctuation">:</span>
    ti <span class="token operator">=</span> kwargs<span class="token punctuation">[</span><span class="token string">&quot;ti&quot;</span><span class="token punctuation">]</span>
    next_ds <span class="token operator">=</span> kwargs<span class="token punctuation">[</span><span class="token string">&quot;next_ds&quot;</span><span class="token punctuation">]</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>此外，有时您可能希望访问堆栈深处的某个上下文，但不希望传递可调用任务中的上下文变量。您仍然可以通过get_current_context方法访问执行上下文。</p><div class="language-python line-numbers-mode" data-ext="py" data-title="py"><pre class="language-python"><code><span class="token keyword">from</span> airflow<span class="token punctuation">.</span>operators<span class="token punctuation">.</span>python <span class="token keyword">import</span> get_current_context


<span class="token keyword">def</span> <span class="token function">some_function_in_your_library</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    context <span class="token operator">=</span> get_current_context<span class="token punctuation">(</span><span class="token punctuation">)</span>
    ti <span class="token operator">=</span> context<span class="token punctuation">[</span><span class="token string">&quot;ti&quot;</span><span class="token punctuation">]</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>当前上下文只能在任务执行期间访问。在执行前或执行后，上下文不可访问。在执行上下文之外调用此方法将引发错误。</p><h1 id="构建pip" tabindex="-1"><a class="header-anchor" href="#构建pip"><span>构建pip</span></a></h1><p>让我们看另一个例子：我们需要从在线托管的文件中获取一些数据，并将其插入本地数据库。我们还需要考虑在插入时删除重复的行。</p><h2 id="初始设置" tabindex="-1"><a class="header-anchor" href="#初始设置"><span>初始设置</span></a></h2><p>我们需要安装Docker：</p><div class="language-bash line-numbers-mode" data-ext="sh" data-title="sh"><pre class="language-bash"><code><span class="token comment"># Download the docker-compose.yaml file</span>
<span class="token function">curl</span> <span class="token parameter variable">-LfO</span> <span class="token string">&#39;https://airflow.apache.org/docs/apache-airflow/stable/docker-compose.yaml&#39;</span>

<span class="token comment"># Make expected directories and set an expected environment variable</span>
<span class="token function">mkdir</span> <span class="token parameter variable">-p</span> ./dags ./logs ./plugins
<span class="token builtin class-name">echo</span> <span class="token parameter variable">-e</span> <span class="token string">&quot;AIRFLOW_UID=<span class="token variable"><span class="token variable">$(</span><span class="token function">id</span> <span class="token parameter variable">-u</span><span class="token variable">)</span></span>&quot;</span> <span class="token operator">&gt;</span> .env

<span class="token comment"># Initialize the database</span>
<span class="token function">docker-compose</span> up airflow-init

<span class="token comment"># Start up all services</span>
<span class="token function">docker-compose</span> up
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>所有服务启动后，web UI将在以下位置可用：http://localhost:8080.默认帐户具有用户名airflow和密码airflow。</p><p>我们还需要创建一个到postgresdb的连接。要通过web UI创建一个，请从“Admin”菜单中选择“Connections”，然后单击加号将<code>Add a new record</code> 添加到连接列表中。</p><p>填写如下所示的字段。请注意Connection Id值，我们将把它作为postgres_conn_Id kwarg的参数传递:</p><ul><li>Connection Id: tutorial_pg_conn</li><li>Connection Type: postgres</li><li>Host: postgres</li><li>Schema: airflow</li><li>Login: airflow</li><li>Password: airflow</li><li>Port: 5432</li></ul><h1 id="架构" tabindex="-1"><a class="header-anchor" href="#架构"><span>架构</span></a></h1><p>Airflow是一个允许您构建和运行工作流的平台。工作流被表示为DAG（有向无循环图），包含称为任务的单独单元，并考虑了任务的依赖关系和数据流。</p><figure><img src="`+v+'" alt="An example Airflow DAG, rendered in Graph" tabindex="0" loading="lazy"><figcaption>An example Airflow DAG, rendered in Graph</figcaption></figure><p>DAG指定任务之间的依赖关系，以及执行任务和运行重试的顺序；任务本身描述了要做什么，例如获取数据、运行分析、触发其他系统 等等。</p><p>Airflow通常由以下部件组成：</p>',96),S={href:"https://airflow.apache.org/docs/apache-airflow/stable/administration-and-deployment/scheduler.html",target:"_blank",rel:"noopener noreferrer"},R={href:"https://airflow.apache.org/docs/apache-airflow/stable/core-concepts/executor/index.html",target:"_blank",rel:"noopener noreferrer"},I=n("li",null,"Web服务器，它提供了一个方便的用户界面来检查、触发和调试DAG和任务的行为。",-1),F=n("li",null,"DAG文件的文件夹，由调度程序和执行程序（以及执行程序拥有的任何工作者）读取",-1),L=n("li",null,"一个元数据数据库，由调度器、执行器和Web服务器用来存储状态。",-1),N=n("figure",null,[n("img",{src:m,alt:"../_images/arch-diag-basic.png",tabindex:"0",loading:"lazy"}),n("figcaption",null,"../_images/arch-diag-basic.png")],-1),C=n("p",null,"大多数执行器通常还会引入其他组件，让他们与工作人员交谈，比如任务队列。",-1),V=n("h2",{id:"工作负载",tabindex:"-1"},[n("a",{class:"header-anchor",href:"#工作负载"},[n("span",null,"工作负载")])],-1),K=n("p",null,"DAG运行一系列任务，您将看到三种常见类型的任务：",-1),B={href:"https://airflow.apache.org/docs/apache-airflow/stable/core-concepts/operators.html",target:"_blank",rel:"noopener noreferrer"},M={href:"https://airflow.apache.org/docs/apache-airflow/stable/core-concepts/sensors.html",target:"_blank",rel:"noopener noreferrer"},z=n("li",null,"TaskFlow @task，将自定义Python函数包装成task。",-1),U=e(`<p>在内部，这些实际上都是Airflow的BaseOperator的子类，Task和Operator的概念在某种程度上是可互换的，但将它们视为单独的概念是有用的——本质上，Operators和Sensors是模板，当你在DAG文件中调用一个模板时，就生成了Task。</p><h2 id="控制流程" tabindex="-1"><a class="header-anchor" href="#控制流程"><span>控制流程</span></a></h2><p>DAG被设计为多次运行，并且它们的多次运行可以并行进行。DAG是参数化的，总是包括它们<strong>运行的间隔</strong>（数据间隔），但也有其他可选参数。</p><p>任务之间有声明的依赖关系:</p><div class="language-bash line-numbers-mode" data-ext="sh" data-title="sh"><pre class="language-bash"><code>first_task <span class="token operator">&gt;&gt;</span> <span class="token punctuation">[</span>second_task, third_task<span class="token punctuation">]</span>
fourth_task <span class="token operator">&lt;&lt;</span> third_task
first_task.set_downstream<span class="token punctuation">(</span><span class="token punctuation">[</span>second_task, third_task<span class="token punctuation">]</span><span class="token punctuation">)</span>
fourth_task.set_upstream<span class="token punctuation">(</span>third_task<span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>这些依赖关系构成了图形的<strong>边</strong>，以及Airflow如何确定任务的运行顺序。默认情况下，任务将等待所有上游任务成功后才能运行，但这可以使用<code>Branching</code>、<code>LatestOnly</code>和<code>Trigger Rules</code>等功能进行自定义。</p><p>要在任务之间传递数据，您有三个选项：</p><ul><li>XComs（交叉通信），一个可以让任务推送和提取少量元数据的系统。</li><li>从存储服务（您运行的存储服务或公共云的一部分）上传和下载大文件</li><li>TaskFlow API通过隐式XComs在任务之间自动传递数据</li></ul><p>当空间可用时，Airflow会发送任务在Workers上运行，因此无法保证DAG中的所有任务都会在同一个worker或同一台机器上运行。</p><p>当你构建DAG时，它们可能会变得非常复杂，因此Airflow提供了几种机制来使其更具可用性——SubDAG可以让你制作<strong>可重复使用的DAG</strong>，你可以嵌入其他DAG中，而TaskGroups可以让你在UI中<strong>对任务进行可视化分组</strong>。</p><p>还有一些功能可以让您以Connections&amp;Hooks的形式轻松地预配置对中央资源（如数据存储）的访问，也可以通过Pools限制并发性。</p><h2 id="用户界面" tabindex="-1"><a class="header-anchor" href="#用户界面"><span>用户界面</span></a></h2><p>Airflow提供了一个用户界面，可以让您查看DAG及其任务正在做什么，触发DAG的运行，查看日志，并对DAG的问题进行一些有限的调试和解决。</p><figure><img src="`+b+'" alt="../_images/dags.png" tabindex="0" loading="lazy"><figcaption>../_images/dags.png</figcaption></figure><h1 id="dag" tabindex="-1"><a class="header-anchor" href="#dag"><span>DAG</span></a></h1><p>DAG（有向无循环图）是Airflow的核心概念，它将任务组织在一起，用依赖关系进行组织，以说明它们应该如何运行。</p><figure><img src="'+g+`" alt="../_images/basic-dag.png" tabindex="0" loading="lazy"><figcaption>../_images/basic-dag.png</figcaption></figure><p>它定义了四个任务——A、B、C和D——并规定了它们必须运行的顺序，以及依赖关系。它还将说明DAG的运行频率——可能是<code>从明天开始每5分钟</code>，也可能是<code>自2020年1月1日起每天</code>。</p><blockquote><p>DAG本身并不关心任务内部发生的事情；它只关心如何执行它们——运行它们的顺序、重试次数、是否超时等等。</p></blockquote><h2 id="声明dag" tabindex="-1"><a class="header-anchor" href="#声明dag"><span>声明DAG</span></a></h2><p>有三种方法可以声明DAG:</p><ol><li><p>您可以使用上下文管理器，它将其中的任何内容隐式添加到DAG：</p><div class="language-python line-numbers-mode" data-ext="py" data-title="py"><pre class="language-python"><code> <span class="token keyword">import</span> datetime

 <span class="token keyword">from</span> airflow <span class="token keyword">import</span> DAG
 <span class="token keyword">from</span> airflow<span class="token punctuation">.</span>operators<span class="token punctuation">.</span>empty <span class="token keyword">import</span> EmptyOperator

 <span class="token keyword">with</span> DAG<span class="token punctuation">(</span>
     dag_id<span class="token operator">=</span><span class="token string">&quot;my_dag_name&quot;</span><span class="token punctuation">,</span>
     start_date<span class="token operator">=</span>datetime<span class="token punctuation">.</span>datetime<span class="token punctuation">(</span><span class="token number">2021</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
     schedule<span class="token operator">=</span><span class="token string">&quot;@daily&quot;</span><span class="token punctuation">,</span>
 <span class="token punctuation">)</span><span class="token punctuation">:</span>
     EmptyOperator<span class="token punctuation">(</span>task_id<span class="token operator">=</span><span class="token string">&quot;task&quot;</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li><li><p>使用标准构造函数，将DAG传递给您使用的任何运算符：</p><div class="language-python line-numbers-mode" data-ext="py" data-title="py"><pre class="language-python"><code> <span class="token keyword">import</span> datetime

 <span class="token keyword">from</span> airflow <span class="token keyword">import</span> DAG
 <span class="token keyword">from</span> airflow<span class="token punctuation">.</span>operators<span class="token punctuation">.</span>empty <span class="token keyword">import</span> EmptyOperator

 my_dag <span class="token operator">=</span> DAG<span class="token punctuation">(</span>
     dag_id<span class="token operator">=</span><span class="token string">&quot;my_dag_name&quot;</span><span class="token punctuation">,</span>
     start_date<span class="token operator">=</span>datetime<span class="token punctuation">.</span>datetime<span class="token punctuation">(</span><span class="token number">2021</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
     schedule<span class="token operator">=</span><span class="token string">&quot;@daily&quot;</span><span class="token punctuation">,</span>
 <span class="token punctuation">)</span>
 EmptyOperator<span class="token punctuation">(</span>task_id<span class="token operator">=</span><span class="token string">&quot;task&quot;</span><span class="token punctuation">,</span> dag<span class="token operator">=</span>my_dag<span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li><li><p>使用@dag decorator将函数转换为dag生成器：</p><div class="language-python line-numbers-mode" data-ext="py" data-title="py"><pre class="language-python"><code><span class="token keyword">import</span> datetime

<span class="token keyword">from</span> airflow<span class="token punctuation">.</span>decorators <span class="token keyword">import</span> dag
<span class="token keyword">from</span> airflow<span class="token punctuation">.</span>operators<span class="token punctuation">.</span>empty <span class="token keyword">import</span> EmptyOperator


<span class="token decorator annotation punctuation">@dag</span><span class="token punctuation">(</span>start_date<span class="token operator">=</span>datetime<span class="token punctuation">.</span>datetime<span class="token punctuation">(</span><span class="token number">2021</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> schedule<span class="token operator">=</span><span class="token string">&quot;@daily&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">generate_dag</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    EmptyOperator<span class="token punctuation">(</span>task_id<span class="token operator">=</span><span class="token string">&quot;task&quot;</span><span class="token punctuation">)</span>


generate_dag<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li></ol><p>DAG没有要运行的任务就什么都不是，它们通常以Operators、Sensors或TaskFlow的形式出现。</p><h3 id="任务依赖" tabindex="-1"><a class="header-anchor" href="#任务依赖"><span>任务依赖</span></a></h3><p><strong>任务/操作符</strong> 通常不会独自生活；它依赖于其他任务（上游任务），其他任务依赖于它（下游任务）。声明任务之间的这些依赖关系构成了DAG结构（有向无环图的边）。</p><p>有两种主要的方法来声明各个任务的依赖关系。建议使用<code>&gt;&gt;</code>和<code>&lt;&lt;</code>运算符：</p><div class="language-python line-numbers-mode" data-ext="py" data-title="py"><pre class="language-python"><code>first_task <span class="token operator">&gt;&gt;</span> <span class="token punctuation">[</span>second_task<span class="token punctuation">,</span> third_task<span class="token punctuation">]</span>
third_task <span class="token operator">&lt;&lt;</span> fourth_task
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p>或者，您也可以使用更明确的set_upstream和set_downstream方法：</p><div class="language-python line-numbers-mode" data-ext="py" data-title="py"><pre class="language-python"><code>first_task<span class="token punctuation">.</span>set_downstream<span class="token punctuation">(</span>second_task<span class="token punctuation">,</span> third_task<span class="token punctuation">)</span>
third_task<span class="token punctuation">.</span>set_upstream<span class="token punctuation">(</span>fourth_task<span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p>还有一些快捷方式可以声明更复杂的依赖关系。如果你想让两个任务列表相互依赖，你不能使用上面的任何一种方法，所以你需要使用<code>cross_downstream</code>：</p><div class="language-python line-numbers-mode" data-ext="py" data-title="py"><pre class="language-python"><code><span class="token keyword">from</span> airflow<span class="token punctuation">.</span>models<span class="token punctuation">.</span>baseoperator <span class="token keyword">import</span> cross_downstream

<span class="token comment"># Replaces</span>
<span class="token comment"># [op1, op2] &gt;&gt; op3</span>
<span class="token comment"># [op1, op2] &gt;&gt; op4</span>
cross_downstream<span class="token punctuation">(</span><span class="token punctuation">[</span>op1<span class="token punctuation">,</span> op2<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>op3<span class="token punctuation">,</span> op4<span class="token punctuation">]</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>如果您想将依赖项链接在一起，可以使用chain：</p><div class="language-python line-numbers-mode" data-ext="py" data-title="py"><pre class="language-python"><code><span class="token keyword">from</span> airflow<span class="token punctuation">.</span>models<span class="token punctuation">.</span>baseoperator <span class="token keyword">import</span> chain

<span class="token comment"># Replaces op1 &gt;&gt; op2 &gt;&gt; op3 &gt;&gt; op4</span>
chain<span class="token punctuation">(</span>op1<span class="token punctuation">,</span> op2<span class="token punctuation">,</span> op3<span class="token punctuation">,</span> op4<span class="token punctuation">)</span>

<span class="token comment"># You can also do it dynamically</span>
chain<span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">[</span>EmptyOperator<span class="token punctuation">(</span>task_id<span class="token operator">=</span><span class="token string">&#39;op&#39;</span> <span class="token operator">+</span> i<span class="token punctuation">)</span> <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>Chain还可以对相同大小的列表进行成对依赖（这与cross_downstream创建的交叉依赖不同！）：</p><div class="language-python line-numbers-mode" data-ext="py" data-title="py"><pre class="language-python"><code><span class="token keyword">from</span> airflow<span class="token punctuation">.</span>models<span class="token punctuation">.</span>baseoperator <span class="token keyword">import</span> chain

<span class="token comment"># Replaces</span>
<span class="token comment"># op1 &gt;&gt; op2 &gt;&gt; op4 &gt;&gt; op6</span>
<span class="token comment"># op1 &gt;&gt; op3 &gt;&gt; op5 &gt;&gt; op6</span>
chain<span class="token punctuation">(</span>op1<span class="token punctuation">,</span> <span class="token punctuation">[</span>op2<span class="token punctuation">,</span> op3<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>op4<span class="token punctuation">,</span> op5<span class="token punctuation">]</span><span class="token punctuation">,</span> op6<span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="加载dag" tabindex="-1"><a class="header-anchor" href="#加载dag"><span>加载DAG</span></a></h2><p>Airflow从Python源文件加载DAG，并在其配置的DAG_FOLDER中查找这些文件。</p><p>这意味着您可以为每个Python文件定义多个DAG，甚至可以使用导入将一个非常复杂的DAG分布在多个Python文件中。</p><p>不过，请注意，当Airflow从Python文件加载DAG时，它只会拉取作为DAG实例的顶层的任何对象。例如，以以下DAG文件为例：</p><div class="language-python line-numbers-mode" data-ext="py" data-title="py"><pre class="language-python"><code>dag_1 <span class="token operator">=</span> DAG<span class="token punctuation">(</span><span class="token string">&#39;this_dag_will_be_discovered&#39;</span><span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">my_function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    dag_2 <span class="token operator">=</span> DAG<span class="token punctuation">(</span><span class="token string">&#39;but_this_dag_will_not&#39;</span><span class="token punctuation">)</span>

my_function<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>当访问文件时，两个DAG构造函数都会被调用，但只有DAG_1处于顶级（在globals（）中），因此只有它被添加到Airflow中。dag2未加载。</p><blockquote><p>在DAG_FOLDER中搜索DAG时，Airflow只将包含字符串Airflow和DAG（不区分大小写）的Python文件视为DAG。要考虑所有Python文件，请禁用DAG_DISCOVERY_SAFE_MODE配置标志。</p></blockquote><p>您还可以在<code>DAG_FOLDER</code>或其任何子文件夹中提供.airflowignore文件，该文件描述了加载程序要忽略的文件模式。它覆盖了它所在的目录及其下的所有子文件夹。</p><p>如果.airflowignore不能满足您的需求，并且您想要一种更灵活的方式来控制是否需要由Airflow解析python文件。您可以通过在配置文件中设置<code>might_contain_dag_callable</code>来插入您的可调用文件。注意，此可调用项将替换默认的Airflow启发式，即检查文件中的字符串Airflow和dag（不区分大小写）。</p><div class="language-python line-numbers-mode" data-ext="py" data-title="py"><pre class="language-python"><code><span class="token keyword">def</span> <span class="token function">might_contain_dag</span><span class="token punctuation">(</span>file_path<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">,</span> zip_file<span class="token punctuation">:</span> zipfile<span class="token punctuation">.</span>ZipFile <span class="token operator">|</span> <span class="token boolean">None</span> <span class="token operator">=</span> <span class="token boolean">None</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token builtin">bool</span><span class="token punctuation">:</span>
    <span class="token comment"># Your logic to check if there are DAGs defined in the file_path</span>
    <span class="token comment"># Return True if the file_path needs to be parsed, otherwise False</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="运行dag" tabindex="-1"><a class="header-anchor" href="#运行dag"><span>运行DAG</span></a></h2><p>DAG将以两种方式之一运行：</p><ul><li>当手动或通过API触发它们时</li><li>在定义的schedule上，该schedule被定义为DAG的一部分</li></ul><p>schedule不是强制的，但定义schedule是很常见的。您可以通过schedule参数来定义它，如下所示：</p><div class="language-python line-numbers-mode" data-ext="py" data-title="py"><pre class="language-python"><code><span class="token keyword">with</span> DAG<span class="token punctuation">(</span><span class="token string">&quot;my_daily_dag&quot;</span><span class="token punctuation">,</span> schedule<span class="token operator">=</span><span class="token string">&quot;@daily&quot;</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p>schedule使用任何有效的Crontab计划值，因此您也可以执行以下操作：</p><div class="language-python line-numbers-mode" data-ext="py" data-title="py"><pre class="language-python"><code><span class="token keyword">with</span> DAG<span class="token punctuation">(</span><span class="token string">&quot;my_daily_dag&quot;</span><span class="token punctuation">,</span> schedule<span class="token operator">=</span><span class="token string">&quot;0 0 * * *&quot;</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p>每次运行DAG时，都会创建该DAG的新实例，Airflow称之为DAG run。DAG运行可以对同一个DAG并行运行，每个DAG都有一个定义的数据间隔，用于标识任务应该操作的数据周期。</p><p>DAG运行将在开始时具有开始日期，在结束时具有结束日期。此时间段描述DAG实际“运行”的时间除了DAG运行的开始和结束日期外，还有一个称为逻辑日期（正式名称为执行日期）的日期，它描述了DAG运行计划或触发的预期时间。之所以称之为逻辑，是因为它的抽象性质具有多种含义，这取决于DAG运行本身的上下文。</p><p>例如，如果DAG运行是由用户手动触发的，则其逻辑日期将是触发DAG运行的日期和时间，并且该值应等于DAG运行开始日期。然而，当DAG被自动调度时，在特定的调度间隔到位的情况下，逻辑日期将指示它标记数据间隔开始的时间，其中DAG运行的开始日期将是逻辑日期+调度间隔。</p><h2 id="默认参数" tabindex="-1"><a class="header-anchor" href="#默认参数"><span>默认参数</span></a></h2><p>通常，DAG中的许多操作符需要相同的一组默认参数（例如重试次数）。不必为每个操作符单独指定，而是可以在创建DAG时将default_args传递给DAG，DAG将自动将它们应用于与其绑定的任何运算符：</p><div class="language-python line-numbers-mode" data-ext="py" data-title="py"><pre class="language-python"><code><span class="token keyword">import</span> pendulum

<span class="token keyword">with</span> DAG<span class="token punctuation">(</span>
    dag_id<span class="token operator">=</span><span class="token string">&quot;my_dag&quot;</span><span class="token punctuation">,</span>
    start_date<span class="token operator">=</span>pendulum<span class="token punctuation">.</span>datetime<span class="token punctuation">(</span><span class="token number">2016</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    schedule<span class="token operator">=</span><span class="token string">&quot;@daily&quot;</span><span class="token punctuation">,</span>
    default_args<span class="token operator">=</span><span class="token punctuation">{</span><span class="token string">&quot;retries&quot;</span><span class="token punctuation">:</span> <span class="token number">2</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">)</span><span class="token punctuation">:</span>
    op <span class="token operator">=</span> BashOperator<span class="token punctuation">(</span>task_id<span class="token operator">=</span><span class="token string">&quot;hello_world&quot;</span><span class="token punctuation">,</span> bash_command<span class="token operator">=</span><span class="token string">&quot;Hello World!&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>op<span class="token punctuation">.</span>retries<span class="token punctuation">)</span>  <span class="token comment"># 2</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="控制流程-1" tabindex="-1"><a class="header-anchor" href="#控制流程-1"><span>控制流程</span></a></h2><p>默认情况下，DAG只有在它所依赖的所有任务都成功时才会运行任务。但是，有几种方法可以对此进行修改：</p>`,60),W={href:"https://airflow.apache.org/docs/apache-airflow/stable/core-concepts/dags.html#concepts-branching",target:"_blank",rel:"noopener noreferrer"},j={href:"https://airflow.apache.org/docs/apache-airflow/stable/core-concepts/dags.html#concepts-trigger-rules",target:"_blank",rel:"noopener noreferrer"},H={href:"https://airflow.apache.org/docs/apache-airflow/stable/howto/setup-and-teardown.html",target:"_blank",rel:"noopener noreferrer"},Y=n("li",null,"Latest Only-一种特殊的分支形式，只在当前运行的DAG上运行",-1),X={href:"https://airflow.apache.org/docs/apache-airflow/stable/core-concepts/dags.html#concepts-depends-on-past",target:"_blank",rel:"noopener noreferrer"},J=e(`<h3 id="分支" tabindex="-1"><a class="header-anchor" href="#分支"><span>分支</span></a></h3><p>您可以利用分支来告诉DAG不要运行所有依赖的任务，而是选择一个或多个路径。这就是@task.branch装饰器的用武之地。 @task.branch decorator与@task非常相似，只是它希望decorated函数向任务返回ID（或ID列表）。将遵循指定的任务，而跳过所有其他路径。它还可以返回None以跳过所有下游任务。</p><p>@task.branch也可以与XComs一起使用，允许分支上下文根据上游任务动态决定要遵循哪个分支。例如：</p><div class="language-python line-numbers-mode" data-ext="py" data-title="py"><pre class="language-python"><code><span class="token decorator annotation punctuation">@task<span class="token punctuation">.</span>branch</span><span class="token punctuation">(</span>task_id<span class="token operator">=</span><span class="token string">&quot;branch_task&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">branch_func</span><span class="token punctuation">(</span>ti<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    xcom_value <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>ti<span class="token punctuation">.</span>xcom_pull<span class="token punctuation">(</span>task_ids<span class="token operator">=</span><span class="token string">&quot;start_task&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> xcom_value <span class="token operator">&gt;=</span> <span class="token number">5</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token string">&quot;continue_task&quot;</span>
    <span class="token keyword">elif</span> xcom_value <span class="token operator">&gt;=</span> <span class="token number">3</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token string">&quot;stop_task&quot;</span>
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token boolean">None</span>


start_op <span class="token operator">=</span> BashOperator<span class="token punctuation">(</span>
    task_id<span class="token operator">=</span><span class="token string">&quot;start_task&quot;</span><span class="token punctuation">,</span>
    bash_command<span class="token operator">=</span><span class="token string">&quot;echo 5&quot;</span><span class="token punctuation">,</span>
    xcom_push<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>
    dag<span class="token operator">=</span>dag<span class="token punctuation">,</span>
<span class="token punctuation">)</span>

branch_op <span class="token operator">=</span> branch_func<span class="token punctuation">(</span><span class="token punctuation">)</span>

continue_op <span class="token operator">=</span> EmptyOperator<span class="token punctuation">(</span>task_id<span class="token operator">=</span><span class="token string">&quot;continue_task&quot;</span><span class="token punctuation">,</span> dag<span class="token operator">=</span>dag<span class="token punctuation">)</span>
stop_op <span class="token operator">=</span> EmptyOperator<span class="token punctuation">(</span>task_id<span class="token operator">=</span><span class="token string">&quot;stop_task&quot;</span><span class="token punctuation">,</span> dag<span class="token operator">=</span>dag<span class="token punctuation">)</span>

start_op <span class="token operator">&gt;&gt;</span> branch_op <span class="token operator">&gt;&gt;</span> <span class="token punctuation">[</span>continue_op<span class="token punctuation">,</span> stop_op<span class="token punctuation">]</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>如果您希望使用分支功能实现自己的运算符，可以从BaseBranchOperator继承，它的行为与@task.branch decorator类似，但希望您提供方法choose_branch的实现。</p><p>与@task.branch的可调用函数一样，此方法可以返回下游任务的ID或任务ID列表，这些任务ID将被运行，所有其他任务都将被跳过。它还可以返回None以跳过所有下游任务：</p><div class="language-python line-numbers-mode" data-ext="py" data-title="py"><pre class="language-python"><code><span class="token keyword">class</span> <span class="token class-name">MyBranchOperator</span><span class="token punctuation">(</span>BaseBranchOperator<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">choose_branch</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> context<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">&quot;&quot;&quot;
        Run an extra branch on the first day of the month
        &quot;&quot;&quot;</span>
        <span class="token keyword">if</span> context<span class="token punctuation">[</span><span class="token string">&#39;data_interval_start&#39;</span><span class="token punctuation">]</span><span class="token punctuation">.</span>day <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">:</span>
            <span class="token keyword">return</span> <span class="token punctuation">[</span><span class="token string">&#39;daily_task_id&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;monthly_task_id&#39;</span><span class="token punctuation">]</span>
        <span class="token keyword">elif</span> context<span class="token punctuation">[</span><span class="token string">&#39;data_interval_start&#39;</span><span class="token punctuation">]</span><span class="token punctuation">.</span>day <span class="token operator">==</span> <span class="token number">2</span><span class="token punctuation">:</span>
            <span class="token keyword">return</span> <span class="token string">&#39;daily_task_id&#39;</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            <span class="token keyword">return</span> <span class="token boolean">None</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="latest-only" tabindex="-1"><a class="header-anchor" href="#latest-only"><span>Latest Only</span></a></h3><p>Airflow的DAG run通常在与当前日期不同的日期运行，例如，在上个月的每一天运行一份DAG副本以回填一些数据。</p><p>不过，在某些情况下，你不想让DAG的某些（或全部）部分在前一个日期运行；在这种情况下，您可以使用LatestOnlyOperator。</p><p>如果您不在“最新”DAG运行中（如果当前墙上的时钟时间在其执行时间和下一个计划执行时间之间，并且它不是外部触发的运行），则此特殊操作符将跳过其下游的所有任务。</p><div class="language-python line-numbers-mode" data-ext="py" data-title="py"><pre class="language-python"><code><span class="token keyword">import</span> datetime

<span class="token keyword">import</span> pendulum

<span class="token keyword">from</span> airflow <span class="token keyword">import</span> DAG
<span class="token keyword">from</span> airflow<span class="token punctuation">.</span>operators<span class="token punctuation">.</span>empty <span class="token keyword">import</span> EmptyOperator
<span class="token keyword">from</span> airflow<span class="token punctuation">.</span>operators<span class="token punctuation">.</span>latest_only <span class="token keyword">import</span> LatestOnlyOperator
<span class="token keyword">from</span> airflow<span class="token punctuation">.</span>utils<span class="token punctuation">.</span>trigger_rule <span class="token keyword">import</span> TriggerRule

<span class="token keyword">with</span> DAG<span class="token punctuation">(</span>
    dag_id<span class="token operator">=</span><span class="token string">&quot;latest_only_with_trigger&quot;</span><span class="token punctuation">,</span>
    schedule<span class="token operator">=</span>datetime<span class="token punctuation">.</span>timedelta<span class="token punctuation">(</span>hours<span class="token operator">=</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    start_date<span class="token operator">=</span>pendulum<span class="token punctuation">.</span>datetime<span class="token punctuation">(</span><span class="token number">2021</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> tz<span class="token operator">=</span><span class="token string">&quot;UTC&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    catchup<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span>
    tags<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">&quot;example3&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">)</span> <span class="token keyword">as</span> dag<span class="token punctuation">:</span>
    latest_only <span class="token operator">=</span> LatestOnlyOperator<span class="token punctuation">(</span>task_id<span class="token operator">=</span><span class="token string">&quot;latest_only&quot;</span><span class="token punctuation">)</span>
    task1 <span class="token operator">=</span> EmptyOperator<span class="token punctuation">(</span>task_id<span class="token operator">=</span><span class="token string">&quot;task1&quot;</span><span class="token punctuation">)</span>
    task2 <span class="token operator">=</span> EmptyOperator<span class="token punctuation">(</span>task_id<span class="token operator">=</span><span class="token string">&quot;task2&quot;</span><span class="token punctuation">)</span>
    task3 <span class="token operator">=</span> EmptyOperator<span class="token punctuation">(</span>task_id<span class="token operator">=</span><span class="token string">&quot;task3&quot;</span><span class="token punctuation">)</span>
    task4 <span class="token operator">=</span> EmptyOperator<span class="token punctuation">(</span>task_id<span class="token operator">=</span><span class="token string">&quot;task4&quot;</span><span class="token punctuation">,</span> trigger_rule<span class="token operator">=</span>TriggerRule<span class="token punctuation">.</span>ALL_DONE<span class="token punctuation">)</span>

    latest_only <span class="token operator">&gt;&gt;</span> task1 <span class="token operator">&gt;&gt;</span> <span class="token punctuation">[</span>task3<span class="token punctuation">,</span> task4<span class="token punctuation">]</span>
    task2 <span class="token operator">&gt;&gt;</span> <span class="token punctuation">[</span>task3<span class="token punctuation">,</span> task4<span class="token punctuation">]</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>task1直接位于latest_only的下游，将跳过除最新运行之外的所有运行。</li><li>task2完全独立于latest_only，并且将在所有计划的时段中运行</li><li>task3位于task1和task2的下游，由于默认触发规则为all_success，因此将从task1接收级联跳过。</li><li>task4位于task1和task2的下游，但不会跳过它，因为它的trigger_rule设置为all_done。</li></ul><figure><img src="`+h+`" alt="../_images/latest_only_with_trigger.png" tabindex="0" loading="lazy"><figcaption>../_images/latest_only_with_trigger.png</figcaption></figure><h3 id="依赖于过去" tabindex="-1"><a class="header-anchor" href="#依赖于过去"><span>依赖于过去</span></a></h3><p>您也可以说，只有在上一次DAG运行中任务的上一次运行成功时，任务才能运行。要使用它，您只需要将Task上的dependens_on_plast参数设置为True。</p><p>请注意，如果您在DAG生命的最初阶段（特别是它的第一次自动运行）运行DAG，那么Task仍将运行，因为没有以前的运行可依赖。</p><h3 id="触发器规则" tabindex="-1"><a class="header-anchor" href="#触发器规则"><span>触发器规则</span></a></h3><p>默认情况下，Airflow将等待所有上游（直接父任务）任务成功，然后再运行该任务。然而，这只是默认行为，您可以使用Task的trigger_rule参数来控制它。trigger_rule的选项包括：</p><ul><li>all_success（默认）：所有上游任务都已成功</li><li>all_failed：所有上游任务都处于失败或上游失败状态</li><li>all_done：所有上游任务都已执行完毕</li><li>all_skipped:所有上游任务都处于跳过状态</li><li>one_failed:至少有一个上游任务失败（不等待所有上游任务完成）</li><li>one_success:至少有一个上游任务成功（不等待所有上游任务完成）</li><li>one_done:至少有一个上游任务成功或失败</li><li>none_failed：所有上游任务没有失败或upstream_failed，即所有上游任务都已成功或跳过</li><li>none_failed_min_one_success：所有上游任务都没有失败或上游失败，并且至少有一个上游任务成功。</li><li>none_skipped：没有上游任务处于跳过状态，即所有上游任务都处于成功、失败或上游失败状态 始终：完全没有依赖项，随时运行此任务</li></ul><blockquote><p>如果您愿意，也可以将其与“依赖过去”功能结合使用。</p></blockquote><p>重要的是要注意触发规则和跳过的任务之间的交互，尤其是作为分支操作的一部分跳过的任务。您几乎从不希望在分支操作的下游使用all_success或all_failed。</p><p>跳过的任务将通过触发规则all_success和all_failed级联，并导致它们也跳过。考虑以下DAG：</p><div class="language-python line-numbers-mode" data-ext="py" data-title="py"><pre class="language-python"><code><span class="token comment"># dags/branch_without_trigger.py</span>
<span class="token keyword">import</span> pendulum

<span class="token keyword">from</span> airflow<span class="token punctuation">.</span>decorators <span class="token keyword">import</span> task
<span class="token keyword">from</span> airflow<span class="token punctuation">.</span>models <span class="token keyword">import</span> DAG
<span class="token keyword">from</span> airflow<span class="token punctuation">.</span>operators<span class="token punctuation">.</span>empty <span class="token keyword">import</span> EmptyOperator

dag <span class="token operator">=</span> DAG<span class="token punctuation">(</span>
    dag_id<span class="token operator">=</span><span class="token string">&quot;branch_without_trigger&quot;</span><span class="token punctuation">,</span>
    schedule<span class="token operator">=</span><span class="token string">&quot;@once&quot;</span><span class="token punctuation">,</span>
    start_date<span class="token operator">=</span>pendulum<span class="token punctuation">.</span>datetime<span class="token punctuation">(</span><span class="token number">2019</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">28</span><span class="token punctuation">,</span> tz<span class="token operator">=</span><span class="token string">&quot;UTC&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">)</span>

run_this_first <span class="token operator">=</span> EmptyOperator<span class="token punctuation">(</span>task_id<span class="token operator">=</span><span class="token string">&quot;run_this_first&quot;</span><span class="token punctuation">,</span> dag<span class="token operator">=</span>dag<span class="token punctuation">)</span>


<span class="token decorator annotation punctuation">@task<span class="token punctuation">.</span>branch</span><span class="token punctuation">(</span>task_id<span class="token operator">=</span><span class="token string">&quot;branching&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">do_branching</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">return</span> <span class="token string">&quot;branch_a&quot;</span>


branching <span class="token operator">=</span> do_branching<span class="token punctuation">(</span><span class="token punctuation">)</span>

branch_a <span class="token operator">=</span> EmptyOperator<span class="token punctuation">(</span>task_id<span class="token operator">=</span><span class="token string">&quot;branch_a&quot;</span><span class="token punctuation">,</span> dag<span class="token operator">=</span>dag<span class="token punctuation">)</span>
follow_branch_a <span class="token operator">=</span> EmptyOperator<span class="token punctuation">(</span>task_id<span class="token operator">=</span><span class="token string">&quot;follow_branch_a&quot;</span><span class="token punctuation">,</span> dag<span class="token operator">=</span>dag<span class="token punctuation">)</span>

branch_false <span class="token operator">=</span> EmptyOperator<span class="token punctuation">(</span>task_id<span class="token operator">=</span><span class="token string">&quot;branch_false&quot;</span><span class="token punctuation">,</span> dag<span class="token operator">=</span>dag<span class="token punctuation">)</span>

join <span class="token operator">=</span> EmptyOperator<span class="token punctuation">(</span>task_id<span class="token operator">=</span><span class="token string">&quot;join&quot;</span><span class="token punctuation">,</span> dag<span class="token operator">=</span>dag<span class="token punctuation">)</span>

run_this_first <span class="token operator">&gt;&gt;</span> branching
branching <span class="token operator">&gt;&gt;</span> branch_a <span class="token operator">&gt;&gt;</span> follow_branch_a <span class="token operator">&gt;&gt;</span> join
branching <span class="token operator">&gt;&gt;</span> branch_false <span class="token operator">&gt;&gt;</span> join
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>join位于follow_branch_a和branch_false的下游。联接任务将显示为已跳过，因为默认情况下其trigger_rule设置为all_success，并且分支操作导致的跳过向下级联以跳过标记为all_ssuccess的任务。</p><figure><img src="`+_+'" alt="../_images/branch_without_trigger.png" tabindex="0" loading="lazy"><figcaption>../_images/branch_without_trigger.png</figcaption></figure><p>通过在联接任务中将trigger_rule设置为none_failed_min_one_success，我们可以获得预期的行为：</p><figure><img src="'+y+`" alt="../_images/branch_with_trigger.png" tabindex="0" loading="lazy"><figcaption>../_images/branch_with_trigger.png</figcaption></figure><h3 id="setup-and-teardown" tabindex="-1"><a class="header-anchor" href="#setup-and-teardown"><span>Setup and teardown</span></a></h3><p>在数据工作流中，通常创建一个资源（如计算资源），使用它来做一些工作，然后将其拆下。Airflow提供安装和拆卸任务来支持这一需求。</p><h2 id="动态dag" tabindex="-1"><a class="header-anchor" href="#动态dag"><span>动态DAG</span></a></h2><p>由于DAG是由Python代码定义的，因此它不需要是纯粹的声明性的；您可以自由使用循环、函数等来定义DAG。 例如，这里有一个DAG，它使用For循环来定义一些任务：</p><div class="language-python line-numbers-mode" data-ext="py" data-title="py"><pre class="language-python"><code> <span class="token keyword">with</span> DAG<span class="token punctuation">(</span><span class="token string">&quot;loop_example&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">:</span>

     first <span class="token operator">=</span> EmptyOperator<span class="token punctuation">(</span>task_id<span class="token operator">=</span><span class="token string">&quot;first&quot;</span><span class="token punctuation">)</span>
     last <span class="token operator">=</span> EmptyOperator<span class="token punctuation">(</span>task_id<span class="token operator">=</span><span class="token string">&quot;last&quot;</span><span class="token punctuation">)</span>

     options <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">&quot;branch_a&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;branch_b&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;branch_c&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;branch_d&quot;</span><span class="token punctuation">]</span>
     <span class="token keyword">for</span> option <span class="token keyword">in</span> options<span class="token punctuation">:</span>
         t <span class="token operator">=</span> EmptyOperator<span class="token punctuation">(</span>task_id<span class="token operator">=</span>option<span class="token punctuation">)</span>
         first <span class="token operator">&gt;&gt;</span> t <span class="token operator">&gt;&gt;</span> last
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>一般来说，我们建议您尽量保持DAG任务的拓扑结构（布局）相对稳定；动态DAG通常更好地用于动态加载配置选项。</p><h2 id="dag可视化" tabindex="-1"><a class="header-anchor" href="#dag可视化"><span>DAG可视化</span></a></h2><p>如果要查看DAG的视觉表示，有两个选项：</p><ul><li>您可以在UI上，导航到DAG，然后选择Graph</li><li>您可以运行命令 <code>airflow dags show</code>，将其渲染为图像文件</li></ul><p>随着您开发DAG，它们将变得越来越复杂，因此我们提供了一些方法来修改这些DAG视图，使其更易于理解。</p><h3 id="任务组" tabindex="-1"><a class="header-anchor" href="#任务组"><span>任务组</span></a></h3><p>“任务组”可用于在Graph视图中将任务组织为层次组。它对于创建重复图案和减少视觉混乱非常有用。</p><p>与SubDAG不同，TaskGroups纯粹是一个UI分组概念。TaskGroups中的任务位于同一个原始DAG上，并遵守所有DAG设置和池配置。</p><figure><img src="`+f+`" alt="../_images/task_group.gif" tabindex="0" loading="lazy"><figcaption>../_images/task_group.gif</figcaption></figure><p>依赖关系可以应用于带有&gt;&gt;和&lt;&lt;运算符的TaskGroup中的所有任务。例如，以下代码将task1和task2放在TaskGroup组1中，然后将这两个任务都放在task3的上游：</p><div class="language-python line-numbers-mode" data-ext="py" data-title="py"><pre class="language-python"><code> <span class="token keyword">from</span> airflow<span class="token punctuation">.</span>decorators <span class="token keyword">import</span> task_group


 <span class="token decorator annotation punctuation">@task_group</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
 <span class="token keyword">def</span> <span class="token function">group1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
     task1 <span class="token operator">=</span> EmptyOperator<span class="token punctuation">(</span>task_id<span class="token operator">=</span><span class="token string">&quot;task1&quot;</span><span class="token punctuation">)</span>
     task2 <span class="token operator">=</span> EmptyOperator<span class="token punctuation">(</span>task_id<span class="token operator">=</span><span class="token string">&quot;task2&quot;</span><span class="token punctuation">)</span>


 task3 <span class="token operator">=</span> EmptyOperator<span class="token punctuation">(</span>task_id<span class="token operator">=</span><span class="token string">&quot;task3&quot;</span><span class="token punctuation">)</span>

 group1<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;&gt;</span> task3
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>TaskGroup也支持类似DAG的default_args，它将覆盖DAG级别的default_arg：</p><div class="language-python line-numbers-mode" data-ext="py" data-title="py"><pre class="language-python"><code><span class="token keyword">import</span> datetime

<span class="token keyword">from</span> airflow <span class="token keyword">import</span> DAG
<span class="token keyword">from</span> airflow<span class="token punctuation">.</span>decorators <span class="token keyword">import</span> task_group
<span class="token keyword">from</span> airflow<span class="token punctuation">.</span>operators<span class="token punctuation">.</span>bash <span class="token keyword">import</span> BashOperator
<span class="token keyword">from</span> airflow<span class="token punctuation">.</span>operators<span class="token punctuation">.</span>empty <span class="token keyword">import</span> EmptyOperator

<span class="token keyword">with</span> DAG<span class="token punctuation">(</span>
    dag_id<span class="token operator">=</span><span class="token string">&quot;dag1&quot;</span><span class="token punctuation">,</span>
    start_date<span class="token operator">=</span>datetime<span class="token punctuation">.</span>datetime<span class="token punctuation">(</span><span class="token number">2016</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    schedule<span class="token operator">=</span><span class="token string">&quot;@daily&quot;</span><span class="token punctuation">,</span>
    default_args<span class="token operator">=</span><span class="token punctuation">{</span><span class="token string">&quot;retries&quot;</span><span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">)</span><span class="token punctuation">:</span>

    <span class="token decorator annotation punctuation">@task_group</span><span class="token punctuation">(</span>default_args<span class="token operator">=</span><span class="token punctuation">{</span><span class="token string">&quot;retries&quot;</span><span class="token punctuation">:</span> <span class="token number">3</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token keyword">def</span> <span class="token function">group1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">&quot;&quot;&quot;This docstring will become the tooltip for the TaskGroup.&quot;&quot;&quot;</span>
        task1 <span class="token operator">=</span> EmptyOperator<span class="token punctuation">(</span>task_id<span class="token operator">=</span><span class="token string">&quot;task1&quot;</span><span class="token punctuation">)</span>
        task2 <span class="token operator">=</span> BashOperator<span class="token punctuation">(</span>task_id<span class="token operator">=</span><span class="token string">&quot;task2&quot;</span><span class="token punctuation">,</span> bash_command<span class="token operator">=</span><span class="token string">&quot;echo Hello World!&quot;</span><span class="token punctuation">,</span> retries<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span>task1<span class="token punctuation">.</span>retries<span class="token punctuation">)</span>  <span class="token comment"># 3</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span>task2<span class="token punctuation">.</span>retries<span class="token punctuation">)</span>  <span class="token comment"># 2</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>默认情况下，子任务/任务组的id前缀为其父任务组的group_id。这有助于确保group_id和task_id在整个DAG中的唯一性。 要禁用前缀，请在创建TaskGroup时传递prefix_group_id=False，但请注意，您现在将负责确保每个任务和组都有自己的唯一id。</p><h3 id="边标签" tabindex="-1"><a class="header-anchor" href="#边标签"><span>边标签</span></a></h3><p>除了将任务分组外，还可以在Graph视图中标记不同任务之间的依赖边-这对于DAG的分支区域特别有用，因此可以标记某些分支可能运行的条件。</p><p>要添加标签，可以直接与&gt;&gt;和&lt;&lt;运算符内联使用它们：</p><div class="language-python line-numbers-mode" data-ext="py" data-title="py"><pre class="language-python"><code><span class="token keyword">from</span> airflow<span class="token punctuation">.</span>utils<span class="token punctuation">.</span>edgemodifier <span class="token keyword">import</span> Label

my_task <span class="token operator">&gt;&gt;</span> Label<span class="token punctuation">(</span><span class="token string">&quot;When empty&quot;</span><span class="token punctuation">)</span> <span class="token operator">&gt;&gt;</span> other_task

<span class="token keyword">from</span> airflow<span class="token punctuation">.</span>utils<span class="token punctuation">.</span>edgemodifier <span class="token keyword">import</span> Label

my_task<span class="token punctuation">.</span>set_downstream<span class="token punctuation">(</span>other_task<span class="token punctuation">,</span> Label<span class="token punctuation">(</span><span class="token string">&quot;When empty&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>下面是一个DAG示例，它说明了如何标记不同的分支：</p><figure><img src="`+q+`" alt="../_images/edge_label_example.png" tabindex="0" loading="lazy"><figcaption>../_images/edge_label_example.png</figcaption></figure><h2 id="dag和任务文档" tabindex="-1"><a class="header-anchor" href="#dag和任务文档"><span>DAG和任务文档</span></a></h2><p>可以向您的DAG和任务对象添加文档或注释，这些文档或注释在web界面中可见（DAG的“图形”和“树”，任务的“任务实例详细信息”）。 如果定义了一组特殊的任务属性，则这些属性将被呈现为丰富的内容：</p><table><thead><tr><th>attribute</th><th>rendered to</th></tr></thead><tbody><tr><td>doc</td><td>monospace</td></tr><tr><td>doc_json</td><td>json</td></tr><tr><td>doc_yaml</td><td>yaml</td></tr><tr><td>doc_md</td><td>markdown</td></tr><tr><td>doc_rst</td><td>reStructuredText</td></tr></tbody></table><p>请注意，对于DAG，doc_md是唯一解释的属性。对于DAG，它可以包含字符串或对模板文件的引用。模板引用由以.md结尾的str识别。如果提供了相对路径，它将从DAG文件的文件夹开始。此外，模板文件必须存在，否则Airflow将引发jinja2.exceptions.TemplateNotFound异常。</p><p>如果您的任务是从配置文件动态构建的，这一点尤其有用，因为它允许您在Airflow中公开导致相关任务的配置：</p><div class="language-python line-numbers-mode" data-ext="py" data-title="py"><pre class="language-python"><code><span class="token triple-quoted-string string">&quot;&quot;&quot;
### My great DAG
&quot;&quot;&quot;</span>
<span class="token keyword">import</span> pendulum

dag <span class="token operator">=</span> DAG<span class="token punctuation">(</span>
    <span class="token string">&quot;my_dag&quot;</span><span class="token punctuation">,</span>
    start_date<span class="token operator">=</span>pendulum<span class="token punctuation">.</span>datetime<span class="token punctuation">(</span><span class="token number">2021</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> tz<span class="token operator">=</span><span class="token string">&quot;UTC&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    schedule<span class="token operator">=</span><span class="token string">&quot;@daily&quot;</span><span class="token punctuation">,</span>
    catchup<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span>
<span class="token punctuation">)</span>
dag<span class="token punctuation">.</span>doc_md <span class="token operator">=</span> __doc__

t <span class="token operator">=</span> BashOperator<span class="token punctuation">(</span><span class="token string">&quot;foo&quot;</span><span class="token punctuation">,</span> dag<span class="token operator">=</span>dag<span class="token punctuation">)</span>
t<span class="token punctuation">.</span>doc_md <span class="token operator">=</span> <span class="token triple-quoted-string string">&quot;&quot;&quot;\\
#Title&quot;
Here&#39;s a [url](www.airbnb.com)
&quot;&quot;&quot;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="subdags" tabindex="-1"><a class="header-anchor" href="#subdags"><span>SubDAGs</span></a></h2><p>有时，你会发现你经常向每个DAG添加完全相同的任务集，或者你想把很多任务分组到一个单一的逻辑单元中。这就是SubDAG的作用。 例如，这里有一个DAG，它在两个部分中有很多并行任务：</p><figure><img src="`+w+'" alt="../_images/subdag_before.png" tabindex="0" loading="lazy"><figcaption>../_images/subdag_before.png</figcaption></figure><p>我们可以将所有并行<code>task-*</code>运算符组合到一个SubDAG中，这样得到的DAG类似于以下内容：</p><figure><img src="'+A+`" alt="../_images/subdag_after.png" tabindex="0" loading="lazy"><figcaption>../_images/subdag_after.png</figcaption></figure><p>请注意，SubDAG运算符应该包含一个返回DAG对象的工厂方法。这将防止SubDAG在主UI中被视为单独的DAG——记住，如果Airflow在Python文件的顶层看到一个DAG，它将把它作为自己的DAG加载。例如：</p><div class="language-python line-numbers-mode" data-ext="py" data-title="py"><pre class="language-python"><code><span class="token keyword">import</span> pendulum

<span class="token keyword">from</span> airflow <span class="token keyword">import</span> DAG
<span class="token keyword">from</span> airflow<span class="token punctuation">.</span>operators<span class="token punctuation">.</span>empty <span class="token keyword">import</span> EmptyOperator


<span class="token keyword">def</span> <span class="token function">subdag</span><span class="token punctuation">(</span>parent_dag_name<span class="token punctuation">,</span> child_dag_name<span class="token punctuation">,</span> args<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> DAG<span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">&quot;&quot;&quot;
    Generate a DAG to be used as a subdag.

    :param str parent_dag_name: Id of the parent DAG
    :param str child_dag_name: Id of the child DAG
    :param dict args: Default arguments to provide to the subdag
    :return: DAG to use as a subdag
    &quot;&quot;&quot;</span>
    dag_subdag <span class="token operator">=</span> DAG<span class="token punctuation">(</span>
        dag_id<span class="token operator">=</span><span class="token string-interpolation"><span class="token string">f&quot;</span><span class="token interpolation"><span class="token punctuation">{</span>parent_dag_name<span class="token punctuation">}</span></span><span class="token string">.</span><span class="token interpolation"><span class="token punctuation">{</span>child_dag_name<span class="token punctuation">}</span></span><span class="token string">&quot;</span></span><span class="token punctuation">,</span>
        default_args<span class="token operator">=</span>args<span class="token punctuation">,</span>
        start_date<span class="token operator">=</span>pendulum<span class="token punctuation">.</span>datetime<span class="token punctuation">(</span><span class="token number">2021</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> tz<span class="token operator">=</span><span class="token string">&quot;UTC&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        catchup<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span>
        schedule<span class="token operator">=</span><span class="token string">&quot;@daily&quot;</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span>

    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        EmptyOperator<span class="token punctuation">(</span>
            task_id<span class="token operator">=</span><span class="token string-interpolation"><span class="token string">f&quot;</span><span class="token interpolation"><span class="token punctuation">{</span>child_dag_name<span class="token punctuation">}</span></span><span class="token string">-task-</span><span class="token interpolation"><span class="token punctuation">{</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">}</span></span><span class="token string">&quot;</span></span><span class="token punctuation">,</span>
            default_args<span class="token operator">=</span>args<span class="token punctuation">,</span>
            dag<span class="token operator">=</span>dag_subdag<span class="token punctuation">,</span>
        <span class="token punctuation">)</span>

    <span class="token keyword">return</span> dag_subdag


</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>然后可以在主DAG文件中引用此子DAG：</p><div class="language-python line-numbers-mode" data-ext="py" data-title="py"><pre class="language-python"><code><span class="token keyword">import</span> datetime

<span class="token keyword">from</span> airflow <span class="token keyword">import</span> DAG
<span class="token keyword">from</span> airflow<span class="token punctuation">.</span>example_dags<span class="token punctuation">.</span>subdags<span class="token punctuation">.</span>subdag <span class="token keyword">import</span> subdag
<span class="token keyword">from</span> airflow<span class="token punctuation">.</span>operators<span class="token punctuation">.</span>empty <span class="token keyword">import</span> EmptyOperator
<span class="token keyword">from</span> airflow<span class="token punctuation">.</span>operators<span class="token punctuation">.</span>subdag <span class="token keyword">import</span> SubDagOperator

DAG_NAME <span class="token operator">=</span> <span class="token string">&quot;example_subdag_operator&quot;</span>

<span class="token keyword">with</span> DAG<span class="token punctuation">(</span>
    dag_id<span class="token operator">=</span>DAG_NAME<span class="token punctuation">,</span>
    default_args<span class="token operator">=</span><span class="token punctuation">{</span><span class="token string">&quot;retries&quot;</span><span class="token punctuation">:</span> <span class="token number">2</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    start_date<span class="token operator">=</span>datetime<span class="token punctuation">.</span>datetime<span class="token punctuation">(</span><span class="token number">2022</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    schedule<span class="token operator">=</span><span class="token string">&quot;@once&quot;</span><span class="token punctuation">,</span>
    tags<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">&quot;example&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">)</span> <span class="token keyword">as</span> dag<span class="token punctuation">:</span>

    start <span class="token operator">=</span> EmptyOperator<span class="token punctuation">(</span>
        task_id<span class="token operator">=</span><span class="token string">&quot;start&quot;</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span>

    section_1 <span class="token operator">=</span> SubDagOperator<span class="token punctuation">(</span>
        task_id<span class="token operator">=</span><span class="token string">&quot;section-1&quot;</span><span class="token punctuation">,</span>
        subdag<span class="token operator">=</span>subdag<span class="token punctuation">(</span>DAG_NAME<span class="token punctuation">,</span> <span class="token string">&quot;section-1&quot;</span><span class="token punctuation">,</span> dag<span class="token punctuation">.</span>default_args<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span>

    some_other_task <span class="token operator">=</span> EmptyOperator<span class="token punctuation">(</span>
        task_id<span class="token operator">=</span><span class="token string">&quot;some-other-task&quot;</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span>

    section_2 <span class="token operator">=</span> SubDagOperator<span class="token punctuation">(</span>
        task_id<span class="token operator">=</span><span class="token string">&quot;section-2&quot;</span><span class="token punctuation">,</span>
        subdag<span class="token operator">=</span>subdag<span class="token punctuation">(</span>DAG_NAME<span class="token punctuation">,</span> <span class="token string">&quot;section-2&quot;</span><span class="token punctuation">,</span> dag<span class="token punctuation">.</span>default_args<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span>

    end <span class="token operator">=</span> EmptyOperator<span class="token punctuation">(</span>
        task_id<span class="token operator">=</span><span class="token string">&quot;end&quot;</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span>

    start <span class="token operator">&gt;&gt;</span> section_1 <span class="token operator">&gt;&gt;</span> some_other_task <span class="token operator">&gt;&gt;</span> section_2 <span class="token operator">&gt;&gt;</span> end
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>您可以从主DAG的图形视图放大SubDagOperator，以显示SubDAG中包含的任务：</p><figure><img src="`+D+`" alt="../_images/subdag_zoom.png" tabindex="0" loading="lazy"><figcaption>../_images/subdag_zoom.png</figcaption></figure><p>使用SubDAG时的一些其他提示：</p><ul><li>按照惯例，子dag的dag_id应该以其父dag的名称和一个点（parent.child）为前缀</li><li>您应该通过将参数传递给SubDAG运算符来在主DAG和SubDAG之间共享参数（如上所示）</li><li>子DAG必须有一个时间表并已启用。如果SubDAG的时间表设置为None或@once，则SubDAG将在不执行任何操作的情况下成功。</li><li>清除SubDagOperator也会清除其中任务的状态。</li><li>在SubDagOperator上标记成功不会影响其中任务的状态。</li><li>不要在SubDAG中的任务中使用“依赖于过去”，因为这可能会令人困惑。</li><li>您可以为SubDAG指定一个执行器。如果您想在进程内运行SubDAG并有效地将其并行度限制为1，则通常使用SequenceExecutor。使用LocalExecutor可能会有问题，因为它可能会过度订阅您的工作程序，在一个插槽中运行多个任务。</li></ul><h2 id="打包dag" tabindex="-1"><a class="header-anchor" href="#打包dag"><span>打包DAG</span></a></h2><p>虽然更简单的DAG通常只在一个Python文件中，但更复杂的DAG可能分布在多个文件中，并具有应随附的依赖项（“vendored”），这并不罕见。 您可以使用标准文件系统布局在DAG_FOLDER内部完成这一切，也可以将DAG及其所有Python文件打包为一个zip文件。例如，您可以将两个DAG以及它们所需的依赖项作为包含以下内容的zip文件：</p><div class="language-bash line-numbers-mode" data-ext="sh" data-title="sh"><pre class="language-bash"><code>my_dag1.py
my_dag2.py
package1/__init__.py
package1/functions.py
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>请注意，打包的DAG附带一些注意事项：</p><ul><li>如果为序列化启用了pickling ，则不能使用它们</li><li>它们不能包含已编译的库（例如libz.so），只能包含纯Python</li><li>它们将插入Python的sys.path中，并且可以由Airflow进程中的任何其他代码导入，因此请确保包名称不会与系统上已安装的其他包冲突。</li></ul><p>一般来说，如果您有一组复杂的已编译依赖项和模块，那么最好使用Python virtualenv系统，并使用pip在目标系统上安装必要的包。</p><h2 id="dag-依赖" tabindex="-1"><a class="header-anchor" href="#dag-依赖"><span>DAG 依赖</span></a></h2><p>虽然DAG中任务之间的依赖关系是通过上游和下游关系明确定义的，但DAG之间的依赖性有点复杂。通常，有两种方式可以使一个DAG依赖于另一个：</p>`,80),$={href:"https://airflow.apache.org/docs/apache-airflow/stable/_api/airflow/operators/trigger_dagrun/index.html#airflow.operators.trigger_dagrun.TriggerDagRunOperator",target:"_blank",rel:"noopener noreferrer"},Q=n("code",null,"TriggerDagRunOperator",-1),Z=n("li",null,[s("waiting - "),n("code",null,"ExternalTaskSensor")],-1),nn=e(`<p>另外的困难是，一个DAG可能会等待或触发具有不同数据间隔的其他DAG的多次运行。Dag依赖关系视图菜单-&gt;浏览-&gt;Dag依赖关系有助于可视化Dag之间的依赖关系。依赖关系由调度程序在DAG序列化期间计算，Web服务器使用它们来构建依赖关系图。</p><p>依赖检测器是可配置的，因此您可以实现自己的逻辑，而不是DependencyDetector中的默认逻辑</p><h2 id="dag暂停、停用和删除" tabindex="-1"><a class="header-anchor" href="#dag暂停、停用和删除"><span>DAG暂停、停用和删除</span></a></h2><p>当涉及到“未运行”时，DAG有几种状态。DAG可以暂停、停用，最后可以删除DAG的所有元数据。</p><p>当Dag存在于DAGS_FOLDER中时，可以通过UI暂停它，调度器将其存储在数据库中，但用户选择通过UI禁用它。“暂停”和“取消暂停”操作可通过UI和API使用。计划程序不安排暂停的DAG，但您可以通过UI触发它们以进行手动运行。在UI中，您可以看到Paused DAG（在Paused选项卡中）。未暂停的DAG可以在活动选项卡中找到。</p><p>Dag可以通过从DAGS_FOLDER中删除来停用（不要将其与UI中的Active标记混淆）。当调度器解析DAGS_FOLDER并错过它之前看到并存储在数据库中的DAG时，它将设置为停用。DAG的元数据和历史记录为停用的DAG保留，当DAG被重新添加到DAGs_FOLDER时，它将再次被激活，历史记录将可见。不能通过UI或API激活/停用DAG，只能通过从DAGS_FOLDER中删除文件来完成。再一次，当调度程序停用DAG时，DAG历史运行的数据不会丢失。请注意，气流UI中的“活动”选项卡指的是未激活和未暂停的DAG，因此最初可能会有点混乱。</p><p>你在UI中看不到停用的DAG——有时你可以看到历史运行，但当你试图查看这些DAG的信息时，你会看到DAG丢失的错误。</p><p>您也可以使用UI或API从元数据数据库中删除DAG元数据，但这并不总是导致DAG从UI中消失-这在最初可能也有点令人困惑。如果删除元数据时DAG仍在DAGS_FOLDER中，则DAG将重新出现，因为Scheduler将解析文件夹，只删除DAG的历史运行信息。</p><p>这一切都意味着，如果你想真正删除DAG及其所有历史元数据，你需要分三个步骤来完成：</p><ol><li>暂停DAG</li><li>通过UI或API从数据库中删除历史元数据</li><li>从DAGS_FOLDER中删除DAG文件，并等待它变为非活动状态</li></ol><h1 id="executor" tabindex="-1"><a class="header-anchor" href="#executor"><span>Executor</span></a></h1><p>airflow一次只能配置一个执行器；这是由配置文件的[core]部分中的executor选项设置的。内置执行器通过名称进行引用，例如：</p><div class="language-bash line-numbers-mode" data-ext="sh" data-title="sh"><pre class="language-bash"><code><span class="token punctuation">[</span>core<span class="token punctuation">]</span>
executor <span class="token operator">=</span> KubernetesExecutor
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p>如果您想检查当前设置了哪个执行器：</p><div class="language-bash line-numbers-mode" data-ext="sh" data-title="sh"><pre class="language-bash"><code>$ airflow config get-value core executor
SequentialExecutor
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="类型" tabindex="-1"><a class="header-anchor" href="#类型"><span>类型</span></a></h2><p>有两种类型的执行器：</p><ul><li>在本地运行任务（在调度程序进程内）</li><li>远程运行任务（通常通过工作线程池）。</li></ul><p>默认情况下，Airflow配置有SequenceExecutor，这是一个本地执行器，也是最安全的执行选项，但我们强烈建议您将其更改为小型单机安装的LocalExecutor或多机/云安装的远程执行器之一。</p><p><strong>Local Executors</strong></p>`,20),sn={href:"https://airflow.apache.org/docs/apache-airflow/stable/core-concepts/executor/debug.html",target:"_blank",rel:"noopener noreferrer"},an={href:"https://airflow.apache.org/docs/apache-airflow/stable/core-concepts/executor/debug.html#debugging-airflow-dags-on-the-command-line",target:"_blank",rel:"noopener noreferrer"},tn={href:"https://airflow.apache.org/docs/apache-airflow/stable/core-concepts/executor/debug.html#debug-executor-deprecated",target:"_blank",rel:"noopener noreferrer"},en={href:"https://airflow.apache.org/docs/apache-airflow/stable/core-concepts/executor/local.html",target:"_blank",rel:"noopener noreferrer"},pn={href:"https://airflow.apache.org/docs/apache-airflow/stable/core-concepts/executor/sequential.html",target:"_blank",rel:"noopener noreferrer"},on=n("p",null,[n("strong",null,"Remote Executors")],-1),ln={href:"https://airflow.apache.org/docs/apache-airflow/stable/core-concepts/executor/celery.html",target:"_blank",rel:"noopener noreferrer"},cn={href:"https://airflow.apache.org/docs/apache-airflow/stable/core-concepts/executor/celery_kubernetes.html",target:"_blank",rel:"noopener noreferrer"},un={href:"https://airflow.apache.org/docs/apache-airflow/stable/core-concepts/executor/dask.html",target:"_blank",rel:"noopener noreferrer"},rn={href:"https://airflow.apache.org/docs/apache-airflow/stable/core-concepts/executor/kubernetes.html",target:"_blank",rel:"noopener noreferrer"},dn={href:"https://airflow.apache.org/docs/apache-airflow/stable/core-concepts/executor/local_kubernetes.html",target:"_blank",rel:"noopener noreferrer"},kn=e('<h2 id="kubernetes-executor" tabindex="-1"><a class="header-anchor" href="#kubernetes-executor"><span>Kubernetes Executor</span></a></h2><p>Kubernetes执行器在Kubernete集群上自己的pod中运行每个任务实例。</p><p>KubernetesExecutor在Airflow Scheduler中作为一个进程运行。调度器本身不一定需要在Kubernetes上运行，但确实需要访问Kubernete集群。</p><p>KubernetesExecutor在后端需要一个非sqlite数据库。</p><p>当DAG提交任务时，KubernetesExecutor从Kubernetes API请求一个worker pod。然后worker pod运行任务，报告结果并终止。</p><figure><img src="'+x+'" alt="../../_images/arch-diag-kubernetes.png" tabindex="0" loading="lazy"><figcaption>../../_images/arch-diag-kubernetes.png</figcaption></figure><p>下面显示了在Kubernetes集群中五个节点的分布式集合上运行的Airflow部署的一个示例：</p><figure><img src="'+G+'" alt="../../_images/arch-diag-kubernetes2.png" tabindex="0" loading="lazy"><figcaption>../../_images/arch-diag-kubernetes2.png</figcaption></figure><p>与常规Airflow体系结构一致，Workers需要访问DAG文件，以执行这些DAG中的任务并与元数据存储库交互。此外，需要在Airflow配置文件中指定特定于Kubernetes Executor的配置信息，如工作命名空间和映像信息。</p><p>此外，Kubernetes Executor允许使用Executor配置在每个任务的基础上指定附加功能。</p><figure><img src="'+E+`" alt="../../_images/k8s-happy-path.png" tabindex="0" loading="lazy"><figcaption>../../_images/k8s-happy-path.png</figcaption></figure><h3 id="主要配置" tabindex="-1"><a class="header-anchor" href="#主要配置"><span>主要配置</span></a></h3><ul><li>pod_template_file：要自定义用于k8s执行器工作进程的pod，可以创建一个pod模板文件。您必须在airflow.cfg的kubernetes_executor部分的pod_template_file选项中提供模板文件的路径。Airflow对pod模板文件有两个严格的要求：基础镜像和pod名称。</li><li>基础镜像：pod_template_file必须在spec.channels[0]位置有一个名为base的容器，并且必须指定其映像。您可以在该必需容器之后自由创建sidecar容器，但Airflow假定辅助容器存在于容器阵列的开头，并假定容器命名为base。</li><li>pod名称：pod的元数据名称必须在模板文件中设置。该字段将始终在pod启动时动态设置，以确保所有pod的唯一性。但是，它必须包含在模板中，不能留空。</li></ul><div class="language-yaml line-numbers-mode" data-ext="yml" data-title="yml"><pre class="language-yaml"><code><span class="token punctuation">---</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Pod
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> placeholder<span class="token punctuation">-</span>name
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">containers</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">env</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> AIRFLOW__CORE__EXECUTOR
          <span class="token key atrule">value</span><span class="token punctuation">:</span> LocalExecutor
        <span class="token comment"># Hard Coded Airflow Envs</span>
        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> AIRFLOW__CORE__FERNET_KEY
          <span class="token key atrule">valueFrom</span><span class="token punctuation">:</span>
            <span class="token key atrule">secretKeyRef</span><span class="token punctuation">:</span>
              <span class="token key atrule">name</span><span class="token punctuation">:</span> RELEASE<span class="token punctuation">-</span>NAME<span class="token punctuation">-</span>fernet<span class="token punctuation">-</span>key
              <span class="token key atrule">key</span><span class="token punctuation">:</span> fernet<span class="token punctuation">-</span>key
        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> AIRFLOW__DATABASE__SQL_ALCHEMY_CONN
          <span class="token key atrule">valueFrom</span><span class="token punctuation">:</span>
            <span class="token key atrule">secretKeyRef</span><span class="token punctuation">:</span>
              <span class="token key atrule">name</span><span class="token punctuation">:</span> RELEASE<span class="token punctuation">-</span>NAME<span class="token punctuation">-</span>airflow<span class="token punctuation">-</span>metadata
              <span class="token key atrule">key</span><span class="token punctuation">:</span> connection
        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> AIRFLOW_CONN_AIRFLOW_DB
          <span class="token key atrule">valueFrom</span><span class="token punctuation">:</span>
            <span class="token key atrule">secretKeyRef</span><span class="token punctuation">:</span>
              <span class="token key atrule">name</span><span class="token punctuation">:</span> RELEASE<span class="token punctuation">-</span>NAME<span class="token punctuation">-</span>airflow<span class="token punctuation">-</span>metadata
              <span class="token key atrule">key</span><span class="token punctuation">:</span> connection
      <span class="token key atrule">image</span><span class="token punctuation">:</span> dummy_image
      <span class="token key atrule">imagePullPolicy</span><span class="token punctuation">:</span> IfNotPresent
      <span class="token key atrule">name</span><span class="token punctuation">:</span> base
      <span class="token key atrule">volumeMounts</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> <span class="token string">&quot;/opt/airflow/logs&quot;</span>
          <span class="token key atrule">name</span><span class="token punctuation">:</span> airflow<span class="token punctuation">-</span>logs
        <span class="token punctuation">-</span> <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /opt/airflow/airflow.cfg
          <span class="token key atrule">name</span><span class="token punctuation">:</span> airflow<span class="token punctuation">-</span>config
          <span class="token key atrule">readOnly</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
          <span class="token key atrule">subPath</span><span class="token punctuation">:</span> airflow.cfg
  <span class="token key atrule">restartPolicy</span><span class="token punctuation">:</span> Never
  <span class="token key atrule">securityContext</span><span class="token punctuation">:</span>
    <span class="token key atrule">runAsUser</span><span class="token punctuation">:</span> <span class="token number">50000</span>
    <span class="token key atrule">fsGroup</span><span class="token punctuation">:</span> <span class="token number">50000</span>
  <span class="token key atrule">serviceAccountName</span><span class="token punctuation">:</span> <span class="token string">&quot;RELEASE-NAME-worker-serviceaccount&quot;</span>
  <span class="token key atrule">volumes</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">emptyDir</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
      <span class="token key atrule">name</span><span class="token punctuation">:</span> airflow<span class="token punctuation">-</span>logs
    <span class="token punctuation">-</span> <span class="token key atrule">configMap</span><span class="token punctuation">:</span>
        <span class="token key atrule">name</span><span class="token punctuation">:</span> RELEASE<span class="token punctuation">-</span>NAME<span class="token punctuation">-</span>airflow<span class="token punctuation">-</span>config
      <span class="token key atrule">name</span><span class="token punctuation">:</span> airflow<span class="token punctuation">-</span>config
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="在持久卷中存储dag" tabindex="-1"><a class="header-anchor" href="#在持久卷中存储dag"><span>在持久卷中存储DAG：</span></a></h3><div class="language-yaml line-numbers-mode" data-ext="yml" data-title="yml"><pre class="language-yaml"><code><span class="token punctuation">---</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Pod
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> placeholder<span class="token punctuation">-</span>name
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">containers</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">env</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> AIRFLOW__CORE__EXECUTOR
          <span class="token key atrule">value</span><span class="token punctuation">:</span> LocalExecutor
        <span class="token comment"># Hard Coded Airflow Envs</span>
        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> AIRFLOW__CORE__FERNET_KEY
          <span class="token key atrule">valueFrom</span><span class="token punctuation">:</span>
            <span class="token key atrule">secretKeyRef</span><span class="token punctuation">:</span>
              <span class="token key atrule">name</span><span class="token punctuation">:</span> RELEASE<span class="token punctuation">-</span>NAME<span class="token punctuation">-</span>fernet<span class="token punctuation">-</span>key
              <span class="token key atrule">key</span><span class="token punctuation">:</span> fernet<span class="token punctuation">-</span>key
        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> AIRFLOW__DATABASE__SQL_ALCHEMY_CONN
          <span class="token key atrule">valueFrom</span><span class="token punctuation">:</span>
            <span class="token key atrule">secretKeyRef</span><span class="token punctuation">:</span>
              <span class="token key atrule">name</span><span class="token punctuation">:</span> RELEASE<span class="token punctuation">-</span>NAME<span class="token punctuation">-</span>airflow<span class="token punctuation">-</span>metadata
              <span class="token key atrule">key</span><span class="token punctuation">:</span> connection
        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> AIRFLOW_CONN_AIRFLOW_DB
          <span class="token key atrule">valueFrom</span><span class="token punctuation">:</span>
            <span class="token key atrule">secretKeyRef</span><span class="token punctuation">:</span>
              <span class="token key atrule">name</span><span class="token punctuation">:</span> RELEASE<span class="token punctuation">-</span>NAME<span class="token punctuation">-</span>airflow<span class="token punctuation">-</span>metadata
              <span class="token key atrule">key</span><span class="token punctuation">:</span> connection
      <span class="token key atrule">image</span><span class="token punctuation">:</span> dummy_image
      <span class="token key atrule">imagePullPolicy</span><span class="token punctuation">:</span> IfNotPresent
      <span class="token key atrule">name</span><span class="token punctuation">:</span> base
      <span class="token key atrule">volumeMounts</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> <span class="token string">&quot;/opt/airflow/logs&quot;</span>
          <span class="token key atrule">name</span><span class="token punctuation">:</span> airflow<span class="token punctuation">-</span>logs
        <span class="token punctuation">-</span> <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /opt/airflow/dags
          <span class="token key atrule">name</span><span class="token punctuation">:</span> airflow<span class="token punctuation">-</span>dags
          <span class="token key atrule">readOnly</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
        <span class="token punctuation">-</span> <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /opt/airflow/airflow.cfg
          <span class="token key atrule">name</span><span class="token punctuation">:</span> airflow<span class="token punctuation">-</span>config
          <span class="token key atrule">readOnly</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
          <span class="token key atrule">subPath</span><span class="token punctuation">:</span> airflow.cfg
  <span class="token key atrule">restartPolicy</span><span class="token punctuation">:</span> Never
  <span class="token key atrule">securityContext</span><span class="token punctuation">:</span>
    <span class="token key atrule">runAsUser</span><span class="token punctuation">:</span> <span class="token number">50000</span>
    <span class="token key atrule">fsGroup</span><span class="token punctuation">:</span> <span class="token number">50000</span>
  <span class="token key atrule">serviceAccountName</span><span class="token punctuation">:</span> <span class="token string">&quot;RELEASE-NAME-worker-serviceaccount&quot;</span>
  <span class="token key atrule">volumes</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> airflow<span class="token punctuation">-</span>dags
      <span class="token key atrule">persistentVolumeClaim</span><span class="token punctuation">:</span>
        <span class="token key atrule">claimName</span><span class="token punctuation">:</span> RELEASE<span class="token punctuation">-</span>NAME<span class="token punctuation">-</span>dags
    <span class="token punctuation">-</span> <span class="token key atrule">emptyDir</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
      <span class="token key atrule">name</span><span class="token punctuation">:</span> airflow<span class="token punctuation">-</span>logs
    <span class="token punctuation">-</span> <span class="token key atrule">configMap</span><span class="token punctuation">:</span>
        <span class="token key atrule">name</span><span class="token punctuation">:</span> RELEASE<span class="token punctuation">-</span>NAME<span class="token punctuation">-</span>airflow<span class="token punctuation">-</span>config
      <span class="token key atrule">name</span><span class="token punctuation">:</span> airflow<span class="token punctuation">-</span>config
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="从git中提取dag" tabindex="-1"><a class="header-anchor" href="#从git中提取dag"><span>从git中提取DAG:</span></a></h3><div class="language-yaml line-numbers-mode" data-ext="yml" data-title="yml"><pre class="language-yaml"><code><span class="token punctuation">---</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Pod
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> dummy<span class="token punctuation">-</span>name
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">initContainers</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> git<span class="token punctuation">-</span>sync
      <span class="token key atrule">image</span><span class="token punctuation">:</span> <span class="token string">&quot;registry.k8s.io/git-sync/git-sync:v3.6.3&quot;</span>
      <span class="token key atrule">env</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> GIT_SYNC_BRANCH
          <span class="token key atrule">value</span><span class="token punctuation">:</span> <span class="token string">&quot;v2-2-stable&quot;</span>
        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> GIT_SYNC_REPO
          <span class="token key atrule">value</span><span class="token punctuation">:</span> <span class="token string">&quot;https://github.com/apache/airflow.git&quot;</span>
        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> GIT_SYNC_DEPTH
          <span class="token key atrule">value</span><span class="token punctuation">:</span> <span class="token string">&quot;1&quot;</span>
        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> GIT_SYNC_ROOT
          <span class="token key atrule">value</span><span class="token punctuation">:</span> <span class="token string">&quot;/git&quot;</span>
        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> GIT_SYNC_DEST
          <span class="token key atrule">value</span><span class="token punctuation">:</span> <span class="token string">&quot;repo&quot;</span>
        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> GIT_SYNC_ADD_USER
          <span class="token key atrule">value</span><span class="token punctuation">:</span> <span class="token string">&quot;true&quot;</span>
        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> GIT_SYNC_ONE_TIME
          <span class="token key atrule">value</span><span class="token punctuation">:</span> <span class="token string">&quot;true&quot;</span>
      <span class="token key atrule">volumeMounts</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> airflow<span class="token punctuation">-</span>dags
          <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /git
  <span class="token key atrule">containers</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">env</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> AIRFLOW__CORE__EXECUTOR
          <span class="token key atrule">value</span><span class="token punctuation">:</span> LocalExecutor
        <span class="token comment"># Hard Coded Airflow Envs</span>
        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> AIRFLOW__CORE__FERNET_KEY
          <span class="token key atrule">valueFrom</span><span class="token punctuation">:</span>
            <span class="token key atrule">secretKeyRef</span><span class="token punctuation">:</span>
              <span class="token key atrule">name</span><span class="token punctuation">:</span> RELEASE<span class="token punctuation">-</span>NAME<span class="token punctuation">-</span>fernet<span class="token punctuation">-</span>key
              <span class="token key atrule">key</span><span class="token punctuation">:</span> fernet<span class="token punctuation">-</span>key
        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> AIRFLOW__DATABASE__SQL_ALCHEMY_CONN
          <span class="token key atrule">valueFrom</span><span class="token punctuation">:</span>
            <span class="token key atrule">secretKeyRef</span><span class="token punctuation">:</span>
              <span class="token key atrule">name</span><span class="token punctuation">:</span> RELEASE<span class="token punctuation">-</span>NAME<span class="token punctuation">-</span>airflow<span class="token punctuation">-</span>metadata
              <span class="token key atrule">key</span><span class="token punctuation">:</span> connection
        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> AIRFLOW_CONN_AIRFLOW_DB
          <span class="token key atrule">valueFrom</span><span class="token punctuation">:</span>
            <span class="token key atrule">secretKeyRef</span><span class="token punctuation">:</span>
              <span class="token key atrule">name</span><span class="token punctuation">:</span> RELEASE<span class="token punctuation">-</span>NAME<span class="token punctuation">-</span>airflow<span class="token punctuation">-</span>metadata
              <span class="token key atrule">key</span><span class="token punctuation">:</span> connection
      <span class="token key atrule">image</span><span class="token punctuation">:</span> dummy_image
      <span class="token key atrule">imagePullPolicy</span><span class="token punctuation">:</span> IfNotPresent
      <span class="token key atrule">name</span><span class="token punctuation">:</span> base
      <span class="token key atrule">volumeMounts</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> <span class="token string">&quot;/opt/airflow/logs&quot;</span>
          <span class="token key atrule">name</span><span class="token punctuation">:</span> airflow<span class="token punctuation">-</span>logs
        <span class="token punctuation">-</span> <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /opt/airflow/dags
          <span class="token key atrule">name</span><span class="token punctuation">:</span> airflow<span class="token punctuation">-</span>dags
          <span class="token key atrule">subPath</span><span class="token punctuation">:</span> repo/airflow/example_dags
          <span class="token key atrule">readOnly</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>
        <span class="token punctuation">-</span> <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /opt/airflow/airflow.cfg
          <span class="token key atrule">name</span><span class="token punctuation">:</span> airflow<span class="token punctuation">-</span>config
          <span class="token key atrule">readOnly</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
          <span class="token key atrule">subPath</span><span class="token punctuation">:</span> airflow.cfg
  <span class="token key atrule">restartPolicy</span><span class="token punctuation">:</span> Never
  <span class="token key atrule">securityContext</span><span class="token punctuation">:</span>
    <span class="token key atrule">runAsUser</span><span class="token punctuation">:</span> <span class="token number">50000</span>
    <span class="token key atrule">fsGroup</span><span class="token punctuation">:</span> <span class="token number">50000</span>
  <span class="token key atrule">serviceAccountName</span><span class="token punctuation">:</span> <span class="token string">&quot;RELEASE-NAME-worker-serviceaccount&quot;</span>
  <span class="token key atrule">volumes</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> airflow<span class="token punctuation">-</span>dags
      <span class="token key atrule">emptyDir</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> airflow<span class="token punctuation">-</span>logs
      <span class="token key atrule">emptyDir</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
    <span class="token punctuation">-</span> <span class="token key atrule">configMap</span><span class="token punctuation">:</span>
        <span class="token key atrule">name</span><span class="token punctuation">:</span> RELEASE<span class="token punctuation">-</span>NAME<span class="token punctuation">-</span>airflow<span class="token punctuation">-</span>config
      <span class="token key atrule">name</span><span class="token punctuation">:</span> airflow<span class="token punctuation">-</span>config
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="pod覆盖" tabindex="-1"><a class="header-anchor" href="#pod覆盖"><span>pod覆盖</span></a></h3><p>当使用KubernetesExecutor时，Airflow提供了在每个任务的基础上覆盖系统默认值的能力。要使用此功能，请创建一个Kubernetes V1pod对象并填写所需的覆盖。请注意，在启动V1pod之前，调度程序将覆盖它的metadata.name和container[0].args。</p><p>要覆盖KubernetesExecutor启动的pod的基本容器，请创建一个带有单个容器的V1pod，并按如下方式覆盖字段：</p><div class="language-python line-numbers-mode" data-ext="py" data-title="py"><pre class="language-python"><code>        executor_config_volume_mount <span class="token operator">=</span> <span class="token punctuation">{</span>
            <span class="token string">&quot;pod_override&quot;</span><span class="token punctuation">:</span> k8s<span class="token punctuation">.</span>V1Pod<span class="token punctuation">(</span>
                spec<span class="token operator">=</span>k8s<span class="token punctuation">.</span>V1PodSpec<span class="token punctuation">(</span>
                    containers<span class="token operator">=</span><span class="token punctuation">[</span>
                        k8s<span class="token punctuation">.</span>V1Container<span class="token punctuation">(</span>
                            name<span class="token operator">=</span><span class="token string">&quot;base&quot;</span><span class="token punctuation">,</span>
                            volume_mounts<span class="token operator">=</span><span class="token punctuation">[</span>
                                k8s<span class="token punctuation">.</span>V1VolumeMount<span class="token punctuation">(</span>mount_path<span class="token operator">=</span><span class="token string">&quot;/foo/&quot;</span><span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">&quot;example-kubernetes-test-volume&quot;</span><span class="token punctuation">)</span>
                            <span class="token punctuation">]</span><span class="token punctuation">,</span>
                        <span class="token punctuation">)</span>
                    <span class="token punctuation">]</span><span class="token punctuation">,</span>
                    volumes<span class="token operator">=</span><span class="token punctuation">[</span>
                        k8s<span class="token punctuation">.</span>V1Volume<span class="token punctuation">(</span>
                            name<span class="token operator">=</span><span class="token string">&quot;example-kubernetes-test-volume&quot;</span><span class="token punctuation">,</span>
                            host_path<span class="token operator">=</span>k8s<span class="token punctuation">.</span>V1HostPathVolumeSource<span class="token punctuation">(</span>path<span class="token operator">=</span><span class="token string">&quot;/tmp/&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                        <span class="token punctuation">)</span>
                    <span class="token punctuation">]</span><span class="token punctuation">,</span>
                <span class="token punctuation">)</span>
            <span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span>

        <span class="token decorator annotation punctuation">@task</span><span class="token punctuation">(</span>executor_config<span class="token operator">=</span>executor_config_volume_mount<span class="token punctuation">)</span>
        <span class="token keyword">def</span> <span class="token function">test_volume_mount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token triple-quoted-string string">&quot;&quot;&quot;
            Tests whether the volume has been mounted.
            &quot;&quot;&quot;</span>

            <span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">&quot;/foo/volume_mount_test.txt&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;w&quot;</span><span class="token punctuation">)</span> <span class="token keyword">as</span> foo<span class="token punctuation">:</span>
                foo<span class="token punctuation">.</span>write<span class="token punctuation">(</span><span class="token string">&quot;Hello&quot;</span><span class="token punctuation">)</span>

            return_code <span class="token operator">=</span> os<span class="token punctuation">.</span>system<span class="token punctuation">(</span><span class="token string">&quot;cat /foo/volume_mount_test.txt&quot;</span><span class="token punctuation">)</span>
            <span class="token keyword">if</span> return_code <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">:</span>
                <span class="token keyword">raise</span> ValueError<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f&quot;Error when checking volume mount. Return code </span><span class="token interpolation"><span class="token punctuation">{</span>return_code<span class="token punctuation">}</span></span><span class="token string">&quot;</span></span><span class="token punctuation">)</span>

        volume_task <span class="token operator">=</span> test_volume_mount<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>请注意，以下字段将被扩展，而不是覆盖。 From <em>spec</em>: volumes, and init_containers. From <em>container</em>: volume mounts, environment variables, ports, and devices.</p><p>要将sidecar容器添加到启动的pod中，请创建一个V1pod，其中第一个容器为空，名称为base，第二个容器包含所需的sidecar。</p><div class="language-yaml line-numbers-mode" data-ext="yml" data-title="yml"><pre class="language-yaml"><code>        executor_config_sidecar = <span class="token punctuation">{</span>
            <span class="token key atrule">&quot;pod_override&quot;</span><span class="token punctuation">:</span> k8s.V1Pod(
                spec=k8s.V1PodSpec(
                    containers=<span class="token punctuation">[</span>
                        k8s.V1Container(
                            name=&quot;base&quot;<span class="token punctuation">,</span>
                            volume_mounts=<span class="token punctuation">[</span>k8s.V1VolumeMount(mount_path=&quot;/shared/&quot;<span class="token punctuation">,</span> name=&quot;shared<span class="token punctuation">-</span>empty<span class="token punctuation">-</span>dir&quot;)<span class="token punctuation">]</span><span class="token punctuation">,</span>
                        )<span class="token punctuation">,</span>
                        k8s.V1Container(
                            name=&quot;sidecar&quot;<span class="token punctuation">,</span>
                            image=&quot;ubuntu&quot;<span class="token punctuation">,</span>
                            args=<span class="token punctuation">[</span><span class="token string">&#39;echo &quot;retrieved from mount&quot; &gt; /shared/test.txt&#39;</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                            command=<span class="token punctuation">[</span><span class="token string">&quot;bash&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;-cx&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                            volume_mounts=<span class="token punctuation">[</span>k8s.V1VolumeMount(mount_path=&quot;/shared/&quot;<span class="token punctuation">,</span> name=&quot;shared<span class="token punctuation">-</span>empty<span class="token punctuation">-</span>dir&quot;)<span class="token punctuation">]</span><span class="token punctuation">,</span>
                        )<span class="token punctuation">,</span>
                    <span class="token punctuation">]</span><span class="token punctuation">,</span>
                    volumes=<span class="token punctuation">[</span>
                        k8s.V1Volume(name=&quot;shared<span class="token punctuation">-</span>empty<span class="token punctuation">-</span>dir&quot;<span class="token punctuation">,</span> empty_dir=k8s.V1EmptyDirVolumeSource())<span class="token punctuation">,</span>
                    <span class="token punctuation">]</span><span class="token punctuation">,</span>
                )
            )<span class="token punctuation">,</span>
        <span class="token punctuation">}</span>

        @task(executor_config=executor_config_sidecar)
        <span class="token key atrule">def test_sharedvolume_mount()</span><span class="token punctuation">:</span>
            &quot;&quot;&quot;
            Tests whether the volume has been mounted.
            &quot;&quot;&quot;
            <span class="token key atrule">for i in range(5)</span><span class="token punctuation">:</span>
                <span class="token key atrule">try</span><span class="token punctuation">:</span>
                    return_code = os.system(&quot;cat /shared/test.txt&quot;)
                    <span class="token key atrule">if return_code != 0</span><span class="token punctuation">:</span>
                        raise ValueError(f&quot;Error when checking volume mount. Return code <span class="token punctuation">{</span>return_code<span class="token punctuation">}</span>&quot;)
                <span class="token key atrule">except ValueError as e</span><span class="token punctuation">:</span>
                    <span class="token key atrule">if i &gt; 4</span><span class="token punctuation">:</span>
                        raise e

        sidecar_task = test_sharedvolume_mount()
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>还可以按任务创建自定义pod_template_file，以便在多个任务之间回收相同的基值。这将替换airflow.cfg中命名的默认pod_template_file，然后使用pod_override覆盖该模板。</p><div class="language-python line-numbers-mode" data-ext="py" data-title="py"><pre class="language-python"><code><span class="token keyword">import</span> os

<span class="token keyword">import</span> pendulum

<span class="token keyword">from</span> airflow <span class="token keyword">import</span> DAG
<span class="token keyword">from</span> airflow<span class="token punctuation">.</span>decorators <span class="token keyword">import</span> task
<span class="token keyword">from</span> airflow<span class="token punctuation">.</span>example_dags<span class="token punctuation">.</span>libs<span class="token punctuation">.</span>helper <span class="token keyword">import</span> print_stuff
<span class="token keyword">from</span> airflow<span class="token punctuation">.</span>settings <span class="token keyword">import</span> AIRFLOW_HOME

<span class="token keyword">from</span> kubernetes<span class="token punctuation">.</span>client <span class="token keyword">import</span> models <span class="token keyword">as</span> k8s

<span class="token keyword">with</span> DAG<span class="token punctuation">(</span>
    dag_id<span class="token operator">=</span><span class="token string">&quot;example_pod_template_file&quot;</span><span class="token punctuation">,</span>
    schedule<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span>
    start_date<span class="token operator">=</span>pendulum<span class="token punctuation">.</span>datetime<span class="token punctuation">(</span><span class="token number">2021</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> tz<span class="token operator">=</span><span class="token string">&quot;UTC&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    catchup<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span>
    tags<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">&quot;example3&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">)</span> <span class="token keyword">as</span> dag<span class="token punctuation">:</span>
    executor_config_template <span class="token operator">=</span> <span class="token punctuation">{</span>
        <span class="token string">&quot;pod_template_file&quot;</span><span class="token punctuation">:</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>AIRFLOW_HOME<span class="token punctuation">,</span> <span class="token string">&quot;pod_templates/basic_template.yaml&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token string">&quot;pod_override&quot;</span><span class="token punctuation">:</span> k8s<span class="token punctuation">.</span>V1Pod<span class="token punctuation">(</span>metadata<span class="token operator">=</span>k8s<span class="token punctuation">.</span>V1ObjectMeta<span class="token punctuation">(</span>labels<span class="token operator">=</span><span class="token punctuation">{</span><span class="token string">&quot;release&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;stable&quot;</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span>

    <span class="token decorator annotation punctuation">@task</span><span class="token punctuation">(</span>executor_config<span class="token operator">=</span>executor_config_template<span class="token punctuation">)</span>
    <span class="token keyword">def</span> <span class="token function">task_with_template</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        print_stuff<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h1 id="kubernetespodoperator" tabindex="-1"><a class="header-anchor" href="#kubernetespodoperator"><span>KubernetesPodOperator</span></a></h1><p>KubernetePodOperator使用Kubernetes API在Kubernetes集群中启动一个pod。通过提供一个镜像URL和一个带有可选参数的命令，操作符使用Kube Python客户端生成一个Kubernetes API请求，该请求动态启动这些单独的pods。用户可以使用config_file参数指定kubeconfig文件，否则操作符将默认为~/.kube/config。</p><p>KubernetsPodOperator支持任务级别的资源配置，对于无法通过公共PyPI存储库获得的自定义Python依赖关系，它是最佳的。它还允许用户使用pod_template_file参数提供模板YAML文件。最终，它允许Airflow充当工作协调人——无论这些工作是用什么语言写的</p><h3 id="调试kubernetespodoperator" tabindex="-1"><a class="header-anchor" href="#调试kubernetespodoperator"><span>调试KubernetesPodOperator</span></a></h3><p>您可以打印出pod的Kubernetes清单，该清单将在运行时通过在操作符的实例上调用dry_run（）来创建。</p><div class="language-python line-numbers-mode" data-ext="py" data-title="py"><pre class="language-python"><code><span class="token keyword">from</span> airflow<span class="token punctuation">.</span>providers<span class="token punctuation">.</span>cncf<span class="token punctuation">.</span>kubernetes<span class="token punctuation">.</span>operators<span class="token punctuation">.</span>pod <span class="token keyword">import</span> KubernetesPodOperator

k <span class="token operator">=</span> KubernetesPodOperator<span class="token punctuation">(</span>
    name<span class="token operator">=</span><span class="token string">&quot;hello-dry-run&quot;</span><span class="token punctuation">,</span>
    image<span class="token operator">=</span><span class="token string">&quot;debian&quot;</span><span class="token punctuation">,</span>
    cmds<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">&quot;bash&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;-cx&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    arguments<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">&quot;echo&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;10&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    labels<span class="token operator">=</span><span class="token punctuation">{</span><span class="token string">&quot;foo&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;bar&quot;</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    task_id<span class="token operator">=</span><span class="token string">&quot;dry_run_demo&quot;</span><span class="token punctuation">,</span>
    do_xcom_push<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>
<span class="token punctuation">)</span>

k<span class="token punctuation">.</span>dry_run<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="参数优先级" tabindex="-1"><a class="header-anchor" href="#参数优先级"><span>参数优先级</span></a></h3><ul><li><p>KPO argument</p></li><li><p>full pod spec</p></li><li><p>pod template file</p></li><li><p>airflow connection.</p></li></ul><p>对于名称空间，如果没有通过这些方法中的任何一个提供名称空间，那么我们将首先尝试获取当前名称空间（如果任务已经在kubernetes中运行），否则我们将使用default名称空间。</p><p>对于pod名称，如果没有明确提供，我们将使用task_id。默认情况下会添加一个随机后缀。</p><h3 id="如何在pod中使用集群configmaps、secrets和volumes" tabindex="-1"><a class="header-anchor" href="#如何在pod中使用集群configmaps、secrets和volumes"><span>如何在Pod中使用集群ConfigMaps、Secrets和Volumes？</span></a></h3><p>要添加ConfigMaps、Volumes和其他Kubernetes原生对象，我们建议您导入Kubernete模型API，如下所示：</p><div class="language-python line-numbers-mode" data-ext="py" data-title="py"><pre class="language-python"><code><span class="token keyword">from</span> kubernetes<span class="token punctuation">.</span>client <span class="token keyword">import</span> models <span class="token keyword">as</span> k8s
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>通过这个API对象，您可以以python类的形式访问所有Kubernetes API对象。使用此方法将确保正确性和类型安全性。虽然我们删除了几乎所有的Kubernetes便利类，但我们保留了Secret类，以简化生成Secret卷/env变量的过程:</p><div class="language-python line-numbers-mode" data-ext="py" data-title="py"><pre class="language-python"><code>secret_file <span class="token operator">=</span> Secret<span class="token punctuation">(</span><span class="token string">&quot;volume&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;/etc/sql_conn&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;airflow-secrets&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;sql_alchemy_conn&quot;</span><span class="token punctuation">)</span>
secret_env <span class="token operator">=</span> Secret<span class="token punctuation">(</span><span class="token string">&quot;env&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;SQL_CONN&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;airflow-secrets&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;sql_alchemy_conn&quot;</span><span class="token punctuation">)</span>
secret_all_keys <span class="token operator">=</span> Secret<span class="token punctuation">(</span><span class="token string">&quot;env&quot;</span><span class="token punctuation">,</span> <span class="token boolean">None</span><span class="token punctuation">,</span> <span class="token string">&quot;airflow-secrets-2&quot;</span><span class="token punctuation">)</span>
volume_mount <span class="token operator">=</span> k8s<span class="token punctuation">.</span>V1VolumeMount<span class="token punctuation">(</span>
    name<span class="token operator">=</span><span class="token string">&quot;test-volume&quot;</span><span class="token punctuation">,</span> mount_path<span class="token operator">=</span><span class="token string">&quot;/root/mount_file&quot;</span><span class="token punctuation">,</span> sub_path<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> read_only<span class="token operator">=</span><span class="token boolean">True</span>
<span class="token punctuation">)</span>

configmaps <span class="token operator">=</span> <span class="token punctuation">[</span>
    k8s<span class="token punctuation">.</span>V1EnvFromSource<span class="token punctuation">(</span>config_map_ref<span class="token operator">=</span>k8s<span class="token punctuation">.</span>V1ConfigMapEnvSource<span class="token punctuation">(</span>name<span class="token operator">=</span><span class="token string">&quot;test-configmap-1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    k8s<span class="token punctuation">.</span>V1EnvFromSource<span class="token punctuation">(</span>config_map_ref<span class="token operator">=</span>k8s<span class="token punctuation">.</span>V1ConfigMapEnvSource<span class="token punctuation">(</span>name<span class="token operator">=</span><span class="token string">&quot;test-configmap-2&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">]</span>

volume <span class="token operator">=</span> k8s<span class="token punctuation">.</span>V1Volume<span class="token punctuation">(</span>
    name<span class="token operator">=</span><span class="token string">&quot;test-volume&quot;</span><span class="token punctuation">,</span>
    persistent_volume_claim<span class="token operator">=</span>k8s<span class="token punctuation">.</span>V1PersistentVolumeClaimVolumeSource<span class="token punctuation">(</span>claim_name<span class="token operator">=</span><span class="token string">&quot;test-volume&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">)</span>

port <span class="token operator">=</span> k8s<span class="token punctuation">.</span>V1ContainerPort<span class="token punctuation">(</span>name<span class="token operator">=</span><span class="token string">&quot;http&quot;</span><span class="token punctuation">,</span> container_port<span class="token operator">=</span><span class="token number">80</span><span class="token punctuation">)</span>

init_container_volume_mounts <span class="token operator">=</span> <span class="token punctuation">[</span>
    k8s<span class="token punctuation">.</span>V1VolumeMount<span class="token punctuation">(</span>mount_path<span class="token operator">=</span><span class="token string">&quot;/etc/foo&quot;</span><span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">&quot;test-volume&quot;</span><span class="token punctuation">,</span> sub_path<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> read_only<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
<span class="token punctuation">]</span>

init_environments <span class="token operator">=</span> <span class="token punctuation">[</span>k8s<span class="token punctuation">.</span>V1EnvVar<span class="token punctuation">(</span>name<span class="token operator">=</span><span class="token string">&quot;key1&quot;</span><span class="token punctuation">,</span> value<span class="token operator">=</span><span class="token string">&quot;value1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span> k8s<span class="token punctuation">.</span>V1EnvVar<span class="token punctuation">(</span>name<span class="token operator">=</span><span class="token string">&quot;key2&quot;</span><span class="token punctuation">,</span> value<span class="token operator">=</span><span class="token string">&quot;value2&quot;</span><span class="token punctuation">)</span><span class="token punctuation">]</span>

init_container <span class="token operator">=</span> k8s<span class="token punctuation">.</span>V1Container<span class="token punctuation">(</span>
    name<span class="token operator">=</span><span class="token string">&quot;init-container&quot;</span><span class="token punctuation">,</span>
    image<span class="token operator">=</span><span class="token string">&quot;ubuntu:16.04&quot;</span><span class="token punctuation">,</span>
    env<span class="token operator">=</span>init_environments<span class="token punctuation">,</span>
    volume_mounts<span class="token operator">=</span>init_container_volume_mounts<span class="token punctuation">,</span>
    command<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">&quot;bash&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;-cx&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    args<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">&quot;echo 10&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">)</span>

affinity <span class="token operator">=</span> k8s<span class="token punctuation">.</span>V1Affinity<span class="token punctuation">(</span>
    node_affinity<span class="token operator">=</span>k8s<span class="token punctuation">.</span>V1NodeAffinity<span class="token punctuation">(</span>
        preferred_during_scheduling_ignored_during_execution<span class="token operator">=</span><span class="token punctuation">[</span>
            k8s<span class="token punctuation">.</span>V1PreferredSchedulingTerm<span class="token punctuation">(</span>
                weight<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span>
                preference<span class="token operator">=</span>k8s<span class="token punctuation">.</span>V1NodeSelectorTerm<span class="token punctuation">(</span>
                    match_expressions<span class="token operator">=</span><span class="token punctuation">[</span>
                        k8s<span class="token punctuation">.</span>V1NodeSelectorRequirement<span class="token punctuation">(</span>key<span class="token operator">=</span><span class="token string">&quot;disktype&quot;</span><span class="token punctuation">,</span> operator<span class="token operator">=</span><span class="token string">&quot;In&quot;</span><span class="token punctuation">,</span> values<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">&quot;ssd&quot;</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
                    <span class="token punctuation">]</span>
                <span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token punctuation">)</span>
        <span class="token punctuation">]</span>
    <span class="token punctuation">)</span><span class="token punctuation">,</span>
    pod_affinity<span class="token operator">=</span>k8s<span class="token punctuation">.</span>V1PodAffinity<span class="token punctuation">(</span>
        required_during_scheduling_ignored_during_execution<span class="token operator">=</span><span class="token punctuation">[</span>
            k8s<span class="token punctuation">.</span>V1WeightedPodAffinityTerm<span class="token punctuation">(</span>
                weight<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span>
                pod_affinity_term<span class="token operator">=</span>k8s<span class="token punctuation">.</span>V1PodAffinityTerm<span class="token punctuation">(</span>
                    label_selector<span class="token operator">=</span>k8s<span class="token punctuation">.</span>V1LabelSelector<span class="token punctuation">(</span>
                        match_expressions<span class="token operator">=</span><span class="token punctuation">[</span>
                            k8s<span class="token punctuation">.</span>V1LabelSelectorRequirement<span class="token punctuation">(</span>key<span class="token operator">=</span><span class="token string">&quot;security&quot;</span><span class="token punctuation">,</span> operator<span class="token operator">=</span><span class="token string">&quot;In&quot;</span><span class="token punctuation">,</span> values<span class="token operator">=</span><span class="token string">&quot;S1&quot;</span><span class="token punctuation">)</span>
                        <span class="token punctuation">]</span>
                    <span class="token punctuation">)</span><span class="token punctuation">,</span>
                    topology_key<span class="token operator">=</span><span class="token string">&quot;failure-domain.beta.kubernetes.io/zone&quot;</span><span class="token punctuation">,</span>
                <span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token punctuation">)</span>
        <span class="token punctuation">]</span>
    <span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">)</span>

tolerations <span class="token operator">=</span> <span class="token punctuation">[</span>k8s<span class="token punctuation">.</span>V1Toleration<span class="token punctuation">(</span>key<span class="token operator">=</span><span class="token string">&quot;key&quot;</span><span class="token punctuation">,</span> operator<span class="token operator">=</span><span class="token string">&quot;Equal&quot;</span><span class="token punctuation">,</span> value<span class="token operator">=</span><span class="token string">&quot;value&quot;</span><span class="token punctuation">)</span><span class="token punctuation">]</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>默认情况下，KubernetsPodOperator将查找Dockerhub上公开托管的图像。要从专用注册表（如ECR、GCR、Quay或其他注册表）中提取映像，必须创建一个Kubernetes Secret，该Secret表示从image_pull_secrets参数中指定的专用注册表访问映像的凭据。</p><div class="language-python line-numbers-mode" data-ext="py" data-title="py"><pre class="language-python"><code>    quay_k8s <span class="token operator">=</span> KubernetesPodOperator<span class="token punctuation">(</span>
        namespace<span class="token operator">=</span><span class="token string">&quot;default&quot;</span><span class="token punctuation">,</span>
        image<span class="token operator">=</span><span class="token string">&quot;quay.io/apache/bash&quot;</span><span class="token punctuation">,</span>
        image_pull_secrets<span class="token operator">=</span><span class="token punctuation">[</span>k8s<span class="token punctuation">.</span>V1LocalObjectReference<span class="token punctuation">(</span><span class="token string">&quot;testquay&quot;</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        cmds<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">&quot;bash&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;-cx&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        arguments<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">&quot;echo&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;10&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;echo pwd&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        labels<span class="token operator">=</span><span class="token punctuation">{</span><span class="token string">&quot;foo&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;bar&quot;</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
        name<span class="token operator">=</span><span class="token string">&quot;airflow-private-image-pod&quot;</span><span class="token punctuation">,</span>
        on_finish_action<span class="token operator">=</span><span class="token string">&quot;delete_pod&quot;</span><span class="token punctuation">,</span>
        in_cluster<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>
        task_id<span class="token operator">=</span><span class="token string">&quot;task-two&quot;</span><span class="token punctuation">,</span>
        get_logs<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>KubernetsPodOperator处理XCom值的方式与其他运算符不同。为了从Pod传递XCom值，必须将do_xcom_push指定为True。这将创建一个与Pod一起运行的sidecar容器。Pod必须将XCom值写入/airflow/xcom/return.json位置。</p><div class="language-yaml line-numbers-mode" data-ext="yml" data-title="yml"><pre class="language-yaml"><code>    write_xcom = KubernetesPodOperator(
        namespace=&quot;default&quot;<span class="token punctuation">,</span>
        image=&quot;alpine&quot;<span class="token punctuation">,</span>
        cmds=<span class="token punctuation">[</span><span class="token string">&quot;sh&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;-c&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;mkdir -p /airflow/xcom/;echo &#39;[1,2,3,4]&#39; &gt; /airflow/xcom/return.json&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        name=&quot;write<span class="token punctuation">-</span>xcom&quot;<span class="token punctuation">,</span>
        do_xcom_push=True<span class="token punctuation">,</span>
        on_finish_action=&quot;delete_pod&quot;<span class="token punctuation">,</span>
        in_cluster=True<span class="token punctuation">,</span>
        task_id=&quot;write<span class="token punctuation">-</span>xcom&quot;<span class="token punctuation">,</span>
        get_logs=True<span class="token punctuation">,</span>
    )

    pod_task_xcom_result = BashOperator(
        bash_command=&quot;echo \\&quot;<span class="token punctuation">{</span><span class="token punctuation">{</span> task_instance.xcom_pull(&#39;write<span class="token punctuation">-</span>xcom&#39;)<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token punctuation">}</span><span class="token punctuation">}</span>\\&quot;&quot;<span class="token punctuation">,</span>
        task_id=&quot;pod_task_xcom_result&quot;<span class="token punctuation">,</span>
    )

    write_xcom <span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span> pod_task_xcom_result
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>写入/dev/termination日志的任何内容都将由Kubernetes检索，并在任务失败时包含在异常消息中。</p><div class="language-yaml line-numbers-mode" data-ext="yml" data-title="yml"><pre class="language-yaml"><code>k = KubernetesPodOperator(
    task_id=&quot;test_error_message&quot;<span class="token punctuation">,</span>
    image=&quot;alpine&quot;<span class="token punctuation">,</span>
    cmds=<span class="token punctuation">[</span><span class="token string">&quot;/bin/sh&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    arguments=<span class="token punctuation">[</span><span class="token string">&quot;-c&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;echo hello world; echo Custom error &gt; /dev/termination-log; exit 1;&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    name=&quot;test<span class="token punctuation">-</span>error<span class="token punctuation">-</span>message&quot;<span class="token punctuation">,</span>
    email=&quot;airflow@example.com&quot;<span class="token punctuation">,</span>
    email_on_failure=True<span class="token punctuation">,</span>
)
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div>`,48);function vn(p,mn){const a=i("ExternalLinkIcon");return l(),c("div",null,[P,n("p",null,"Airflow利用了Jinja Templateing的强大功能，并为管道作者提供了一组内置参数和宏。Airflow还为管道作者提供了钩子，以定义他们自己的参数、宏和模板。 本教程几乎没有触及如何在Airflow中使用模板，但本节的目标是让您知道该功能的存在，熟悉双花括号，并指向最常见的模板变量："+u(p.ds)+" 。",1),T,n("ul",null,[n("li",null,[s("调度程序（"),n("a",S,[s("scheduler"),t(a)]),s("），触发任务，并将任务提交给执行器。")]),n("li",null,[s("执行器（"),n("a",R,[s("executor"),t(a)]),s("），运行任务。")]),I,F,L]),N,C,V,K,n("ul",null,[n("li",null,[s("操作符（"),n("a",B,[s("Operators"),t(a)]),s("），预定义的任务，您可以快速串在一起构建DAG的大部分。")]),n("li",null,[s("传感器（"),n("a",M,[s("Sensors"),t(a)]),s("），操作符的一个特殊子类，完全是为了等待外部事件发生。")]),z]),U,n("ul",null,[n("li",null,[s("分支（"),n("a",W,[s("Branching"),t(a)]),s(" ）-根据条件选择要移动到的任务")]),n("li",null,[s("触发器规则（"),n("a",j,[s("Trigger Rules"),t(a)]),s(" ）-设置DAG运行任务的条件")]),n("li",null,[s("设置和拆卸（"),n("a",H,[s("Setup and Teardown"),t(a)]),s(" ）-定义设置和拆卸关系")]),Y,n("li",null,[s("依赖于过去（"),n("a",X,[s("Depends On Past"),t(a)]),s(" ）-任务可以依赖于以前运行的任务本身")])]),J,n("ul",null,[n("li",null,[s("triggering - "),n("a",$,[Q,t(a)])]),Z]),nn,n("ul",null,[n("li",null,[n("a",sn,[s("Testing DAGs with dag.test()"),t(a)])]),n("li",null,[n("a",an,[s("Debugging Airflow DAGs on the command line"),t(a)])]),n("li",null,[n("a",tn,[s("Debug Executor (deprecated)"),t(a)])]),n("li",null,[n("a",en,[s("Local Executor"),t(a)])]),n("li",null,[n("a",pn,[s("Sequential Executor"),t(a)])])]),on,n("ul",null,[n("li",null,[n("a",ln,[s("Celery Executor"),t(a)])]),n("li",null,[n("a",cn,[s("CeleryKubernetes Executor"),t(a)])]),n("li",null,[n("a",un,[s("Dask Executor"),t(a)])]),n("li",null,[n("a",rn,[s("Kubernetes Executor"),t(a)])]),n("li",null,[n("a",dn,[s("LocalKubernetes Executor"),t(a)])])]),kn])}const hn=o(O,[["render",vn],["__file","AirFlow.html.vue"]]),_n=JSON.parse('{"path":"/post/AirFlow.html","title":"AirFlow","lang":"zh-CN","frontmatter":{"title":"AirFlow","date":"2023-10-08T00:00:00.000Z","categories":["Python"],"tags":["AirFlow","任务调度"],"description":"Airflow是一个用于开发、调度和监控 面向批处理的工作流 的开源平台。主要特点是所有工作流都是用Python代码定义的。 快速入门 一个名为 demo 的DAG，从2022年1月1日开始，每天运行一次。DAG是Airflow对工作流的表示。 两个任务，一个是运行Bash脚本的BashOperator，另一个是使用@task decorator定义的...","head":[["meta",{"property":"og:url","content":"https://banrenshan.github.io/post/AirFlow.html"}],["meta",{"property":"og:site_name","content":"心之所向，素履以往"}],["meta",{"property":"og:title","content":"AirFlow"}],["meta",{"property":"og:description","content":"Airflow是一个用于开发、调度和监控 面向批处理的工作流 的开源平台。主要特点是所有工作流都是用Python代码定义的。 快速入门 一个名为 demo 的DAG，从2022年1月1日开始，每天运行一次。DAG是Airflow对工作流的表示。 两个任务，一个是运行Bash脚本的BashOperator，另一个是使用@task decorator定义的..."}],["meta",{"property":"og:type","content":"article"}],["meta",{"property":"og:image","content":"http://montcs.bloomu.edu/~bobmon/Semesters/2012-01/491/import%20soul.png"}],["meta",{"property":"og:locale","content":"zh-CN"}],["meta",{"property":"og:updated_time","content":"2024-04-15T13:40:04.000Z"}],["meta",{"property":"article:author","content":"banrenshan"}],["meta",{"property":"article:tag","content":"AirFlow"}],["meta",{"property":"article:tag","content":"任务调度"}],["meta",{"property":"article:published_time","content":"2023-10-08T00:00:00.000Z"}],["meta",{"property":"article:modified_time","content":"2024-04-15T13:40:04.000Z"}],["script",{"type":"application/ld+json"},"{\\"@context\\":\\"https://schema.org\\",\\"@type\\":\\"Article\\",\\"headline\\":\\"AirFlow\\",\\"image\\":[\\"http://montcs.bloomu.edu/~bobmon/Semesters/2012-01/491/import%20soul.png\\"],\\"datePublished\\":\\"2023-10-08T00:00:00.000Z\\",\\"dateModified\\":\\"2024-04-15T13:40:04.000Z\\",\\"author\\":[{\\"@type\\":\\"Person\\",\\"name\\":\\"banrenshan\\",\\"url\\":\\"https://github.com/banrenshan\\"}]}"]]},"headers":[{"level":3,"title":"默认参数 ： default_args","slug":"默认参数-default-args","link":"#默认参数-default-args","children":[]},{"level":3,"title":"实例化DAG","slug":"实例化dag","link":"#实例化dag","children":[]},{"level":2,"title":"Operators","slug":"operators","link":"#operators","children":[]},{"level":2,"title":"任务","slug":"任务","link":"#任务","children":[]},{"level":2,"title":"Jinja模板","slug":"jinja模板","link":"#jinja模板","children":[]},{"level":2,"title":"文档","slug":"文档","link":"#文档","children":[]},{"level":2,"title":"任务依赖关系","slug":"任务依赖关系","link":"#任务依赖关系","children":[]},{"level":2,"title":"时区","slug":"时区","link":"#时区","children":[]},{"level":2,"title":"测试","slug":"测试","link":"#测试","children":[{"level":3,"title":"验证","slug":"验证","link":"#验证","children":[]},{"level":3,"title":"运行任务","slug":"运行任务","link":"#运行任务","children":[]},{"level":3,"title":"Backfill(回填)","slug":"backfill-回填","link":"#backfill-回填","children":[]}]},{"level":2,"title":"TaskFlow","slug":"taskflow","link":"#taskflow","children":[{"level":3,"title":"重用","slug":"重用","link":"#重用","children":[]},{"level":3,"title":"使用具有复杂/冲突Python依赖关系的TaskFlow API","slug":"使用具有复杂-冲突python依赖关系的taskflow-api","link":"#使用具有复杂-冲突python依赖关系的taskflow-api","children":[]},{"level":3,"title":"与传感器（Sensor ）操作符一起使用TaskFlow API","slug":"与传感器-sensor-操作符一起使用taskflow-api","link":"#与传感器-sensor-操作符一起使用taskflow-api","children":[]},{"level":3,"title":"多输出推理","slug":"多输出推理","link":"#多输出推理","children":[]},{"level":3,"title":"添加装饰任务和传统任务之间的依赖关系","slug":"添加装饰任务和传统任务之间的依赖关系","link":"#添加装饰任务和传统任务之间的依赖关系","children":[]},{"level":3,"title":"在装饰和传统任务之间消费XComs","slug":"在装饰和传统任务之间消费xcoms","link":"#在装饰和传统任务之间消费xcoms","children":[]},{"level":3,"title":"访问装饰任务中的上下文变量","slug":"访问装饰任务中的上下文变量","link":"#访问装饰任务中的上下文变量","children":[]}]},{"level":2,"title":"初始设置","slug":"初始设置","link":"#初始设置","children":[]},{"level":2,"title":"工作负载","slug":"工作负载","link":"#工作负载","children":[]},{"level":2,"title":"控制流程","slug":"控制流程","link":"#控制流程","children":[]},{"level":2,"title":"用户界面","slug":"用户界面","link":"#用户界面","children":[]},{"level":2,"title":"声明DAG","slug":"声明dag","link":"#声明dag","children":[{"level":3,"title":"任务依赖","slug":"任务依赖","link":"#任务依赖","children":[]}]},{"level":2,"title":"加载DAG","slug":"加载dag","link":"#加载dag","children":[]},{"level":2,"title":"运行DAG","slug":"运行dag","link":"#运行dag","children":[]},{"level":2,"title":"默认参数","slug":"默认参数","link":"#默认参数","children":[]},{"level":2,"title":"控制流程","slug":"控制流程-1","link":"#控制流程-1","children":[{"level":3,"title":"分支","slug":"分支","link":"#分支","children":[]},{"level":3,"title":"Latest Only","slug":"latest-only","link":"#latest-only","children":[]},{"level":3,"title":"依赖于过去","slug":"依赖于过去","link":"#依赖于过去","children":[]},{"level":3,"title":"触发器规则","slug":"触发器规则","link":"#触发器规则","children":[]},{"level":3,"title":"Setup and teardown","slug":"setup-and-teardown","link":"#setup-and-teardown","children":[]}]},{"level":2,"title":"动态DAG","slug":"动态dag","link":"#动态dag","children":[]},{"level":2,"title":"DAG可视化","slug":"dag可视化","link":"#dag可视化","children":[{"level":3,"title":"任务组","slug":"任务组","link":"#任务组","children":[]},{"level":3,"title":"边标签","slug":"边标签","link":"#边标签","children":[]}]},{"level":2,"title":"DAG和任务文档","slug":"dag和任务文档","link":"#dag和任务文档","children":[]},{"level":2,"title":"SubDAGs","slug":"subdags","link":"#subdags","children":[]},{"level":2,"title":"打包DAG","slug":"打包dag","link":"#打包dag","children":[]},{"level":2,"title":"DAG 依赖","slug":"dag-依赖","link":"#dag-依赖","children":[]},{"level":2,"title":"DAG暂停、停用和删除","slug":"dag暂停、停用和删除","link":"#dag暂停、停用和删除","children":[]},{"level":2,"title":"类型","slug":"类型","link":"#类型","children":[]},{"level":2,"title":"Kubernetes Executor","slug":"kubernetes-executor","link":"#kubernetes-executor","children":[{"level":3,"title":"主要配置","slug":"主要配置","link":"#主要配置","children":[]},{"level":3,"title":"在持久卷中存储DAG：","slug":"在持久卷中存储dag","link":"#在持久卷中存储dag","children":[]},{"level":3,"title":"从git中提取DAG:","slug":"从git中提取dag","link":"#从git中提取dag","children":[]},{"level":3,"title":"pod覆盖","slug":"pod覆盖","link":"#pod覆盖","children":[]},{"level":3,"title":"调试KubernetesPodOperator","slug":"调试kubernetespodoperator","link":"#调试kubernetespodoperator","children":[]},{"level":3,"title":"参数优先级","slug":"参数优先级","link":"#参数优先级","children":[]},{"level":3,"title":"如何在Pod中使用集群ConfigMaps、Secrets和Volumes？","slug":"如何在pod中使用集群configmaps、secrets和volumes","link":"#如何在pod中使用集群configmaps、secrets和volumes","children":[]}]}],"git":{"createdTime":1713188404000,"updatedTime":1713188404000,"contributors":[{"name":"banrenshan","email":"1367508819@qq.com","commits":1}]},"readingTime":{"minutes":49.82,"words":14945},"filePathRelative":"post/AirFlow.md","localizedDate":"2023年10月8日","excerpt":"<p>Airflow是一个用于开发、调度和监控 <strong>面向批处理的工作流</strong> 的开源平台。<strong>主要特点是所有工作流都是用Python代码定义的</strong>。</p>\\n<h1>快速入门</h1>\\n<div class=\\"language-python\\" data-ext=\\"py\\" data-title=\\"py\\"><pre class=\\"language-python\\"><code><span class=\\"token keyword\\">from</span> datetime <span class=\\"token keyword\\">import</span> datetime\\n\\n<span class=\\"token keyword\\">from</span> airflow <span class=\\"token keyword\\">import</span> DAG\\n<span class=\\"token keyword\\">from</span> airflow<span class=\\"token punctuation\\">.</span>decorators <span class=\\"token keyword\\">import</span> task\\n<span class=\\"token keyword\\">from</span> airflow<span class=\\"token punctuation\\">.</span>operators<span class=\\"token punctuation\\">.</span>bash <span class=\\"token keyword\\">import</span> BashOperator\\n\\n<span class=\\"token comment\\"># A DAG represents a workflow, a collection of tasks</span>\\n<span class=\\"token keyword\\">with</span> DAG<span class=\\"token punctuation\\">(</span>dag_id<span class=\\"token operator\\">=</span><span class=\\"token string\\">\\"demo\\"</span><span class=\\"token punctuation\\">,</span> start_date<span class=\\"token operator\\">=</span>datetime<span class=\\"token punctuation\\">(</span><span class=\\"token number\\">2022</span><span class=\\"token punctuation\\">,</span> <span class=\\"token number\\">1</span><span class=\\"token punctuation\\">,</span> <span class=\\"token number\\">1</span><span class=\\"token punctuation\\">)</span><span class=\\"token punctuation\\">,</span> schedule<span class=\\"token operator\\">=</span><span class=\\"token string\\">\\"0 0 * * *\\"</span><span class=\\"token punctuation\\">)</span> <span class=\\"token keyword\\">as</span> dag<span class=\\"token punctuation\\">:</span>\\n\\n    <span class=\\"token comment\\"># Tasks are represented as operators</span>\\n    hello <span class=\\"token operator\\">=</span> BashOperator<span class=\\"token punctuation\\">(</span>task_id<span class=\\"token operator\\">=</span><span class=\\"token string\\">\\"hello\\"</span><span class=\\"token punctuation\\">,</span> bash_command<span class=\\"token operator\\">=</span><span class=\\"token string\\">\\"echo hello\\"</span><span class=\\"token punctuation\\">)</span>\\n\\n    <span class=\\"token decorator annotation punctuation\\">@task</span><span class=\\"token punctuation\\">(</span><span class=\\"token punctuation\\">)</span>\\n    <span class=\\"token keyword\\">def</span> <span class=\\"token function\\">airflow</span><span class=\\"token punctuation\\">(</span><span class=\\"token punctuation\\">)</span><span class=\\"token punctuation\\">:</span>\\n        <span class=\\"token keyword\\">print</span><span class=\\"token punctuation\\">(</span><span class=\\"token string\\">\\"airflow\\"</span><span class=\\"token punctuation\\">)</span>\\n\\n    <span class=\\"token comment\\"># Set dependencies between tasks</span>\\n    hello <span class=\\"token operator\\">&gt;&gt;</span> airflow<span class=\\"token punctuation\\">(</span><span class=\\"token punctuation\\">)</span>\\n</code></pre></div>","autoDesc":true}');export{hn as comp,_n as data};
